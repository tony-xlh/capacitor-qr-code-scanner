import{W as ct,E as Ye}from"./index-CZtbNzEb.js";/*! For license information please see fabric.js.LICENSE.txt */var ut={653:(ae,h,d)=>{var _,b,x,S,F,E,P,O,G,z,J,X,q,H,ee,ne,ie,he,de,fe,pe,g=g||{version:"5.2.1"};if(h.fabric=g,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?g.document=document:g.document=document.implementation.createHTMLDocument(""),g.window=window;else{var ce=new(d(192)).JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;g.document=ce.document,g.jsdomImplForWrapper=d(898).implForWrapper,g.nodeCanvas=d(245).Canvas,g.window=ce,DOMParser=g.window.DOMParser}function ve(s,i){var n=s.canvas,l=i.targetCanvas,e=l.getContext("2d");e.translate(0,l.height),e.scale(1,-1);var t=n.height-l.height;e.drawImage(n,0,t,l.width,l.height,0,0,l.width,l.height)}function Ee(s,i){var n=i.targetCanvas.getContext("2d"),l=i.destinationWidth,e=i.destinationHeight,t=l*e*4,a=new Uint8Array(this.imageBuffer,0,t),c=new Uint8ClampedArray(this.imageBuffer,0,t);s.readPixels(0,0,l,e,s.RGBA,s.UNSIGNED_BYTE,a);var o=new ImageData(c,l,e);n.putImageData(o,0,0)}g.isTouchSupported="ontouchstart"in g.window||"ontouchstart"in g.document||g.window&&g.window.navigator&&g.window.navigator.maxTouchPoints>0,g.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",g.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],g.DPI=96,g.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",g.commaWsp="(?:\\s+,?\\s*|,\\s*)",g.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,g.reNonWord=/[ \n\.,;!\?\-]/,g.fontPaths={},g.iMatrix=[1,0,0,1,0,0],g.svgNS="http://www.w3.org/2000/svg",g.perfLimitSizeTotal=2097152,g.maxCacheSideLimit=4096,g.minCacheSideLimit=256,g.charWidthsCache={},g.textureSize=2048,g.disableStyleCopyPaste=!1,g.enableGLFiltering=!0,g.devicePixelRatio=g.window.devicePixelRatio||g.window.webkitDevicePixelRatio||g.window.mozDevicePixelRatio||1,g.browserShadowBlurConstant=1,g.arcToSegmentsCache={},g.boundsOfCurveCache={},g.cachesBoundsOfCurve=!0,g.forceGLPutImageData=!1,g.initFilterBackend=function(){return g.enableGLFiltering&&g.isWebglSupported&&g.isWebglSupported(g.textureSize)?(console.log("max texture size: "+g.maxTextureSize),new g.WebglFilterBackend({tileSize:g.textureSize})):g.Canvas2dFilterBackend?new g.Canvas2dFilterBackend:void 0},typeof document<"u"&&typeof window<"u"&&(window.fabric=g),function(){function s(n,l){if(this.__eventListeners[n]){var e=this.__eventListeners[n];l?e[e.indexOf(l)]=!1:g.util.array.fill(e,!1)}}function i(n,l){var e=(function(){l.apply(this,arguments),this.off(n,e)}).bind(this);this.on(n,e)}g.Observable={fire:function(n,l){if(!this.__eventListeners)return this;var e=this.__eventListeners[n];if(!e)return this;for(var t=0,a=e.length;t<a;t++)e[t]&&e[t].call(this,l||{});return this.__eventListeners[n]=e.filter(function(c){return c!==!1}),this},on:function(n,l){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var e in n)this.on(e,n[e]);else this.__eventListeners[n]||(this.__eventListeners[n]=[]),this.__eventListeners[n].push(l);return this},once:function(n,l){if(arguments.length===1)for(var e in n)i.call(this,e,n[e]);else i.call(this,n,l);return this},off:function(n,l){if(!this.__eventListeners)return this;if(arguments.length===0)for(n in this.__eventListeners)s.call(this,n);else if(arguments.length===1&&typeof arguments[0]=="object")for(var e in n)s.call(this,e,n[e]);else s.call(this,n,l);return this}}}(),g.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var s=0,i=arguments.length;s<i;s++)this._onObjectAdded(arguments[s]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(s,i,n){var l=this._objects;return n?l[i]=s:l.splice(i,0,s),this._onObjectAdded&&this._onObjectAdded(s),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var s,i=this._objects,n=!1,l=0,e=arguments.length;l<e;l++)(s=i.indexOf(arguments[l]))!==-1&&(n=!0,i.splice(s,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[l]));return this.renderOnAddRemove&&n&&this.requestRenderAll(),this},forEachObject:function(s,i){for(var n=this.getObjects(),l=0,e=n.length;l<e;l++)s.call(i,n[l],l,n);return this},getObjects:function(s){return s===void 0?this._objects.concat():this._objects.filter(function(i){return i.type===s})},item:function(s){return this._objects[s]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(s,i){return this._objects.indexOf(s)>-1||!!i&&this._objects.some(function(n){return typeof n.contains=="function"&&n.contains(s,!0)})},complexity:function(){return this._objects.reduce(function(s,i){return s+(i.complexity?i.complexity():0)},0)}},g.CommonMethods={_setOptions:function(s){for(var i in s)this.set(i,s[i])},_initGradient:function(s,i){!s||!s.colorStops||s instanceof g.Gradient||this.set(i,new g.Gradient(s))},_initPattern:function(s,i,n){!s||!s.source||s instanceof g.Pattern?n&&n():this.set(i,new g.Pattern(s,n))},_setObject:function(s){for(var i in s)this._set(i,s[i])},set:function(s,i){return typeof s=="object"?this._setObject(s):this._set(s,i),this},_set:function(s,i){this[s]=i},toggle:function(s){var i=this.get(s);return typeof i=="boolean"&&this.set(s,!i),this},get:function(s){return this[s]}},_=h,b=Math.sqrt,x=Math.atan2,S=Math.pow,F=Math.PI/180,E=Math.PI/2,g.util={cos:function(s){if(s===0)return 1;switch(s<0&&(s=-s),s/E){case 1:case 3:return 0;case 2:return-1}return Math.cos(s)},sin:function(s){if(s===0)return 0;var i=1;switch(s<0&&(i=-1),s/E){case 1:return i;case 2:return 0;case 3:return-i}return Math.sin(s)},removeFromArray:function(s,i){var n=s.indexOf(i);return n!==-1&&s.splice(n,1),s},getRandomInt:function(s,i){return Math.floor(Math.random()*(i-s+1))+s},degreesToRadians:function(s){return s*F},radiansToDegrees:function(s){return s/F},rotatePoint:function(s,i,n){var l=new g.Point(s.x-i.x,s.y-i.y),e=g.util.rotateVector(l,n);return new g.Point(e.x,e.y).addEquals(i)},rotateVector:function(s,i){var n=g.util.sin(i),l=g.util.cos(i);return{x:s.x*l-s.y*n,y:s.x*n+s.y*l}},createVector:function(s,i){return new g.Point(i.x-s.x,i.y-s.y)},calcAngleBetweenVectors:function(s,i){return Math.acos((s.x*i.x+s.y*i.y)/(Math.hypot(s.x,s.y)*Math.hypot(i.x,i.y)))},getHatVector:function(s){return new g.Point(s.x,s.y).multiply(1/Math.hypot(s.x,s.y))},getBisector:function(s,i,n){var l=g.util.createVector(s,i),e=g.util.createVector(s,n),t=g.util.calcAngleBetweenVectors(l,e),a=t*(g.util.calcAngleBetweenVectors(g.util.rotateVector(l,t),e)===0?1:-1)/2;return{vector:g.util.getHatVector(g.util.rotateVector(l,a)),angle:t}},projectStrokeOnPoints:function(s,i,n){var l=[],e=i.strokeWidth/2,t=i.strokeUniform?new g.Point(1/i.scaleX,1/i.scaleY):new g.Point(1,1),a=function(c){var o=e/Math.hypot(c.x,c.y);return new g.Point(c.x*o*t.x,c.y*o*t.y)};return s.length<=1||s.forEach(function(c,o){var r,u,f=new g.Point(c.x,c.y);o===0?(u=s[o+1],r=n?a(g.util.createVector(u,f)).addEquals(f):s[s.length-1]):o===s.length-1?(r=s[o-1],u=n?a(g.util.createVector(r,f)).addEquals(f):s[0]):(r=s[o-1],u=s[o+1]);var p,m,v=g.util.getBisector(f,r,u),y=v.vector,C=v.angle;if(i.strokeLineJoin==="miter"&&(p=-e/Math.sin(C/2),m=new g.Point(y.x*p*t.x,y.y*p*t.y),Math.hypot(m.x,m.y)/e<=i.strokeMiterLimit))return l.push(f.add(m)),void l.push(f.subtract(m));p=-e*Math.SQRT2,m=new g.Point(y.x*p*t.x,y.y*p*t.y),l.push(f.add(m)),l.push(f.subtract(m))}),l},transformPoint:function(s,i,n){return n?new g.Point(i[0]*s.x+i[2]*s.y,i[1]*s.x+i[3]*s.y):new g.Point(i[0]*s.x+i[2]*s.y+i[4],i[1]*s.x+i[3]*s.y+i[5])},makeBoundingBoxFromPoints:function(s,i){if(i)for(var n=0;n<s.length;n++)s[n]=g.util.transformPoint(s[n],i);var l=[s[0].x,s[1].x,s[2].x,s[3].x],e=g.util.array.min(l),t=g.util.array.max(l)-e,a=[s[0].y,s[1].y,s[2].y,s[3].y],c=g.util.array.min(a);return{left:e,top:c,width:t,height:g.util.array.max(a)-c}},invertTransform:function(s){var i=1/(s[0]*s[3]-s[1]*s[2]),n=[i*s[3],-i*s[1],-i*s[2],i*s[0]],l=g.util.transformPoint({x:s[4],y:s[5]},n,!0);return n[4]=-l.x,n[5]=-l.y,n},toFixed:function(s,i){return parseFloat(Number(s).toFixed(i))},parseUnit:function(s,i){var n=/\D{0,2}$/.exec(s),l=parseFloat(s);switch(i||(i=g.Text.DEFAULT_SVG_FONT_SIZE),n[0]){case"mm":return l*g.DPI/25.4;case"cm":return l*g.DPI/2.54;case"in":return l*g.DPI;case"pt":return l*g.DPI/72;case"pc":return l*g.DPI/72*12;case"em":return l*i;default:return l}},falseFunction:function(){return!1},getKlass:function(s,i){return s=g.util.string.camelize(s.charAt(0).toUpperCase()+s.slice(1)),g.util.resolveNamespace(i)[s]},getSvgAttributes:function(s){var i=["instantiated_by_use","style","id","class"];switch(s){case"linearGradient":i=i.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":i=i.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":i=i.concat(["offset","stop-color","stop-opacity"])}return i},resolveNamespace:function(s){if(!s)return g;var i,n=s.split("."),l=n.length,e=_||g.window;for(i=0;i<l;++i)e=e[n[i]];return e},loadImage:function(s,i,n,l){if(s){var e=g.util.createImage(),t=function(){i&&i.call(n,e,!1),e=e.onload=e.onerror=null};e.onload=t,e.onerror=function(){g.log("Error loading "+e.src),i&&i.call(n,null,!0),e=e.onload=e.onerror=null},s.indexOf("data")!==0&&l!=null&&(e.crossOrigin=l),s.substring(0,14)==="data:image/svg"&&(e.onload=null,g.util.loadImageInDom(e,t)),e.src=s}else i&&i.call(n,s)},loadImageInDom:function(s,i){var n=g.document.createElement("div");n.style.width=n.style.height="1px",n.style.left=n.style.top="-100%",n.style.position="absolute",n.appendChild(s),g.document.querySelector("body").appendChild(n),s.onload=function(){i(),n.parentNode.removeChild(n),n=null}},enlivenObjects:function(s,i,n,l){var e=[],t=0,a=(s=s||[]).length;function c(){++t===a&&i&&i(e.filter(function(o){return o}))}a?s.forEach(function(o,r){o&&o.type?g.util.getKlass(o.type,n).fromObject(o,function(u,f){f||(e[r]=u),l&&l(o,u,f),c()}):c()}):i&&i(e)},enlivenObjectEnlivables:function(s,i,n){var l=g.Object.ENLIVEN_PROPS.filter(function(e){return!!s[e]});g.util.enlivenObjects(l.map(function(e){return s[e]}),function(e){var t={};l.forEach(function(a,c){t[a]=e[c],i&&(i[a]=e[c])}),n&&n(t)})},enlivenPatterns:function(s,i){function n(){++e===t&&i&&i(l)}var l=[],e=0,t=(s=s||[]).length;t?s.forEach(function(a,c){a&&a.source?new g.Pattern(a,function(o){l[c]=o,n()}):(l[c]=a,n())}):i&&i(l)},groupSVGElements:function(s,i,n){var l;return s&&s.length===1?s[0]:(i&&(i.width&&i.height?i.centerPoint={x:i.width/2,y:i.height/2}:(delete i.width,delete i.height)),l=new g.Group(s,i),n!==void 0&&(l.sourcePath=n),l)},populateWithProperties:function(s,i,n){if(n&&Array.isArray(n))for(var l=0,e=n.length;l<e;l++)n[l]in s&&(i[n[l]]=s[n[l]])},createCanvasElement:function(){return g.document.createElement("canvas")},copyCanvasElement:function(s){var i=g.util.createCanvasElement();return i.width=s.width,i.height=s.height,i.getContext("2d").drawImage(s,0,0),i},toDataURL:function(s,i,n){return s.toDataURL("image/"+i,n)},createImage:function(){return g.document.createElement("img")},multiplyTransformMatrices:function(s,i,n){return[s[0]*i[0]+s[2]*i[1],s[1]*i[0]+s[3]*i[1],s[0]*i[2]+s[2]*i[3],s[1]*i[2]+s[3]*i[3],n?0:s[0]*i[4]+s[2]*i[5]+s[4],n?0:s[1]*i[4]+s[3]*i[5]+s[5]]},qrDecompose:function(s){var i=x(s[1],s[0]),n=S(s[0],2)+S(s[1],2),l=b(n),e=(s[0]*s[3]-s[2]*s[1])/l,t=x(s[0]*s[2]+s[1]*s[3],n);return{angle:i/F,scaleX:l,scaleY:e,skewX:t/F,skewY:0,translateX:s[4],translateY:s[5]}},calcRotateMatrix:function(s){if(!s.angle)return g.iMatrix.concat();var i=g.util.degreesToRadians(s.angle),n=g.util.cos(i),l=g.util.sin(i);return[n,l,-l,n,0,0]},calcDimensionsMatrix:function(s){var i=s.scaleX===void 0?1:s.scaleX,n=s.scaleY===void 0?1:s.scaleY,l=[s.flipX?-i:i,0,0,s.flipY?-n:n,0,0],e=g.util.multiplyTransformMatrices,t=g.util.degreesToRadians;return s.skewX&&(l=e(l,[1,0,Math.tan(t(s.skewX)),1],!0)),s.skewY&&(l=e(l,[1,Math.tan(t(s.skewY)),0,1],!0)),l},composeMatrix:function(s){var i=[1,0,0,1,s.translateX||0,s.translateY||0],n=g.util.multiplyTransformMatrices;return s.angle&&(i=n(i,g.util.calcRotateMatrix(s))),(s.scaleX!==1||s.scaleY!==1||s.skewX||s.skewY||s.flipX||s.flipY)&&(i=n(i,g.util.calcDimensionsMatrix(s))),i},resetObjectTransform:function(s){s.scaleX=1,s.scaleY=1,s.skewX=0,s.skewY=0,s.flipX=!1,s.flipY=!1,s.rotate(0)},saveObjectTransform:function(s){return{scaleX:s.scaleX,scaleY:s.scaleY,skewX:s.skewX,skewY:s.skewY,angle:s.angle,left:s.left,flipX:s.flipX,flipY:s.flipY,top:s.top}},isTransparent:function(s,i,n,l){l>0&&(i>l?i-=l:i=0,n>l?n-=l:n=0);var e,t=!0,a=s.getImageData(i,n,2*l||1,2*l||1),c=a.data.length;for(e=3;e<c&&(t=a.data[e]<=0)!=0;e+=4);return a=null,t},parsePreserveAspectRatioAttribute:function(s){var i,n="meet",l=s.split(" ");return l&&l.length&&((n=l.pop())!=="meet"&&n!=="slice"?(i=n,n="meet"):l.length&&(i=l.pop())),{meetOrSlice:n,alignX:i!=="none"?i.slice(1,4):"none",alignY:i!=="none"?i.slice(5,8):"none"}},clearFabricFontCache:function(s){(s=(s||"").toLowerCase())?g.charWidthsCache[s]&&delete g.charWidthsCache[s]:g.charWidthsCache={}},limitDimsByArea:function(s,i){var n=Math.sqrt(i*s),l=Math.floor(i/n);return{x:Math.floor(n),y:l}},capValue:function(s,i,n){return Math.max(s,Math.min(i,n))},findScaleToFit:function(s,i){return Math.min(i.width/s.width,i.height/s.height)},findScaleToCover:function(s,i){return Math.max(i.width/s.width,i.height/s.height)},matrixToSVG:function(s){return"matrix("+s.map(function(i){return g.util.toFixed(i,g.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(s,i){var n=g.util.invertTransform(i),l=g.util.multiplyTransformMatrices(n,s.calcOwnMatrix());g.util.applyTransformToObject(s,l)},addTransformToObject:function(s,i){g.util.applyTransformToObject(s,g.util.multiplyTransformMatrices(i,s.calcOwnMatrix()))},applyTransformToObject:function(s,i){var n=g.util.qrDecompose(i),l=new g.Point(n.translateX,n.translateY);s.flipX=!1,s.flipY=!1,s.set("scaleX",n.scaleX),s.set("scaleY",n.scaleY),s.skewX=n.skewX,s.skewY=n.skewY,s.angle=n.angle,s.setPositionByOrigin(l,"center","center")},sizeAfterTransform:function(s,i,n){var l=s/2,e=i/2,t=[{x:-l,y:-e},{x:l,y:-e},{x:-l,y:e},{x:l,y:e}],a=g.util.calcDimensionsMatrix(n),c=g.util.makeBoundingBoxFromPoints(t,a);return{x:c.width,y:c.height}},mergeClipPaths:function(s,i){var n=s,l=i;n.inverted&&!l.inverted&&(n=i,l=s),g.util.applyTransformToObject(l,g.util.multiplyTransformMatrices(g.util.invertTransform(n.calcTransformMatrix()),l.calcTransformMatrix()));var e=n.inverted&&l.inverted;return e&&(n.inverted=l.inverted=!1),new g.Group([n],{clipPath:l,inverted:e})}},function(){var s=Array.prototype.join,i={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},n={m:"l",M:"L"};function l(m,v,y,C,R,M,W,j,I,T,D){var U=g.util.cos(m),L=g.util.sin(m),B=g.util.cos(v),A=g.util.sin(v),w=y*R*B-C*M*A+W,k=C*R*B+y*M*A+j;return["C",T+I*(-y*R*L-C*M*U),D+I*(-C*R*L+y*M*U),w+I*(y*R*A+C*M*B),k+I*(C*R*A-y*M*B),w,k]}function e(m,v,y,C){var R=Math.atan2(v,m),M=Math.atan2(C,y);return M>=R?M-R:2*Math.PI-(R-M)}function t(m,v,y){for(var C=y[1],R=y[2],M=y[3],W=y[4],j=y[5],I=function(U,L,B,A,w,k,V){var N=Math.PI,Y=V*N/180,K=g.util.sin(Y),te=g.util.cos(Y),Q=0,re=0,Z=-te*U*.5-K*L*.5,oe=-te*L*.5+K*U*.5,le=(B=Math.abs(B))*B,se=(A=Math.abs(A))*A,ue=oe*oe,ge=Z*Z,Ce=le*se-le*ue-se*ge,xe=0;if(Ce<0){var Le=Math.sqrt(1-Ce/(le*se));B*=Le,A*=Le}else xe=(w===k?-1:1)*Math.sqrt(Ce/(le*ue+se*ge));var _e=xe*B*oe/A,Oe=-xe*A*Z/B,Ge=te*_e-K*Oe+.5*U,Pe=K*_e+te*Oe+.5*L,ke=e(1,0,(Z-_e)/B,(oe-Oe)/A),Ie=e((Z-_e)/B,(oe-Oe)/A,(-Z-_e)/B,(-oe-Oe)/A);k===0&&Ie>0?Ie-=2*N:k===1&&Ie<0&&(Ie+=2*N);for(var Je=Math.ceil(Math.abs(Ie/N*2)),We=[],Se=Ie/Je,Ze=8/3*Math.sin(Se/4)*Math.sin(Se/4)/Math.sin(Se/2),Xe=ke+Se,Ve=0;Ve<Je;Ve++)We[Ve]=l(ke,Xe,te,K,B,A,Ge,Pe,Ze,Q,re),Q=We[Ve][5],re=We[Ve][6],ke=Xe,Xe+=Se;return We}(y[6]-m,y[7]-v,C,R,W,j,M),T=0,D=I.length;T<D;T++)I[T][1]+=m,I[T][2]+=v,I[T][3]+=m,I[T][4]+=v,I[T][5]+=m,I[T][6]+=v;return I}function a(m,v,y,C){return Math.sqrt((y-m)*(y-m)+(C-v)*(C-v))}function c(m,v,y,C,R,M,W,j){return function(I){var T,D=(T=I)*T*T,U=function(A){return 3*A*A*(1-A)}(I),L=function(A){return 3*A*(1-A)*(1-A)}(I),B=function(A){return(1-A)*(1-A)*(1-A)}(I);return{x:W*D+R*U+y*L+m*B,y:j*D+M*U+C*L+v*B}}}function o(m,v,y,C,R,M,W,j){return function(I){var T=1-I,D=3*T*T*(y-m)+6*T*I*(R-y)+3*I*I*(W-R),U=3*T*T*(C-v)+6*T*I*(M-C)+3*I*I*(j-M);return Math.atan2(U,D)}}function r(m,v,y,C,R,M){return function(W){var j,I=(j=W)*j,T=function(U){return 2*U*(1-U)}(W),D=function(U){return(1-U)*(1-U)}(W);return{x:R*I+y*T+m*D,y:M*I+C*T+v*D}}}function u(m,v,y,C,R,M){return function(W){var j=1-W,I=2*j*(y-m)+2*W*(R-y),T=2*j*(C-v)+2*W*(M-C);return Math.atan2(T,I)}}function f(m,v,y){var C,R,M={x:v,y},W=0;for(R=1;R<=100;R+=1)C=m(R/100),W+=a(M.x,M.y,C.x,C.y),M=C;return W}function p(m){for(var v,y,C,R,M=0,W=m.length,j=0,I=0,T=0,D=0,U=[],L=0;L<W;L++){switch(C={x:j,y:I,command:(v=m[L])[0]},v[0]){case"M":C.length=0,T=j=v[1],D=I=v[2];break;case"L":C.length=a(j,I,v[1],v[2]),j=v[1],I=v[2];break;case"C":y=c(j,I,v[1],v[2],v[3],v[4],v[5],v[6]),R=o(j,I,v[1],v[2],v[3],v[4],v[5],v[6]),C.iterator=y,C.angleFinder=R,C.length=f(y,j,I),j=v[5],I=v[6];break;case"Q":y=r(j,I,v[1],v[2],v[3],v[4]),R=u(j,I,v[1],v[2],v[3],v[4]),C.iterator=y,C.angleFinder=R,C.length=f(y,j,I),j=v[3],I=v[4];break;case"Z":case"z":C.destX=T,C.destY=D,C.length=a(j,I,T,D),j=T,I=D}M+=C.length,U.push(C)}return U.push({length:M,x:j,y:I}),U}g.util.joinPath=function(m){return m.map(function(v){return v.join(" ")}).join(" ")},g.util.parsePath=function(m){var v,y,C,R,M,W=[],j=[],I=g.rePathCommand,T="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",D="("+T+")"+g.commaWsp,U="([01])"+g.commaWsp+"?",L=new RegExp(D+"?"+D+"?"+D+U+U+D+"?("+T+")","g");if(!m||!m.match)return W;for(var B,A=0,w=(M=m.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi)).length;A<w;A++){R=(v=M[A]).slice(1).trim(),j.length=0;var k=v.charAt(0);if(B=[k],k.toLowerCase()==="a")for(var V;V=L.exec(R);)for(var N=1;N<V.length;N++)j.push(V[N]);else for(;C=I.exec(R);)j.push(C[0]);N=0;for(var Y=j.length;N<Y;N++)y=parseFloat(j[N]),isNaN(y)||B.push(y);var K=i[k.toLowerCase()],te=n[k]||k;if(B.length-1>K)for(var Q=1,re=B.length;Q<re;Q+=K)W.push([k].concat(B.slice(Q,Q+K))),k=te;else W.push(B)}return W},g.util.makePathSimpler=function(m){var v,y,C,R,M,W,j=0,I=0,T=m.length,D=0,U=0,L=[];for(y=0;y<T;++y){switch(C=!1,(v=m[y].slice(0))[0]){case"l":v[0]="L",v[1]+=j,v[2]+=I;case"L":j=v[1],I=v[2];break;case"h":v[1]+=j;case"H":v[0]="L",v[2]=I,j=v[1];break;case"v":v[1]+=I;case"V":v[0]="L",I=v[1],v[1]=j,v[2]=I;break;case"m":v[0]="M",v[1]+=j,v[2]+=I;case"M":j=v[1],I=v[2],D=v[1],U=v[2];break;case"c":v[0]="C",v[1]+=j,v[2]+=I,v[3]+=j,v[4]+=I,v[5]+=j,v[6]+=I;case"C":M=v[3],W=v[4],j=v[5],I=v[6];break;case"s":v[0]="S",v[1]+=j,v[2]+=I,v[3]+=j,v[4]+=I;case"S":R==="C"?(M=2*j-M,W=2*I-W):(M=j,W=I),j=v[3],I=v[4],v[0]="C",v[5]=v[3],v[6]=v[4],v[3]=v[1],v[4]=v[2],v[1]=M,v[2]=W,M=v[3],W=v[4];break;case"q":v[0]="Q",v[1]+=j,v[2]+=I,v[3]+=j,v[4]+=I;case"Q":M=v[1],W=v[2],j=v[3],I=v[4];break;case"t":v[0]="T",v[1]+=j,v[2]+=I;case"T":R==="Q"?(M=2*j-M,W=2*I-W):(M=j,W=I),v[0]="Q",j=v[1],I=v[2],v[1]=M,v[2]=W,v[3]=j,v[4]=I;break;case"a":v[0]="A",v[6]+=j,v[7]+=I;case"A":C=!0,L=L.concat(t(j,I,v)),j=v[6],I=v[7];break;case"z":case"Z":j=D,I=U}C||L.push(v),R=v[0]}return L},g.util.getSmoothPathFromPoints=function(m,v){var y,C=[],R=new g.Point(m[0].x,m[0].y),M=new g.Point(m[1].x,m[1].y),W=m.length,j=1,I=0,T=W>2;for(v=v||0,T&&(j=m[2].x<M.x?-1:m[2].x===M.x?0:1,I=m[2].y<M.y?-1:m[2].y===M.y?0:1),C.push(["M",R.x-j*v,R.y-I*v]),y=1;y<W;y++){if(!R.eq(M)){var D=R.midPointFrom(M);C.push(["Q",R.x,R.y,D.x,D.y])}R=m[y],y+1<m.length&&(M=m[y+1])}return T&&(j=R.x>m[y-2].x?1:R.x===m[y-2].x?0:-1,I=R.y>m[y-2].y?1:R.y===m[y-2].y?0:-1),C.push(["L",R.x+j*v,R.y+I*v]),C},g.util.getPathSegmentsInfo=p,g.util.getBoundsOfCurve=function(m,v,y,C,R,M,W,j){var I;if(g.cachesBoundsOfCurve&&(I=s.call(arguments),g.boundsOfCurveCache[I]))return g.boundsOfCurveCache[I];var T,D,U,L,B,A,w,k,V=Math.sqrt,N=Math.min,Y=Math.max,K=Math.abs,te=[],Q=[[],[]];D=6*m-12*y+6*R,T=-3*m+9*y-9*R+3*W,U=3*y-3*m;for(var re=0;re<2;++re)if(re>0&&(D=6*v-12*C+6*M,T=-3*v+9*C-9*M+3*j,U=3*C-3*v),K(T)<1e-12){if(K(D)<1e-12)continue;0<(L=-U/D)&&L<1&&te.push(L)}else(w=D*D-4*U*T)<0||(0<(B=(-D+(k=V(w)))/(2*T))&&B<1&&te.push(B),0<(A=(-D-k)/(2*T))&&A<1&&te.push(A));for(var Z,oe,le,se=te.length,ue=se;se--;)Z=(le=1-(L=te[se]))*le*le*m+3*le*le*L*y+3*le*L*L*R+L*L*L*W,Q[0][se]=Z,oe=le*le*le*v+3*le*le*L*C+3*le*L*L*M+L*L*L*j,Q[1][se]=oe;Q[0][ue]=m,Q[1][ue]=v,Q[0][ue+1]=W,Q[1][ue+1]=j;var ge=[{x:N.apply(null,Q[0]),y:N.apply(null,Q[1])},{x:Y.apply(null,Q[0]),y:Y.apply(null,Q[1])}];return g.cachesBoundsOfCurve&&(g.boundsOfCurveCache[I]=ge),ge},g.util.getPointOnPath=function(m,v,y){y||(y=p(m));for(var C=0;v-y[C].length>0&&C<y.length-2;)v-=y[C].length,C++;var R,M=y[C],W=v/M.length,j=M.command,I=m[C];switch(j){case"M":return{x:M.x,y:M.y,angle:0};case"Z":case"z":return(R=new g.Point(M.x,M.y).lerp(new g.Point(M.destX,M.destY),W)).angle=Math.atan2(M.destY-M.y,M.destX-M.x),R;case"L":return(R=new g.Point(M.x,M.y).lerp(new g.Point(I[1],I[2]),W)).angle=Math.atan2(I[2]-M.y,I[1]-M.x),R;case"C":case"Q":return function(T,D){for(var U,L,B,A=0,w=0,k=T.iterator,V={x:T.x,y:T.y},N=.01,Y=T.angleFinder;w<D&&N>1e-4;)U=k(A),B=A,(L=a(V.x,V.y,U.x,U.y))+w>D?(A-=N,N/=2):(V=U,A+=N,w+=L);return U.angle=Y(B),U}(M,v)}},g.util.transformPath=function(m,v,y){return y&&(v=g.util.multiplyTransformMatrices(v,[1,0,0,1,-y.x,-y.y])),m.map(function(C){for(var R=C.slice(0),M={},W=1;W<C.length-1;W+=2)M.x=C[W],M.y=C[W+1],M=g.util.transformPoint(M,v),R[W]=M.x,R[W+1]=M.y;return R})}}(),function(){var s=Array.prototype.slice;function i(n,l,e){if(n&&n.length!==0){var t=n.length-1,a=l?n[t][l]:n[t];if(l)for(;t--;)e(n[t][l],a)&&(a=n[t][l]);else for(;t--;)e(n[t],a)&&(a=n[t]);return a}}g.util.array={fill:function(n,l){for(var e=n.length;e--;)n[e]=l;return n},invoke:function(n,l){for(var e=s.call(arguments,2),t=[],a=0,c=n.length;a<c;a++)t[a]=e.length?n[a][l].apply(n[a],e):n[a][l].call(n[a]);return t},min:function(n,l){return i(n,l,function(e,t){return e<t})},max:function(n,l){return i(n,l,function(e,t){return e>=t})}}}(),function(){function s(i,n,l){if(l)if(!g.isLikelyNode&&n instanceof Element)i=n;else if(n instanceof Array){i=[];for(var e=0,t=n.length;e<t;e++)i[e]=s({},n[e],l)}else if(n&&typeof n=="object")for(var a in n)a==="canvas"||a==="group"?i[a]=null:n.hasOwnProperty(a)&&(i[a]=s({},n[a],l));else i=n;else for(var a in n)i[a]=n[a];return i}g.util.object={extend:s,clone:function(i,n){return s({},i,n)}},g.util.object.extend(g.util,g.Observable)}(),function(){function s(i,n){var l=i.charCodeAt(n);if(isNaN(l))return"";if(l<55296||l>57343)return i.charAt(n);if(55296<=l&&l<=56319){if(i.length<=n+1)throw"High surrogate without following low surrogate";var e=i.charCodeAt(n+1);if(56320>e||e>57343)throw"High surrogate without following low surrogate";return i.charAt(n)+i.charAt(n+1)}if(n===0)throw"Low surrogate without preceding high surrogate";var t=i.charCodeAt(n-1);if(55296>t||t>56319)throw"Low surrogate without preceding high surrogate";return!1}g.util.string={camelize:function(i){return i.replace(/-+(.)?/g,function(n,l){return l?l.toUpperCase():""})},capitalize:function(i,n){return i.charAt(0).toUpperCase()+(n?i.slice(1):i.slice(1).toLowerCase())},escapeXml:function(i){return i.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},graphemeSplit:function(i){var n,l=0,e=[];for(l=0;l<i.length;l++)(n=s(i,l))!==!1&&e.push(n);return e}}}(),function(){var s=Array.prototype.slice,i=function(){},n=function(){for(var a in{toString:1})if(a==="toString")return!1;return!0}(),l=function(a,c,o){for(var r in c)r in a.prototype&&typeof a.prototype[r]=="function"&&(c[r]+"").indexOf("callSuper")>-1?a.prototype[r]=function(u){return function(){var f=this.constructor.superclass;this.constructor.superclass=o;var p=c[u].apply(this,arguments);if(this.constructor.superclass=f,u!=="initialize")return p}}(r):a.prototype[r]=c[r],n&&(c.toString!==Object.prototype.toString&&(a.prototype.toString=c.toString),c.valueOf!==Object.prototype.valueOf&&(a.prototype.valueOf=c.valueOf))};function e(){}function t(a){for(var c=null,o=this;o.constructor.superclass;){var r=o.constructor.superclass.prototype[a];if(o[a]!==r){c=r;break}o=o.constructor.superclass.prototype}return c?arguments.length>1?c.apply(this,s.call(arguments,1)):c.call(this):console.log("tried to callSuper "+a+", method not found in prototype chain",this)}g.util.createClass=function(){var a=null,c=s.call(arguments,0);function o(){this.initialize.apply(this,arguments)}typeof c[0]=="function"&&(a=c.shift()),o.superclass=a,o.subclasses=[],a&&(e.prototype=a.prototype,o.prototype=new e,a.subclasses.push(o));for(var r=0,u=c.length;r<u;r++)l(o,c[r],a);return o.prototype.initialize||(o.prototype.initialize=i),o.prototype.constructor=o,o.prototype.callSuper=t,o}}(),P=!!g.document.createElement("div").attachEvent,O=["touchstart","touchmove","touchend"],g.util.addListener=function(s,i,n,l){s&&s.addEventListener(i,n,!P&&l)},g.util.removeListener=function(s,i,n,l){s&&s.removeEventListener(i,n,!P&&l)},g.util.getPointer=function(s){var i=s.target,n=g.util.getScrollLeftTop(i),l=function(e){var t=e.changedTouches;return t&&t[0]?t[0]:e}(s);return{x:l.clientX+n.left,y:l.clientY+n.top}},g.util.isTouchEvent=function(s){return O.indexOf(s.type)>-1||s.pointerType==="touch"},z=typeof(G=g.document.createElement("div")).style.opacity=="string",J=typeof G.style.filter=="string",X=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,q=function(s){return s},z?q=function(s,i){return s.style.opacity=i,s}:J&&(q=function(s,i){var n=s.style;return s.currentStyle&&!s.currentStyle.hasLayout&&(n.zoom=1),X.test(n.filter)?(i=i>=.9999?"":"alpha(opacity="+100*i+")",n.filter=n.filter.replace(X,i)):n.filter+=" alpha(opacity="+100*i+")",s}),g.util.setStyle=function(s,i){var n=s.style;if(!n)return s;if(typeof i=="string")return s.style.cssText+=";"+i,i.indexOf("opacity")>-1?q(s,i.match(/opacity:\s*(\d?\.?\d*)/)[1]):s;for(var l in i)l==="opacity"?q(s,i[l]):n[l==="float"||l==="cssFloat"?n.styleFloat===void 0?"cssFloat":"styleFloat":l]=i[l];return s},function(){var s,i,n,l,e=Array.prototype.slice,t=function(o){return e.call(o,0)};try{s=t(g.document.childNodes)instanceof Array}catch{}function a(o,r){var u=g.document.createElement(o);for(var f in r)f==="class"?u.className=r[f]:f==="for"?u.htmlFor=r[f]:u.setAttribute(f,r[f]);return u}function c(o){for(var r=0,u=0,f=g.document.documentElement,p=g.document.body||{scrollLeft:0,scrollTop:0};o&&(o.parentNode||o.host)&&((o=o.parentNode||o.host)===g.document?(r=p.scrollLeft||f.scrollLeft||0,u=p.scrollTop||f.scrollTop||0):(r+=o.scrollLeft||0,u+=o.scrollTop||0),o.nodeType!==1||o.style.position!=="fixed"););return{left:r,top:u}}s||(t=function(o){for(var r=new Array(o.length),u=o.length;u--;)r[u]=o[u];return r}),i=g.document.defaultView&&g.document.defaultView.getComputedStyle?function(o,r){var u=g.document.defaultView.getComputedStyle(o,null);return u?u[r]:void 0}:function(o,r){var u=o.style[r];return!u&&o.currentStyle&&(u=o.currentStyle[r]),u},n=g.document.documentElement.style,l="userSelect"in n?"userSelect":"MozUserSelect"in n?"MozUserSelect":"WebkitUserSelect"in n?"WebkitUserSelect":"KhtmlUserSelect"in n?"KhtmlUserSelect":"",g.util.makeElementUnselectable=function(o){return o.onselectstart!==void 0&&(o.onselectstart=g.util.falseFunction),l?o.style[l]="none":typeof o.unselectable=="string"&&(o.unselectable="on"),o},g.util.makeElementSelectable=function(o){return o.onselectstart!==void 0&&(o.onselectstart=null),l?o.style[l]="":typeof o.unselectable=="string"&&(o.unselectable=""),o},g.util.setImageSmoothing=function(o,r){o.imageSmoothingEnabled=o.imageSmoothingEnabled||o.webkitImageSmoothingEnabled||o.mozImageSmoothingEnabled||o.msImageSmoothingEnabled||o.oImageSmoothingEnabled,o.imageSmoothingEnabled=r},g.util.getById=function(o){return typeof o=="string"?g.document.getElementById(o):o},g.util.toArray=t,g.util.addClass=function(o,r){o&&(" "+o.className+" ").indexOf(" "+r+" ")===-1&&(o.className+=(o.className?" ":"")+r)},g.util.makeElement=a,g.util.wrapElement=function(o,r,u){return typeof r=="string"&&(r=a(r,u)),o.parentNode&&o.parentNode.replaceChild(r,o),r.appendChild(o),r},g.util.getScrollLeftTop=c,g.util.getElementOffset=function(o){var r,u,f=o&&o.ownerDocument,p={left:0,top:0},m={left:0,top:0},v={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!f)return m;for(var y in v)m[v[y]]+=parseInt(i(o,y),10)||0;return r=f.documentElement,o.getBoundingClientRect!==void 0&&(p=o.getBoundingClientRect()),u=c(o),{left:p.left+u.left-(r.clientLeft||0)+m.left,top:p.top+u.top-(r.clientTop||0)+m.top}},g.util.getNodeCanvas=function(o){var r=g.jsdomImplForWrapper(o);return r._canvas||r._image},g.util.cleanUpJsdomNode=function(o){if(g.isLikelyNode){var r=g.jsdomImplForWrapper(o);r&&(r._image=null,r._canvas=null,r._currentSrc=null,r._attributes=null,r._classList=null)}}}(),function(){function s(){}g.util.request=function(i,n){n||(n={});var l=n.method?n.method.toUpperCase():"GET",e=n.onComplete||function(){},t=new g.window.XMLHttpRequest,a=n.body||n.parameters;return t.onreadystatechange=function(){t.readyState===4&&(e(t),t.onreadystatechange=s)},l==="GET"&&(a=null,typeof n.parameters=="string"&&(i=function(c,o){return c+(/\?/.test(c)?"&":"?")+o}(i,n.parameters))),t.open(l,i,!0),l!=="POST"&&l!=="PUT"||t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(a),t}}(),g.log=console.log,g.warn=console.warn,function(){var s=g.util.object.extend,i=g.util.object.clone,n=[];function l(){return!1}function e(o,r,u,f){return-u*Math.cos(o/f*(Math.PI/2))+u+r}g.util.object.extend(n,{cancelAll:function(){var o=this.splice(0);return o.forEach(function(r){r.cancel()}),o},cancelByCanvas:function(o){if(!o)return[];var r=this.filter(function(u){return typeof u.target=="object"&&u.target.canvas===o});return r.forEach(function(u){u.cancel()}),r},cancelByTarget:function(o){var r=this.findAnimationsByTarget(o);return r.forEach(function(u){u.cancel()}),r},findAnimationIndex:function(o){return this.indexOf(this.findAnimation(o))},findAnimation:function(o){return this.find(function(r){return r.cancel===o})},findAnimationsByTarget:function(o){return o?this.filter(function(r){return r.target===o}):[]}});var t=g.window.requestAnimationFrame||g.window.webkitRequestAnimationFrame||g.window.mozRequestAnimationFrame||g.window.oRequestAnimationFrame||g.window.msRequestAnimationFrame||function(o){return g.window.setTimeout(o,1e3/60)},a=g.window.cancelAnimationFrame||g.window.clearTimeout;function c(){return t.apply(g.window,arguments)}g.util.animate=function(o){o||(o={});var r,u=!1,f=function(){var p=g.runningAnimations.indexOf(r);return p>-1&&g.runningAnimations.splice(p,1)[0]};return r=s(i(o),{cancel:function(){return u=!0,f()},currentValue:"startValue"in o?o.startValue:0,completionRate:0,durationRate:0}),g.runningAnimations.push(r),c(function(p){var m,v=p||+new Date,y=o.duration||500,C=v+y,R=o.onChange||l,M=o.abort||l,W=o.onComplete||l,j=o.easing||e,I="startValue"in o&&o.startValue.length>0,T="startValue"in o?o.startValue:0,D="endValue"in o?o.endValue:100,U=o.byValue||(I?T.map(function(L,B){return D[B]-T[B]}):D-T);o.onStart&&o.onStart(),function L(B){var A=(m=B||+new Date)>C?y:m-v,w=A/y,k=I?T.map(function(N,Y){return j(A,T[Y],U[Y],y)}):j(A,T,U,y),V=Math.abs(I?(k[0]-T[0])/U[0]:(k-T)/U);if(r.currentValue=I?k.slice():k,r.completionRate=V,r.durationRate=w,!u){if(!M(k,V,w))return m>C?(r.currentValue=I?D.slice():D,r.completionRate=1,r.durationRate=1,R(I?D.slice():D,1,1),W(D,1,1),void f()):(R(k,V,w),void c(L));f()}}(v)}),r.cancel},g.util.requestAnimFrame=c,g.util.cancelAnimFrame=function(){return a.apply(g.window,arguments)},g.runningAnimations=n}(),function(){function s(i,n,l){var e="rgba("+parseInt(i[0]+l*(n[0]-i[0]),10)+","+parseInt(i[1]+l*(n[1]-i[1]),10)+","+parseInt(i[2]+l*(n[2]-i[2]),10);return(e+=","+(i&&n?parseFloat(i[3]+l*(n[3]-i[3])):1))+")"}g.util.animateColor=function(i,n,l,e){var t=new g.Color(i).getSource(),a=new g.Color(n).getSource(),c=e.onComplete,o=e.onChange;return e=e||{},g.util.animate(g.util.object.extend(e,{duration:l||500,startValue:t,endValue:a,byValue:a,easing:function(r,u,f,p){return s(u,f,e.colorEasing?e.colorEasing(r,p):1-Math.cos(r/p*(Math.PI/2)))},onComplete:function(r,u,f){if(c)return c(s(a,a,0),u,f)},onChange:function(r,u,f){if(o){if(Array.isArray(r))return o(s(r,r,0),u,f);o(r,u,f)}}}))}}(),function(){function s(e,t,a,c){return e<Math.abs(t)?(e=t,c=a/4):c=t===0&&e===0?a/(2*Math.PI)*Math.asin(1):a/(2*Math.PI)*Math.asin(t/e),{a:e,c:t,p:a,s:c}}function i(e,t,a){return e.a*Math.pow(2,10*(t-=1))*Math.sin((t*a-e.s)*(2*Math.PI)/e.p)}function n(e,t,a,c){return a-l(c-e,0,a,c)+t}function l(e,t,a,c){return(e/=c)<1/2.75?a*(7.5625*e*e)+t:e<2/2.75?a*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?a*(7.5625*(e-=2.25/2.75)*e+.9375)+t:a*(7.5625*(e-=2.625/2.75)*e+.984375)+t}g.util.ease={easeInQuad:function(e,t,a,c){return a*(e/=c)*e+t},easeOutQuad:function(e,t,a,c){return-a*(e/=c)*(e-2)+t},easeInOutQuad:function(e,t,a,c){return(e/=c/2)<1?a/2*e*e+t:-a/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,a,c){return a*(e/=c)*e*e+t},easeOutCubic:function(e,t,a,c){return a*((e=e/c-1)*e*e+1)+t},easeInOutCubic:function(e,t,a,c){return(e/=c/2)<1?a/2*e*e*e+t:a/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,a,c){return a*(e/=c)*e*e*e+t},easeOutQuart:function(e,t,a,c){return-a*((e=e/c-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,a,c){return(e/=c/2)<1?a/2*e*e*e*e+t:-a/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,a,c){return a*(e/=c)*e*e*e*e+t},easeOutQuint:function(e,t,a,c){return a*((e=e/c-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,a,c){return(e/=c/2)<1?a/2*e*e*e*e*e+t:a/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,a,c){return-a*Math.cos(e/c*(Math.PI/2))+a+t},easeOutSine:function(e,t,a,c){return a*Math.sin(e/c*(Math.PI/2))+t},easeInOutSine:function(e,t,a,c){return-a/2*(Math.cos(Math.PI*e/c)-1)+t},easeInExpo:function(e,t,a,c){return e===0?t:a*Math.pow(2,10*(e/c-1))+t},easeOutExpo:function(e,t,a,c){return e===c?t+a:a*(1-Math.pow(2,-10*e/c))+t},easeInOutExpo:function(e,t,a,c){return e===0?t:e===c?t+a:(e/=c/2)<1?a/2*Math.pow(2,10*(e-1))+t:a/2*(2-Math.pow(2,-10*--e))+t},easeInCirc:function(e,t,a,c){return-a*(Math.sqrt(1-(e/=c)*e)-1)+t},easeOutCirc:function(e,t,a,c){return a*Math.sqrt(1-(e=e/c-1)*e)+t},easeInOutCirc:function(e,t,a,c){return(e/=c/2)<1?-a/2*(Math.sqrt(1-e*e)-1)+t:a/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,a,c){var o=0;return e===0?t:(e/=c)==1?t+a:(o||(o=.3*c),-i(s(a,a,o,1.70158),e,c)+t)},easeOutElastic:function(e,t,a,c){var o=0;if(e===0)return t;if((e/=c)==1)return t+a;o||(o=.3*c);var r=s(a,a,o,1.70158);return r.a*Math.pow(2,-10*e)*Math.sin((e*c-r.s)*(2*Math.PI)/r.p)+r.c+t},easeInOutElastic:function(e,t,a,c){var o=0;if(e===0)return t;if((e/=c/2)==2)return t+a;o||(o=c*(.3*1.5));var r=s(a,a,o,1.70158);return e<1?-.5*i(r,e,c)+t:r.a*Math.pow(2,-10*(e-=1))*Math.sin((e*c-r.s)*(2*Math.PI)/r.p)*.5+r.c+t},easeInBack:function(e,t,a,c,o){return o===void 0&&(o=1.70158),a*(e/=c)*e*((o+1)*e-o)+t},easeOutBack:function(e,t,a,c,o){return o===void 0&&(o=1.70158),a*((e=e/c-1)*e*((o+1)*e+o)+1)+t},easeInOutBack:function(e,t,a,c,o){return o===void 0&&(o=1.70158),(e/=c/2)<1?a/2*(e*e*((1+(o*=1.525))*e-o))+t:a/2*((e-=2)*e*((1+(o*=1.525))*e+o)+2)+t},easeInBounce:n,easeOutBounce:l,easeInOutBounce:function(e,t,a,c){return e<c/2?.5*n(2*e,0,a,c)+t:.5*l(2*e-c,0,a,c)+.5*a+t}}}(),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.util.object.clone,e=i.util.toFixed,t=i.util.parseUnit,a=i.util.multiplyTransformMatrices,c={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},o={stroke:"strokeOpacity",fill:"fillOpacity"},r="font-size",u="clip-path";function f(T){return T in c?c[T]:T}function p(T,D,U,L){var B,A=Array.isArray(D);if(T!=="fill"&&T!=="stroke"||D!=="none"){if(T==="strokeUniform")return D==="non-scaling-stroke";if(T==="strokeDashArray")D=D==="none"?null:D.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(T==="transformMatrix")D=U&&U.transformMatrix?a(U.transformMatrix,i.parseTransformAttribute(D)):i.parseTransformAttribute(D);else if(T==="visible")D=D!=="none"&&D!=="hidden",U&&U.visible===!1&&(D=!1);else if(T==="opacity")D=parseFloat(D),U&&U.opacity!==void 0&&(D*=U.opacity);else if(T==="textAnchor")D=D==="start"?"left":D==="end"?"right":"center";else if(T==="charSpacing")B=t(D,L)/L*1e3;else if(T==="paintFirst"){var w=D.indexOf("fill"),k=D.indexOf("stroke");D="fill",(w>-1&&k>-1&&k<w||w===-1&&k>-1)&&(D="stroke")}else{if(T==="href"||T==="xlink:href"||T==="font")return D;if(T==="imageSmoothing")return D==="optimizeQuality";B=A?D.map(t):t(D,L)}}else D="";return!A&&isNaN(B)?D:B}function m(T){return new RegExp("^("+T.join("|")+")\\b","i")}function v(T,D){var U,L,B,A,w=[];for(B=0,A=D.length;B<A;B++)U=D[B],L=T.getElementsByTagName(U),w=w.concat(Array.prototype.slice.call(L));return w}function y(T,D){var U,L=!0;return(U=C(T,D.pop()))&&D.length&&(L=function(B,A){for(var w,k=!0;B.parentNode&&B.parentNode.nodeType===1&&A.length;)k&&(w=A.pop()),k=C(B=B.parentNode,w);return A.length===0}(T,D)),U&&L&&D.length===0}function C(T,D){var U,L,B=T.nodeName,A=T.getAttribute("class"),w=T.getAttribute("id");if(U=new RegExp("^"+B,"i"),D=D.replace(U,""),w&&D.length&&(U=new RegExp("#"+w+"(?![a-zA-Z\\-]+)","i"),D=D.replace(U,"")),A&&D.length)for(L=(A=A.split(" ")).length;L--;)U=new RegExp("\\."+A[L]+"(?![a-zA-Z\\-]+)","i"),D=D.replace(U,"");return D.length===0}function R(T,D){var U;if(T.getElementById&&(U=T.getElementById(D)),U)return U;var L,B,A,w=T.getElementsByTagName("*");for(B=0,A=w.length;B<A;B++)if(D===(L=w[B]).getAttribute("id"))return L}i.svgValidTagNamesRegEx=m(["path","circle","polygon","polyline","ellipse","rect","line","image","text"]),i.svgViewBoxElementsRegEx=m(["symbol","image","marker","pattern","view","svg"]),i.svgInvalidAncestorsRegEx=m(["pattern","defs","symbol","metadata","clipPath","mask","desc"]),i.svgValidParentsRegEx=m(["symbol","g","a","svg","clipPath","defs"]),i.cssRules={},i.gradientDefs={},i.clipPaths={},i.parseTransformAttribute=function(){function T(k,V,N){k[N]=Math.tan(i.util.degreesToRadians(V[0]))}var D=i.iMatrix,U=i.reNum,L=i.commaWsp,B="(?:(?:(matrix)\\s*\\(\\s*("+U+")"+L+"("+U+")"+L+"("+U+")"+L+"("+U+")"+L+"("+U+")"+L+"("+U+")\\s*\\))|(?:(translate)\\s*\\(\\s*("+U+")(?:"+L+"("+U+"))?\\s*\\))|(?:(scale)\\s*\\(\\s*("+U+")(?:"+L+"("+U+"))?\\s*\\))|(?:(rotate)\\s*\\(\\s*("+U+")(?:"+L+"("+U+")"+L+"("+U+"))?\\s*\\))|(?:(skewX)\\s*\\(\\s*("+U+")\\s*\\))|(?:(skewY)\\s*\\(\\s*("+U+")\\s*\\)))",A=new RegExp("^\\s*(?:(?:"+B+"(?:"+L+"*"+B+")*)?)\\s*$"),w=new RegExp(B,"g");return function(k){var V=D.concat(),N=[];if(!k||k&&!A.test(k))return V;k.replace(w,function(K){var te=new RegExp(B).exec(K).filter(function(Z){return!!Z}),Q=te[1],re=te.slice(2).map(parseFloat);switch(Q){case"translate":(function(Z,oe){Z[4]=oe[0],oe.length===2&&(Z[5]=oe[1])})(V,re);break;case"rotate":re[0]=i.util.degreesToRadians(re[0]),function(Z,oe){var le=i.util.cos(oe[0]),se=i.util.sin(oe[0]),ue=0,ge=0;oe.length===3&&(ue=oe[1],ge=oe[2]),Z[0]=le,Z[1]=se,Z[2]=-se,Z[3]=le,Z[4]=ue-(le*ue-se*ge),Z[5]=ge-(se*ue+le*ge)}(V,re);break;case"scale":(function(Z,oe){var le=oe[0],se=oe.length===2?oe[1]:oe[0];Z[0]=le,Z[3]=se})(V,re);break;case"skewX":T(V,re,2);break;case"skewY":T(V,re,1);break;case"matrix":V=re}N.push(V.concat()),V=D.concat()});for(var Y=N[0];N.length>1;)N.shift(),Y=i.util.multiplyTransformMatrices(Y,N[0]);return Y}}();var M=new RegExp("^\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*,?\\s*("+i.reNum+"+)\\s*$");function W(T){if(!i.svgViewBoxElementsRegEx.test(T.nodeName))return{};var D,U,L,B,A,w,k=T.getAttribute("viewBox"),V=1,N=1,Y=T.getAttribute("width"),K=T.getAttribute("height"),te=T.getAttribute("x")||0,Q=T.getAttribute("y")||0,re=T.getAttribute("preserveAspectRatio")||"",Z=!k||!(k=k.match(M)),oe=!Y||!K||Y==="100%"||K==="100%",le=Z&&oe,se={},ue="",ge=0,Ce=0;if(se.width=0,se.height=0,se.toBeParsed=le,Z&&(te||Q)&&T.parentNode&&T.parentNode.nodeName!=="#document"&&(ue=" translate("+t(te)+" "+t(Q)+") ",A=(T.getAttribute("transform")||"")+ue,T.setAttribute("transform",A),T.removeAttribute("x"),T.removeAttribute("y")),le)return se;if(Z)return se.width=t(Y),se.height=t(K),se;if(D=-parseFloat(k[1]),U=-parseFloat(k[2]),L=parseFloat(k[3]),B=parseFloat(k[4]),se.minX=D,se.minY=U,se.viewBoxWidth=L,se.viewBoxHeight=B,oe?(se.width=L,se.height=B):(se.width=t(Y),se.height=t(K),V=se.width/L,N=se.height/B),(re=i.util.parsePreserveAspectRatioAttribute(re)).alignX!=="none"&&(re.meetOrSlice==="meet"&&(N=V=V>N?N:V),re.meetOrSlice==="slice"&&(N=V=V>N?V:N),ge=se.width-L*V,Ce=se.height-B*V,re.alignX==="Mid"&&(ge/=2),re.alignY==="Mid"&&(Ce/=2),re.alignX==="Min"&&(ge=0),re.alignY==="Min"&&(Ce=0)),V===1&&N===1&&D===0&&U===0&&te===0&&Q===0)return se;if((te||Q)&&T.parentNode.nodeName!=="#document"&&(ue=" translate("+t(te)+" "+t(Q)+") "),A=ue+" matrix("+V+" 0 0 "+N+" "+(D*V+ge)+" "+(U*N+Ce)+") ",T.nodeName==="svg"){for(w=T.ownerDocument.createElementNS(i.svgNS,"g");T.firstChild;)w.appendChild(T.firstChild);T.appendChild(w)}else(w=T).removeAttribute("x"),w.removeAttribute("y"),A=w.getAttribute("transform")+A;return w.setAttribute("transform",A),se}function j(T,D){var U="xlink:href",L=R(T,D.getAttribute(U).slice(1));if(L&&L.getAttribute(U)&&j(T,L),["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"].forEach(function(A){L&&!D.hasAttribute(A)&&L.hasAttribute(A)&&D.setAttribute(A,L.getAttribute(A))}),!D.children.length)for(var B=L.cloneNode(!0);B.firstChild;)D.appendChild(B.firstChild);D.removeAttribute(U)}i.parseSVGDocument=function(T,D,U,L){if(T){(function(te){for(var Q=v(te,["use","svg:use"]),re=0;Q.length&&re<Q.length;){var Z=Q[re],oe=Z.getAttribute("xlink:href")||Z.getAttribute("href");if(oe===null)return;var le,se,ue,ge,Ce=oe.slice(1),xe=Z.getAttribute("x")||0,Le=Z.getAttribute("y")||0,_e=R(te,Ce).cloneNode(!0),Oe=(_e.getAttribute("transform")||"")+" translate("+xe+", "+Le+")",Ge=Q.length,Pe=i.svgNS;if(W(_e),/^svg$/i.test(_e.nodeName)){var ke=_e.ownerDocument.createElementNS(Pe,"g");for(se=0,ge=(ue=_e.attributes).length;se<ge;se++)le=ue.item(se),ke.setAttributeNS(Pe,le.nodeName,le.nodeValue);for(;_e.firstChild;)ke.appendChild(_e.firstChild);_e=ke}for(se=0,ge=(ue=Z.attributes).length;se<ge;se++)(le=ue.item(se)).nodeName!=="x"&&le.nodeName!=="y"&&le.nodeName!=="xlink:href"&&le.nodeName!=="href"&&(le.nodeName==="transform"?Oe=le.nodeValue+" "+Oe:_e.setAttribute(le.nodeName,le.nodeValue));_e.setAttribute("transform",Oe),_e.setAttribute("instantiated_by_use","1"),_e.removeAttribute("id"),Z.parentNode.replaceChild(_e,Z),Q.length===Ge&&re++}})(T);var B,A,w=i.Object.__uid++,k=W(T),V=i.util.toArray(T.getElementsByTagName("*"));if(k.crossOrigin=L&&L.crossOrigin,k.svgUid=w,V.length===0&&i.isLikelyNode){var N=[];for(B=0,A=(V=T.selectNodes('//*[name(.)!="svg"]')).length;B<A;B++)N[B]=V[B];V=N}var Y=V.filter(function(te){return W(te),i.svgValidTagNamesRegEx.test(te.nodeName.replace("svg:",""))&&!function(Q,re){for(;Q&&(Q=Q.parentNode);)if(Q.nodeName&&re.test(Q.nodeName.replace("svg:",""))&&!Q.getAttribute("instantiated_by_use"))return!0;return!1}(te,i.svgInvalidAncestorsRegEx)});if(!Y||Y&&!Y.length)D&&D([],{});else{var K={};V.filter(function(te){return te.nodeName.replace("svg:","")==="clipPath"}).forEach(function(te){var Q=te.getAttribute("id");K[Q]=i.util.toArray(te.getElementsByTagName("*")).filter(function(re){return i.svgValidTagNamesRegEx.test(re.nodeName.replace("svg:",""))})}),i.gradientDefs[w]=i.getGradientDefs(T),i.cssRules[w]=i.getCSSRules(T),i.clipPaths[w]=K,i.parseElements(Y,function(te,Q){D&&(D(te,k,Q,V),delete i.gradientDefs[w],delete i.cssRules[w],delete i.clipPaths[w])},l(k),U,L)}}};var I=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+i.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+i.reNum+"))?\\s+(.*)");n(i,{parseFontDeclaration:function(T,D){var U=T.match(I);if(U){var L=U[1],B=U[3],A=U[4],w=U[5],k=U[6];L&&(D.fontStyle=L),B&&(D.fontWeight=isNaN(parseFloat(B))?B:parseFloat(B)),A&&(D.fontSize=t(A)),k&&(D.fontFamily=k),w&&(D.lineHeight=w==="normal"?1:w)}},getGradientDefs:function(T){var D,U=v(T,["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"]),L=0,B={};for(L=U.length;L--;)(D=U[L]).getAttribute("xlink:href")&&j(T,D),B[D.getAttribute("id")]=D;return B},parseAttributes:function(T,D,U){if(T){var L,B,A,w={};U===void 0&&(U=T.getAttribute("svgUid")),T.parentNode&&i.svgValidParentsRegEx.test(T.parentNode.nodeName)&&(w=i.parseAttributes(T.parentNode,D,U));var k=D.reduce(function(re,Z){return(L=T.getAttribute(Z))&&(re[Z]=L),re},{}),V=n(function(re,Z){var oe={};for(var le in i.cssRules[Z])if(y(re,le.split(" ")))for(var se in i.cssRules[Z][le])oe[se]=i.cssRules[Z][le][se];return oe}(T,U),i.parseStyleAttribute(T));k=n(k,V),V[u]&&T.setAttribute(u,V[u]),B=A=w.fontSize||i.Text.DEFAULT_SVG_FONT_SIZE,k[r]&&(k[r]=B=t(k[r],A));var N,Y,K={};for(var te in k)Y=p(N=f(te),k[te],w,B),K[N]=Y;K&&K.font&&i.parseFontDeclaration(K.font,K);var Q=n(w,K);return i.svgValidParentsRegEx.test(T.nodeName)?Q:function(re){for(var Z in o)if(re[o[Z]]!==void 0&&re[Z]!==""){if(re[Z]===void 0){if(!i.Object.prototype[Z])continue;re[Z]=i.Object.prototype[Z]}if(re[Z].indexOf("url(")!==0){var oe=new i.Color(re[Z]);re[Z]=oe.setAlpha(e(oe.getAlpha()*re[o[Z]],2)).toRgba()}}return re}(Q)}},parseElements:function(T,D,U,L,B){new i.ElementsParser(T,D,U,L,B).parse()},parseStyleAttribute:function(T){var D={},U=T.getAttribute("style");return U&&(typeof U=="string"?function(L,B){var A,w;L.replace(/;\s*$/,"").split(";").forEach(function(k){var V=k.split(":");A=V[0].trim().toLowerCase(),w=V[1].trim(),B[A]=w})}(U,D):function(L,B){var A,w;for(var k in L)L[k]!==void 0&&(A=k.toLowerCase(),w=L[k],B[A]=w)}(U,D)),D},parsePointsAttribute:function(T){if(!T)return null;var D,U,L=[];for(D=0,U=(T=(T=T.replace(/,/g," ").trim()).split(/\s+/)).length;D<U;D+=2)L.push({x:parseFloat(T[D]),y:parseFloat(T[D+1])});return L},getCSSRules:function(T){var D,U,L=T.getElementsByTagName("style"),B={};for(D=0,U=L.length;D<U;D++){var A=L[D].textContent;(A=A.replace(/\/\*[\s\S]*?\*\//g,"")).trim()!==""&&A.split("}").filter(function(w){return w.trim()}).forEach(function(w){var k=w.split("{"),V={},N=k[1].trim().split(";").filter(function(Q){return Q.trim()});for(D=0,U=N.length;D<U;D++){var Y=N[D].split(":"),K=Y[0].trim(),te=Y[1].trim();V[K]=te}(w=k[0].trim()).split(",").forEach(function(Q){(Q=Q.replace(/^svg/i,"").trim())!==""&&(B[Q]?i.util.object.extend(B[Q],V):B[Q]=i.util.object.clone(V))})})}return B},loadSVGFromURL:function(T,D,U,L){T=T.replace(/^\n\s*/,"").trim(),new i.util.request(T,{method:"get",onComplete:function(B){var A=B.responseXML;if(!A||!A.documentElement)return D&&D(null),!1;i.parseSVGDocument(A.documentElement,function(w,k,V,N){D&&D(w,k,V,N)},U,L)}})},loadSVGFromString:function(T,D,U,L){var B=new i.window.DOMParser().parseFromString(T.trim(),"text/xml");i.parseSVGDocument(B.documentElement,function(A,w,k,V){D(A,w,k,V)},U,L)}})}(h),g.ElementsParser=function(s,i,n,l,e,t){this.elements=s,this.callback=i,this.options=n,this.reviver=l,this.svgUid=n&&n.svgUid||0,this.parsingOptions=e,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=t},(H=g.ElementsParser.prototype).parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},H.createObjects=function(){var s=this;this.elements.forEach(function(i,n){i.setAttribute("svgUid",s.svgUid),s.createObject(i,n)})},H.findTag=function(s){return g[g.util.string.capitalize(s.tagName.replace("svg:",""))]},H.createObject=function(s,i){var n=this.findTag(s);if(n&&n.fromElement)try{n.fromElement(s,this.createCallback(i,s),this.options)}catch(l){g.log(l)}else this.checkIfDone()},H.createCallback=function(s,i){var n=this;return function(l){var e;n.resolveGradient(l,i,"fill"),n.resolveGradient(l,i,"stroke"),l instanceof g.Image&&l._originalElement&&(e=l.parsePreserveAspectRatioAttribute(i)),l._removeTransformMatrix(e),n.resolveClipPath(l,i),n.reviver&&n.reviver(i,l),n.instances[s]=l,n.checkIfDone()}},H.extractPropertyDefinition=function(s,i,n){var l=s[i],e=this.regexUrl;if(e.test(l)){e.lastIndex=0;var t=e.exec(l)[1];return e.lastIndex=0,g[n][this.svgUid][t]}},H.resolveGradient=function(s,i,n){var l=this.extractPropertyDefinition(s,n,"gradientDefs");if(l){var e=i.getAttribute(n+"-opacity"),t=g.Gradient.fromElement(l,s,e,this.options);s.set(n,t)}},H.createClipPathCallback=function(s,i){return function(n){n._removeTransformMatrix(),n.fillRule=n.clipRule,i.push(n)}},H.resolveClipPath=function(s,i){var n,l,e,t,a=this.extractPropertyDefinition(s,"clipPath","clipPaths");if(a){e=[],l=g.util.invertTransform(s.calcTransformMatrix());for(var c=a[0].parentNode,o=i;o.parentNode&&o.getAttribute("clip-path")!==s.clipPath;)o=o.parentNode;o.parentNode.appendChild(c);for(var r=0;r<a.length;r++)n=a[r],this.findTag(n).fromElement(n,this.createClipPathCallback(s,e),this.options);a=e.length===1?e[0]:new g.Group(e),t=g.util.multiplyTransformMatrices(l,a.calcTransformMatrix()),a.clipPath&&this.resolveClipPath(a,o);var u=g.util.qrDecompose(t);a.flipX=!1,a.flipY=!1,a.set("scaleX",u.scaleX),a.set("scaleY",u.scaleY),a.angle=u.angle,a.skewX=u.skewX,a.skewY=0,a.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),s.clipPath=a}else delete s.clipPath},H.checkIfDone=function(){--this.numElements==0&&(this.instances=this.instances.filter(function(s){return s!=null}),this.callback(this.instances,this.elements))},function(s){var i=s.fabric||(s.fabric={});function n(l,e){this.x=l,this.y=e}i.Point?i.warn("fabric.Point is already defined"):(i.Point=n,n.prototype={type:"point",constructor:n,add:function(l){return new n(this.x+l.x,this.y+l.y)},addEquals:function(l){return this.x+=l.x,this.y+=l.y,this},scalarAdd:function(l){return new n(this.x+l,this.y+l)},scalarAddEquals:function(l){return this.x+=l,this.y+=l,this},subtract:function(l){return new n(this.x-l.x,this.y-l.y)},subtractEquals:function(l){return this.x-=l.x,this.y-=l.y,this},scalarSubtract:function(l){return new n(this.x-l,this.y-l)},scalarSubtractEquals:function(l){return this.x-=l,this.y-=l,this},multiply:function(l){return new n(this.x*l,this.y*l)},multiplyEquals:function(l){return this.x*=l,this.y*=l,this},divide:function(l){return new n(this.x/l,this.y/l)},divideEquals:function(l){return this.x/=l,this.y/=l,this},eq:function(l){return this.x===l.x&&this.y===l.y},lt:function(l){return this.x<l.x&&this.y<l.y},lte:function(l){return this.x<=l.x&&this.y<=l.y},gt:function(l){return this.x>l.x&&this.y>l.y},gte:function(l){return this.x>=l.x&&this.y>=l.y},lerp:function(l,e){return e===void 0&&(e=.5),e=Math.max(Math.min(1,e),0),new n(this.x+(l.x-this.x)*e,this.y+(l.y-this.y)*e)},distanceFrom:function(l){var e=this.x-l.x,t=this.y-l.y;return Math.sqrt(e*e+t*t)},midPointFrom:function(l){return this.lerp(l)},min:function(l){return new n(Math.min(this.x,l.x),Math.min(this.y,l.y))},max:function(l){return new n(Math.max(this.x,l.x),Math.max(this.y,l.y))},toString:function(){return this.x+","+this.y},setXY:function(l,e){return this.x=l,this.y=e,this},setX:function(l){return this.x=l,this},setY:function(l){return this.y=l,this},setFromPoint:function(l){return this.x=l.x,this.y=l.y,this},swap:function(l){var e=this.x,t=this.y;this.x=l.x,this.y=l.y,l.x=e,l.y=t},clone:function(){return new n(this.x,this.y)}})}(h),function(s){var i=s.fabric||(s.fabric={});function n(l){this.status=l,this.points=[]}i.Intersection?i.warn("fabric.Intersection is already defined"):(i.Intersection=n,i.Intersection.prototype={constructor:n,appendPoint:function(l){return this.points.push(l),this},appendPoints:function(l){return this.points=this.points.concat(l),this}},i.Intersection.intersectLineLine=function(l,e,t,a){var c,o=(a.x-t.x)*(l.y-t.y)-(a.y-t.y)*(l.x-t.x),r=(e.x-l.x)*(l.y-t.y)-(e.y-l.y)*(l.x-t.x),u=(a.y-t.y)*(e.x-l.x)-(a.x-t.x)*(e.y-l.y);if(u!==0){var f=o/u,p=r/u;0<=f&&f<=1&&0<=p&&p<=1?(c=new n("Intersection")).appendPoint(new i.Point(l.x+f*(e.x-l.x),l.y+f*(e.y-l.y))):c=new n}else c=new n(o===0||r===0?"Coincident":"Parallel");return c},i.Intersection.intersectLinePolygon=function(l,e,t){var a,c,o,r,u=new n,f=t.length;for(r=0;r<f;r++)a=t[r],c=t[(r+1)%f],o=n.intersectLineLine(l,e,a,c),u.appendPoints(o.points);return u.points.length>0&&(u.status="Intersection"),u},i.Intersection.intersectPolygonPolygon=function(l,e){var t,a=new n,c=l.length;for(t=0;t<c;t++){var o=l[t],r=l[(t+1)%c],u=n.intersectLinePolygon(o,r,e);a.appendPoints(u.points)}return a.points.length>0&&(a.status="Intersection"),a},i.Intersection.intersectPolygonRectangle=function(l,e,t){var a=e.min(t),c=e.max(t),o=new i.Point(c.x,a.y),r=new i.Point(a.x,c.y),u=n.intersectLinePolygon(a,o,l),f=n.intersectLinePolygon(o,c,l),p=n.intersectLinePolygon(c,r,l),m=n.intersectLinePolygon(r,a,l),v=new n;return v.appendPoints(u.points),v.appendPoints(f.points),v.appendPoints(p.points),v.appendPoints(m.points),v.points.length>0&&(v.status="Intersection"),v})}(h),function(s){var i=s.fabric||(s.fabric={});function n(e){e?this._tryParsingColor(e):this.setSource([0,0,0,1])}function l(e,t,a){return a<0&&(a+=1),a>1&&(a-=1),a<1/6?e+6*(t-e)*a:a<.5?t:a<2/3?e+(t-e)*(2/3-a)*6:e}i.Color?i.warn("fabric.Color is already defined."):(i.Color=n,i.Color.prototype={_tryParsingColor:function(e){var t;e in n.colorNameMap&&(e=n.colorNameMap[e]),e==="transparent"&&(t=[255,255,255,0]),t||(t=n.sourceFromHex(e)),t||(t=n.sourceFromRgb(e)),t||(t=n.sourceFromHsl(e)),t||(t=[0,0,0,1]),t&&this.setSource(t)},_rgbToHsl:function(e,t,a){e/=255,t/=255,a/=255;var c,o,r,u=i.util.array.max([e,t,a]),f=i.util.array.min([e,t,a]);if(r=(u+f)/2,u===f)c=o=0;else{var p=u-f;switch(o=r>.5?p/(2-u-f):p/(u+f),u){case e:c=(t-a)/p+(t<a?6:0);break;case t:c=(a-e)/p+2;break;case a:c=(e-t)/p+4}c/=6}return[Math.round(360*c),Math.round(100*o),Math.round(100*r)]},getSource:function(){return this._source},setSource:function(e){this._source=e},toRgb:function(){var e=this.getSource();return"rgb("+e[0]+","+e[1]+","+e[2]+")"},toRgba:function(){var e=this.getSource();return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},toHsl:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsl("+t[0]+","+t[1]+"%,"+t[2]+"%)"},toHsla:function(){var e=this.getSource(),t=this._rgbToHsl(e[0],e[1],e[2]);return"hsla("+t[0]+","+t[1]+"%,"+t[2]+"%,"+e[3]+")"},toHex:function(){var e,t,a,c=this.getSource();return e=(e=c[0].toString(16)).length===1?"0"+e:e,t=(t=c[1].toString(16)).length===1?"0"+t:t,a=(a=c[2].toString(16)).length===1?"0"+a:a,e.toUpperCase()+t.toUpperCase()+a.toUpperCase()},toHexa:function(){var e,t=this.getSource();return e=(e=(e=Math.round(255*t[3])).toString(16)).length===1?"0"+e:e,this.toHex()+e.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(e){var t=this.getSource();return t[3]=e,this.setSource(t),this},toGrayscale:function(){var e=this.getSource(),t=parseInt((.3*e[0]+.59*e[1]+.11*e[2]).toFixed(0),10),a=e[3];return this.setSource([t,t,t,a]),this},toBlackWhite:function(e){var t=this.getSource(),a=(.3*t[0]+.59*t[1]+.11*t[2]).toFixed(0),c=t[3];return e=e||127,a=Number(a)<Number(e)?0:255,this.setSource([a,a,a,c]),this},overlayWith:function(e){e instanceof n||(e=new n(e));var t,a=[],c=this.getAlpha(),o=this.getSource(),r=e.getSource();for(t=0;t<3;t++)a.push(Math.round(.5*o[t]+.5*r[t]));return a[3]=c,this.setSource(a),this}},i.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,i.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,i.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,i.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},i.Color.fromRgb=function(e){return n.fromSource(n.sourceFromRgb(e))},i.Color.sourceFromRgb=function(e){var t=e.match(n.reRGBa);if(t){var a=parseInt(t[1],10)/(/%$/.test(t[1])?100:1)*(/%$/.test(t[1])?255:1),c=parseInt(t[2],10)/(/%$/.test(t[2])?100:1)*(/%$/.test(t[2])?255:1),o=parseInt(t[3],10)/(/%$/.test(t[3])?100:1)*(/%$/.test(t[3])?255:1);return[parseInt(a,10),parseInt(c,10),parseInt(o,10),t[4]?parseFloat(t[4]):1]}},i.Color.fromRgba=n.fromRgb,i.Color.fromHsl=function(e){return n.fromSource(n.sourceFromHsl(e))},i.Color.sourceFromHsl=function(e){var t=e.match(n.reHSLa);if(t){var a,c,o,r=(parseFloat(t[1])%360+360)%360/360,u=parseFloat(t[2])/(/%$/.test(t[2])?100:1),f=parseFloat(t[3])/(/%$/.test(t[3])?100:1);if(u===0)a=c=o=f;else{var p=f<=.5?f*(u+1):f+u-f*u,m=2*f-p;a=l(m,p,r+1/3),c=l(m,p,r),o=l(m,p,r-1/3)}return[Math.round(255*a),Math.round(255*c),Math.round(255*o),t[4]?parseFloat(t[4]):1]}},i.Color.fromHsla=n.fromHsl,i.Color.fromHex=function(e){return n.fromSource(n.sourceFromHex(e))},i.Color.sourceFromHex=function(e){if(e.match(n.reHex)){var t=e.slice(e.indexOf("#")+1),a=t.length===3||t.length===4,c=t.length===8||t.length===4,o=a?t.charAt(0)+t.charAt(0):t.substring(0,2),r=a?t.charAt(1)+t.charAt(1):t.substring(2,4),u=a?t.charAt(2)+t.charAt(2):t.substring(4,6),f=c?a?t.charAt(3)+t.charAt(3):t.substring(6,8):"FF";return[parseInt(o,16),parseInt(r,16),parseInt(u,16),parseFloat((parseInt(f,16)/255).toFixed(2))]}},i.Color.fromSource=function(e){var t=new n;return t.setSource(e),t})}(h),function(s){var i=s.fabric||(s.fabric={}),n=["e","se","s","sw","w","nw","n","ne","e"],l=["ns","nesw","ew","nwse"],e={},t="left",a="top",c="right",o="bottom",r="center",u={top:o,bottom:a,left:c,right:t,center:r},f=i.util.radiansToDegrees,p=Math.sign||function(A){return(A>0)-(A<0)||+A};function m(A,w){var k=A.angle+f(Math.atan2(w.y,w.x))+360;return Math.round(k%360/45)}function v(A,w){var k=w.transform.target,V=k.canvas,N=i.util.object.clone(w);N.target=k,V&&V.fire("object:"+A,N),k.fire(A,w)}function y(A,w){var k=w.canvas,V=A[k.uniScaleKey];return k.uniformScaling&&!V||!k.uniformScaling&&V}function C(A){return A.originX===r&&A.originY===r}function R(A,w,k){var V=A.lockScalingX,N=A.lockScalingY;return!((!V||!N)&&(w||!V&&!N||!k)&&(!V||w!=="x")&&(!N||w!=="y"))}function M(A,w,k,V){return{e:A,transform:w,pointer:{x:k,y:V}}}function W(A){return function(w,k,V,N){var Y=k.target,K=Y.getCenterPoint(),te=Y.translateToOriginPoint(K,k.originX,k.originY),Q=A(w,k,V,N);return Y.setPositionByOrigin(te,k.originX,k.originY),Q}}function j(A,w){return function(k,V,N,Y){var K=w(k,V,N,Y);return K&&v(A,M(k,V,N,Y)),K}}function I(A,w,k,V,N){var Y=A.target,K=Y.controls[A.corner],te=Y.canvas.getZoom(),Q=Y.padding/te,re=Y.toLocalPoint(new i.Point(V,N),w,k);return re.x>=Q&&(re.x-=Q),re.x<=-Q&&(re.x+=Q),re.y>=Q&&(re.y-=Q),re.y<=Q&&(re.y+=Q),re.x-=K.offsetX,re.y-=K.offsetY,re}function T(A){return A.flipX!==A.flipY}function D(A,w,k,V,N){if(A[w]!==0){var Y=N/A._getTransformedDimensions()[V]*A[k];A.set(k,Y)}}function U(A,w,k,V){var N,Y=w.target,K=Y._getTransformedDimensions(0,Y.skewY),te=I(w,w.originX,w.originY,k,V),Q=Math.abs(2*te.x)-K.x,re=Y.skewX;Q<2?N=0:(N=f(Math.atan2(Q/Y.scaleX,K.y/Y.scaleY)),w.originX===t&&w.originY===o&&(N=-N),w.originX===c&&w.originY===a&&(N=-N),T(Y)&&(N=-N));var Z=re!==N;if(Z){var oe=Y._getTransformedDimensions().y;Y.set("skewX",N),D(Y,"skewY","scaleY","y",oe)}return Z}function L(A,w,k,V){var N,Y=w.target,K=Y._getTransformedDimensions(Y.skewX,0),te=I(w,w.originX,w.originY,k,V),Q=Math.abs(2*te.y)-K.y,re=Y.skewY;Q<2?N=0:(N=f(Math.atan2(Q/Y.scaleY,K.x/Y.scaleX)),w.originX===t&&w.originY===o&&(N=-N),w.originX===c&&w.originY===a&&(N=-N),T(Y)&&(N=-N));var Z=re!==N;if(Z){var oe=Y._getTransformedDimensions().x;Y.set("skewY",N),D(Y,"skewX","scaleX","x",oe)}return Z}function B(A,w,k,V,N){N=N||{};var Y,K,te,Q,re,Z,oe=w.target,le=oe.lockScalingX,se=oe.lockScalingY,ue=N.by,ge=y(A,oe),Ce=R(oe,ue,ge),xe=w.gestureScale;if(Ce)return!1;if(xe)K=w.scaleX*xe,te=w.scaleY*xe;else{if(Y=I(w,w.originX,w.originY,k,V),re=ue!=="y"?p(Y.x):1,Z=ue!=="x"?p(Y.y):1,w.signX||(w.signX=re),w.signY||(w.signY=Z),oe.lockScalingFlip&&(w.signX!==re||w.signY!==Z))return!1;if(Q=oe._getTransformedDimensions(),ge&&!ue){var Le=Math.abs(Y.x)+Math.abs(Y.y),_e=w.original,Oe=Le/(Math.abs(Q.x*_e.scaleX/oe.scaleX)+Math.abs(Q.y*_e.scaleY/oe.scaleY));K=_e.scaleX*Oe,te=_e.scaleY*Oe}else K=Math.abs(Y.x*oe.scaleX/Q.x),te=Math.abs(Y.y*oe.scaleY/Q.y);C(w)&&(K*=2,te*=2),w.signX!==re&&ue!=="y"&&(w.originX=u[w.originX],K*=-1,w.signX=re),w.signY!==Z&&ue!=="x"&&(w.originY=u[w.originY],te*=-1,w.signY=Z)}var Ge=oe.scaleX,Pe=oe.scaleY;return ue?(ue==="x"&&oe.set("scaleX",K),ue==="y"&&oe.set("scaleY",te)):(!le&&oe.set("scaleX",K),!se&&oe.set("scaleY",te)),Ge!==oe.scaleX||Pe!==oe.scaleY}e.scaleCursorStyleHandler=function(A,w,k){var V=y(A,k),N="";if(w.x!==0&&w.y===0?N="x":w.x===0&&w.y!==0&&(N="y"),R(k,N,V))return"not-allowed";var Y=m(k,w);return n[Y]+"-resize"},e.skewCursorStyleHandler=function(A,w,k){var V="not-allowed";if(w.x!==0&&k.lockSkewingY||w.y!==0&&k.lockSkewingX)return V;var N=m(k,w)%4;return l[N]+"-resize"},e.scaleSkewCursorStyleHandler=function(A,w,k){return A[k.canvas.altActionKey]?e.skewCursorStyleHandler(A,w,k):e.scaleCursorStyleHandler(A,w,k)},e.rotationWithSnapping=j("rotating",W(function(A,w,k,V){var N=w,Y=N.target,K=Y.translateToOriginPoint(Y.getCenterPoint(),N.originX,N.originY);if(Y.lockRotation)return!1;var te,Q=Math.atan2(N.ey-K.y,N.ex-K.x),re=Math.atan2(V-K.y,k-K.x),Z=f(re-Q+N.theta);if(Y.snapAngle>0){var oe=Y.snapAngle,le=Y.snapThreshold||oe,se=Math.ceil(Z/oe)*oe,ue=Math.floor(Z/oe)*oe;Math.abs(Z-ue)<le?Z=ue:Math.abs(Z-se)<le&&(Z=se)}return Z<0&&(Z=360+Z),Z%=360,te=Y.angle!==Z,Y.angle=Z,te})),e.scalingEqually=j("scaling",W(function(A,w,k,V){return B(A,w,k,V)})),e.scalingX=j("scaling",W(function(A,w,k,V){return B(A,w,k,V,{by:"x"})})),e.scalingY=j("scaling",W(function(A,w,k,V){return B(A,w,k,V,{by:"y"})})),e.scalingYOrSkewingX=function(A,w,k,V){return A[w.target.canvas.altActionKey]?e.skewHandlerX(A,w,k,V):e.scalingY(A,w,k,V)},e.scalingXOrSkewingY=function(A,w,k,V){return A[w.target.canvas.altActionKey]?e.skewHandlerY(A,w,k,V):e.scalingX(A,w,k,V)},e.changeWidth=j("resizing",W(function(A,w,k,V){var N=w.target,Y=I(w,w.originX,w.originY,k,V),K=N.strokeWidth/(N.strokeUniform?N.scaleX:1),te=C(w)?2:1,Q=N.width,re=Math.abs(Y.x*te/N.scaleX)-K;return N.set("width",Math.max(re,0)),Q!==re})),e.skewHandlerX=function(A,w,k,V){var N,Y=w.target,K=Y.skewX,te=w.originY;return!Y.lockSkewingX&&(K===0?N=I(w,r,r,k,V).x>0?t:c:(K>0&&(N=te===a?t:c),K<0&&(N=te===a?c:t),T(Y)&&(N=N===t?c:t)),w.originX=N,j("skewing",W(U))(A,w,k,V))},e.skewHandlerY=function(A,w,k,V){var N,Y=w.target,K=Y.skewY,te=w.originX;return!Y.lockSkewingY&&(K===0?N=I(w,r,r,k,V).y>0?a:o:(K>0&&(N=te===t?a:o),K<0&&(N=te===t?o:a),T(Y)&&(N=N===a?o:a)),w.originY=N,j("skewing",W(L))(A,w,k,V))},e.dragHandler=function(A,w,k,V){var N=w.target,Y=k-w.offsetX,K=V-w.offsetY,te=!N.get("lockMovementX")&&N.left!==Y,Q=!N.get("lockMovementY")&&N.top!==K;return te&&N.set("left",Y),Q&&N.set("top",K),(te||Q)&&v("moving",M(A,w,k,V)),te||Q},e.scaleOrSkewActionName=function(A,w,k){var V=A[k.canvas.altActionKey];return w.x===0?V?"skewX":"scaleY":w.y===0?V?"skewY":"scaleX":void 0},e.rotationStyleHandler=function(A,w,k){return k.lockRotation?"not-allowed":w.cursorStyle},e.fireEvent=v,e.wrapWithFixedAnchor=W,e.wrapWithFireEvent=j,e.getLocalPoint=I,i.controlsUtils=e}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.degreesToRadians,l=i.controlsUtils;l.renderCircleControl=function(e,t,a,c,o){c=c||{};var r,u=this.sizeX||c.cornerSize||o.cornerSize,f=this.sizeY||c.cornerSize||o.cornerSize,p=c.transparentCorners!==void 0?c.transparentCorners:o.transparentCorners,m=p?"stroke":"fill",v=!p&&(c.cornerStrokeColor||o.cornerStrokeColor),y=t,C=a;e.save(),e.fillStyle=c.cornerColor||o.cornerColor,e.strokeStyle=c.cornerStrokeColor||o.cornerStrokeColor,u>f?(r=u,e.scale(1,f/u),C=a*u/f):f>u?(r=f,e.scale(u/f,1),y=t*f/u):r=u,e.lineWidth=1,e.beginPath(),e.arc(y,C,r/2,0,2*Math.PI,!1),e[m](),v&&e.stroke(),e.restore()},l.renderSquareControl=function(e,t,a,c,o){c=c||{};var r=this.sizeX||c.cornerSize||o.cornerSize,u=this.sizeY||c.cornerSize||o.cornerSize,f=c.transparentCorners!==void 0?c.transparentCorners:o.transparentCorners,p=f?"stroke":"fill",m=!f&&(c.cornerStrokeColor||o.cornerStrokeColor),v=r/2,y=u/2;e.save(),e.fillStyle=c.cornerColor||o.cornerColor,e.strokeStyle=c.cornerStrokeColor||o.cornerStrokeColor,e.lineWidth=1,e.translate(t,a),e.rotate(n(o.angle)),e[p+"Rect"](-v,-y,r,u),m&&e.strokeRect(-v,-y,r,u),e.restore()}}(h),function(s){var i=s.fabric||(s.fabric={});i.Control=function(n){for(var l in n)this[l]=n[l]},i.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(n,l){return l.cursorStyle},getActionName:function(n,l){return l.actionName},getVisibility:function(n,l){var e=n._controlsVisibility;return e&&e[l]!==void 0?e[l]:this.visible},setVisibility:function(n){this.visible=n},positionHandler:function(n,l){return i.util.transformPoint({x:this.x*n.x+this.offsetX,y:this.y*n.y+this.offsetY},l)},calcCornerCoords:function(n,l,e,t,a){var c,o,r,u,f=a?this.touchSizeX:this.sizeX,p=a?this.touchSizeY:this.sizeY;if(f&&p&&f!==p){var m=Math.atan2(p,f),v=Math.sqrt(f*f+p*p)/2,y=m-i.util.degreesToRadians(n),C=Math.PI/2-m-i.util.degreesToRadians(n);c=v*i.util.cos(y),o=v*i.util.sin(y),r=v*i.util.cos(C),u=v*i.util.sin(C)}else v=.7071067812*(f&&p?f:l),y=i.util.degreesToRadians(45-n),c=r=v*i.util.cos(y),o=u=v*i.util.sin(y);return{tl:{x:e-u,y:t-r},tr:{x:e+c,y:t-o},bl:{x:e-c,y:t+o},br:{x:e+u,y:t+r}}},render:function(n,l,e,t,a){((t=t||{}).cornerStyle||a.cornerStyle)==="circle"?i.controlsUtils.renderCircleControl.call(this,n,l,e,t,a):i.controlsUtils.renderSquareControl.call(this,n,l,e,t,a)}}}(h),function(){function s(n,l){var e,t,a,c,o=n.getAttribute("style"),r=n.getAttribute("offset")||0;if(r=(r=parseFloat(r)/(/%$/.test(r)?100:1))<0?0:r>1?1:r,o){var u=o.split(/\s*;\s*/);for(u[u.length-1]===""&&u.pop(),c=u.length;c--;){var f=u[c].split(/\s*:\s*/),p=f[0].trim(),m=f[1].trim();p==="stop-color"?e=m:p==="stop-opacity"&&(a=m)}}return e||(e=n.getAttribute("stop-color")||"rgb(0,0,0)"),a||(a=n.getAttribute("stop-opacity")),t=(e=new g.Color(e)).getAlpha(),a=isNaN(parseFloat(a))?1:parseFloat(a),a*=t*l,{offset:r,color:e.toRgb(),opacity:a}}var i=g.util.object.clone;g.Gradient=g.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(n){n||(n={}),n.coords||(n.coords={});var l,e=this;Object.keys(n).forEach(function(t){e[t]=n[t]}),this.id?this.id+="_"+g.Object.__uid++:this.id=g.Object.__uid++,l={x1:n.coords.x1||0,y1:n.coords.y1||0,x2:n.coords.x2||0,y2:n.coords.y2||0},this.type==="radial"&&(l.r1=n.coords.r1||0,l.r2=n.coords.r2||0),this.coords=l,this.colorStops=n.colorStops.slice()},addColorStop:function(n){for(var l in n){var e=new g.Color(n[l]);this.colorStops.push({offset:parseFloat(l),color:e.toRgb(),opacity:e.getAlpha()})}return this},toObject:function(n){var l={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return g.util.populateWithProperties(this,l,n),l},toSVG:function(n,l){var e,t,a,c,o=i(this.coords,!0),r=(l=l||{},i(this.colorStops,!0)),u=o.r1>o.r2,f=this.gradientTransform?this.gradientTransform.concat():g.iMatrix.concat(),p=-this.offsetX,m=-this.offsetY,v=!!l.additionalTransform,y=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(r.sort(function(W,j){return W.offset-j.offset}),y==="objectBoundingBox"?(p/=n.width,m/=n.height):(p+=n.width/2,m+=n.height/2),n.type==="path"&&this.gradientUnits!=="percentage"&&(p-=n.pathOffset.x,m-=n.pathOffset.y),f[4]-=p,f[5]-=m,c='id="SVGID_'+this.id+'" gradientUnits="'+y+'"',c+=' gradientTransform="'+(v?l.additionalTransform+" ":"")+g.util.matrixToSVG(f)+'" ',this.type==="linear"?a=["<linearGradient ",c,' x1="',o.x1,'" y1="',o.y1,'" x2="',o.x2,'" y2="',o.y2,`">
`]:this.type==="radial"&&(a=["<radialGradient ",c,' cx="',u?o.x1:o.x2,'" cy="',u?o.y1:o.y2,'" r="',u?o.r1:o.r2,'" fx="',u?o.x2:o.x1,'" fy="',u?o.y2:o.y1,`">
`]),this.type==="radial"){if(u)for((r=r.concat()).reverse(),e=0,t=r.length;e<t;e++)r[e].offset=1-r[e].offset;var C=Math.min(o.r1,o.r2);if(C>0){var R=C/Math.max(o.r1,o.r2);for(e=0,t=r.length;e<t;e++)r[e].offset+=R*(1-r[e].offset)}}for(e=0,t=r.length;e<t;e++){var M=r[e];a.push("<stop ",'offset="',100*M.offset+"%",'" style="stop-color:',M.color,M.opacity!==void 0?";stop-opacity: "+M.opacity:";",`"/>
`)}return a.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),a.join("")},toLive:function(n){var l,e,t,a=g.util.object.clone(this.coords);if(this.type){for(this.type==="linear"?l=n.createLinearGradient(a.x1,a.y1,a.x2,a.y2):this.type==="radial"&&(l=n.createRadialGradient(a.x1,a.y1,a.r1,a.x2,a.y2,a.r2)),e=0,t=this.colorStops.length;e<t;e++){var c=this.colorStops[e].color,o=this.colorStops[e].opacity,r=this.colorStops[e].offset;o!==void 0&&(c=new g.Color(c).setAlpha(o).toRgba()),l.addColorStop(r,c)}return l}}}),g.util.object.extend(g.Gradient,{fromElement:function(n,l,e,t){var a=parseFloat(e)/(/%$/.test(e)?100:1);a=a<0?0:a>1?1:a,isNaN(a)&&(a=1);var c,o,r,u,f=n.getElementsByTagName("stop"),p=n.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",m=n.getAttribute("gradientTransform")||"",v=[],y=0,C=0;for(n.nodeName==="linearGradient"||n.nodeName==="LINEARGRADIENT"?(c="linear",o=function(R){return{x1:R.getAttribute("x1")||0,y1:R.getAttribute("y1")||0,x2:R.getAttribute("x2")||"100%",y2:R.getAttribute("y2")||0}}(n)):(c="radial",o=function(R){return{x1:R.getAttribute("fx")||R.getAttribute("cx")||"50%",y1:R.getAttribute("fy")||R.getAttribute("cy")||"50%",r1:0,x2:R.getAttribute("cx")||"50%",y2:R.getAttribute("cy")||"50%",r2:R.getAttribute("r")||"50%"}}(n)),r=f.length;r--;)v.push(s(f[r],a));return u=g.parseTransformAttribute(m),function(R,M,W,j){var I,T;Object.keys(M).forEach(function(D){(I=M[D])==="Infinity"?T=1:I==="-Infinity"?T=0:(T=parseFloat(M[D],10),typeof I=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(I)&&(T*=.01,j==="pixels"&&(D!=="x1"&&D!=="x2"&&D!=="r2"||(T*=W.viewBoxWidth||W.width),D!=="y1"&&D!=="y2"||(T*=W.viewBoxHeight||W.height)))),M[D]=T})}(0,o,t,p),p==="pixels"&&(y=-l.left,C=-l.top),new g.Gradient({id:n.getAttribute("id"),type:c,coords:o,colorStops:v,gradientUnits:p,gradientTransform:u,offsetX:y,offsetY:C})}})}(),ee=g.util.toFixed,g.Pattern=g.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(s,i){if(s||(s={}),this.id=g.Object.__uid++,this.setOptions(s),!s.source||s.source&&typeof s.source!="string")i&&i(this);else{var n=this;this.source=g.util.createImage(),g.util.loadImage(s.source,function(l,e){n.source=l,i&&i(n,e)},null,this.crossOrigin)}},toObject:function(s){var i,n,l=g.Object.NUM_FRACTION_DIGITS;return typeof this.source.src=="string"?i=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(i=this.source.toDataURL()),n={type:"pattern",source:i,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:ee(this.offsetX,l),offsetY:ee(this.offsetY,l),patternTransform:this.patternTransform?this.patternTransform.concat():null},g.util.populateWithProperties(this,n,s),n},toSVG:function(s){var i=typeof this.source=="function"?this.source():this.source,n=i.width/s.width,l=i.height/s.height,e=this.offsetX/s.width,t=this.offsetY/s.height,a="";return this.repeat!=="repeat-x"&&this.repeat!=="no-repeat"||(l=1,t&&(l+=Math.abs(t))),this.repeat!=="repeat-y"&&this.repeat!=="no-repeat"||(n=1,e&&(n+=Math.abs(e))),i.src?a=i.src:i.toDataURL&&(a=i.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+e+'" y="'+t+'" width="'+n+'" height="'+l+`">
<image x="0" y="0" width="`+i.width+'" height="'+i.height+'" xlink:href="'+a+`"></image>
</pattern>
`},setOptions:function(s){for(var i in s)this[i]=s[i]},toLive:function(s){var i=this.source;return!i||i.src!==void 0&&(!i.complete||i.naturalWidth===0||i.naturalHeight===0)?"":s.createPattern(i,this.repeat)}}),function(s){var i=s.fabric||(s.fabric={}),n=i.util.toFixed;i.Shadow?i.warn("fabric.Shadow is already defined."):(i.Shadow=i.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(l){for(var e in typeof l=="string"&&(l=this._parseShadow(l)),l)this[e]=l[e];this.id=i.Object.__uid++},_parseShadow:function(l){var e=l.trim(),t=i.Shadow.reOffsetsAndBlur.exec(e)||[];return{color:(e.replace(i.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:parseFloat(t[1],10)||0,offsetY:parseFloat(t[2],10)||0,blur:parseFloat(t[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(l){var e=40,t=40,a=i.Object.NUM_FRACTION_DIGITS,c=i.util.rotateVector({x:this.offsetX,y:this.offsetY},i.util.degreesToRadians(-l.angle)),o=new i.Color(this.color);return l.width&&l.height&&(e=100*n((Math.abs(c.x)+this.blur)/l.width,a)+20,t=100*n((Math.abs(c.y)+this.blur)/l.height,a)+20),l.flipX&&(c.x*=-1),l.flipY&&(c.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+t+'%" height="'+(100+2*t)+'%" x="-'+e+'%" width="'+(100+2*e)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+n(this.blur?this.blur/2:0,a)+`"></feGaussianBlur>
	<feOffset dx="`+n(c.x,a)+'" dy="'+n(c.y,a)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+o.toRgb()+'" flood-opacity="'+o.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var l={},e=i.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(t){this[t]!==e[t]&&(l[t]=this[t])},this),l}}),i.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/)}(h),function(){if(g.StaticCanvas)g.warn("fabric.StaticCanvas is already defined.");else{var s=g.util.object.extend,i=g.util.getElementOffset,n=g.util.removeFromArray,l=g.util.toFixed,e=g.util.transformPoint,t=g.util.invertTransform,a=g.util.getNodeCanvas,c=g.util.createCanvasElement,o=new Error("Could not initialize `canvas` element");g.StaticCanvas=g.util.createClass(g.CommonMethods,{initialize:function(r,u){u||(u={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(r,u)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:g.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(r,u){var f=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(r),this._initOptions(u),this.interactive||this._initRetinaScaling(),u.overlayImage&&this.setOverlayImage(u.overlayImage,f),u.backgroundImage&&this.setBackgroundImage(u.backgroundImage,f),u.backgroundColor&&this.setBackgroundColor(u.backgroundColor,f),u.overlayColor&&this.setOverlayColor(u.overlayColor,f),this.calcOffset()},_isRetinaScaling:function(){return g.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,g.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var r=g.devicePixelRatio;this.__initRetinaScaling(r,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(r,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(r,u,f){u.setAttribute("width",this.width*r),u.setAttribute("height",this.height*r),f.scale(r,r)},calcOffset:function(){return this._offset=i(this.lowerCanvasEl),this},setOverlayImage:function(r,u,f){return this.__setBgOverlayImage("overlayImage",r,u,f)},setBackgroundImage:function(r,u,f){return this.__setBgOverlayImage("backgroundImage",r,u,f)},setOverlayColor:function(r,u){return this.__setBgOverlayColor("overlayColor",r,u)},setBackgroundColor:function(r,u){return this.__setBgOverlayColor("backgroundColor",r,u)},__setBgOverlayImage:function(r,u,f,p){return typeof u=="string"?g.util.loadImage(u,function(m,v){if(m){var y=new g.Image(m,p);this[r]=y,y.canvas=this}f&&f(m,v)},this,p&&p.crossOrigin):(p&&u.setOptions(p),this[r]=u,u&&(u.canvas=this),f&&f(u,!1)),this},__setBgOverlayColor:function(r,u,f){return this[r]=u,this._initGradient(u,r),this._initPattern(u,r,f),this},_createCanvasElement:function(){var r=c();if(!r||(r.style||(r.style={}),r.getContext===void 0))throw o;return r},_initOptions:function(r){var u=this.lowerCanvasEl;this._setOptions(r),this.width=this.width||parseInt(u.width,10)||0,this.height=this.height||parseInt(u.height,10)||0,this.lowerCanvasEl.style&&(u.width=this.width,u.height=this.height,u.style.width=this.width+"px",u.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(r){r&&r.getContext?this.lowerCanvasEl=r:this.lowerCanvasEl=g.util.getById(r)||this._createCanvasElement(),g.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(r,u){return this.setDimensions({width:r},u)},setHeight:function(r,u){return this.setDimensions({height:r},u)},setDimensions:function(r,u){var f;for(var p in u=u||{},r)f=r[p],u.cssOnly||(this._setBackstoreDimension(p,r[p]),f+="px",this.hasLostContext=!0),u.backstoreOnly||this._setCssDimension(p,f);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),u.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(r,u){return this.lowerCanvasEl[r]=u,this.upperCanvasEl&&(this.upperCanvasEl[r]=u),this.cacheCanvasEl&&(this.cacheCanvasEl[r]=u),this[r]=u,this},_setCssDimension:function(r,u){return this.lowerCanvasEl.style[r]=u,this.upperCanvasEl&&(this.upperCanvasEl.style[r]=u),this.wrapperEl&&(this.wrapperEl.style[r]=u),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(r){var u,f,p,m=this._activeObject,v=this.backgroundImage,y=this.overlayImage;for(this.viewportTransform=r,f=0,p=this._objects.length;f<p;f++)(u=this._objects[f]).group||u.setCoords(!0);return m&&m.setCoords(),v&&v.setCoords(!0),y&&y.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(r,u){var f=r,p=this.viewportTransform.slice(0);r=e(r,t(this.viewportTransform)),p[0]=u,p[3]=u;var m=e(r,p);return p[4]+=f.x-m.x,p[5]+=f.y-m.y,this.setViewportTransform(p)},setZoom:function(r){return this.zoomToPoint(new g.Point(0,0),r),this},absolutePan:function(r){var u=this.viewportTransform.slice(0);return u[4]=-r.x,u[5]=-r.y,this.setViewportTransform(u)},relativePan:function(r){return this.absolutePan(new g.Point(-r.x-this.viewportTransform[4],-r.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(r){this.stateful&&r.setupState(),r._set("canvas",this),r.setCoords(),this.fire("object:added",{target:r}),r.fire("added")},_onObjectRemoved:function(r){this.fire("object:removed",{target:r}),r.fire("removed"),delete r.canvas},clearContext:function(r){return r.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var r=this.contextContainer;return this.renderCanvas(r,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=g.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var r={},u=this.width,f=this.height,p=t(this.viewportTransform);return r.tl=e({x:0,y:0},p),r.br=e({x:u,y:f},p),r.tr=new g.Point(r.br.x,r.tl.y),r.bl=new g.Point(r.tl.x,r.br.y),this.vptCoords=r,r},cancelRequestedRender:function(){this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(r,u){var f=this.viewportTransform,p=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(r),g.util.setImageSmoothing(r,this.imageSmoothingEnabled),this.fire("before:render",{ctx:r}),this._renderBackground(r),r.save(),r.transform(f[0],f[1],f[2],f[3],f[4],f[5]),this._renderObjects(r,u),r.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(r),p&&(p.canvas=this,p.shouldCache(),p._transformDone=!0,p.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(r)),this._renderOverlay(r),this.controlsAboveOverlay&&this.interactive&&this.drawControls(r),this.fire("after:render",{ctx:r})},drawClipPathOnCanvas:function(r){var u=this.viewportTransform,f=this.clipPath;r.save(),r.transform(u[0],u[1],u[2],u[3],u[4],u[5]),r.globalCompositeOperation="destination-in",f.transform(r),r.scale(1/f.zoomX,1/f.zoomY),r.drawImage(f._cacheCanvas,-f.cacheTranslationX,-f.cacheTranslationY),r.restore()},_renderObjects:function(r,u){var f,p;for(f=0,p=u.length;f<p;++f)u[f]&&u[f].render(r)},_renderBackgroundOrOverlay:function(r,u){var f=this[u+"Color"],p=this[u+"Image"],m=this.viewportTransform,v=this[u+"Vpt"];if(f||p){if(f){r.save(),r.beginPath(),r.moveTo(0,0),r.lineTo(this.width,0),r.lineTo(this.width,this.height),r.lineTo(0,this.height),r.closePath(),r.fillStyle=f.toLive?f.toLive(r,this):f,v&&r.transform(m[0],m[1],m[2],m[3],m[4],m[5]),r.transform(1,0,0,1,f.offsetX||0,f.offsetY||0);var y=f.gradientTransform||f.patternTransform;y&&r.transform(y[0],y[1],y[2],y[3],y[4],y[5]),r.fill(),r.restore()}p&&(r.save(),v&&r.transform(m[0],m[1],m[2],m[3],m[4],m[5]),p.render(r),r.restore())}},_renderBackground:function(r){this._renderBackgroundOrOverlay(r,"background")},_renderOverlay:function(r){this._renderBackgroundOrOverlay(r,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new g.Point(this.width/2,this.height/2)},centerObjectH:function(r){return this._centerObject(r,new g.Point(this.getCenterPoint().x,r.getCenterPoint().y))},centerObjectV:function(r){return this._centerObject(r,new g.Point(r.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(r){var u=this.getCenterPoint();return this._centerObject(r,u)},viewportCenterObject:function(r){var u=this.getVpCenter();return this._centerObject(r,u)},viewportCenterObjectH:function(r){var u=this.getVpCenter();return this._centerObject(r,new g.Point(u.x,r.getCenterPoint().y)),this},viewportCenterObjectV:function(r){var u=this.getVpCenter();return this._centerObject(r,new g.Point(r.getCenterPoint().x,u.y))},getVpCenter:function(){var r=this.getCenterPoint(),u=t(this.viewportTransform);return e(r,u)},_centerObject:function(r,u){return r.setPositionByOrigin(u,"center","center"),r.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(r){return this.toDatalessObject(r)},toObject:function(r){return this._toObjectMethod("toObject",r)},toDatalessObject:function(r){return this._toObjectMethod("toDatalessObject",r)},_toObjectMethod:function(r,u){var f=this.clipPath,p={version:g.version,objects:this._toObjects(r,u)};return f&&!f.excludeFromExport&&(p.clipPath=this._toObject(this.clipPath,r,u)),s(p,this.__serializeBgOverlay(r,u)),g.util.populateWithProperties(this,p,u),p},_toObjects:function(r,u){return this._objects.filter(function(f){return!f.excludeFromExport}).map(function(f){return this._toObject(f,r,u)},this)},_toObject:function(r,u,f){var p;this.includeDefaultValues||(p=r.includeDefaultValues,r.includeDefaultValues=!1);var m=r[u](f);return this.includeDefaultValues||(r.includeDefaultValues=p),m},__serializeBgOverlay:function(r,u){var f={},p=this.backgroundImage,m=this.overlayImage,v=this.backgroundColor,y=this.overlayColor;return v&&v.toObject?v.excludeFromExport||(f.background=v.toObject(u)):v&&(f.background=v),y&&y.toObject?y.excludeFromExport||(f.overlay=y.toObject(u)):y&&(f.overlay=y),p&&!p.excludeFromExport&&(f.backgroundImage=this._toObject(p,r,u)),m&&!m.excludeFromExport&&(f.overlayImage=this._toObject(m,r,u)),f},svgViewportTransformation:!0,toSVG:function(r,u){r||(r={}),r.reviver=u;var f=[];return this._setSVGPreamble(f,r),this._setSVGHeader(f,r),this.clipPath&&f.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(f,"background"),this._setSVGBgOverlayImage(f,"backgroundImage",u),this._setSVGObjects(f,u),this.clipPath&&f.push(`</g>
`),this._setSVGBgOverlayColor(f,"overlay"),this._setSVGBgOverlayImage(f,"overlayImage",u),f.push("</svg>"),f.join("")},_setSVGPreamble:function(r,u){u.suppressPreamble||r.push('<?xml version="1.0" encoding="',u.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(r,u){var f,p=u.width||this.width,m=u.height||this.height,v='viewBox="0 0 '+this.width+" "+this.height+'" ',y=g.Object.NUM_FRACTION_DIGITS;u.viewBox?v='viewBox="'+u.viewBox.x+" "+u.viewBox.y+" "+u.viewBox.width+" "+u.viewBox.height+'" ':this.svgViewportTransformation&&(f=this.viewportTransform,v='viewBox="'+l(-f[4]/f[0],y)+" "+l(-f[5]/f[3],y)+" "+l(this.width/f[0],y)+" "+l(this.height/f[3],y)+'" '),r.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',p,'" ','height="',m,'" ',v,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",g.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(u),`</defs>
`)},createSVGClipPathMarkup:function(r){var u=this.clipPath;return u?(u.clipPathId="CLIPPATH_"+g.Object.__uid++,'<clipPath id="'+u.clipPathId+`" >
`+this.clipPath.toClipPathSVG(r.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var r=this;return["background","overlay"].map(function(u){var f=r[u+"Color"];if(f&&f.toLive){var p=r[u+"Vpt"],m=r.viewportTransform,v={width:r.width/(p?m[0]:1),height:r.height/(p?m[3]:1)};return f.toSVG(v,{additionalTransform:p?g.util.matrixToSVG(m):""})}}).join("")},createSVGFontFacesMarkup:function(){var r,u,f,p,m,v,y,C,R="",M={},W=g.fontPaths,j=[];for(this._objects.forEach(function T(D){j.push(D),D._objects&&D._objects.forEach(T)}),y=0,C=j.length;y<C;y++)if(u=(r=j[y]).fontFamily,r.type.indexOf("text")!==-1&&!M[u]&&W[u]&&(M[u]=!0,r.styles))for(m in f=r.styles)for(v in p=f[m])!M[u=p[v].fontFamily]&&W[u]&&(M[u]=!0);for(var I in M)R+=[`		@font-face {
`,"			font-family: '",I,`';
`,"			src: url('",W[I],`');
`,`		}
`].join("");return R&&(R=['	<style type="text/css">',`<![CDATA[
`,R,"]]>",`</style>
`].join("")),R},_setSVGObjects:function(r,u){var f,p,m,v=this._objects;for(p=0,m=v.length;p<m;p++)(f=v[p]).excludeFromExport||this._setSVGObject(r,f,u)},_setSVGObject:function(r,u,f){r.push(u.toSVG(f))},_setSVGBgOverlayImage:function(r,u,f){this[u]&&!this[u].excludeFromExport&&this[u].toSVG&&r.push(this[u].toSVG(f))},_setSVGBgOverlayColor:function(r,u){var f=this[u+"Color"],p=this.viewportTransform,m=this.width,v=this.height;if(f)if(f.toLive){var y=f.repeat,C=g.util.invertTransform(p),R=this[u+"Vpt"]?g.util.matrixToSVG(C):"";r.push('<rect transform="'+R+" translate(",m/2,",",v/2,')"',' x="',f.offsetX-m/2,'" y="',f.offsetY-v/2,'" ','width="',y==="repeat-y"||y==="no-repeat"?f.source.width:m,'" height="',y==="repeat-x"||y==="no-repeat"?f.source.height:v,'" fill="url(#SVGID_'+f.id+')"',`></rect>
`)}else r.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',f,'"',`></rect>
`)},sendToBack:function(r){if(!r)return this;var u,f,p,m=this._activeObject;if(r===m&&r.type==="activeSelection")for(u=(p=m._objects).length;u--;)f=p[u],n(this._objects,f),this._objects.unshift(f);else n(this._objects,r),this._objects.unshift(r);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(r){if(!r)return this;var u,f,p,m=this._activeObject;if(r===m&&r.type==="activeSelection")for(p=m._objects,u=0;u<p.length;u++)f=p[u],n(this._objects,f),this._objects.push(f);else n(this._objects,r),this._objects.push(r);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(r,u){if(!r)return this;var f,p,m,v,y,C=this._activeObject,R=0;if(r===C&&r.type==="activeSelection")for(y=C._objects,f=0;f<y.length;f++)p=y[f],(m=this._objects.indexOf(p))>0+R&&(v=m-1,n(this._objects,p),this._objects.splice(v,0,p)),R++;else(m=this._objects.indexOf(r))!==0&&(v=this._findNewLowerIndex(r,m,u),n(this._objects,r),this._objects.splice(v,0,r));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(r,u,f){var p,m;if(f){for(p=u,m=u-1;m>=0;--m)if(r.intersectsWithObject(this._objects[m])||r.isContainedWithinObject(this._objects[m])||this._objects[m].isContainedWithinObject(r)){p=m;break}}else p=u-1;return p},bringForward:function(r,u){if(!r)return this;var f,p,m,v,y,C=this._activeObject,R=0;if(r===C&&r.type==="activeSelection")for(f=(y=C._objects).length;f--;)p=y[f],(m=this._objects.indexOf(p))<this._objects.length-1-R&&(v=m+1,n(this._objects,p),this._objects.splice(v,0,p)),R++;else(m=this._objects.indexOf(r))!==this._objects.length-1&&(v=this._findNewUpperIndex(r,m,u),n(this._objects,r),this._objects.splice(v,0,r));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(r,u,f){var p,m,v;if(f){for(p=u,m=u+1,v=this._objects.length;m<v;++m)if(r.intersectsWithObject(this._objects[m])||r.isContainedWithinObject(this._objects[m])||this._objects[m].isContainedWithinObject(r)){p=m;break}}else p=u+1;return p},moveTo:function(r,u){return n(this._objects,r),this._objects.splice(u,0,r),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(g.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(r){r.dispose&&r.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),g.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),g.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),s(g.StaticCanvas.prototype,g.Observable),s(g.StaticCanvas.prototype,g.Collection),s(g.StaticCanvas.prototype,g.DataURLExporter),s(g.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(r){var u=c();if(!u||!u.getContext)return null;var f=u.getContext("2d");return f&&r==="setLineDash"?f.setLineDash!==void 0:null}}),g.StaticCanvas.prototype.toJSON=g.StaticCanvas.prototype.toObject,g.isLikelyNode&&(g.StaticCanvas.prototype.createPNGStream=function(){var r=a(this.lowerCanvasEl);return r&&r.createPNGStream()},g.StaticCanvas.prototype.createJPEGStream=function(r){var u=a(this.lowerCanvasEl);return u&&u.createJPEGStream(r)})}}(),g.BaseBrush=g.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(s){s.strokeStyle=this.color,s.lineWidth=this.width,s.lineCap=this.strokeLineCap,s.miterLimit=this.strokeMiterLimit,s.lineJoin=this.strokeLineJoin,s.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(s){var i=this.canvas.viewportTransform;s.save(),s.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_setShadow:function(){if(this.shadow){var s=this.canvas,i=this.shadow,n=s.contextTop,l=s.getZoom();s&&s._isRetinaScaling()&&(l*=g.devicePixelRatio),n.shadowColor=i.color,n.shadowBlur=i.blur*l,n.shadowOffsetX=i.offsetX*l,n.shadowOffsetY=i.offsetY*l}},needsFullRender:function(){return new g.Color(this.color).getAlpha()<1||!!this.shadow},_resetShadow:function(){var s=this.canvas.contextTop;s.shadowColor="",s.shadowBlur=s.shadowOffsetX=s.shadowOffsetY=0},_isOutSideCanvas:function(s){return s.x<0||s.x>this.canvas.getWidth()||s.y<0||s.y>this.canvas.getHeight()}}),g.PencilBrush=g.util.createClass(g.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(s){this.canvas=s,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(s,i,n){var l=i.midPointFrom(n);return s.quadraticCurveTo(i.x,i.y,l.x,l.y),l},onMouseDown:function(s,i){this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],this._prepareForDrawing(s),this._captureDrawingPath(s),this._render())},onMouseMove:function(s,i){if(this.canvas._isMainEvent(i.e)&&(this.drawStraightLine=i.e[this.straightLineKey],(this.limitedToCanvasSize!==!0||!this._isOutSideCanvas(s))&&this._captureDrawingPath(s)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var n=this._points,l=n.length,e=this.canvas.contextTop;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,n[l-2],n[l-1],!0),e.stroke(),e.restore()}},onMouseUp:function(s){return!this.canvas._isMainEvent(s.e)||(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1)},_prepareForDrawing:function(s){var i=new g.Point(s.x,s.y);this._reset(),this._addPoint(i),this.canvas.contextTop.moveTo(i.x,i.y)},_addPoint:function(s){return!(this._points.length>1&&s.eq(this._points[this._points.length-1])||(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(s),0))},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(s){var i=new g.Point(s.x,s.y);return this._addPoint(i)},_render:function(s){var i,n,l=this._points[0],e=this._points[1];if(s=s||this.canvas.contextTop,this._saveAndTransform(s),s.beginPath(),this._points.length===2&&l.x===e.x&&l.y===e.y){var t=this.width/1e3;l=new g.Point(l.x,l.y),e=new g.Point(e.x,e.y),l.x-=t,e.x+=t}for(s.moveTo(l.x,l.y),i=1,n=this._points.length;i<n;i++)this._drawSegment(s,l,e),l=this._points[i],e=this._points[i+1];s.lineTo(l.x,l.y),s.stroke(),s.restore()},convertPointsToSVGPath:function(s){var i=this.width/1e3;return g.util.getSmoothPathFromPoints(s,i)},_isEmptySVGPath:function(s){return g.util.joinPath(s)==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(s){var i=new g.Path(s,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,i.shadow=new g.Shadow(this.shadow)),i},decimatePoints:function(s,i){if(s.length<=2)return s;var n,l=this.canvas.getZoom(),e=Math.pow(i/l,2),t=s.length-1,a=s[0],c=[a];for(n=1;n<t-1;n++)Math.pow(a.x-s[n].x,2)+Math.pow(a.y-s[n].y,2)>=e&&(a=s[n],c.push(a));return c.push(s[t]),c},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var s=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(s))this.canvas.requestRenderAll();else{var i=this.createPath(s);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}}),g.CircleBrush=g.util.createClass(g.BaseBrush,{width:10,initialize:function(s){this.canvas=s,this.points=[]},drawDot:function(s){var i=this.addPoint(s),n=this.canvas.contextTop;this._saveAndTransform(n),this.dot(n,i),n.restore()},dot:function(s,i){s.fillStyle=i.fill,s.beginPath(),s.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),s.closePath(),s.fill()},onMouseDown:function(s){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(s)},_render:function(){var s,i,n=this.canvas.contextTop,l=this.points;for(this._saveAndTransform(n),s=0,i=l.length;s<i;s++)this.dot(n,l[s]);n.restore()},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(s),this._render()):this.drawDot(s))},onMouseUp:function(){var s,i,n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;var l=[];for(s=0,i=this.points.length;s<i;s++){var e=this.points[s],t=new g.Circle({radius:e.radius,left:e.x,top:e.y,originX:"center",originY:"center",fill:e.fill});this.shadow&&(t.shadow=new g.Shadow(this.shadow)),l.push(t)}var a=new g.Group(l);a.canvas=this.canvas,this.canvas.fire("before:path:created",{path:a}),this.canvas.add(a),this.canvas.fire("path:created",{path:a}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},addPoint:function(s){var i=new g.Point(s.x,s.y),n=g.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,l=new g.Color(this.color).setAlpha(g.util.getRandomInt(0,100)/100).toRgba();return i.radius=n,i.fill=l,this.points.push(i),i}}),g.SprayBrush=g.util.createClass(g.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(s){this.canvas=s,this.sprayChunks=[]},onMouseDown:function(s){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(s),this.render(this.sprayChunkPoints)},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.addSprayChunk(s),this.render(this.sprayChunkPoints))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var i=[],n=0,l=this.sprayChunks.length;n<l;n++)for(var e=this.sprayChunks[n],t=0,a=e.length;t<a;t++){var c=new g.Rect({width:e[t].width,height:e[t].width,left:e[t].x+1,top:e[t].y+1,originX:"center",originY:"center",fill:this.color});i.push(c)}this.optimizeOverlapping&&(i=this._getOptimizedRects(i));var o=new g.Group(i);this.shadow&&o.set("shadow",new g.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:o}),this.canvas.add(o),this.canvas.fire("path:created",{path:o}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},_getOptimizedRects:function(s){var i,n,l,e={};for(n=0,l=s.length;n<l;n++)e[i=s[n].left+""+s[n].top]||(e[i]=s[n]);var t=[];for(i in e)t.push(e[i]);return t},render:function(s){var i,n,l=this.canvas.contextTop;for(l.fillStyle=this.color,this._saveAndTransform(l),i=0,n=s.length;i<n;i++){var e=s[i];e.opacity!==void 0&&(l.globalAlpha=e.opacity),l.fillRect(e.x,e.y,e.width,e.width)}l.restore()},_render:function(){var s,i,n=this.canvas.contextTop;for(n.fillStyle=this.color,this._saveAndTransform(n),s=0,i=this.sprayChunks.length;s<i;s++)this.render(this.sprayChunks[s]);n.restore()},addSprayChunk:function(s){this.sprayChunkPoints=[];var i,n,l,e,t=this.width/2;for(e=0;e<this.density;e++){i=g.util.getRandomInt(s.x-t,s.x+t),n=g.util.getRandomInt(s.y-t,s.y+t),l=this.dotWidthVariance?g.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth;var a=new g.Point(i,n);a.width=l,this.randomOpacity&&(a.opacity=g.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(a)}this.sprayChunks.push(this.sprayChunkPoints)}}),g.PatternBrush=g.util.createClass(g.PencilBrush,{getPatternSrc:function(){var s=g.util.createCanvasElement(),i=s.getContext("2d");return s.width=s.height=25,i.fillStyle=this.color,i.beginPath(),i.arc(10,10,10,0,2*Math.PI,!1),i.closePath(),i.fill(),s},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(s){return s.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(s){this.callSuper("_setBrushStyles",s),s.strokeStyle=this.getPattern(s)},createPath:function(s){var i=this.callSuper("createPath",s),n=i._getLeftTopCoords().scalarAdd(i.strokeWidth/2);return i.stroke=new g.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-n.x,offsetY:-n.y}),i}}),function(){var s=g.util.getPointer,i=g.util.degreesToRadians,n=g.util.isTouchEvent;for(var l in g.Canvas=g.util.createClass(g.StaticCanvas,{initialize:function(e,t){t||(t={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(e,t),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=g.PencilBrush&&new g.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var e,t,a,c=this.getActiveObjects();if(c.length>0&&!this.preserveObjectStacking){t=[],a=[];for(var o=0,r=this._objects.length;o<r;o++)e=this._objects[o],c.indexOf(e)===-1?t.push(e):a.push(e);c.length>1&&(this._activeObject._objects=a),t.push.apply(t,a)}else t=this._objects;return t},renderAll:function(){!this.contextTopDirty||this._groupSelector||this.isDrawingMode||(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var e=this.contextContainer;return this.renderCanvas(e,this._chooseObjectsToRender()),this},renderTopLayer:function(e){e.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(e),this.contextTopDirty=!0),e.restore()},renderTop:function(){var e=this.contextTop;return this.clearContext(e),this.renderTopLayer(e),this.fire("after:render"),this},_normalizePointer:function(e,t){var a=e.calcTransformMatrix(),c=g.util.invertTransform(a),o=this.restorePointerVpt(t);return g.util.transformPoint(o,c)},isTargetTransparent:function(e,t,a){if(e.shouldCache()&&e._cacheCanvas&&e!==this._activeObject){var c=this._normalizePointer(e,{x:t,y:a}),o=Math.max(e.cacheTranslationX+c.x*e.zoomX,0),r=Math.max(e.cacheTranslationY+c.y*e.zoomY,0);return g.util.isTransparent(e._cacheContext,Math.round(o),Math.round(r),this.targetFindTolerance)}var u=this.contextCache,f=e.selectionBackgroundColor,p=this.viewportTransform;return e.selectionBackgroundColor="",this.clearContext(u),u.save(),u.transform(p[0],p[1],p[2],p[3],p[4],p[5]),e.render(u),u.restore(),e.selectionBackgroundColor=f,g.util.isTransparent(u,t,a,this.targetFindTolerance)},_isSelectionKeyPressed:function(e){return Array.isArray(this.selectionKey)?!!this.selectionKey.find(function(t){return e[t]===!0}):e[this.selectionKey]},_shouldClearSelection:function(e,t){var a=this.getActiveObjects(),c=this._activeObject;return!t||t&&c&&a.length>1&&a.indexOf(t)===-1&&c!==t&&!this._isSelectionKeyPressed(e)||t&&!t.evented||t&&!t.selectable&&c&&c!==t},_shouldCenterTransform:function(e,t,a){var c;if(e)return t==="scale"||t==="scaleX"||t==="scaleY"||t==="resizing"?c=this.centeredScaling||e.centeredScaling:t==="rotate"&&(c=this.centeredRotation||e.centeredRotation),c?!a:a},_getOriginFromCorner:function(e,t){var a={x:e.originX,y:e.originY};return t==="ml"||t==="tl"||t==="bl"?a.x="right":t!=="mr"&&t!=="tr"&&t!=="br"||(a.x="left"),t==="tl"||t==="mt"||t==="tr"?a.y="bottom":t!=="bl"&&t!=="mb"&&t!=="br"||(a.y="top"),a},_getActionFromCorner:function(e,t,a,c){if(!t||!e)return"drag";var o=c.controls[t];return o.getActionName(a,o,c)},_setupCurrentTransform:function(e,t,a){if(t){var c=this.getPointer(e),o=t.__corner,r=t.controls[o],u=a&&o?r.getActionHandler(e,t,r):g.controlsUtils.dragHandler,f=this._getActionFromCorner(a,o,e,t),p=this._getOriginFromCorner(t,o),m=e[this.centeredKey],v={target:t,action:f,actionHandler:u,corner:o,scaleX:t.scaleX,scaleY:t.scaleY,skewX:t.skewX,skewY:t.skewY,offsetX:c.x-t.left,offsetY:c.y-t.top,originX:p.x,originY:p.y,ex:c.x,ey:c.y,lastX:c.x,lastY:c.y,theta:i(t.angle),width:t.width*t.scaleX,shiftKey:e.shiftKey,altKey:m,original:g.util.saveObjectTransform(t)};this._shouldCenterTransform(t,f,m)&&(v.originX="center",v.originY="center"),v.original.originX=p.x,v.original.originY=p.y,this._currentTransform=v,this._beforeTransform(e)}},setCursor:function(e){this.upperCanvasEl.style.cursor=e},_drawSelection:function(e){var t=this._groupSelector,a=new g.Point(t.ex,t.ey),c=g.util.transformPoint(a,this.viewportTransform),o=new g.Point(t.ex+t.left,t.ey+t.top),r=g.util.transformPoint(o,this.viewportTransform),u=Math.min(c.x,r.x),f=Math.min(c.y,r.y),p=Math.max(c.x,r.x),m=Math.max(c.y,r.y),v=this.selectionLineWidth/2;this.selectionColor&&(e.fillStyle=this.selectionColor,e.fillRect(u,f,p-u,m-f)),this.selectionLineWidth&&this.selectionBorderColor&&(e.lineWidth=this.selectionLineWidth,e.strokeStyle=this.selectionBorderColor,u+=v,f+=v,p-=v,m-=v,g.Object.prototype._setLineDash.call(this,e,this.selectionDashArray),e.strokeRect(u,f,p-u,m-f))},findTarget:function(e,t){if(!this.skipTargetFind){var a,c,o=this.getPointer(e,!0),r=this._activeObject,u=this.getActiveObjects(),f=n(e),p=u.length>1&&!t||u.length===1;if(this.targets=[],p&&r._findTargetCorner(o,f)||u.length>1&&!t&&r===this._searchPossibleTargets([r],o))return r;if(u.length===1&&r===this._searchPossibleTargets([r],o)){if(!this.preserveObjectStacking)return r;a=r,c=this.targets,this.targets=[]}var m=this._searchPossibleTargets(this._objects,o);return e[this.altSelectionKey]&&m&&a&&m!==a&&(m=a,this.targets=c),m}},_checkTarget:function(e,t,a){if(t&&t.visible&&t.evented&&t.containsPoint(e)&&(!this.perPixelTargetFind&&!t.perPixelTargetFind||t.isEditing||!this.isTargetTransparent(t,a.x,a.y)))return!0},_searchPossibleTargets:function(e,t){for(var a,c,o=e.length;o--;){var r=e[o],u=r.group?this._normalizePointer(r.group,t):t;if(this._checkTarget(u,r,t)){(a=e[o]).subTargetCheck&&a instanceof g.Group&&(c=this._searchPossibleTargets(a._objects,t))&&this.targets.push(c);break}}return a},restorePointerVpt:function(e){return g.util.transformPoint(e,g.util.invertTransform(this.viewportTransform))},getPointer:function(e,t){if(this._absolutePointer&&!t)return this._absolutePointer;if(this._pointer&&t)return this._pointer;var a,c=s(e),o=this.upperCanvasEl,r=o.getBoundingClientRect(),u=r.width||0,f=r.height||0;u&&f||("top"in r&&"bottom"in r&&(f=Math.abs(r.top-r.bottom)),"right"in r&&"left"in r&&(u=Math.abs(r.right-r.left))),this.calcOffset(),c.x=c.x-this._offset.left,c.y=c.y-this._offset.top,t||(c=this.restorePointerVpt(c));var p=this.getRetinaScaling();return p!==1&&(c.x/=p,c.y/=p),a=u===0||f===0?{width:1,height:1}:{width:o.width/u,height:o.height/f},{x:c.x*a.width,y:c.y*a.height}},_createUpperCanvas:function(){var e=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),t=this.lowerCanvasEl,a=this.upperCanvasEl;a?a.className="":(a=this._createCanvasElement(),this.upperCanvasEl=a),g.util.addClass(a,"upper-canvas "+e),this.wrapperEl.appendChild(a),this._copyCanvasStyle(t,a),this._applyCanvasStyle(a),this.contextTop=a.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=g.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),g.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),g.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(e){var t=this.width||e.width,a=this.height||e.height;g.util.setStyle(e,{position:"absolute",width:t+"px",height:a+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),e.width=t,e.height=a,g.util.makeElementUnselectable(e)},_copyCanvasStyle:function(e,t){t.style.cssText=e.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var e=this._activeObject;return e?e.type==="activeSelection"&&e._objects?e._objects.slice(0):[e]:[]},_onObjectRemoved:function(e){e===this._activeObject&&(this.fire("before:selection:cleared",{target:e}),this._discardActiveObject(),this.fire("selection:cleared",{target:e}),e.fire("deselected")),e===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",e)},_fireSelectionEvents:function(e,t){var a=!1,c=this.getActiveObjects(),o=[],r=[];e.forEach(function(u){c.indexOf(u)===-1&&(a=!0,u.fire("deselected",{e:t,target:u}),r.push(u))}),c.forEach(function(u){e.indexOf(u)===-1&&(a=!0,u.fire("selected",{e:t,target:u}),o.push(u))}),e.length>0&&c.length>0?a&&this.fire("selection:updated",{e:t,selected:o,deselected:r}):c.length>0?this.fire("selection:created",{e:t,selected:o}):e.length>0&&this.fire("selection:cleared",{e:t,deselected:r})},setActiveObject:function(e,t){var a=this.getActiveObjects();return this._setActiveObject(e,t),this._fireSelectionEvents(a,t),this},_setActiveObject:function(e,t){return this._activeObject!==e&&!!this._discardActiveObject(t,e)&&!e.onSelect({e:t})&&(this._activeObject=e,!0)},_discardActiveObject:function(e,t){var a=this._activeObject;if(a){if(a.onDeselect({e,object:t}))return!1;this._activeObject=null}return!0},discardActiveObject:function(e){var t=this.getActiveObjects(),a=this.getActiveObject();return t.length&&this.fire("before:selection:cleared",{target:a,e}),this._discardActiveObject(e),this._fireSelectionEvents(t,e),this},dispose:function(){var e=this.wrapperEl;return this.removeListeners(),e.removeChild(this.upperCanvasEl),e.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(t){g.util.cleanUpJsdomNode(this[t]),this[t]=void 0}).bind(this)),e.parentNode&&e.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,g.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(e){var t=this._activeObject;t&&t._renderControls(e)},_toObject:function(e,t,a){var c=this._realizeGroupTransformOnObject(e),o=this.callSuper("_toObject",e,t,a);return this._unwindGroupTransformOnObject(e,c),o},_realizeGroupTransformOnObject:function(e){if(e.group&&e.group.type==="activeSelection"&&this._activeObject===e.group){var t={};return["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"].forEach(function(a){t[a]=e[a]}),g.util.addTransformToObject(e,this._activeObject.calcOwnMatrix()),t}return null},_unwindGroupTransformOnObject:function(e,t){t&&e.set(t)},_setSVGObject:function(e,t,a){var c=this._realizeGroupTransformOnObject(t);this.callSuper("_setSVGObject",e,t,a),this._unwindGroupTransformOnObject(t,c)},setViewportTransform:function(e){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),g.StaticCanvas.prototype.setViewportTransform.call(this,e)}}),g.StaticCanvas)l!=="prototype"&&(g.Canvas[l]=g.StaticCanvas[l])}(),function(){var s=g.util.addListener,i=g.util.removeListener,n={passive:!1};function l(e,t){return e.button&&e.button===t-1}g.util.object.extend(g.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(s,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(e,t){var a=this.upperCanvasEl,c=this._getEventPrefix();e(g.window,"resize",this._onResize),e(a,c+"down",this._onMouseDown),e(a,c+"move",this._onMouseMove,n),e(a,c+"out",this._onMouseOut),e(a,c+"enter",this._onMouseEnter),e(a,"wheel",this._onMouseWheel),e(a,"contextmenu",this._onContextMenu),e(a,"dblclick",this._onDoubleClick),e(a,"dragover",this._onDragOver),e(a,"dragenter",this._onDragEnter),e(a,"dragleave",this._onDragLeave),e(a,"drop",this._onDrop),this.enablePointerEvents||e(a,"touchstart",this._onTouchStart,n),typeof eventjs<"u"&&t in eventjs&&(eventjs[t](a,"gesture",this._onGesture),eventjs[t](a,"drag",this._onDrag),eventjs[t](a,"orientation",this._onOrientationChange),eventjs[t](a,"shake",this._onShake),eventjs[t](a,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(i,"remove");var e=this._getEventPrefix();i(g.document,e+"up",this._onMouseUp),i(g.document,"touchend",this._onTouchEnd,n),i(g.document,e+"move",this._onMouseMove,n),i(g.document,"touchmove",this._onMouseMove,n)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(e,t){this.__onTransformGesture&&this.__onTransformGesture(e,t)},_onDrag:function(e,t){this.__onDrag&&this.__onDrag(e,t)},_onMouseWheel:function(e){this.__onMouseWheel(e)},_onMouseOut:function(e){var t=this._hoveredTarget;this.fire("mouse:out",{target:t,e}),this._hoveredTarget=null,t&&t.fire("mouseout",{e});var a=this;this._hoveredTargets.forEach(function(c){a.fire("mouse:out",{target:t,e}),c&&t.fire("mouseout",{e})}),this._hoveredTargets=[],this._iTextInstances&&this._iTextInstances.forEach(function(c){c.isEditing&&c.hiddenTextarea.focus()})},_onMouseEnter:function(e){this._currentTransform||this.findTarget(e)||(this.fire("mouse:over",{target:null,e}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(e,t){this.__onOrientationChange&&this.__onOrientationChange(e,t)},_onShake:function(e,t){this.__onShake&&this.__onShake(e,t)},_onLongPress:function(e,t){this.__onLongPress&&this.__onLongPress(e,t)},_onDragOver:function(e){e.preventDefault();var t=this._simpleEventHandler("dragover",e);this._fireEnterLeaveEvents(t,e)},_onDrop:function(e){return this._simpleEventHandler("drop:before",e),this._simpleEventHandler("drop",e)},_onContextMenu:function(e){return this.stopContextMenu&&(e.stopPropagation(),e.preventDefault()),!1},_onDoubleClick:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"dblclick"),this._resetTransformEventData(e)},getPointerId:function(e){var t=e.changedTouches;return t?t[0]&&t[0].identifier:this.enablePointerEvents?e.pointerId:-1},_isMainEvent:function(e){return e.isPrimary===!0||e.isPrimary!==!1&&(e.type==="touchend"&&e.touches.length===0||!e.changedTouches||e.changedTouches[0].identifier===this.mainTouchId)},_onTouchStart:function(e){e.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(e)),this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,a=this._getEventPrefix();s(g.document,"touchend",this._onTouchEnd,n),s(g.document,"touchmove",this._onMouseMove,n),i(t,a+"down",this._onMouseDown)},_onMouseDown:function(e){this.__onMouseDown(e),this._resetTransformEventData();var t=this.upperCanvasEl,a=this._getEventPrefix();i(t,a+"move",this._onMouseMove,n),s(g.document,a+"up",this._onMouseUp),s(g.document,a+"move",this._onMouseMove,n)},_onTouchEnd:function(e){if(!(e.touches.length>0)){this.__onMouseUp(e),this._resetTransformEventData(),this.mainTouchId=null;var t=this._getEventPrefix();i(g.document,"touchend",this._onTouchEnd,n),i(g.document,"touchmove",this._onMouseMove,n);var a=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){s(a.upperCanvasEl,t+"down",a._onMouseDown),a._willAddMouseDown=0},400)}},_onMouseUp:function(e){this.__onMouseUp(e),this._resetTransformEventData();var t=this.upperCanvasEl,a=this._getEventPrefix();this._isMainEvent(e)&&(i(g.document,a+"up",this._onMouseUp),i(g.document,a+"move",this._onMouseMove,n),s(t,a+"move",this._onMouseMove,n))},_onMouseMove:function(e){!this.allowTouchScrolling&&e.preventDefault&&e.preventDefault(),this.__onMouseMove(e)},_onResize:function(){this.calcOffset()},_shouldRender:function(e){var t=this._activeObject;return!!(!!t!=!!e||t&&e&&t!==e)||(t&&t.isEditing,!1)},__onMouseUp:function(e){var t,a=this._currentTransform,c=this._groupSelector,o=!1,r=!c||c.left===0&&c.top===0;if(this._cacheTransformEventData(e),t=this._target,this._handleEvent(e,"up:before"),l(e,3))this.fireRightClick&&this._handleEvent(e,"up",3,r);else{if(l(e,2))return this.fireMiddleClick&&this._handleEvent(e,"up",2,r),void this._resetTransformEventData();if(this.isDrawingMode&&this._isCurrentlyDrawing)this._onMouseUpInDrawingMode(e);else if(this._isMainEvent(e)){if(a&&(this._finalizeCurrentTransform(e),o=a.actionPerformed),!r){var u=t===this._activeObject;this._maybeGroupObjects(e),o||(o=this._shouldRender(t)||!u&&t===this._activeObject)}var f,p;if(t){if(f=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e)),t.selectable&&t!==this._activeObject&&t.activeOn==="up")this.setActiveObject(t,e),o=!0;else{var m=t.controls[f],v=m&&m.getMouseUpHandler(e,t,m);v&&v(e,a,(p=this.getPointer(e)).x,p.y)}t.isMoving=!1}if(a&&(a.target!==t||a.corner!==f)){var y=a.target&&a.target.controls[a.corner],C=y&&y.getMouseUpHandler(e,t,m);p=p||this.getPointer(e),C&&C(e,a,p.x,p.y)}this._setCursorFromEvent(e,t),this._handleEvent(e,"up",1,r),this._groupSelector=null,this._currentTransform=null,t&&(t.__corner=0),o?this.requestRenderAll():r||this.renderTop()}}},_simpleEventHandler:function(e,t){var a=this.findTarget(t),c=this.targets,o={e:t,target:a,subTargets:c};if(this.fire(e,o),a&&a.fire(e,o),!c)return a;for(var r=0;r<c.length;r++)c[r].fire(e,o);return a},_handleEvent:function(e,t,a,c){var o=this._target,r=this.targets||[],u={e,target:o,subTargets:r,button:a||1,isClick:c||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};t==="up"&&(u.currentTarget=this.findTarget(e),u.currentSubTargets=this.targets),this.fire("mouse:"+t,u),o&&o.fire("mouse"+t,u);for(var f=0;f<r.length;f++)r[f].fire("mouse"+t,u)},_finalizeCurrentTransform:function(e){var t=this._currentTransform,a=t.target,c={e,target:a,transform:t,action:t.action};a._scaling&&(a._scaling=!1),a.setCoords(),(t.actionPerformed||this.stateful&&a.hasStateChanged())&&this._fire("modified",c)},_onMouseDownInDrawingMode:function(e){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(e).requestRenderAll();var t=this.getPointer(e);this.freeDrawingBrush.onMouseDown(t,{e,pointer:t}),this._handleEvent(e,"down")},_onMouseMoveInDrawingMode:function(e){if(this._isCurrentlyDrawing){var t=this.getPointer(e);this.freeDrawingBrush.onMouseMove(t,{e,pointer:t})}this.setCursor(this.freeDrawingCursor),this._handleEvent(e,"move")},_onMouseUpInDrawingMode:function(e){var t=this.getPointer(e);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e,pointer:t}),this._handleEvent(e,"up")},__onMouseDown:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"down:before");var t=this._target;if(l(e,3))this.fireRightClick&&this._handleEvent(e,"down",3);else if(l(e,2))this.fireMiddleClick&&this._handleEvent(e,"down",2);else if(this.isDrawingMode)this._onMouseDownInDrawingMode(e);else if(this._isMainEvent(e)&&!this._currentTransform){var a=this._pointer;this._previousPointer=a;var c=this._shouldRender(t),o=this._shouldGroup(e,t);if(this._shouldClearSelection(e,t)?this.discardActiveObject(e):o&&(this._handleGrouping(e,t),t=this._activeObject),!this.selection||t&&(t.selectable||t.isEditing||t===this._activeObject)||(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),t){var r=t===this._activeObject;t.selectable&&t.activeOn==="down"&&this.setActiveObject(t,e);var u=t._findTargetCorner(this.getPointer(e,!0),g.util.isTouchEvent(e));if(t.__corner=u,t===this._activeObject&&(u||!o)){this._setupCurrentTransform(e,t,r);var f=t.controls[u],p=(a=this.getPointer(e),f&&f.getMouseDownHandler(e,t,f));p&&p(e,this._currentTransform,a.x,a.y)}}this._handleEvent(e,"down"),(c||o)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(e){this._resetTransformEventData(),this._pointer=this.getPointer(e,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(e)||null},_beforeTransform:function(e){var t=this._currentTransform;this.stateful&&t.target.saveState(),this.fire("before:transform",{e,transform:t})},__onMouseMove:function(e){var t,a;if(this._handleEvent(e,"move:before"),this._cacheTransformEventData(e),this.isDrawingMode)this._onMouseMoveInDrawingMode(e);else if(this._isMainEvent(e)){var c=this._groupSelector;c?(a=this._absolutePointer,c.left=a.x-c.ex,c.top=a.y-c.ey,this.renderTop()):this._currentTransform?this._transformObject(e):(t=this.findTarget(e)||null,this._setCursorFromEvent(e,t),this._fireOverOutEvents(t,e)),this._handleEvent(e,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(e,t){var a=this._hoveredTarget,c=this._hoveredTargets,o=this.targets,r=Math.max(c.length,o.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:a,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var u=0;u<r;u++)this.fireSyntheticInOutEvents(o[u],t,{oldTarget:c[u],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(e,t){var a=this._draggedoverTarget,c=this._hoveredTargets,o=this.targets,r=Math.max(c.length,o.length);this.fireSyntheticInOutEvents(e,t,{oldTarget:a,evtOut:"dragleave",evtIn:"dragenter"});for(var u=0;u<r;u++)this.fireSyntheticInOutEvents(o[u],t,{oldTarget:c[u],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=e},fireSyntheticInOutEvents:function(e,t,a){var c,o,r,u=a.oldTarget,f=u!==e,p=a.canvasEvtIn,m=a.canvasEvtOut;f&&(c={e:t,target:e,previousTarget:u},o={e:t,target:u,nextTarget:e}),r=e&&f,u&&f&&(m&&this.fire(m,o),u.fire(a.evtOut,o)),r&&(p&&this.fire(p,c),e.fire(a.evtIn,c))},__onMouseWheel:function(e){this._cacheTransformEventData(e),this._handleEvent(e,"wheel"),this._resetTransformEventData()},_transformObject:function(e){var t=this.getPointer(e),a=this._currentTransform;a.reset=!1,a.shiftKey=e.shiftKey,a.altKey=e[this.centeredKey],this._performTransformAction(e,a,t),a.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(e,t,a){var c=a.x,o=a.y,r=t.action,u=!1,f=t.actionHandler;f&&(u=f(e,t,c,o)),r==="drag"&&u&&(t.target.isMoving=!0,this.setCursor(t.target.moveCursor||this.moveCursor)),t.actionPerformed=t.actionPerformed||u},_fire:g.controlsUtils.fireEvent,_setCursorFromEvent:function(e,t){if(!t)return this.setCursor(this.defaultCursor),!1;var a=t.hoverCursor||this.hoverCursor,c=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,o=(!c||!c.contains(t))&&t._findTargetCorner(this.getPointer(e,!0));o?this.setCursor(this.getCornerCursor(o,t,e)):(t.subTargetCheck&&this.targets.concat().reverse().map(function(r){a=r.hoverCursor||a}),this.setCursor(a))},getCornerCursor:function(e,t,a){var c=t.controls[e];return c.cursorStyleHandler(a,c,t)}})}(),ne=Math.min,ie=Math.max,g.util.object.extend(g.Canvas.prototype,{_shouldGroup:function(s,i){var n=this._activeObject;return n&&this._isSelectionKeyPressed(s)&&i&&i.selectable&&this.selection&&(n!==i||n.type==="activeSelection")&&!i.onSelect({e:s})},_handleGrouping:function(s,i){var n=this._activeObject;n.__corner||(i!==n||(i=this.findTarget(s,!0))&&i.selectable)&&(n&&n.type==="activeSelection"?this._updateActiveSelection(i,s):this._createActiveSelection(i,s))},_updateActiveSelection:function(s,i){var n=this._activeObject,l=n._objects.slice(0);n.contains(s)?(n.removeWithUpdate(s),this._hoveredTarget=s,this._hoveredTargets=this.targets.concat(),n.size()===1&&this._setActiveObject(n.item(0),i)):(n.addWithUpdate(s),this._hoveredTarget=n,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(l,i)},_createActiveSelection:function(s,i){var n=this.getActiveObjects(),l=this._createGroup(s);this._hoveredTarget=l,this._setActiveObject(l,i),this._fireSelectionEvents(n,i)},_createGroup:function(s){var i=this._objects,n=i.indexOf(this._activeObject)<i.indexOf(s)?[this._activeObject,s]:[s,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new g.ActiveSelection(n,{canvas:this})},_groupSelectedObjects:function(s){var i,n=this._collectObjects(s);n.length===1?this.setActiveObject(n[0],s):n.length>1&&(i=new g.ActiveSelection(n.reverse(),{canvas:this}),this.setActiveObject(i,s))},_collectObjects:function(s){for(var i,n=[],l=this._groupSelector.ex,e=this._groupSelector.ey,t=l+this._groupSelector.left,a=e+this._groupSelector.top,c=new g.Point(ne(l,t),ne(e,a)),o=new g.Point(ie(l,t),ie(e,a)),r=!this.selectionFullyContained,u=l===t&&e===a,f=this._objects.length;f--&&!((i=this._objects[f])&&i.selectable&&i.visible&&(r&&i.intersectsWithRect(c,o,!0)||i.isContainedWithinRect(c,o,!0)||r&&i.containsPoint(c,null,!0)||r&&i.containsPoint(o,null,!0))&&(n.push(i),u)););return n.length>1&&(n=n.filter(function(p){return!p.onSelect({e:s})})),n},_maybeGroupObjects:function(s){this.selection&&this._groupSelector&&this._groupSelectedObjects(s),this.setCursor(this.defaultCursor),this._groupSelector=null}}),g.util.object.extend(g.StaticCanvas.prototype,{toDataURL:function(s){s||(s={});var i=s.format||"png",n=s.quality||1,l=(s.multiplier||1)*(s.enableRetinaScaling?this.getRetinaScaling():1),e=this.toCanvasElement(l,s);return g.util.toDataURL(e,i,n)},toCanvasElement:function(s,i){s=s||1;var n=((i=i||{}).width||this.width)*s,l=(i.height||this.height)*s,e=this.getZoom(),t=this.width,a=this.height,c=e*s,o=this.viewportTransform,r=(o[4]-(i.left||0))*s,u=(o[5]-(i.top||0))*s,f=this.interactive,p=[c,0,0,c,r,u],m=this.enableRetinaScaling,v=g.util.createCanvasElement(),y=this.contextTop;return v.width=n,v.height=l,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=p,this.width=n,this.height=l,this.calcViewportBoundaries(),this.renderCanvas(v.getContext("2d"),this._objects),this.viewportTransform=o,this.width=t,this.height=a,this.calcViewportBoundaries(),this.interactive=f,this.enableRetinaScaling=m,this.contextTop=y,v}}),g.util.object.extend(g.StaticCanvas.prototype,{loadFromJSON:function(s,i,n){if(s){var l=typeof s=="string"?JSON.parse(s):g.util.object.clone(s),e=this,t=l.clipPath,a=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete l.clipPath,this._enlivenObjects(l.objects,function(c){e.clear(),e._setBgOverlay(l,function(){t?e._enlivenObjects([t],function(o){e.clipPath=o[0],e.__setupCanvas.call(e,l,c,a,i)}):e.__setupCanvas.call(e,l,c,a,i)})},n),this}},__setupCanvas:function(s,i,n,l){var e=this;i.forEach(function(t,a){e.insertAt(t,a)}),this.renderOnAddRemove=n,delete s.objects,delete s.backgroundImage,delete s.overlayImage,delete s.background,delete s.overlay,this._setOptions(s),this.renderAll(),l&&l()},_setBgOverlay:function(s,i){var n={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(s.backgroundImage||s.overlayImage||s.background||s.overlay){var l=function(){n.backgroundImage&&n.overlayImage&&n.backgroundColor&&n.overlayColor&&i&&i()};this.__setBgOverlay("backgroundImage",s.backgroundImage,n,l),this.__setBgOverlay("overlayImage",s.overlayImage,n,l),this.__setBgOverlay("backgroundColor",s.background,n,l),this.__setBgOverlay("overlayColor",s.overlay,n,l)}else i&&i()},__setBgOverlay:function(s,i,n,l){var e=this;if(!i)return n[s]=!0,void(l&&l());s==="backgroundImage"||s==="overlayImage"?g.util.enlivenObjects([i],function(t){e[s]=t[0],n[s]=!0,l&&l()}):this["set"+g.util.string.capitalize(s,!0)](i,function(){n[s]=!0,l&&l()})},_enlivenObjects:function(s,i,n){s&&s.length!==0?g.util.enlivenObjects(s,function(l){i&&i(l)},null,n):i&&i([])},_toDataURL:function(s,i){this.clone(function(n){i(n.toDataURL(s))})},_toDataURLWithMultiplier:function(s,i,n){this.clone(function(l){n(l.toDataURLWithMultiplier(s,i))})},clone:function(s,i){var n=JSON.stringify(this.toJSON(i));this.cloneWithoutData(function(l){l.loadFromJSON(n,function(){s&&s(l)})})},cloneWithoutData:function(s){var i=g.util.createCanvasElement();i.width=this.width,i.height=this.height;var n=new g.Canvas(i);this.backgroundImage?(n.setBackgroundImage(this.backgroundImage.src,function(){n.renderAll(),s&&s(n)}),n.backgroundImageOpacity=this.backgroundImageOpacity,n.backgroundImageStretch=this.backgroundImageStretch):s&&s(n)}}),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.util.object.clone,e=i.util.toFixed,t=i.util.string.capitalize,a=i.util.degreesToRadians,c=!i.isLikelyNode;i.Object||(i.Object=i.util.createClass(i.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:c,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(o){o&&this.setOptions(o)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=i.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(o){var r=i.perfLimitSizeTotal,u=o.width,f=o.height,p=i.maxCacheSideLimit,m=i.minCacheSideLimit;if(u<=p&&f<=p&&u*f<=r)return u<m&&(o.width=m),f<m&&(o.height=m),o;var v=u/f,y=i.util.limitDimsByArea(v,r),C=i.util.capValue,R=C(m,y.x,p),M=C(m,y.y,p);return u>R&&(o.zoomX/=u/R,o.width=R,o.capped=!0),f>M&&(o.zoomY/=f/M,o.height=M,o.capped=!0),o},_getCacheCanvasDimensions:function(){var o=this.getTotalObjectScaling(),r=this._getTransformedDimensions(0,0),u=r.x*o.scaleX/this.scaleX,f=r.y*o.scaleY/this.scaleY;return{width:u+2,height:f+2,zoomX:o.scaleX,zoomY:o.scaleY,x:u,y:f}},_updateCacheCanvas:function(){var o=this.canvas;if(this.noScaleCache&&o&&o._currentTransform){var r=o._currentTransform.target,u=o._currentTransform.action;if(this===r&&u.slice&&u.slice(0,5)==="scale")return!1}var f,p,m=this._cacheCanvas,v=this._limitCacheSize(this._getCacheCanvasDimensions()),y=i.minCacheSideLimit,C=v.width,R=v.height,M=v.zoomX,W=v.zoomY,j=C!==this.cacheWidth||R!==this.cacheHeight,I=this.zoomX!==M||this.zoomY!==W,T=j||I,D=0,U=0,L=!1;if(j){var B=this._cacheCanvas.width,A=this._cacheCanvas.height,w=C>B||R>A;L=w||(C<.9*B||R<.9*A)&&B>y&&A>y,w&&!v.capped&&(C>y||R>y)&&(D=.1*C,U=.1*R)}return this instanceof i.Text&&this.path&&(T=!0,L=!0,D+=this.getHeightOfLine(0)*this.zoomX,U+=this.getHeightOfLine(0)*this.zoomY),!!T&&(L?(m.width=Math.ceil(C+D),m.height=Math.ceil(R+U)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,m.width,m.height)),f=v.x/2,p=v.y/2,this.cacheTranslationX=Math.round(m.width/2-f)+f,this.cacheTranslationY=Math.round(m.height/2-p)+p,this.cacheWidth=C,this.cacheHeight=R,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(M,W),this.zoomX=M,this.zoomY=W,!0)},setOptions:function(o){this._setOptions(o),this._initGradient(o.fill,"fill"),this._initGradient(o.stroke,"stroke"),this._initPattern(o.fill,"fill"),this._initPattern(o.stroke,"stroke")},transform:function(o){var r=this.group&&!this.group._transformDone||this.group&&this.canvas&&o===this.canvas.contextTop,u=this.calcTransformMatrix(!r);o.transform(u[0],u[1],u[2],u[3],u[4],u[5])},toObject:function(o){var r=i.Object.NUM_FRACTION_DIGITS,u={type:this.type,version:i.version,originX:this.originX,originY:this.originY,left:e(this.left,r),top:e(this.top,r),width:e(this.width,r),height:e(this.height,r),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:e(this.strokeWidth,r),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:e(this.strokeMiterLimit,r),scaleX:e(this.scaleX,r),scaleY:e(this.scaleY,r),angle:e(this.angle,r),flipX:this.flipX,flipY:this.flipY,opacity:e(this.opacity,r),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:e(this.skewX,r),skewY:e(this.skewY,r)};return this.clipPath&&!this.clipPath.excludeFromExport&&(u.clipPath=this.clipPath.toObject(o),u.clipPath.inverted=this.clipPath.inverted,u.clipPath.absolutePositioned=this.clipPath.absolutePositioned),i.util.populateWithProperties(this,u,o),this.includeDefaultValues||(u=this._removeDefaultValues(u)),u},toDatalessObject:function(o){return this.toObject(o)},_removeDefaultValues:function(o){var r=i.util.getKlass(o.type).prototype;return r.stateProperties.forEach(function(u){u!=="left"&&u!=="top"&&(o[u]===r[u]&&delete o[u],Array.isArray(o[u])&&Array.isArray(r[u])&&o[u].length===0&&r[u].length===0&&delete o[u])}),o},toString:function(){return"#<fabric."+t(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var o=i.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(o.scaleX),scaleY:Math.abs(o.scaleY)}},getTotalObjectScaling:function(){var o=this.getObjectScaling(),r=o.scaleX,u=o.scaleY;if(this.canvas){var f=this.canvas.getZoom(),p=this.canvas.getRetinaScaling();r*=f*p,u*=f*p}return{scaleX:r,scaleY:u}},getObjectOpacity:function(){var o=this.opacity;return this.group&&(o*=this.group.getObjectOpacity()),o},_set:function(o,r){var u=o==="scaleX"||o==="scaleY",f=this[o]!==r,p=!1;return u&&(r=this._constrainScale(r)),o==="scaleX"&&r<0?(this.flipX=!this.flipX,r*=-1):o==="scaleY"&&r<0?(this.flipY=!this.flipY,r*=-1):o!=="shadow"||!r||r instanceof i.Shadow?o==="dirty"&&this.group&&this.group.set("dirty",r):r=new i.Shadow(r),this[o]=r,f&&(p=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(o)>-1?(this.dirty=!0,p&&this.group.set("dirty",!0)):p&&this.stateProperties.indexOf(o)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:i.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(o){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(o.save(),this._setupCompositeOperation(o),this.drawSelectionBackground(o),this.transform(o),this._setOpacity(o),this._setShadow(o,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(o)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(o),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),o.restore())},renderCache:function(o){o=o||{},this._cacheCanvas&&this._cacheContext||this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,o.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!(this.paintFirst!=="stroke"||!this.hasFill()||!this.hasStroke()||typeof this.shadow!="object")||!!this.clipPath},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(o,r){if(o.save(),r.inverted?o.globalCompositeOperation="destination-out":o.globalCompositeOperation="destination-in",r.absolutePositioned){var u=i.util.invertTransform(this.calcTransformMatrix());o.transform(u[0],u[1],u[2],u[3],u[4],u[5])}r.transform(o),o.scale(1/r.zoomX,1/r.zoomY),o.drawImage(r._cacheCanvas,-r.cacheTranslationX,-r.cacheTranslationY),o.restore()},drawObject:function(o,r){var u=this.fill,f=this.stroke;r?(this.fill="black",this.stroke="",this._setClippingProperties(o)):this._renderBackground(o),this._render(o),this._drawClipPath(o,this.clipPath),this.fill=u,this.stroke=f},_drawClipPath:function(o,r){r&&(r.canvas=this.canvas,r.shouldCache(),r._transformDone=!0,r.renderCache({forClipping:!0}),this.drawClipPathOnCache(o,r))},drawCacheOnCanvas:function(o){o.scale(1/this.zoomX,1/this.zoomY),o.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(o){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!o&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!o){var r=this.cacheWidth/this.zoomX,u=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-r/2,-u/2,r,u)}return!0}return!1},_renderBackground:function(o){if(this.backgroundColor){var r=this._getNonTransformedDimensions();o.fillStyle=this.backgroundColor,o.fillRect(-r.x/2,-r.y/2,r.x,r.y),this._removeShadow(o)}},_setOpacity:function(o){this.group&&!this.group._transformDone?o.globalAlpha=this.getObjectOpacity():o.globalAlpha*=this.opacity},_setStrokeStyles:function(o,r){var u=r.stroke;u&&(o.lineWidth=r.strokeWidth,o.lineCap=r.strokeLineCap,o.lineDashOffset=r.strokeDashOffset,o.lineJoin=r.strokeLineJoin,o.miterLimit=r.strokeMiterLimit,u.toLive?u.gradientUnits==="percentage"||u.gradientTransform||u.patternTransform?this._applyPatternForTransformedGradient(o,u):(o.strokeStyle=u.toLive(o,this),this._applyPatternGradientTransform(o,u)):o.strokeStyle=r.stroke)},_setFillStyles:function(o,r){var u=r.fill;u&&(u.toLive?(o.fillStyle=u.toLive(o,this),this._applyPatternGradientTransform(o,r.fill)):o.fillStyle=u)},_setClippingProperties:function(o){o.globalAlpha=1,o.strokeStyle="transparent",o.fillStyle="#000000"},_setLineDash:function(o,r){r&&r.length!==0&&(1&r.length&&r.push.apply(r,r),o.setLineDash(r))},_renderControls:function(o,r){var u,f,p,m=this.getViewportTransform(),v=this.calcTransformMatrix();f=(r=r||{}).hasBorders!==void 0?r.hasBorders:this.hasBorders,p=r.hasControls!==void 0?r.hasControls:this.hasControls,v=i.util.multiplyTransformMatrices(m,v),u=i.util.qrDecompose(v),o.save(),o.translate(u.translateX,u.translateY),o.lineWidth=1*this.borderScaleFactor,this.group||(o.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(u.angle-=180),o.rotate(a(this.group?u.angle:this.angle)),r.forActiveSelection||this.group?f&&this.drawBordersInGroup(o,u,r):f&&this.drawBorders(o,r),p&&this.drawControls(o,r),o.restore()},_setShadow:function(o){if(this.shadow){var r,u=this.shadow,f=this.canvas,p=f&&f.viewportTransform[0]||1,m=f&&f.viewportTransform[3]||1;r=u.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),f&&f._isRetinaScaling()&&(p*=i.devicePixelRatio,m*=i.devicePixelRatio),o.shadowColor=u.color,o.shadowBlur=u.blur*i.browserShadowBlurConstant*(p+m)*(r.scaleX+r.scaleY)/4,o.shadowOffsetX=u.offsetX*p*r.scaleX,o.shadowOffsetY=u.offsetY*m*r.scaleY}},_removeShadow:function(o){this.shadow&&(o.shadowColor="",o.shadowBlur=o.shadowOffsetX=o.shadowOffsetY=0)},_applyPatternGradientTransform:function(o,r){if(!r||!r.toLive)return{offsetX:0,offsetY:0};var u=r.gradientTransform||r.patternTransform,f=-this.width/2+r.offsetX||0,p=-this.height/2+r.offsetY||0;return r.gradientUnits==="percentage"?o.transform(this.width,0,0,this.height,f,p):o.transform(1,0,0,1,f,p),u&&o.transform(u[0],u[1],u[2],u[3],u[4],u[5]),{offsetX:f,offsetY:p}},_renderPaintInOrder:function(o){this.paintFirst==="stroke"?(this._renderStroke(o),this._renderFill(o)):(this._renderFill(o),this._renderStroke(o))},_render:function(){},_renderFill:function(o){this.fill&&(o.save(),this._setFillStyles(o,this),this.fillRule==="evenodd"?o.fill("evenodd"):o.fill(),o.restore())},_renderStroke:function(o){if(this.stroke&&this.strokeWidth!==0){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(o),o.save(),this.strokeUniform&&this.group){var r=this.getObjectScaling();o.scale(1/r.scaleX,1/r.scaleY)}else this.strokeUniform&&o.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(o,this.strokeDashArray),this._setStrokeStyles(o,this),o.stroke(),o.restore()}},_applyPatternForTransformedGradient:function(o,r){var u,f=this._limitCacheSize(this._getCacheCanvasDimensions()),p=i.util.createCanvasElement(),m=this.canvas.getRetinaScaling(),v=f.x/this.scaleX/m,y=f.y/this.scaleY/m;p.width=v,p.height=y,(u=p.getContext("2d")).beginPath(),u.moveTo(0,0),u.lineTo(v,0),u.lineTo(v,y),u.lineTo(0,y),u.closePath(),u.translate(v/2,y/2),u.scale(f.zoomX/this.scaleX/m,f.zoomY/this.scaleY/m),this._applyPatternGradientTransform(u,r),u.fillStyle=r.toLive(o),u.fill(),o.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),o.scale(m*this.scaleX/f.zoomX,m*this.scaleY/f.zoomY),o.strokeStyle=u.createPattern(p,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var o=i.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",o.scaleX),this.set("scaleY",o.scaleY),this.angle=o.angle,this.skewX=o.skewX,this.skewY=0}},_removeTransformMatrix:function(o){var r=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),r=i.util.transformPoint(r,this.transformMatrix)),this.transformMatrix=null,o&&(this.scaleX*=o.scaleX,this.scaleY*=o.scaleY,this.cropX=o.cropX,this.cropY=o.cropY,r.x+=o.offsetLeft,r.y+=o.offsetTop,this.width=o.width,this.height=o.height),this.setPositionByOrigin(r,"center","center")},clone:function(o,r){var u=this.toObject(r);this.constructor.fromObject?this.constructor.fromObject(u,o):i.Object._fromObject("Object",u,o)},cloneAsImage:function(o,r){var u=this.toCanvasElement(r);return o&&o(new i.Image(u)),this},toCanvasElement:function(o){o||(o={});var r=i.util,u=r.saveObjectTransform(this),f=this.group,p=this.shadow,m=Math.abs,v=(o.multiplier||1)*(o.enableRetinaScaling?i.devicePixelRatio:1);delete this.group,o.withoutTransform&&r.resetObjectTransform(this),o.withoutShadow&&(this.shadow=null);var y,C,R,M,W=i.util.createCanvasElement(),j=this.getBoundingRect(!0,!0),I=this.shadow,T={x:0,y:0};I&&(C=I.blur,y=I.nonScaling?{scaleX:1,scaleY:1}:this.getObjectScaling(),T.x=2*Math.round(m(I.offsetX)+C)*m(y.scaleX),T.y=2*Math.round(m(I.offsetY)+C)*m(y.scaleY)),R=j.width+T.x,M=j.height+T.y,W.width=Math.ceil(R),W.height=Math.ceil(M);var D=new i.StaticCanvas(W,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});o.format==="jpeg"&&(D.backgroundColor="#fff"),this.setPositionByOrigin(new i.Point(D.width/2,D.height/2),"center","center");var U=this.canvas;D.add(this);var L=D.toCanvasElement(v||1,o);return this.shadow=p,this.set("canvas",U),f&&(this.group=f),this.set(u).setCoords(),D._objects=[],D.dispose(),D=null,L},toDataURL:function(o){return o||(o={}),i.util.toDataURL(this.toCanvasElement(o),o.format||"png",o.quality||1)},isType:function(o){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===o},complexity:function(){return 1},toJSON:function(o){return this.toObject(o)},rotate:function(o){var r=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return r&&this._setOriginToCenter(),this.set("angle",o),r&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(o,r){r=r||this.canvas.getPointer(o);var u=new i.Point(r.x,r.y),f=this._getLeftTopCoords();return this.angle&&(u=i.util.rotatePoint(u,f,a(-this.angle))),{x:u.x-f.x,y:u.y-f.y}},_setupCompositeOperation:function(o){this.globalCompositeOperation&&(o.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){i.runningAnimations&&i.runningAnimations.cancelByTarget(this)}}),i.util.createAccessors&&i.util.createAccessors(i.Object),n(i.Object.prototype,i.Observable),i.Object.NUM_FRACTION_DIGITS=2,i.Object.ENLIVEN_PROPS=["clipPath"],i.Object._fromObject=function(o,r,u,f){var p=i[o];r=l(r,!0),i.util.enlivenPatterns([r.fill,r.stroke],function(m){m[0]!==void 0&&(r.fill=m[0]),m[1]!==void 0&&(r.stroke=m[1]),i.util.enlivenObjectEnlivables(r,r,function(){var v=f?new p(r[f],r):new p(r);u&&u(v)})})},i.Object.__uid=0)}(h),he=g.util.degreesToRadians,de={left:-.5,center:0,right:.5},fe={top:-.5,center:0,bottom:.5},g.util.object.extend(g.Object.prototype,{translateToGivenOrigin:function(s,i,n,l,e){var t,a,c,o=s.x,r=s.y;return typeof i=="string"?i=de[i]:i-=.5,typeof l=="string"?l=de[l]:l-=.5,typeof n=="string"?n=fe[n]:n-=.5,typeof e=="string"?e=fe[e]:e-=.5,a=e-n,((t=l-i)||a)&&(c=this._getTransformedDimensions(),o=s.x+t*c.x,r=s.y+a*c.y),new g.Point(o,r)},translateToCenterPoint:function(s,i,n){var l=this.translateToGivenOrigin(s,i,n,"center","center");return this.angle?g.util.rotatePoint(l,s,he(this.angle)):l},translateToOriginPoint:function(s,i,n){var l=this.translateToGivenOrigin(s,"center","center",i,n);return this.angle?g.util.rotatePoint(l,s,he(this.angle)):l},getCenterPoint:function(){var s=new g.Point(this.left,this.top);return this.translateToCenterPoint(s,this.originX,this.originY)},getPointByOrigin:function(s,i){var n=this.getCenterPoint();return this.translateToOriginPoint(n,s,i)},toLocalPoint:function(s,i,n){var l,e,t=this.getCenterPoint();return l=i!==void 0&&n!==void 0?this.translateToGivenOrigin(t,"center","center",i,n):new g.Point(this.left,this.top),e=new g.Point(s.x,s.y),this.angle&&(e=g.util.rotatePoint(e,t,-he(this.angle))),e.subtractEquals(l)},setPositionByOrigin:function(s,i,n){var l=this.translateToCenterPoint(s,i,n),e=this.translateToOriginPoint(l,this.originX,this.originY);this.set("left",e.x),this.set("top",e.y)},adjustPosition:function(s){var i,n,l=he(this.angle),e=this.getScaledWidth(),t=g.util.cos(l)*e,a=g.util.sin(l)*e;i=typeof this.originX=="string"?de[this.originX]:this.originX-.5,n=typeof s=="string"?de[s]:s-.5,this.left+=t*(n-i),this.top+=a*(n-i),this.setCoords(),this.originX=s},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var s=this.getCenterPoint();this.originX="center",this.originY="center",this.left=s.x,this.top=s.y},_resetOrigin:function(){var s=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=s.x,this.top=s.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}}),function(){var s=g.util,i=s.degreesToRadians,n=s.multiplyTransformMatrices,l=s.transformPoint;s.object.extend(g.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(e,t){return t?e?this.calcACoords():this.calcLineCoords():(this.aCoords&&this.lineCoords||this.setCoords(!0),e?this.aCoords:this.lineCoords)},getCoords:function(e,t){return a=this._getCoords(e,t),[new g.Point(a.tl.x,a.tl.y),new g.Point(a.tr.x,a.tr.y),new g.Point(a.br.x,a.br.y),new g.Point(a.bl.x,a.bl.y)];var a},intersectsWithRect:function(e,t,a,c){var o=this.getCoords(a,c);return g.Intersection.intersectPolygonRectangle(o,e,t).status==="Intersection"},intersectsWithObject:function(e,t,a){return g.Intersection.intersectPolygonPolygon(this.getCoords(t,a),e.getCoords(t,a)).status==="Intersection"||e.isContainedWithinObject(this,t,a)||this.isContainedWithinObject(e,t,a)},isContainedWithinObject:function(e,t,a){for(var c=this.getCoords(t,a),o=t?e.aCoords:e.lineCoords,r=0,u=e._getImageLines(o);r<4;r++)if(!e.containsPoint(c[r],u))return!1;return!0},isContainedWithinRect:function(e,t,a,c){var o=this.getBoundingRect(a,c);return o.left>=e.x&&o.left+o.width<=t.x&&o.top>=e.y&&o.top+o.height<=t.y},containsPoint:function(e,t,a,c){var o=this._getCoords(a,c),r=(t=t||this._getImageLines(o),this._findCrossPoints(e,t));return r!==0&&r%2==1},isOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,a=this.canvas.vptCoords.br;return!!this.getCoords(!0,e).some(function(c){return c.x<=a.x&&c.x>=t.x&&c.y<=a.y&&c.y>=t.y})||!!this.intersectsWithRect(t,a,!0,e)||this._containsCenterOfCanvas(t,a,e)},_containsCenterOfCanvas:function(e,t,a){var c={x:(e.x+t.x)/2,y:(e.y+t.y)/2};return!!this.containsPoint(c,null,!0,a)},isPartiallyOnScreen:function(e){if(!this.canvas)return!1;var t=this.canvas.vptCoords.tl,a=this.canvas.vptCoords.br;return!!this.intersectsWithRect(t,a,!0,e)||this.getCoords(!0,e).every(function(c){return(c.x>=a.x||c.x<=t.x)&&(c.y>=a.y||c.y<=t.y)})&&this._containsCenterOfCanvas(t,a,e)},_getImageLines:function(e){return{topline:{o:e.tl,d:e.tr},rightline:{o:e.tr,d:e.br},bottomline:{o:e.br,d:e.bl},leftline:{o:e.bl,d:e.tl}}},_findCrossPoints:function(e,t){var a,c,o,r=0;for(var u in t)if(!((o=t[u]).o.y<e.y&&o.d.y<e.y||o.o.y>=e.y&&o.d.y>=e.y||(o.o.x===o.d.x&&o.o.x>=e.x?c=o.o.x:(a=(o.d.y-o.o.y)/(o.d.x-o.o.x),c=-(e.y-0*e.x-(o.o.y-a*o.o.x))/(0-a)),c>=e.x&&(r+=1),r!==2)))break;return r},getBoundingRect:function(e,t){var a=this.getCoords(e,t);return s.makeBoundingBoxFromPoints(a)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(e){return Math.abs(e)<this.minScaleLimit?e<0?-this.minScaleLimit:this.minScaleLimit:e===0?1e-4:e},scale:function(e){return this._set("scaleX",e),this._set("scaleY",e),this.setCoords()},scaleToWidth:function(e,t){var a=this.getBoundingRect(t).width/this.getScaledWidth();return this.scale(e/this.width/a)},scaleToHeight:function(e,t){var a=this.getBoundingRect(t).height/this.getScaledHeight();return this.scale(e/this.height/a)},calcLineCoords:function(){var e=this.getViewportTransform(),t=this.padding,a=i(this.angle),c=s.cos(a)*t,o=s.sin(a)*t,r=c+o,u=c-o,f=this.calcACoords(),p={tl:l(f.tl,e),tr:l(f.tr,e),bl:l(f.bl,e),br:l(f.br,e)};return t&&(p.tl.x-=u,p.tl.y-=r,p.tr.x+=r,p.tr.y-=u,p.bl.x-=r,p.bl.y+=u,p.br.x+=u,p.br.y+=r),p},calcOCoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),a=this.getViewportTransform(),c=n(a,t),o=n(c,e),r=(o=n(o,[1/a[0],0,0,1/a[3],0,0]),this._calculateCurrentDimensions()),u={};return this.forEachControl(function(f,p,m){u[p]=f.positionHandler(r,o,m)}),u},calcACoords:function(){var e=this._calcRotateMatrix(),t=this._calcTranslateMatrix(),a=n(t,e),c=this._getTransformedDimensions(),o=c.x/2,r=c.y/2;return{tl:l({x:-o,y:-r},a),tr:l({x:o,y:-r},a),bl:l({x:-o,y:r},a),br:l({x:o,y:r},a)}},setCoords:function(e){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),e||(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords()),this},_calcRotateMatrix:function(){return s.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var e=this.getCenterPoint();return[1,0,0,1,e.x,e.y]},transformMatrixKey:function(e){var t="_",a="";return!e&&this.group&&(a=this.group.transformMatrixKey(e)+t),a+this.top+t+this.left+t+this.scaleX+t+this.scaleY+t+this.skewX+t+this.skewY+t+this.angle+t+this.originX+t+this.originY+t+this.width+t+this.height+t+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(e){var t=this.calcOwnMatrix();if(e||!this.group)return t;var a=this.transformMatrixKey(e),c=this.matrixCache||(this.matrixCache={});return c.key===a?c.value:(this.group&&(t=n(this.group.calcTransformMatrix(!1),t)),c.key=a,c.value=t,t)},calcOwnMatrix:function(){var e=this.transformMatrixKey(!0),t=this.ownMatrixCache||(this.ownMatrixCache={});if(t.key===e)return t.value;var a=this._calcTranslateMatrix(),c={angle:this.angle,translateX:a[4],translateY:a[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return t.key=e,t.value=s.composeMatrix(c),t.value},_getNonTransformedDimensions:function(){var e=this.strokeWidth;return{x:this.width+e,y:this.height+e}},_getTransformedDimensions:function(e,t){e===void 0&&(e=this.skewX),t===void 0&&(t=this.skewY);var a,c,o,r=e===0&&t===0;if(this.strokeUniform?(c=this.width,o=this.height):(c=(a=this._getNonTransformedDimensions()).x,o=a.y),r)return this._finalizeDimensions(c*this.scaleX,o*this.scaleY);var u=s.sizeAfterTransform(c,o,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:e,skewY:t});return this._finalizeDimensions(u.x,u.y)},_finalizeDimensions:function(e,t){return this.strokeUniform?{x:e+this.strokeWidth,y:t+this.strokeWidth}:{x:e,y:t}},_calculateCurrentDimensions:function(){var e=this.getViewportTransform(),t=this._getTransformedDimensions();return l(t,e,!0).scalarAdd(2*this.padding)}})}(),g.util.object.extend(g.Object.prototype,{sendToBack:function(){return this.group?g.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?g.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(s){return this.group?g.StaticCanvas.prototype.sendBackwards.call(this.group,this,s):this.canvas&&this.canvas.sendBackwards(this,s),this},bringForward:function(s){return this.group?g.StaticCanvas.prototype.bringForward.call(this.group,this,s):this.canvas&&this.canvas.bringForward(this,s),this},moveTo:function(s){return this.group&&this.group.type!=="activeSelection"?g.StaticCanvas.prototype.moveTo.call(this.group,this,s):this.canvas&&this.canvas.moveTo(this,s),this}}),function(){function s(n,l){if(l){if(l.toLive)return n+": url(#SVGID_"+l.id+"); ";var e=new g.Color(l),t=n+": "+e.toRgb()+"; ",a=e.getAlpha();return a!==1&&(t+=n+"-opacity: "+a.toString()+"; "),t}return n+": none; "}var i=g.util.toFixed;g.util.object.extend(g.Object.prototype,{getSvgStyles:function(n){var l=this.fillRule?this.fillRule:"nonzero",e=this.strokeWidth?this.strokeWidth:"0",t=this.strokeDashArray?this.strokeDashArray.join(" "):"none",a=this.strokeDashOffset?this.strokeDashOffset:"0",c=this.strokeLineCap?this.strokeLineCap:"butt",o=this.strokeLineJoin?this.strokeLineJoin:"miter",r=this.strokeMiterLimit?this.strokeMiterLimit:"4",u=this.opacity!==void 0?this.opacity:"1",f=this.visible?"":" visibility: hidden;",p=n?"":this.getSvgFilter(),m=s("fill",this.fill);return[s("stroke",this.stroke),"stroke-width: ",e,"; ","stroke-dasharray: ",t,"; ","stroke-linecap: ",c,"; ","stroke-dashoffset: ",a,"; ","stroke-linejoin: ",o,"; ","stroke-miterlimit: ",r,"; ",m,"fill-rule: ",l,"; ","opacity: ",u,";",p,f].join("")},getSvgSpanStyles:function(n,l){var e="; ",t=n.fontFamily?"font-family: "+(n.fontFamily.indexOf("'")===-1&&n.fontFamily.indexOf('"')===-1?"'"+n.fontFamily+"'":n.fontFamily)+e:"",a=n.strokeWidth?"stroke-width: "+n.strokeWidth+e:"",c=n.fontSize?"font-size: "+n.fontSize+"px"+e:"",o=n.fontStyle?"font-style: "+n.fontStyle+e:"",r=n.fontWeight?"font-weight: "+n.fontWeight+e:"",u=n.fill?s("fill",n.fill):"",f=n.stroke?s("stroke",n.stroke):"",p=this.getSvgTextDecoration(n);return p&&(p="text-decoration: "+p+e),[f,a,t,c,o,r,p,u,n.deltaY?"baseline-shift: "+-n.deltaY+"; ":"",l?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(n){return["overline","underline","line-through"].filter(function(l){return n[l.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(n,l){var e=n?this.calcTransformMatrix():this.calcOwnMatrix();return'transform="'+g.util.matrixToSVG(e)+(l||"")+'" '},_setSVGBg:function(n){if(this.backgroundColor){var l=g.Object.NUM_FRACTION_DIGITS;n.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',i(-this.width/2,l),'" y="',i(-this.height/2,l),'" width="',i(this.width,l),'" height="',i(this.height,l),`"></rect>
`)}},toSVG:function(n){return this._createBaseSVGMarkup(this._toSVG(n),{reviver:n})},toClipPathSVG:function(n){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(n),{reviver:n})},_createBaseClipPathSVGMarkup:function(n,l){var e=(l=l||{}).reviver,t=l.additionalTransform||"",a=[this.getSvgTransform(!0,t),this.getSvgCommons()].join(""),c=n.indexOf("COMMON_PARTS");return n[c]=a,e?e(n.join("")):n.join("")},_createBaseSVGMarkup:function(n,l){var e,t,a=(l=l||{}).noStyle,c=l.reviver,o=a?"":'style="'+this.getSvgStyles()+'" ',r=l.withShadow?'style="'+this.getSvgFilter()+'" ':"",u=this.clipPath,f=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",p=u&&u.absolutePositioned,m=this.stroke,v=this.fill,y=this.shadow,C=[],R=n.indexOf("COMMON_PARTS"),M=l.additionalTransform;return u&&(u.clipPathId="CLIPPATH_"+g.Object.__uid++,t='<clipPath id="'+u.clipPathId+`" >
`+u.toClipPathSVG(c)+`</clipPath>
`),p&&C.push("<g ",r,this.getSvgCommons(),` >
`),C.push("<g ",this.getSvgTransform(!1),p?"":r+this.getSvgCommons(),` >
`),e=[o,f,a?"":this.addPaintOrder()," ",M?'transform="'+M+'" ':""].join(""),n[R]=e,v&&v.toLive&&C.push(v.toSVG(this)),m&&m.toLive&&C.push(m.toSVG(this)),y&&C.push(y.toSVG(this)),u&&C.push(t),C.push(n.join("")),C.push(`</g>
`),p&&C.push(`</g>
`),c?c(C.join("")):C.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var s=g.util.object.extend,i="stateProperties";function n(e,t,a){var c={};a.forEach(function(o){c[o]=e[o]}),s(e[t],c,!0)}function l(e,t,a){if(e===t)return!0;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(var c=0,o=e.length;c<o;c++)if(!l(e[c],t[c]))return!1;return!0}if(e&&typeof e=="object"){var r,u=Object.keys(e);if(!t||typeof t!="object"||!a&&u.length!==Object.keys(t).length)return!1;for(c=0,o=u.length;c<o;c++)if((r=u[c])!=="canvas"&&r!=="group"&&!l(e[r],t[r]))return!1;return!0}}g.util.object.extend(g.Object.prototype,{hasStateChanged:function(e){var t="_"+(e=e||i);return Object.keys(this[t]).length<this[e].length||!l(this[t],this,!0)},saveState:function(e){var t=e&&e.propertySet||i,a="_"+t;return this[a]?(n(this,a,this[t]),e&&e.stateProperties&&n(this,a,e.stateProperties),this):this.setupState(e)},setupState:function(e){var t=(e=e||{}).propertySet||i;return e.propertySet=t,this["_"+t]={},this.saveState(e),this}})}(),function(){var s=g.util.degreesToRadians;g.util.object.extend(g.Object.prototype,{_findTargetCorner:function(i,n){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var l,e,t,a=i.x,c=i.y,o=Object.keys(this.oCoords),r=o.length-1;for(this.__corner=0;r>=0;r--)if(t=o[r],this.isControlVisible(t)&&(e=this._getImageLines(n?this.oCoords[t].touchCorner:this.oCoords[t].corner),(l=this._findCrossPoints({x:a,y:c},e))!==0&&l%2==1))return this.__corner=t,t;return!1},forEachControl:function(i){for(var n in this.controls)i(this.controls[n],n,this)},_setCornerCoords:function(){var i=this.oCoords;for(var n in i){var l=this.controls[n];i[n].corner=l.calcCornerCoords(this.angle,this.cornerSize,i[n].x,i[n].y,!1),i[n].touchCorner=l.calcCornerCoords(this.angle,this.touchCornerSize,i[n].x,i[n].y,!0)}},drawSelectionBackground:function(i){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;i.save();var n=this.getCenterPoint(),l=this._calculateCurrentDimensions(),e=this.canvas.viewportTransform;return i.translate(n.x,n.y),i.scale(1/e[0],1/e[3]),i.rotate(s(this.angle)),i.fillStyle=this.selectionBackgroundColor,i.fillRect(-l.x/2,-l.y/2,l.x,l.y),i.restore(),this},drawBorders:function(i,n){n=n||{};var l=this._calculateCurrentDimensions(),e=this.borderScaleFactor,t=l.x+e,a=l.y+e,c=n.hasControls!==void 0?n.hasControls:this.hasControls,o=!1;return i.save(),i.strokeStyle=n.borderColor||this.borderColor,this._setLineDash(i,n.borderDashArray||this.borderDashArray),i.strokeRect(-t/2,-a/2,t,a),c&&(i.beginPath(),this.forEachControl(function(r,u,f){r.withConnection&&r.getVisibility(f,u)&&(o=!0,i.moveTo(r.x*t,r.y*a),i.lineTo(r.x*t+r.offsetX,r.y*a+r.offsetY))}),o&&i.stroke()),i.restore(),this},drawBordersInGroup:function(i,n,l){l=l||{};var e=g.util.sizeAfterTransform(this.width,this.height,n),t=this.strokeWidth,a=this.strokeUniform,c=this.borderScaleFactor,o=e.x+t*(a?this.canvas.getZoom():n.scaleX)+c,r=e.y+t*(a?this.canvas.getZoom():n.scaleY)+c;return i.save(),this._setLineDash(i,l.borderDashArray||this.borderDashArray),i.strokeStyle=l.borderColor||this.borderColor,i.strokeRect(-o/2,-r/2,o,r),i.restore(),this},drawControls:function(i,n){n=n||{},i.save();var l,e,t=this.canvas.getRetinaScaling();return i.setTransform(t,0,0,t,0,0),i.strokeStyle=i.fillStyle=n.cornerColor||this.cornerColor,this.transparentCorners||(i.strokeStyle=n.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(i,n.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(l=this.group.calcTransformMatrix()),this.forEachControl(function(a,c,o){e=o.oCoords[c],a.getVisibility(o,c)&&(l&&(e=g.util.transformPoint(e,l)),a.render(i,e.x,e.y,n,o))}),i.restore(),this},isControlVisible:function(i){return this.controls[i]&&this.controls[i].getVisibility(this,i)},setControlVisible:function(i,n){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[i]=n,this},setControlsVisibility:function(i){for(var n in i||(i={}),i)this.setControlVisible(n,i[n]);return this},onDeselect:function(){},onSelect:function(){}})}(),g.util.object.extend(g.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(s,i){var n=function(){},l=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:s.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(a){s.set("left",a),t.requestRenderAll(),e()},onComplete:function(){s.setCoords(),l()}})},fxCenterObjectV:function(s,i){var n=function(){},l=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:s.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(a){s.set("top",a),t.requestRenderAll(),e()},onComplete:function(){s.setCoords(),l()}})},fxRemove:function(s,i){var n=function(){},l=(i=i||{}).onComplete||n,e=i.onChange||n,t=this;return g.util.animate({target:this,startValue:s.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(a){s.set("opacity",a),t.requestRenderAll(),e()},onComplete:function(){t.remove(s),l()}})}}),g.util.object.extend(g.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var s,i,n=[],l=[];for(s in arguments[0])n.push(s);for(var e=0,t=n.length;e<t;e++)s=n[e],i=e!==t-1,l.push(this._animate(s,arguments[0][s],arguments[1],i));return l}return this._animate.apply(this,arguments)},_animate:function(s,i,n,l){var e,t=this;i=i.toString(),n=n?g.util.object.clone(n):{},~s.indexOf(".")&&(e=s.split("."));var a=t.colorProperties.indexOf(s)>-1||e&&t.colorProperties.indexOf(e[1])>-1,c=e?this.get(e[0])[e[1]]:this.get(s);"from"in n||(n.from=c),a||(i=~i.indexOf("=")?c+parseFloat(i.replace("=","")):parseFloat(i));var o={target:this,startValue:n.from,endValue:i,byValue:n.by,easing:n.easing,duration:n.duration,abort:n.abort&&function(r,u,f){return n.abort.call(t,r,u,f)},onChange:function(r,u,f){e?t[e[0]][e[1]]=r:t.set(s,r),l||n.onChange&&n.onChange(r,u,f)},onComplete:function(r,u,f){l||(t.setCoords(),n.onComplete&&n.onComplete(r,u,f))}};return a?g.util.animateColor(o.startValue,o.endValue,o.duration,o):g.util.animate(o)}}),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.util.object.clone,e={x1:1,x2:1,y1:1,y2:1};function t(a,c){var o=a.origin,r=a.axis1,u=a.axis2,f=a.dimension,p=c.nearest,m=c.center,v=c.farthest;return function(){switch(this.get(o)){case p:return Math.min(this.get(r),this.get(u));case m:return Math.min(this.get(r),this.get(u))+.5*this.get(f);case v:return Math.max(this.get(r),this.get(u))}}}i.Line?i.warn("fabric.Line is already defined"):(i.Line=i.util.createClass(i.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:i.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(a,c){a||(a=[0,0,0,0]),this.callSuper("initialize",c),this.set("x1",a[0]),this.set("y1",a[1]),this.set("x2",a[2]),this.set("y2",a[3]),this._setWidthHeight(c)},_setWidthHeight:function(a){a||(a={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in a?a.left:this._getLeftToOriginX(),this.top="top"in a?a.top:this._getTopToOriginY()},_set:function(a,c){return this.callSuper("_set",a,c),e[a]!==void 0&&this._setWidthHeight(),this},_getLeftToOriginX:t({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:t({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(a){a.beginPath();var c=this.calcLinePoints();a.moveTo(c.x1,c.y1),a.lineTo(c.x2,c.y2),a.lineWidth=this.strokeWidth;var o=a.strokeStyle;a.strokeStyle=this.stroke||a.fillStyle,this.stroke&&this._renderStroke(a),a.strokeStyle=o},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(a){return n(this.callSuper("toObject",a),this.calcLinePoints())},_getNonTransformedDimensions:function(){var a=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(a.y-=this.strokeWidth),this.height===0&&(a.x-=this.strokeWidth)),a},calcLinePoints:function(){var a=this.x1<=this.x2?-1:1,c=this.y1<=this.y2?-1:1,o=a*this.width*.5,r=c*this.height*.5;return{x1:o,x2:a*this.width*-.5,y1:r,y2:c*this.height*-.5}},_toSVG:function(){var a=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',a.x1,'" y1="',a.y1,'" x2="',a.x2,'" y2="',a.y2,`" />
`]}}),i.Line.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),i.Line.fromElement=function(a,c,o){o=o||{};var r=i.parseAttributes(a,i.Line.ATTRIBUTE_NAMES),u=[r.x1||0,r.y1||0,r.x2||0,r.y2||0];c(new i.Line(u,n(r,o)))},i.Line.fromObject=function(a,c){var o=l(a,!0);o.points=[a.x1,a.y1,a.x2,a.y2],i.Object._fromObject("Line",o,function(r){delete r.points,c&&c(r)},"points")})}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.degreesToRadians;i.Circle?i.warn("fabric.Circle is already defined."):(i.Circle=i.util.createClass(i.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:i.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(l,e){return this.callSuper("_set",l,e),l==="radius"&&this.setRadius(e),this},toObject:function(l){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(l))},_toSVG:function(){var l,e=(this.endAngle-this.startAngle)%360;if(e===0)l=["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,`" />
`];else{var t=n(this.startAngle),a=n(this.endAngle),c=this.radius;l=['<path d="M '+i.util.cos(t)*c+" "+i.util.sin(t)*c," A "+c+" "+c," 0 ",+(e>180?"1":"0")+" 1"," "+i.util.cos(a)*c+" "+i.util.sin(a)*c,'" ',"COMMON_PARTS",` />
`]}return l},_render:function(l){l.beginPath(),l.arc(0,0,this.radius,n(this.startAngle),n(this.endAngle),!1),this._renderPaintInOrder(l)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(l){return this.radius=l,this.set("width",2*l).set("height",2*l)}}),i.Circle.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),i.Circle.fromElement=function(l,e){var t,a=i.parseAttributes(l,i.Circle.ATTRIBUTE_NAMES);if(!("radius"in(t=a)&&t.radius>=0))throw new Error("value of `r` attribute is required and can not be negative");a.left=(a.left||0)-a.radius,a.top=(a.top||0)-a.radius,e(new i.Circle(a))},i.Circle.fromObject=function(l,e){i.Object._fromObject("Circle",l,e)})}(h),function(s){var i=s.fabric||(s.fabric={});i.Triangle?i.warn("fabric.Triangle is already defined"):(i.Triangle=i.util.createClass(i.Object,{type:"triangle",width:100,height:100,_render:function(n){var l=this.width/2,e=this.height/2;n.beginPath(),n.moveTo(-l,e),n.lineTo(0,-e),n.lineTo(l,e),n.closePath(),this._renderPaintInOrder(n)},_toSVG:function(){var n=this.width/2,l=this.height/2;return["<polygon ","COMMON_PARTS",'points="',[-n+" "+l,"0 "+-l,n+" "+l].join(","),'" />']}}),i.Triangle.fromObject=function(n,l){return i.Object._fromObject("Triangle",n,l)})}(h),function(s){var i=s.fabric||(s.fabric={}),n=2*Math.PI;i.Ellipse?i.warn("fabric.Ellipse is already defined."):(i.Ellipse=i.util.createClass(i.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(l){this.callSuper("initialize",l),this.set("rx",l&&l.rx||0),this.set("ry",l&&l.ry||0)},_set:function(l,e){switch(this.callSuper("_set",l,e),l){case"rx":this.rx=e,this.set("width",2*e);break;case"ry":this.ry=e,this.set("height",2*e)}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(l){return this.callSuper("toObject",["rx","ry"].concat(l))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(l){l.beginPath(),l.save(),l.transform(1,0,0,this.ry/this.rx,0,0),l.arc(0,0,this.rx,0,n,!1),l.restore(),this._renderPaintInOrder(l)}}),i.Ellipse.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),i.Ellipse.fromElement=function(l,e){var t=i.parseAttributes(l,i.Ellipse.ATTRIBUTE_NAMES);t.left=(t.left||0)-t.rx,t.top=(t.top||0)-t.ry,e(new i.Ellipse(t))},i.Ellipse.fromObject=function(l,e){i.Object._fromObject("Ellipse",l,e)})}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend;i.Rect?i.warn("fabric.Rect is already defined"):(i.Rect=i.util.createClass(i.Object,{stateProperties:i.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:i.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(l){this.callSuper("initialize",l),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(l){var e=this.rx?Math.min(this.rx,this.width/2):0,t=this.ry?Math.min(this.ry,this.height/2):0,a=this.width,c=this.height,o=-this.width/2,r=-this.height/2,u=e!==0||t!==0,f=.4477152502;l.beginPath(),l.moveTo(o+e,r),l.lineTo(o+a-e,r),u&&l.bezierCurveTo(o+a-f*e,r,o+a,r+f*t,o+a,r+t),l.lineTo(o+a,r+c-t),u&&l.bezierCurveTo(o+a,r+c-f*t,o+a-f*e,r+c,o+a-e,r+c),l.lineTo(o+e,r+c),u&&l.bezierCurveTo(o+f*e,r+c,o,r+c-f*t,o,r+c-t),l.lineTo(o,r+t),u&&l.bezierCurveTo(o,r+f*t,o+f*e,r,o+e,r),l.closePath(),this._renderPaintInOrder(l)},toObject:function(l){return this.callSuper("toObject",["rx","ry"].concat(l))},_toSVG:function(){return["<rect ","COMMON_PARTS",'x="',-this.width/2,'" y="',-this.height/2,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),i.Rect.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),i.Rect.fromElement=function(l,e,t){if(!l)return e(null);t=t||{};var a=i.parseAttributes(l,i.Rect.ATTRIBUTE_NAMES);a.left=a.left||0,a.top=a.top||0,a.height=a.height||0,a.width=a.width||0;var c=new i.Rect(n(t?i.util.object.clone(t):{},a));c.visible=c.visible&&c.width>0&&c.height>0,e(c)},i.Rect.fromObject=function(l,e){return i.Object._fromObject("Rect",l,e)})}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.util.array.min,e=i.util.array.max,t=i.util.toFixed,a=i.util.projectStrokeOnPoints;i.Polyline?i.warn("fabric.Polyline is already defined"):(i.Polyline=i.util.createClass(i.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:i.Object.prototype.cacheProperties.concat("points"),initialize:function(c,o){o=o||{},this.points=c||[],this.callSuper("initialize",o),this._setPositionDimensions(o)},_projectStrokeOnPoints:function(){return a(this.points,this,!0)},_setPositionDimensions:function(c){var o,r=this._calcDimensions(c),u=this.exactBoundingBox?this.strokeWidth:0;this.width=r.width-u,this.height=r.height-u,c.fromSVG||(o=this.translateToGivenOrigin({x:r.left-this.strokeWidth/2+u/2,y:r.top-this.strokeWidth/2+u/2},"left","top",this.originX,this.originY)),c.left===void 0&&(this.left=c.fromSVG?r.left:o.x),c.top===void 0&&(this.top=c.fromSVG?r.top:o.y),this.pathOffset={x:r.left+this.width/2+u/2,y:r.top+this.height/2+u/2}},_calcDimensions:function(){var c=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,o=l(c,"x")||0,r=l(c,"y")||0;return{left:o,top:r,width:(e(c,"x")||0)-o,height:(e(c,"y")||0)-r}},toObject:function(c){return n(this.callSuper("toObject",c),{points:this.points.concat()})},_toSVG:function(){for(var c=[],o=this.pathOffset.x,r=this.pathOffset.y,u=i.Object.NUM_FRACTION_DIGITS,f=0,p=this.points.length;f<p;f++)c.push(t(this.points[f].x-o,u),",",t(this.points[f].y-r,u)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',c.join(""),`" />
`]},commonRender:function(c){var o,r=this.points.length,u=this.pathOffset.x,f=this.pathOffset.y;if(!r||isNaN(this.points[r-1].y))return!1;c.beginPath(),c.moveTo(this.points[0].x-u,this.points[0].y-f);for(var p=0;p<r;p++)o=this.points[p],c.lineTo(o.x-u,o.y-f);return!0},_render:function(c){this.commonRender(c)&&this._renderPaintInOrder(c)},complexity:function(){return this.get("points").length}}),i.Polyline.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polyline.fromElementGenerator=function(c){return function(o,r,u){if(!o)return r(null);u||(u={});var f=i.parsePointsAttribute(o.getAttribute("points")),p=i.parseAttributes(o,i[c].ATTRIBUTE_NAMES);p.fromSVG=!0,r(new i[c](f,n(p,u)))}},i.Polyline.fromElement=i.Polyline.fromElementGenerator("Polyline"),i.Polyline.fromObject=function(c,o){return i.Object._fromObject("Polyline",c,o,"points")})}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.projectStrokeOnPoints;i.Polygon?i.warn("fabric.Polygon is already defined"):(i.Polygon=i.util.createClass(i.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return n(this.points,this)},_render:function(l){this.commonRender(l)&&(l.closePath(),this._renderPaintInOrder(l))}}),i.Polygon.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(),i.Polygon.fromElement=i.Polyline.fromElementGenerator("Polygon"),i.Polygon.fromObject=function(l,e){i.Object._fromObject("Polygon",l,e,"points")})}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.array.min,l=i.util.array.max,e=i.util.object.extend,t=i.util.object.clone,a=i.util.toFixed;i.Path?i.warn("fabric.Path is already defined"):(i.Path=i.util.createClass(i.Object,{type:"path",path:null,cacheProperties:i.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:i.Object.prototype.stateProperties.concat("path"),initialize:function(c,o){delete(o=t(o||{})).path,this.callSuper("initialize",o),this._setPath(c||[],o)},_setPath:function(c,o){this.path=i.util.makePathSimpler(Array.isArray(c)?c:i.util.parsePath(c)),i.Polyline.prototype._setPositionDimensions.call(this,o||{})},_renderPathCommands:function(c){var o,r=0,u=0,f=0,p=0,m=0,v=0,y=-this.pathOffset.x,C=-this.pathOffset.y;c.beginPath();for(var R=0,M=this.path.length;R<M;++R)switch((o=this.path[R])[0]){case"L":f=o[1],p=o[2],c.lineTo(f+y,p+C);break;case"M":r=f=o[1],u=p=o[2],c.moveTo(f+y,p+C);break;case"C":f=o[5],p=o[6],m=o[3],v=o[4],c.bezierCurveTo(o[1]+y,o[2]+C,m+y,v+C,f+y,p+C);break;case"Q":c.quadraticCurveTo(o[1]+y,o[2]+C,o[3]+y,o[4]+C),f=o[3],p=o[4],m=o[1],v=o[2];break;case"z":case"Z":f=r,p=u,c.closePath()}},_render:function(c){this._renderPathCommands(c),this._renderPaintInOrder(c)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(c){return e(this.callSuper("toObject",c),{path:this.path.map(function(o){return o.slice()})})},toDatalessObject:function(c){var o=this.toObject(["sourcePath"].concat(c));return o.sourcePath&&delete o.path,o},_toSVG:function(){return["<path ","COMMON_PARTS",'d="',i.util.joinPath(this.path),'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var c=i.Object.NUM_FRACTION_DIGITS;return" translate("+a(-this.pathOffset.x,c)+", "+a(-this.pathOffset.y,c)+")"},toClipPathSVG:function(c){var o=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:c,additionalTransform:o})},toSVG:function(c){var o=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:c,additionalTransform:o})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var c,o,r=[],u=[],f=0,p=0,m=0,v=0,y=0,C=this.path.length;y<C;++y){switch((c=this.path[y])[0]){case"L":m=c[1],v=c[2],o=[];break;case"M":f=m=c[1],p=v=c[2],o=[];break;case"C":o=i.util.getBoundsOfCurve(m,v,c[1],c[2],c[3],c[4],c[5],c[6]),m=c[5],v=c[6];break;case"Q":o=i.util.getBoundsOfCurve(m,v,c[1],c[2],c[1],c[2],c[3],c[4]),m=c[3],v=c[4];break;case"z":case"Z":m=f,v=p}o.forEach(function(W){r.push(W.x),u.push(W.y)}),r.push(m),u.push(v)}var R=n(r)||0,M=n(u)||0;return{left:R,top:M,width:(l(r)||0)-R,height:(l(u)||0)-M}}}),i.Path.fromObject=function(c,o){if(typeof c.sourcePath=="string"){var r=c.sourcePath;i.loadSVGFromURL(r,function(u){var f=u[0];f.setOptions(c),o&&o(f)})}else i.Object._fromObject("Path",c,o,"path")},i.Path.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat(["d"]),i.Path.fromElement=function(c,o,r){var u=i.parseAttributes(c,i.Path.ATTRIBUTE_NAMES);u.fromSVG=!0,o(new i.Path(u.d,e(u,r)))})}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.array.min,l=i.util.array.max;i.Group||(i.Group=i.util.createClass(i.Object,i.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(e,t,a){t=t||{},this._objects=[],a&&this.callSuper("initialize",t),this._objects=e||[];for(var c=this._objects.length;c--;)this._objects[c].group=this;if(a)this._updateObjectsACoords();else{var o=t&&t.centerPoint;t.originX!==void 0&&(this.originX=t.originX),t.originY!==void 0&&(this.originY=t.originY),o||this._calcBounds(),this._updateObjectsCoords(o),delete t.centerPoint,this.callSuper("initialize",t)}this.setCoords()},_updateObjectsACoords:function(){for(var e=this._objects.length;e--;)this._objects[e].setCoords(!0)},_updateObjectsCoords:function(e){e=e||this.getCenterPoint();for(var t=this._objects.length;t--;)this._updateObjectCoords(this._objects[t],e)},_updateObjectCoords:function(e,t){var a=e.left,c=e.top;e.set({left:a-t.x,top:c-t.y}),e.group=this,e.setCoords(!0)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(e){var t=!!this.group;return this._restoreObjectsState(),i.util.resetObjectTransform(this),e&&(t&&i.util.removeTransformFromObject(e,this.group.calcTransformMatrix()),this._objects.push(e),e.group=this,e._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,t?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(e){return this._restoreObjectsState(),i.util.resetObjectTransform(this),this.remove(e),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(e){this.dirty=!0,e.group=this,e._set("canvas",this.canvas)},_onObjectRemoved:function(e){this.dirty=!0,delete e.group},_set:function(e,t){var a=this._objects.length;if(this.useSetOnGroup)for(;a--;)this._objects[a].setOnGroup(e,t);if(e==="canvas")for(;a--;)this._objects[a]._set(e,t);i.Object.prototype._set.call(this,e,t)},toObject:function(e){var t=this.includeDefaultValues,a=this._objects.filter(function(o){return!o.excludeFromExport}).map(function(o){var r=o.includeDefaultValues;o.includeDefaultValues=t;var u=o.toObject(e);return o.includeDefaultValues=r,u}),c=i.Object.prototype.toObject.call(this,e);return c.objects=a,c},toDatalessObject:function(e){var t,a=this.sourcePath;if(a)t=a;else{var c=this.includeDefaultValues;t=this._objects.map(function(r){var u=r.includeDefaultValues;r.includeDefaultValues=c;var f=r.toDatalessObject(e);return r.includeDefaultValues=u,f})}var o=i.Object.prototype.toDatalessObject.call(this,e);return o.objects=t,o},render:function(e){this._transformDone=!0,this.callSuper("render",e),this._transformDone=!1},shouldCache:function(){var e=i.Object.prototype.shouldCache.call(this);if(e){for(var t=0,a=this._objects.length;t<a;t++)if(this._objects[t].willDrawShadow())return this.ownCaching=!1,!1}return e},willDrawShadow:function(){if(i.Object.prototype.willDrawShadow.call(this))return!0;for(var e=0,t=this._objects.length;e<t;e++)if(this._objects[e].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(e){for(var t=0,a=this._objects.length;t<a;t++)this._objects[t].render(e);this._drawClipPath(e,this.clipPath)},isCacheDirty:function(e){if(this.callSuper("isCacheDirty",e))return!0;if(!this.statefullCache)return!1;for(var t=0,a=this._objects.length;t<a;t++)if(this._objects[t].isCacheDirty(!0)){if(this._cacheCanvas){var c=this.cacheWidth/this.zoomX,o=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-c/2,-o/2,c,o)}return!0}return!1},_restoreObjectsState:function(){var e=this.calcOwnMatrix();return this._objects.forEach(function(t){i.util.addTransformToObject(t,e),delete t.group,t.setCoords()}),this},destroy:function(){return this._objects.forEach(function(e){e.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(e){e.dispose&&e.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var e=this._objects,t=this.canvas;this._objects=[];var a=this.toObject();delete a.objects;var c=new i.ActiveSelection([]);return c.set(a),c.type="activeSelection",t.remove(this),e.forEach(function(o){o.group=c,o.dirty=!0,t.add(o)}),c.canvas=t,c._objects=e,t._activeObject=c,c.setCoords(),c}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){return this.forEachObject(function(e){e.setCoords(!0)}),this},_calcBounds:function(e){for(var t,a,c,o,r=[],u=[],f=["tr","br","bl","tl"],p=0,m=this._objects.length,v=f.length;p<m;++p){for(c=(t=this._objects[p]).calcACoords(),o=0;o<v;o++)a=f[o],r.push(c[a].x),u.push(c[a].y);t.aCoords=c}this._getBounds(r,u,e)},_getBounds:function(e,t,a){var c=new i.Point(n(e),n(t)),o=new i.Point(l(e),l(t)),r=c.y||0,u=c.x||0,f=o.x-c.x||0,p=o.y-c.y||0;this.width=f,this.height=p,a||this.setPositionByOrigin({x:u,y:r},"left","top")},_toSVG:function(e){for(var t=["<g ","COMMON_PARTS",` >
`],a=0,c=this._objects.length;a<c;a++)t.push("		",this._objects[a].toSVG(e));return t.push(`</g>
`),t},getSvgStyles:function(){var e=this.opacity!==void 0&&this.opacity!==1?"opacity: "+this.opacity+";":"",t=this.visible?"":" visibility: hidden;";return[e,this.getSvgFilter(),t].join("")},toClipPathSVG:function(e){for(var t=[],a=0,c=this._objects.length;a<c;a++)t.push("	",this._objects[a].toClipPathSVG(e));return this._createBaseClipPathSVGMarkup(t,{reviver:e})}}),i.Group.fromObject=function(e,t){var a=e.objects,c=i.util.object.clone(e,!0);delete c.objects,typeof a!="string"?i.util.enlivenObjects(a,function(o){var r=i.util.object.clone(e,!0);delete r.objects,i.util.enlivenObjectEnlivables(e,r,function(){t&&t(new i.Group(o,r,!0))})}):i.loadSVGFromURL(a,function(o){var r=i.util.groupSVGElements(o,e,a);r.set(c),t&&t(r)})})}(h),function(s){var i=s.fabric||(s.fabric={});i.ActiveSelection||(i.ActiveSelection=i.util.createClass(i.Group,{type:"activeSelection",initialize:function(n,l){l=l||{},this._objects=n||[];for(var e=this._objects.length;e--;)this._objects[e].group=this;l.originX&&(this.originX=l.originX),l.originY&&(this.originY=l.originY),this._calcBounds(),this._updateObjectsCoords(),i.Object.prototype.initialize.call(this,l),this.setCoords()},toGroup:function(){var n=this._objects.concat();this._objects=[];var l=i.Object.prototype.toObject.call(this),e=new i.Group([]);if(delete l.type,e.set(l),n.forEach(function(a){a.canvas.remove(a),a.group=e}),e._objects=n,!this.canvas)return e;var t=this.canvas;return t.add(e),t._activeObject=e,e.setCoords(),e},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(n,l,e){n.save(),n.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",n,l),(e=e||{}).hasControls===void 0&&(e.hasControls=!1),e.forActiveSelection=!0;for(var t=0,a=this._objects.length;t<a;t++)this._objects[t]._renderControls(n,e);n.restore()}}),i.ActiveSelection.fromObject=function(n,l){i.util.enlivenObjects(n.objects,function(e){delete n.objects,l&&l(new i.ActiveSelection(e,n,!0))})})}(h),function(s){var i=g.util.object.extend;s.fabric||(s.fabric={}),s.fabric.Image?g.warn("fabric.Image is already defined."):(g.Image=g.util.createClass(g.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:g.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:g.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(n,l){l||(l={}),this.filters=[],this.cacheKey="texture"+g.Object.__uid++,this.callSuper("initialize",l),this._initElement(n,l)},getElement:function(){return this._element||{}},setElement:function(n,l){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=n,this._originalElement=n,this._initConfig(l),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(n){var l=g.filterBackend;l&&l.evictCachesForKey&&l.evictCachesForKey(n)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(n){g.util.cleanUpJsdomNode(this[n]),this[n]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var n=this.getElement();return{width:n.naturalWidth||n.width,height:n.naturalHeight||n.height}},_stroke:function(n){if(this.stroke&&this.strokeWidth!==0){var l=this.width/2,e=this.height/2;n.beginPath(),n.moveTo(-l,-e),n.lineTo(l,-e),n.lineTo(l,e),n.lineTo(-l,e),n.lineTo(-l,-e),n.closePath()}},toObject:function(n){var l=[];this.filters.forEach(function(t){t&&l.push(t.toObject())});var e=i(this.callSuper("toObject",["cropX","cropY"].concat(n)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:l});return this.resizeFilter&&(e.resizeFilter=this.resizeFilter.toObject()),e},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var n,l=[],e=[],t=this._element,a=-this.width/2,c=-this.height/2,o="",r="";if(!t)return[];if(this.hasCrop()){var u=g.Object.__uid++;l.push('<clipPath id="imageCrop_'+u+`">
`,'	<rect x="'+a+'" y="'+c+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),o=' clip-path="url(#imageCrop_'+u+')" '}if(this.imageSmoothing||(r='" image-rendering="optimizeSpeed'),e.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',a-this.cropX,'" y="',c-this.cropY,'" width="',t.width||t.naturalWidth,'" height="',t.height||t.height,r,'"',o,`></image>
`),this.stroke||this.strokeDashArray){var f=this.fill;this.fill=null,n=["	<rect ",'x="',a,'" y="',c,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=f}return this.paintFirst!=="fill"?l.concat(n,e):l.concat(e,n)},getSrc:function(n){var l=n?this._element:this._originalElement;return l?l.toDataURL?l.toDataURL():this.srcFromAttribute?l.getAttribute("src"):l.src:this.src||""},setSrc:function(n,l,e){return g.util.loadImage(n,function(t,a){this.setElement(t,e),this._setWidthHeight(),l&&l(this,a)},this,e&&e.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var n=this.resizeFilter,l=this.minimumScaleTrigger,e=this.getTotalObjectScaling(),t=e.scaleX,a=e.scaleY,c=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!n||t>l&&a>l)return this._element=c,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=t,void(this._lastScaleY=a);g.filterBackend||(g.filterBackend=g.initFilterBackend());var o=g.util.createCanvasElement(),r=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,u=c.width,f=c.height;o.width=u,o.height=f,this._element=o,this._lastScaleX=n.scaleX=t,this._lastScaleY=n.scaleY=a,g.filterBackend.applyFilters([n],c,u,f,this._element,r),this._filterScalingX=o.width/this._originalElement.width,this._filterScalingY=o.height/this._originalElement.height},applyFilters:function(n){if(n=(n=n||this.filters||[]).filter(function(c){return c&&!c.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),n.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var l=this._originalElement,e=l.naturalWidth||l.width,t=l.naturalHeight||l.height;if(this._element===this._originalElement){var a=g.util.createCanvasElement();a.width=e,a.height=t,this._element=a,this._filteredEl=a}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,e,t),this._lastScaleX=1,this._lastScaleY=1;return g.filterBackend||(g.filterBackend=g.initFilterBackend()),g.filterBackend.applyFilters(n,this._originalElement,e,t,this._element,this.cacheKey),this._originalElement.width===this._element.width&&this._originalElement.height===this._element.height||(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(n){g.util.setImageSmoothing(n,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(n),this._renderPaintInOrder(n)},drawCacheOnCanvas:function(n){g.util.setImageSmoothing(n,this.imageSmoothing),g.Object.prototype.drawCacheOnCanvas.call(this,n)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(n){var l=this._element;if(l){var e=this._filterScalingX,t=this._filterScalingY,a=this.width,c=this.height,o=Math.min,r=Math.max,u=r(this.cropX,0),f=r(this.cropY,0),p=l.naturalWidth||l.width,m=l.naturalHeight||l.height,v=u*e,y=f*t,C=o(a*e,p-v),R=o(c*t,m-y),M=-a/2,W=-c/2,j=o(a,p/e-u),I=o(c,m/t-f);l&&n.drawImage(l,v,y,C,R,M,W,j,I)}},_needsResize:function(){var n=this.getTotalObjectScaling();return n.scaleX!==this._lastScaleX||n.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(n,l){this.setElement(g.util.getById(n),l),g.util.addClass(this.getElement(),g.Image.CSS_CANVAS)},_initConfig:function(n){n||(n={}),this.setOptions(n),this._setWidthHeight(n)},_initFilters:function(n,l){n&&n.length?g.util.enlivenObjects(n,function(e){l&&l(e)},"fabric.Image.filters"):l&&l()},_setWidthHeight:function(n){n||(n={});var l=this.getElement();this.width=n.width||l.naturalWidth||l.width||0,this.height=n.height||l.naturalHeight||l.height||0},parsePreserveAspectRatioAttribute:function(){var n,l=g.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),e=this._element.width,t=this._element.height,a=1,c=1,o=0,r=0,u=0,f=0,p=this.width,m=this.height,v={width:p,height:m};return!l||l.alignX==="none"&&l.alignY==="none"?(a=p/e,c=m/t):(l.meetOrSlice==="meet"&&(n=(p-e*(a=c=g.util.findScaleToFit(this._element,v)))/2,l.alignX==="Min"&&(o=-n),l.alignX==="Max"&&(o=n),n=(m-t*c)/2,l.alignY==="Min"&&(r=-n),l.alignY==="Max"&&(r=n)),l.meetOrSlice==="slice"&&(n=e-p/(a=c=g.util.findScaleToCover(this._element,v)),l.alignX==="Mid"&&(u=n/2),l.alignX==="Max"&&(u=n),n=t-m/c,l.alignY==="Mid"&&(f=n/2),l.alignY==="Max"&&(f=n),e=p/a,t=m/c)),{width:e,height:t,scaleX:a,scaleY:c,offsetLeft:o,offsetTop:r,cropX:u,cropY:f}}}),g.Image.CSS_CANVAS="canvas-img",g.Image.prototype.getSvgSrc=g.Image.prototype.getSrc,g.Image.fromObject=function(n,l){var e=g.util.object.clone(n);g.util.loadImage(e.src,function(t,a){a?l&&l(null,!0):g.Image.prototype._initFilters.call(e,e.filters,function(c){e.filters=c||[],g.Image.prototype._initFilters.call(e,[e.resizeFilter],function(o){e.resizeFilter=o[0],g.util.enlivenObjectEnlivables(e,e,function(){var r=new g.Image(t,e);l(r,!1)})})})},null,e.crossOrigin)},g.Image.fromURL=function(n,l,e){g.util.loadImage(n,function(t,a){l&&l(new g.Image(t,e),a)},null,e&&e.crossOrigin)},g.Image.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),g.Image.fromElement=function(n,l,e){var t=g.parseAttributes(n,g.Image.ATTRIBUTE_NAMES);g.Image.fromURL(t["xlink:href"],l,i(e?g.util.object.clone(e):{},t))})}(h),g.util.object.extend(g.Object.prototype,{_getAngleValueForStraighten:function(){var s=this.angle%360;return s>0?90*Math.round((s-1)/90):90*Math.round(s/90)},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(s){var i=function(){},n=(s=s||{}).onComplete||i,l=s.onChange||i,e=this;return g.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(t){e.rotate(t),l()},onComplete:function(){e.setCoords(),n()}})}}),g.util.object.extend(g.StaticCanvas.prototype,{straightenObject:function(s){return s.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(s){return s.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function s(n,l){var e="precision "+l+` float;
void main(){}`,t=n.createShader(n.FRAGMENT_SHADER);return n.shaderSource(t,e),n.compileShader(t),!!n.getShaderParameter(t,n.COMPILE_STATUS)}function i(n){n&&n.tileSize&&(this.tileSize=n.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}g.isWebglSupported=function(n){if(g.isLikelyNode)return!1;n=n||g.WebglFilterBackend.prototype.tileSize;var l=document.createElement("canvas"),e=l.getContext("webgl")||l.getContext("experimental-webgl"),t=!1;if(e){g.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),t=g.maxTextureSize>=n;for(var a=["highp","mediump","lowp"],c=0;c<3;c++)if(s(e,a[c])){g.webGlPrecision=a[c];break}}return this.isSupported=t,t},g.WebglFilterBackend=i,i.prototype={tileSize:2048,resources:{},setupGLContext:function(n,l){this.dispose(),this.createWebGLCanvas(n,l),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(n,l)},chooseFastestCopyGLTo2DMethod:function(n,l){var e,t=window.performance!==void 0;try{new ImageData(1,1),e=!0}catch{e=!1}var a=typeof ArrayBuffer<"u",c=typeof Uint8ClampedArray<"u";if(t&&e&&a&&c){var o=g.util.createCanvasElement(),r=new ArrayBuffer(n*l*4);if(g.forceGLPutImageData)return this.imageBuffer=r,void(this.copyGLTo2D=Ee);var u,f,p={imageBuffer:r,destinationWidth:n,destinationHeight:l,targetCanvas:o};o.width=n,o.height=l,u=window.performance.now(),ve.call(p,this.gl,p),f=window.performance.now()-u,u=window.performance.now(),Ee.call(p,this.gl,p),f>window.performance.now()-u?(this.imageBuffer=r,this.copyGLTo2D=Ee):this.copyGLTo2D=ve}},createWebGLCanvas:function(n,l){var e=g.util.createCanvasElement();e.width=n,e.height=l;var t={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},a=e.getContext("webgl",t);a||(a=e.getContext("experimental-webgl",t)),a&&(a.clearColor(0,0,0,0),this.canvas=e,this.gl=a)},applyFilters:function(n,l,e,t,a,c){var o,r=this.gl;c&&(o=this.getCachedTexture(c,l));var u={originalWidth:l.width||l.originalWidth,originalHeight:l.height||l.originalHeight,sourceWidth:e,sourceHeight:t,destinationWidth:e,destinationHeight:t,context:r,sourceTexture:this.createTexture(r,e,t,!o&&l),targetTexture:this.createTexture(r,e,t),originalTexture:o||this.createTexture(r,e,t,!o&&l),passes:n.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:a},f=r.createFramebuffer();return r.bindFramebuffer(r.FRAMEBUFFER,f),n.forEach(function(p){p&&p.applyTo(u)}),function(p){var m=p.targetCanvas,v=m.width,y=m.height,C=p.destinationWidth,R=p.destinationHeight;v===C&&y===R||(m.width=C,m.height=R)}(u),this.copyGLTo2D(r,u),r.bindTexture(r.TEXTURE_2D,null),r.deleteTexture(u.sourceTexture),r.deleteTexture(u.targetTexture),r.deleteFramebuffer(f),a.getContext("2d").setTransform(1,0,0,1,0,0),u},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(n,l,e,t){var a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),t?n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t):n.texImage2D(n.TEXTURE_2D,0,n.RGBA,l,e,0,n.RGBA,n.UNSIGNED_BYTE,null),a},getCachedTexture:function(n,l){if(this.textureCache[n])return this.textureCache[n];var e=this.createTexture(this.gl,l.width,l.height,l);return this.textureCache[n]=e,e},evictCachesForKey:function(n){this.textureCache[n]&&(this.gl.deleteTexture(this.textureCache[n]),delete this.textureCache[n])},copyGLTo2D:ve,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var n=this.gl,l={renderer:"",vendor:""};if(!n)return l;var e=n.getExtension("WEBGL_debug_renderer_info");if(e){var t=n.getParameter(e.UNMASKED_RENDERER_WEBGL),a=n.getParameter(e.UNMASKED_VENDOR_WEBGL);t&&(l.renderer=t.toLowerCase()),a&&(l.vendor=a.toLowerCase())}return this.gpuInfo=l,l}}}(),function(){var s=function(){};function i(){}g.Canvas2dFilterBackend=i,i.prototype={evictCachesForKey:s,dispose:s,clearWebGLCaches:s,resources:{},applyFilters:function(n,l,e,t,a){var c=a.getContext("2d");c.drawImage(l,0,0,e,t);var o={sourceWidth:e,sourceHeight:t,imageData:c.getImageData(0,0,e,t),originalEl:l,originalImageData:c.getImageData(0,0,e,t),canvasEl:a,ctx:c,filterBackend:this};return n.forEach(function(r){r.applyTo(o)}),o.imageData.width===e&&o.imageData.height===t||(a.width=o.imageData.width,a.height=o.imageData.height),c.putImageData(o.imageData,0,0),o}}}(),g.Image=g.Image||{},g.Image.filters=g.Image.filters||{},g.Image.filters.BaseFilter=g.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(s){s&&this.setOptions(s)},setOptions:function(s){for(var i in s)this[i]=s[i]},createProgram:function(s,i,n){i=i||this.fragmentSource,n=n||this.vertexSource,g.webGlPrecision!=="highp"&&(i=i.replace(/precision highp float/g,"precision "+g.webGlPrecision+" float"));var l=s.createShader(s.VERTEX_SHADER);if(s.shaderSource(l,n),s.compileShader(l),!s.getShaderParameter(l,s.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+s.getShaderInfoLog(l));var e=s.createShader(s.FRAGMENT_SHADER);if(s.shaderSource(e,i),s.compileShader(e),!s.getShaderParameter(e,s.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+s.getShaderInfoLog(e));var t=s.createProgram();if(s.attachShader(t,l),s.attachShader(t,e),s.linkProgram(t),!s.getProgramParameter(t,s.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+s.getProgramInfoLog(t));var a=this.getAttributeLocations(s,t),c=this.getUniformLocations(s,t)||{};return c.uStepW=s.getUniformLocation(t,"uStepW"),c.uStepH=s.getUniformLocation(t,"uStepH"),{program:t,attributeLocations:a,uniformLocations:c}},getAttributeLocations:function(s,i){return{aPosition:s.getAttribLocation(i,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(s,i,n){var l=i.aPosition,e=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,e),s.enableVertexAttribArray(l),s.vertexAttribPointer(l,2,s.FLOAT,!1,0,0),s.bufferData(s.ARRAY_BUFFER,n,s.STATIC_DRAW)},_setupFrameBuffer:function(s){var i,n,l=s.context;s.passes>1?(i=s.destinationWidth,n=s.destinationHeight,s.sourceWidth===i&&s.sourceHeight===n||(l.deleteTexture(s.targetTexture),s.targetTexture=s.filterBackend.createTexture(l,i,n)),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,s.targetTexture,0)):(l.bindFramebuffer(l.FRAMEBUFFER,null),l.finish())},_swapTextures:function(s){s.passes--,s.pass++;var i=s.targetTexture;s.targetTexture=s.sourceTexture,s.sourceTexture=i},isNeutralState:function(){var s=this.mainParameter,i=g.Image.filters[this.type].prototype;if(s){if(Array.isArray(i[s])){for(var n=i[s].length;n--;)if(this[s][n]!==i[s][n])return!1;return!0}return i[s]===this[s]}return!1},applyTo:function(s){s.webgl?(this._setupFrameBuffer(s),this.applyToWebGL(s),this._swapTextures(s)):this.applyTo2d(s)},retrieveShader:function(s){return s.programCache.hasOwnProperty(this.type)||(s.programCache[this.type]=this.createProgram(s.context)),s.programCache[this.type]},applyToWebGL:function(s){var i=s.context,n=this.retrieveShader(s);s.pass===0&&s.originalTexture?i.bindTexture(i.TEXTURE_2D,s.originalTexture):i.bindTexture(i.TEXTURE_2D,s.sourceTexture),i.useProgram(n.program),this.sendAttributeData(i,n.attributeLocations,s.aPosition),i.uniform1f(n.uniformLocations.uStepW,1/s.sourceWidth),i.uniform1f(n.uniformLocations.uStepH,1/s.sourceHeight),this.sendUniformData(i,n.uniformLocations),i.viewport(0,0,s.destinationWidth,s.destinationHeight),i.drawArrays(i.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(s,i,n){s.activeTexture(n),s.bindTexture(s.TEXTURE_2D,i),s.activeTexture(s.TEXTURE0)},unbindAdditionalTexture:function(s,i){s.activeTexture(i),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(s){this[this.mainParameter]=s},sendUniformData:function(){},createHelpLayer:function(s){if(!s.helpLayer){var i=document.createElement("canvas");i.width=s.sourceWidth,i.height=s.sourceHeight,s.helpLayer=i}},toObject:function(){var s={type:this.type},i=this.mainParameter;return i&&(s[i]=this[i]),s},toJSON:function(){return this.toObject()}}),g.Image.filters.BaseFilter.fromObject=function(s,i){var n=new g.Image.filters[s.type](s);return i&&i(n),n},function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.ColorMatrix=l(n.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(e){this.callSuper("initialize",e),this.matrix=this.matrix.slice(0)},applyTo2d:function(e){var t,a,c,o,r,u=e.imageData.data,f=u.length,p=this.matrix,m=this.colorsOnly;for(r=0;r<f;r+=4)t=u[r],a=u[r+1],c=u[r+2],m?(u[r]=t*p[0]+a*p[1]+c*p[2]+255*p[4],u[r+1]=t*p[5]+a*p[6]+c*p[7]+255*p[9],u[r+2]=t*p[10]+a*p[11]+c*p[12]+255*p[14]):(o=u[r+3],u[r]=t*p[0]+a*p[1]+c*p[2]+o*p[3]+255*p[4],u[r+1]=t*p[5]+a*p[6]+c*p[7]+o*p[8]+255*p[9],u[r+2]=t*p[10]+a*p[11]+c*p[12]+o*p[13]+255*p[14],u[r+3]=t*p[15]+a*p[16]+c*p[17]+o*p[18]+255*p[19])},getUniformLocations:function(e,t){return{uColorMatrix:e.getUniformLocation(t,"uColorMatrix"),uConstants:e.getUniformLocation(t,"uConstants")}},sendUniformData:function(e,t){var a=this.matrix,c=[a[0],a[1],a[2],a[3],a[5],a[6],a[7],a[8],a[10],a[11],a[12],a[13],a[15],a[16],a[17],a[18]],o=[a[4],a[9],a[14],a[19]];e.uniformMatrix4fv(t.uColorMatrix,!1,c),e.uniform4fv(t.uConstants,o)}}),i.Image.filters.ColorMatrix.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Brightness=l(n.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(e){if(this.brightness!==0){var t,a=e.imageData.data,c=a.length,o=Math.round(255*this.brightness);for(t=0;t<c;t+=4)a[t]=a[t]+o,a[t+1]=a[t+1]+o,a[t+2]=a[t+2]+o}},getUniformLocations:function(e,t){return{uBrightness:e.getUniformLocation(t,"uBrightness")}},sendUniformData:function(e,t){e.uniform1f(t.uBrightness,this.brightness)}}),i.Image.filters.Brightness.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.Image.filters,e=i.util.createClass;l.Convolute=e(l.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(t){var a=Math.sqrt(this.matrix.length),c=this.type+"_"+a+"_"+(this.opaque?1:0),o=this.fragmentSource[c];return t.programCache.hasOwnProperty(c)||(t.programCache[c]=this.createProgram(t.context,o)),t.programCache[c]},applyTo2d:function(t){var a,c,o,r,u,f,p,m,v,y,C,R,M,W=t.imageData,j=W.data,I=this.matrix,T=Math.round(Math.sqrt(I.length)),D=Math.floor(T/2),U=W.width,L=W.height,B=t.ctx.createImageData(U,L),A=B.data,w=this.opaque?1:0;for(C=0;C<L;C++)for(y=0;y<U;y++){for(u=4*(C*U+y),a=0,c=0,o=0,r=0,M=0;M<T;M++)for(R=0;R<T;R++)f=y+R-D,(p=C+M-D)<0||p>=L||f<0||f>=U||(m=4*(p*U+f),v=I[M*T+R],a+=j[m]*v,c+=j[m+1]*v,o+=j[m+2]*v,w||(r+=j[m+3]*v));A[u]=a,A[u+1]=c,A[u+2]=o,A[u+3]=w?j[u+3]:r}t.imageData=B},getUniformLocations:function(t,a){return{uMatrix:t.getUniformLocation(a,"uMatrix"),uOpaque:t.getUniformLocation(a,"uOpaque"),uHalfSize:t.getUniformLocation(a,"uHalfSize"),uSize:t.getUniformLocation(a,"uSize")}},sendUniformData:function(t,a){t.uniform1fv(a.uMatrix,this.matrix)},toObject:function(){return n(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),i.Image.filters.Convolute.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Grayscale=l(n.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(e){var t,a,c=e.imageData.data,o=c.length,r=this.mode;for(t=0;t<o;t+=4)r==="average"?a=(c[t]+c[t+1]+c[t+2])/3:r==="lightness"?a=(Math.min(c[t],c[t+1],c[t+2])+Math.max(c[t],c[t+1],c[t+2]))/2:r==="luminosity"&&(a=.21*c[t]+.72*c[t+1]+.07*c[t+2]),c[t]=a,c[t+1]=a,c[t+2]=a},retrieveShader:function(e){var t=this.type+"_"+this.mode;if(!e.programCache.hasOwnProperty(t)){var a=this.fragmentSource[this.mode];e.programCache[t]=this.createProgram(e.context,a)}return e.programCache[t]},getUniformLocations:function(e,t){return{uMode:e.getUniformLocation(t,"uMode")}},sendUniformData:function(e,t){e.uniform1i(t.uMode,1)},isNeutralState:function(){return!1}}),i.Image.filters.Grayscale.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Invert=l(n.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(e){var t,a=e.imageData.data,c=a.length;for(t=0;t<c;t+=4)a[t]=255-a[t],a[t+1]=255-a[t+1],a[t+2]=255-a[t+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(e,t){return{uInvert:e.getUniformLocation(t,"uInvert")}},sendUniformData:function(e,t){e.uniform1i(t.uInvert,this.invert)}}),i.Image.filters.Invert.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.Image.filters,e=i.util.createClass;l.Noise=e(l.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(t){if(this.noise!==0){var a,c,o=t.imageData.data,r=o.length,u=this.noise;for(a=0,r=o.length;a<r;a+=4)c=(.5-Math.random())*u,o[a]+=c,o[a+1]+=c,o[a+2]+=c}},getUniformLocations:function(t,a){return{uNoise:t.getUniformLocation(a,"uNoise"),uSeed:t.getUniformLocation(a,"uSeed")}},sendUniformData:function(t,a){t.uniform1f(a.uNoise,this.noise/255),t.uniform1f(a.uSeed,Math.random())},toObject:function(){return n(this.callSuper("toObject"),{noise:this.noise})}}),i.Image.filters.Noise.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Pixelate=l(n.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(e){var t,a,c,o,r,u,f,p,m,v,y,C=e.imageData,R=C.data,M=C.height,W=C.width;for(a=0;a<M;a+=this.blocksize)for(c=0;c<W;c+=this.blocksize)for(o=R[t=4*a*W+4*c],r=R[t+1],u=R[t+2],f=R[t+3],v=Math.min(a+this.blocksize,M),y=Math.min(c+this.blocksize,W),p=a;p<v;p++)for(m=c;m<y;m++)R[t=4*p*W+4*m]=o,R[t+1]=r,R[t+2]=u,R[t+3]=f},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(e,t){return{uBlocksize:e.getUniformLocation(t,"uBlocksize"),uStepW:e.getUniformLocation(t,"uStepW"),uStepH:e.getUniformLocation(t,"uStepH")}},sendUniformData:function(e,t){e.uniform1f(t.uBlocksize,this.blocksize)}}),i.Image.filters.Pixelate.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.extend,l=i.Image.filters,e=i.util.createClass;l.RemoveColor=e(l.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(t){var a,c,o,r,u=t.imageData.data,f=255*this.distance,p=new i.Color(this.color).getSource(),m=[p[0]-f,p[1]-f,p[2]-f],v=[p[0]+f,p[1]+f,p[2]+f];for(a=0;a<u.length;a+=4)c=u[a],o=u[a+1],r=u[a+2],c>m[0]&&o>m[1]&&r>m[2]&&c<v[0]&&o<v[1]&&r<v[2]&&(u[a+3]=0)},getUniformLocations:function(t,a){return{uLow:t.getUniformLocation(a,"uLow"),uHigh:t.getUniformLocation(a,"uHigh")}},sendUniformData:function(t,a){var c=new i.Color(this.color).getSource(),o=parseFloat(this.distance),r=[0+c[0]/255-o,0+c[1]/255-o,0+c[2]/255-o,1],u=[c[0]/255+o,c[1]/255+o,c[2]/255+o,1];t.uniform4fv(a.uLow,r),t.uniform4fv(a.uHigh,u)},toObject:function(){return n(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),i.Image.filters.RemoveColor.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass,e={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var t in e)n[t]=l(n.ColorMatrix,{type:t,matrix:e[t],mainParameter:!1,colorsOnly:!0}),i.Image.filters[t].fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric,n=i.Image.filters,l=i.util.createClass;n.BlendColor=l(n.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(e){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[e]+`}
}`},retrieveShader:function(e){var t,a=this.type+"_"+this.mode;return e.programCache.hasOwnProperty(a)||(t=this.buildSource(this.mode),e.programCache[a]=this.createProgram(e.context,t)),e.programCache[a]},applyTo2d:function(e){var t,a,c,o,r,u,f,p=e.imageData.data,m=p.length,v=1-this.alpha;t=(f=new i.Color(this.color).getSource())[0]*this.alpha,a=f[1]*this.alpha,c=f[2]*this.alpha;for(var y=0;y<m;y+=4)switch(o=p[y],r=p[y+1],u=p[y+2],this.mode){case"multiply":p[y]=o*t/255,p[y+1]=r*a/255,p[y+2]=u*c/255;break;case"screen":p[y]=255-(255-o)*(255-t)/255,p[y+1]=255-(255-r)*(255-a)/255,p[y+2]=255-(255-u)*(255-c)/255;break;case"add":p[y]=o+t,p[y+1]=r+a,p[y+2]=u+c;break;case"diff":case"difference":p[y]=Math.abs(o-t),p[y+1]=Math.abs(r-a),p[y+2]=Math.abs(u-c);break;case"subtract":p[y]=o-t,p[y+1]=r-a,p[y+2]=u-c;break;case"darken":p[y]=Math.min(o,t),p[y+1]=Math.min(r,a),p[y+2]=Math.min(u,c);break;case"lighten":p[y]=Math.max(o,t),p[y+1]=Math.max(r,a),p[y+2]=Math.max(u,c);break;case"overlay":p[y]=t<128?2*o*t/255:255-2*(255-o)*(255-t)/255,p[y+1]=a<128?2*r*a/255:255-2*(255-r)*(255-a)/255,p[y+2]=c<128?2*u*c/255:255-2*(255-u)*(255-c)/255;break;case"exclusion":p[y]=t+o-2*t*o/255,p[y+1]=a+r-2*a*r/255,p[y+2]=c+u-2*c*u/255;break;case"tint":p[y]=t+o*v,p[y+1]=a+r*v,p[y+2]=c+u*v}},getUniformLocations:function(e,t){return{uColor:e.getUniformLocation(t,"uColor")}},sendUniformData:function(e,t){var a=new i.Color(this.color).getSource();a[0]=this.alpha*a[0]/255,a[1]=this.alpha*a[1]/255,a[2]=this.alpha*a[2]/255,a[3]=this.alpha,e.uniform4fv(t.uColor,a)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendColor.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric,n=i.Image.filters,l=i.util.createClass;n.BlendImage=l(n.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(e){var t=this.type+"_"+this.mode,a=this.fragmentSource[this.mode];return e.programCache.hasOwnProperty(t)||(e.programCache[t]=this.createProgram(e.context,a)),e.programCache[t]},applyToWebGL:function(e){var t=e.context,a=this.createTexture(e.filterBackend,this.image);this.bindAdditionalTexture(t,a,t.TEXTURE1),this.callSuper("applyToWebGL",e),this.unbindAdditionalTexture(t,t.TEXTURE1)},createTexture:function(e,t){return e.getCachedTexture(t.cacheKey,t._element)},calculateMatrix:function(){var e=this.image,t=e._element.width,a=e._element.height;return[1/e.scaleX,0,0,0,1/e.scaleY,0,-e.left/t,-e.top/a,1]},applyTo2d:function(e){var t,a,c,o,r,u,f,p,m,v,y,C=e.imageData,R=e.filterBackend.resources,M=C.data,W=M.length,j=C.width,I=C.height,T=this.image;R.blendImage||(R.blendImage=i.util.createCanvasElement()),v=(m=R.blendImage).getContext("2d"),m.width!==j||m.height!==I?(m.width=j,m.height=I):v.clearRect(0,0,j,I),v.setTransform(T.scaleX,0,0,T.scaleY,T.left,T.top),v.drawImage(T._element,0,0,j,I),y=v.getImageData(0,0,j,I).data;for(var D=0;D<W;D+=4)switch(r=M[D],u=M[D+1],f=M[D+2],p=M[D+3],t=y[D],a=y[D+1],c=y[D+2],o=y[D+3],this.mode){case"multiply":M[D]=r*t/255,M[D+1]=u*a/255,M[D+2]=f*c/255,M[D+3]=p*o/255;break;case"mask":M[D+3]=o}},getUniformLocations:function(e,t){return{uTransformMatrix:e.getUniformLocation(t,"uTransformMatrix"),uImage:e.getUniformLocation(t,"uImage")}},sendUniformData:function(e,t){var a=this.calculateMatrix();e.uniform1i(t.uImage,1),e.uniformMatrix3fv(t.uTransformMatrix,!1,a)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),i.Image.filters.BlendImage.fromObject=function(e,t){i.Image.fromObject(e.image,function(a){var c=i.util.object.clone(e);c.image=a,t(new i.Image.filters.BlendImage(c))})}}(h),function(s){var i=s.fabric||(s.fabric={}),n=Math.pow,l=Math.floor,e=Math.sqrt,t=Math.abs,a=Math.round,c=Math.sin,o=Math.ceil,r=i.Image.filters,u=i.util.createClass;r.Resize=u(r.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(f,p){return{uDelta:f.getUniformLocation(p,"uDelta"),uTaps:f.getUniformLocation(p,"uTaps")}},sendUniformData:function(f,p){f.uniform2fv(p.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),f.uniform1fv(p.uTaps,this.taps)},retrieveShader:function(f){var p=this.getFilterWindow(),m=this.type+"_"+p;if(!f.programCache.hasOwnProperty(m)){var v=this.generateShader(p);f.programCache[m]=this.createProgram(f.context,v)}return f.programCache[m]},getFilterWindow:function(){var f=this.tempScale;return Math.ceil(this.lanczosLobes/f)},getTaps:function(){for(var f=this.lanczosCreate(this.lanczosLobes),p=this.tempScale,m=this.getFilterWindow(),v=new Array(m),y=1;y<=m;y++)v[y-1]=f(y*p);return v},generateShader:function(f){for(var p=new Array(f),m=this.fragmentSourceTOP,v=1;v<=f;v++)p[v-1]=v+".0 * uDelta";return m+="uniform float uTaps["+f+`];
`,m+=`void main() {
`,m+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,m+=`  float sum = 1.0;
`,p.forEach(function(y,C){m+="  color += texture2D(uTexture, vTexCoord + "+y+") * uTaps["+C+`];
`,m+="  color += texture2D(uTexture, vTexCoord - "+y+") * uTaps["+C+`];
`,m+="  sum += 2.0 * uTaps["+C+`];
`}),m+=`  gl_FragColor = color / sum;
`,m+="}"},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(f){f.webgl?(f.passes++,this.width=f.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=f.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),f.destinationWidth=this.dW,this._setupFrameBuffer(f),this.applyToWebGL(f),this._swapTextures(f),f.sourceWidth=f.destinationWidth,this.height=f.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),f.destinationHeight=this.dH,this._setupFrameBuffer(f),this.applyToWebGL(f),this._swapTextures(f),f.sourceHeight=f.destinationHeight):this.applyTo2d(f)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(f){return function(p){if(p>=f||p<=-f)return 0;if(p<11920929e-14&&p>-11920929e-14)return 1;var m=(p*=Math.PI)/f;return c(p)/p*c(m)/m}},applyTo2d:function(f){var p=f.imageData,m=this.scaleX,v=this.scaleY;this.rcpScaleX=1/m,this.rcpScaleY=1/v;var y,C=p.width,R=p.height,M=a(C*m),W=a(R*v);this.resizeType==="sliceHack"?y=this.sliceByTwo(f,C,R,M,W):this.resizeType==="hermite"?y=this.hermiteFastResize(f,C,R,M,W):this.resizeType==="bilinear"?y=this.bilinearFiltering(f,C,R,M,W):this.resizeType==="lanczos"&&(y=this.lanczosResize(f,C,R,M,W)),f.imageData=y},sliceByTwo:function(f,p,m,v,y){var C,R,M=f.imageData,W=.5,j=!1,I=!1,T=p*W,D=m*W,U=i.filterBackend.resources,L=0,B=0,A=p,w=0;for(U.sliceByTwo||(U.sliceByTwo=document.createElement("canvas")),((C=U.sliceByTwo).width<1.5*p||C.height<m)&&(C.width=1.5*p,C.height=m),(R=C.getContext("2d")).clearRect(0,0,1.5*p,m),R.putImageData(M,0,0),v=l(v),y=l(y);!j||!I;)p=T,m=D,v<l(T*W)?T=l(T*W):(T=v,j=!0),y<l(D*W)?D=l(D*W):(D=y,I=!0),R.drawImage(C,L,B,p,m,A,w,T,D),L=A,B=w,w+=D;return R.getImageData(L,B,v,y)},lanczosResize:function(f,p,m,v,y){var C=f.imageData.data,R=f.ctx.createImageData(v,y),M=R.data,W=this.lanczosCreate(this.lanczosLobes),j=this.rcpScaleX,I=this.rcpScaleY,T=2/this.rcpScaleX,D=2/this.rcpScaleY,U=o(j*this.lanczosLobes/2),L=o(I*this.lanczosLobes/2),B={},A={},w={};return function k(V){var N,Y,K,te,Q,re,Z,oe,le,se,ue;for(A.x=(V+.5)*j,w.x=l(A.x),N=0;N<y;N++){for(A.y=(N+.5)*I,w.y=l(A.y),Q=0,re=0,Z=0,oe=0,le=0,Y=w.x-U;Y<=w.x+U;Y++)if(!(Y<0||Y>=p)){se=l(1e3*t(Y-A.x)),B[se]||(B[se]={});for(var ge=w.y-L;ge<=w.y+L;ge++)ge<0||ge>=m||(ue=l(1e3*t(ge-A.y)),B[se][ue]||(B[se][ue]=W(e(n(se*T,2)+n(ue*D,2))/1e3)),(K=B[se][ue])>0&&(Q+=K,re+=K*C[te=4*(ge*p+Y)],Z+=K*C[te+1],oe+=K*C[te+2],le+=K*C[te+3]))}M[te=4*(N*v+V)]=re/Q,M[te+1]=Z/Q,M[te+2]=oe/Q,M[te+3]=le/Q}return++V<v?k(V):R}(0)},bilinearFiltering:function(f,p,m,v,y){var C,R,M,W,j,I,T,D,U,L=0,B=this.rcpScaleX,A=this.rcpScaleY,w=4*(p-1),k=f.imageData.data,V=f.ctx.createImageData(v,y),N=V.data;for(M=0;M<y;M++)for(W=0;W<v;W++)for(j=B*W-(C=l(B*W)),I=A*M-(R=l(A*M)),U=4*(R*p+C),T=0;T<4;T++)D=k[U+T]*(1-j)*(1-I)+k[U+4+T]*j*(1-I)+k[U+w+T]*I*(1-j)+k[U+w+4+T]*j*I,N[L++]=D;return V},hermiteFastResize:function(f,p,m,v,y){for(var C=this.rcpScaleX,R=this.rcpScaleY,M=o(C/2),W=o(R/2),j=f.imageData.data,I=f.ctx.createImageData(v,y),T=I.data,D=0;D<y;D++)for(var U=0;U<v;U++){for(var L=4*(U+D*v),B=0,A=0,w=0,k=0,V=0,N=0,Y=0,K=(D+.5)*R,te=l(D*R);te<(D+1)*R;te++)for(var Q=t(K-(te+.5))/W,re=(U+.5)*C,Z=Q*Q,oe=l(U*C);oe<(U+1)*C;oe++){var le=t(re-(oe+.5))/M,se=e(Z+le*le);se>1&&se<-1||(B=2*se*se*se-3*se*se+1)>0&&(Y+=B*j[3+(le=4*(oe+te*p))],w+=B,j[le+3]<255&&(B=B*j[le+3]/250),k+=B*j[le],V+=B*j[le+1],N+=B*j[le+2],A+=B)}T[L]=k/A,T[L+1]=V/A,T[L+2]=N/A,T[L+3]=Y/w}return I},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),i.Image.filters.Resize.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Contrast=l(n.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(e){if(this.contrast!==0){var t,a=e.imageData.data,c=a.length,o=Math.floor(255*this.contrast),r=259*(o+255)/(255*(259-o));for(t=0;t<c;t+=4)a[t]=r*(a[t]-128)+128,a[t+1]=r*(a[t+1]-128)+128,a[t+2]=r*(a[t+2]-128)+128}},getUniformLocations:function(e,t){return{uContrast:e.getUniformLocation(t,"uContrast")}},sendUniformData:function(e,t){e.uniform1f(t.uContrast,this.contrast)}}),i.Image.filters.Contrast.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Saturation=l(n.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(e){if(this.saturation!==0){var t,a,c=e.imageData.data,o=c.length,r=-this.saturation;for(t=0;t<o;t+=4)a=Math.max(c[t],c[t+1],c[t+2]),c[t]+=a!==c[t]?(a-c[t])*r:0,c[t+1]+=a!==c[t+1]?(a-c[t+1])*r:0,c[t+2]+=a!==c[t+2]?(a-c[t+2])*r:0}},getUniformLocations:function(e,t){return{uSaturation:e.getUniformLocation(t,"uSaturation")}},sendUniformData:function(e,t){e.uniform1f(t.uSaturation,-this.saturation)}}),i.Image.filters.Saturation.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Vibrance=l(n.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(e){if(this.vibrance!==0){var t,a,c,o,r=e.imageData.data,u=r.length,f=-this.vibrance;for(t=0;t<u;t+=4)a=Math.max(r[t],r[t+1],r[t+2]),c=(r[t]+r[t+1]+r[t+2])/3,o=2*Math.abs(a-c)/255*f,r[t]+=a!==r[t]?(a-r[t])*o:0,r[t+1]+=a!==r[t+1]?(a-r[t+1])*o:0,r[t+2]+=a!==r[t+2]?(a-r[t+2])*o:0}},getUniformLocations:function(e,t){return{uVibrance:e.getUniformLocation(t,"uVibrance")}},sendUniformData:function(e,t){e.uniform1f(t.uVibrance,-this.vibrance)}}),i.Image.filters.Vibrance.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Blur=l(n.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(e){e.webgl?(this.aspectRatio=e.sourceWidth/e.sourceHeight,e.passes++,this._setupFrameBuffer(e),this.horizontal=!0,this.applyToWebGL(e),this._swapTextures(e),this._setupFrameBuffer(e),this.horizontal=!1,this.applyToWebGL(e),this._swapTextures(e)):this.applyTo2d(e)},applyTo2d:function(e){e.imageData=this.simpleBlur(e)},simpleBlur:function(e){var t,a,c=e.filterBackend.resources,o=e.imageData.width,r=e.imageData.height;c.blurLayer1||(c.blurLayer1=i.util.createCanvasElement(),c.blurLayer2=i.util.createCanvasElement()),t=c.blurLayer1,a=c.blurLayer2,t.width===o&&t.height===r||(a.width=t.width=o,a.height=t.height=r);var u,f,p,m,v=t.getContext("2d"),y=a.getContext("2d"),C=.06*this.blur*.5;for(v.putImageData(e.imageData,0,0),y.clearRect(0,0,o,r),m=-15;m<=15;m++)p=C*(f=m/15)*o+(u=(Math.random()-.5)/4),y.globalAlpha=1-Math.abs(f),y.drawImage(t,p,u),v.drawImage(a,0,0),y.globalAlpha=1,y.clearRect(0,0,a.width,a.height);for(m=-15;m<=15;m++)p=C*(f=m/15)*r+(u=(Math.random()-.5)/4),y.globalAlpha=1-Math.abs(f),y.drawImage(t,u,p),v.drawImage(a,0,0),y.globalAlpha=1,y.clearRect(0,0,a.width,a.height);e.ctx.drawImage(t,0,0);var R=e.ctx.getImageData(0,0,t.width,t.height);return v.globalAlpha=1,v.clearRect(0,0,t.width,t.height),R},getUniformLocations:function(e,t){return{delta:e.getUniformLocation(t,"uDelta")}},sendUniformData:function(e,t){var a=this.chooseRightDelta();e.uniform2fv(t.delta,a)},chooseRightDelta:function(){var e,t=1,a=[0,0];return this.horizontal?this.aspectRatio>1&&(t=1/this.aspectRatio):this.aspectRatio<1&&(t=this.aspectRatio),e=t*this.blur*.12,this.horizontal?a[0]=e:a[1]=e,a}}),n.Blur.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Gamma=l(n.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(e){this.gamma=[1,1,1],n.BaseFilter.prototype.initialize.call(this,e)},applyTo2d:function(e){var t,a=e.imageData.data,c=this.gamma,o=a.length,r=1/c[0],u=1/c[1],f=1/c[2];for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),t=0,o=256;t<o;t++)this.rVals[t]=255*Math.pow(t/255,r),this.gVals[t]=255*Math.pow(t/255,u),this.bVals[t]=255*Math.pow(t/255,f);for(t=0,o=a.length;t<o;t+=4)a[t]=this.rVals[a[t]],a[t+1]=this.gVals[a[t+1]],a[t+2]=this.bVals[a[t+2]]},getUniformLocations:function(e,t){return{uGamma:e.getUniformLocation(t,"uGamma")}},sendUniformData:function(e,t){e.uniform3fv(t.uGamma,this.gamma)}}),i.Image.filters.Gamma.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.Composed=l(n.BaseFilter,{type:"Composed",subFilters:[],initialize:function(e){this.callSuper("initialize",e),this.subFilters=this.subFilters.slice(0)},applyTo:function(e){e.passes+=this.subFilters.length-1,this.subFilters.forEach(function(t){t.applyTo(e)})},toObject:function(){return i.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(e){return e.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(e){return!e.isNeutralState()})}}),i.Image.filters.Composed.fromObject=function(e,t){var a=(e.subFilters||[]).map(function(o){return new i.Image.filters[o.type](o)}),c=new i.Image.filters.Composed({subFilters:a});return t&&t(c),c}}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.Image.filters,l=i.util.createClass;n.HueRotation=l(n.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var e=this.rotation*Math.PI,t=i.util.cos(e),a=i.util.sin(e),c=1/3,o=Math.sqrt(c)*a,r=1-t;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=t+r/3,this.matrix[1]=c*r-o,this.matrix[2]=c*r+o,this.matrix[5]=c*r+o,this.matrix[6]=t+c*r,this.matrix[7]=c*r-o,this.matrix[10]=c*r-o,this.matrix[11]=c*r+o,this.matrix[12]=t+c*r},isNeutralState:function(e){return this.calculateMatrix(),n.BaseFilter.prototype.isNeutralState.call(this,e)},applyTo:function(e){this.calculateMatrix(),n.BaseFilter.prototype.applyTo.call(this,e)}}),i.Image.filters.HueRotation.fromObject=i.Image.filters.BaseFilter.fromObject}(h),function(s){var i=s.fabric||(s.fabric={}),n=i.util.object.clone;if(i.Text)i.warn("fabric.Text is already defined");else{var l="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");i.Text=i.util.createClass(i.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:i.Object.prototype.stateProperties.concat(l),cacheProperties:i.Object.prototype.cacheProperties.concat(l),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(e,t){this.styles=t&&t.styles||{},this.text=e,this.__skipDimension=!0,this.callSuper("initialize",t),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var e=this.path;e&&(e.segmentsInfo=i.util.getPathSegmentsInfo(e.path))},getMeasuringContext:function(){return i._measuringContext||(i._measuringContext=this.canvas&&this.canvas.contextCache||i.util.createCanvasElement().getContext("2d")),i._measuringContext},_splitText:function(){var e=this._splitTextIntoLines(this.text);return this.textLines=e.lines,this._textLines=e.graphemeLines,this._unwrappedTextLines=e._unwrappedLines,this._text=e.graphemeText,e},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var e,t,a,c,o,r,u,f=0,p=this._textLines.length;f<p;f++)if((this.textAlign==="justify"||f!==p-1&&!this.isEndOfWrapping(f))&&(c=0,o=this._textLines[f],(t=this.getLineWidth(f))<this.width&&(u=this.textLines[f].match(this._reSpacesAndTabs)))){a=u.length,e=(this.width-t)/a;for(var m=0,v=o.length;m<=v;m++)r=this.__charBounds[f][m],this._reSpaceAndTab.test(o[m])?(r.width+=e,r.kernedWidth+=e,r.left+=c,c+=e):r.left+=c}},isEndOfWrapping:function(e){return e===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var e=this.callSuper("_getCacheCanvasDimensions"),t=this.fontSize;return e.width+=t*e.zoomX,e.height+=t*e.zoomY,e},_render:function(e){var t=this.path;t&&!t.isNotVisible()&&t._render(e),this._setTextStyles(e),this._renderTextLinesBackground(e),this._renderTextDecoration(e,"underline"),this._renderText(e),this._renderTextDecoration(e,"overline"),this._renderTextDecoration(e,"linethrough")},_renderText:function(e){this.paintFirst==="stroke"?(this._renderTextStroke(e),this._renderTextFill(e)):(this._renderTextFill(e),this._renderTextStroke(e))},_setTextStyles:function(e,t,a){if(e.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":e.textBaseline="middle";break;case"ascender":e.textBaseline="top";break;case"descender":e.textBaseline="bottom"}e.font=this._getFontDeclaration(t,a)},calcTextWidth:function(){for(var e=this.getLineWidth(0),t=1,a=this._textLines.length;t<a;t++){var c=this.getLineWidth(t);c>e&&(e=c)}return e},_renderTextLine:function(e,t,a,c,o,r){this._renderChars(e,t,a,c,o,r)},_renderTextLinesBackground:function(e){if(this.textBackgroundColor||this.styleHas("textBackgroundColor")){for(var t,a,c,o,r,u,f,p=e.fillStyle,m=this._getLeftOffset(),v=this._getTopOffset(),y=0,C=0,R=this.path,M=0,W=this._textLines.length;M<W;M++)if(t=this.getHeightOfLine(M),this.textBackgroundColor||this.styleHas("textBackgroundColor",M)){c=this._textLines[M],a=this._getLineLeftOffset(M),C=0,y=0,o=this.getValueOfPropertyAt(M,0,"textBackgroundColor");for(var j=0,I=c.length;j<I;j++)r=this.__charBounds[M][j],u=this.getValueOfPropertyAt(M,j,"textBackgroundColor"),R?(e.save(),e.translate(r.renderLeft,r.renderTop),e.rotate(r.angle),e.fillStyle=u,u&&e.fillRect(-r.width/2,-t/this.lineHeight*(1-this._fontSizeFraction),r.width,t/this.lineHeight),e.restore()):u!==o?(f=m+a+y,this.direction==="rtl"&&(f=this.width-f-C),e.fillStyle=o,o&&e.fillRect(f,v,C,t/this.lineHeight),y=r.left,C=r.width,o=u):C+=r.kernedWidth;u&&!R&&(f=m+a+y,this.direction==="rtl"&&(f=this.width-f-C),e.fillStyle=u,e.fillRect(f,v,C,t/this.lineHeight)),v+=t}else v+=t;e.fillStyle=p,this._removeShadow(e)}},getFontCache:function(e){var t=e.fontFamily.toLowerCase();i.charWidthsCache[t]||(i.charWidthsCache[t]={});var a=i.charWidthsCache[t],c=e.fontStyle.toLowerCase()+"_"+(e.fontWeight+"").toLowerCase();return a[c]||(a[c]={}),a[c]},_measureChar:function(e,t,a,c){var o,r,u,f,p=this.getFontCache(t),m=a+e,v=this._getFontDeclaration(t)===this._getFontDeclaration(c),y=t.fontSize/this.CACHE_FONT_SIZE;if(a&&p[a]!==void 0&&(u=p[a]),p[e]!==void 0&&(f=o=p[e]),v&&p[m]!==void 0&&(f=(r=p[m])-u),o===void 0||u===void 0||r===void 0){var C=this.getMeasuringContext();this._setTextStyles(C,t,!0)}return o===void 0&&(f=o=C.measureText(e).width,p[e]=o),u===void 0&&v&&a&&(u=C.measureText(a).width,p[a]=u),v&&r===void 0&&(r=C.measureText(m).width,p[m]=r,f=r-u),{width:o*y,kernedWidth:f*y}},getHeightOfChar:function(e,t){return this.getValueOfPropertyAt(e,t,"fontSize")},measureLine:function(e){var t=this._measureLine(e);return this.charSpacing!==0&&(t.width-=this._getWidthOfCharSpacing()),t.width<0&&(t.width=0),t},_measureLine:function(e){var t,a,c,o,r,u,f=0,p=this._textLines[e],m=new Array(p.length),v=0,y=this.path,C=this.pathSide==="right";for(this.__charBounds[e]=m,t=0;t<p.length;t++)a=p[t],o=this._getGraphemeBox(a,e,t,c),m[t]=o,f+=o.kernedWidth,c=a;if(m[t]={left:o?o.left+o.width:0,width:0,kernedWidth:0,height:this.fontSize},y){switch(u=y.segmentsInfo[y.segmentsInfo.length-1].length,(r=i.util.getPointOnPath(y.path,0,y.segmentsInfo)).x+=y.pathOffset.x,r.y+=y.pathOffset.y,this.textAlign){case"left":v=C?u-f:0;break;case"center":v=(u-f)/2;break;case"right":v=C?0:u-f}for(v+=this.pathStartOffset*(C?-1:1),t=C?p.length-1:0;C?t>=0:t<p.length;C?t--:t++)o=m[t],v>u?v%=u:v<0&&(v+=u),this._setGraphemeOnPath(v,o,r),v+=o.kernedWidth}return{width:f,numOfSpaces:0}},_setGraphemeOnPath:function(e,t,a){var c=e+t.kernedWidth/2,o=this.path,r=i.util.getPointOnPath(o.path,c,o.segmentsInfo);t.renderLeft=r.x-a.x,t.renderTop=r.y-a.y,t.angle=r.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(e,t,a,c,o){var r,u=this.getCompleteStyleDeclaration(t,a),f=c?this.getCompleteStyleDeclaration(t,a-1):{},p=this._measureChar(e,u,c,f),m=p.kernedWidth,v=p.width;this.charSpacing!==0&&(v+=r=this._getWidthOfCharSpacing(),m+=r);var y={width:v,left:0,height:u.fontSize,kernedWidth:m,deltaY:u.deltaY};if(a>0&&!o){var C=this.__charBounds[t][a-1];y.left=C.left+C.width+p.kernedWidth-p.width}return y},getHeightOfLine:function(e){if(this.__lineHeights[e])return this.__lineHeights[e];for(var t=this._textLines[e],a=this.getHeightOfChar(e,0),c=1,o=t.length;c<o;c++)a=Math.max(this.getHeightOfChar(e,c),a);return this.__lineHeights[e]=a*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var e,t=0,a=0,c=this._textLines.length;a<c;a++)e=this.getHeightOfLine(a),t+=a===c-1?e/this.lineHeight:e;return t},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(e,t){e.save();for(var a=0,c=this._getLeftOffset(),o=this._getTopOffset(),r=0,u=this._textLines.length;r<u;r++){var f=this.getHeightOfLine(r),p=f/this.lineHeight,m=this._getLineLeftOffset(r);this._renderTextLine(t,e,this._textLines[r],c+m,o+a+p,r),a+=f}e.restore()},_renderTextFill:function(e){(this.fill||this.styleHas("fill"))&&this._renderTextCommon(e,"fillText")},_renderTextStroke:function(e){(this.stroke&&this.strokeWidth!==0||!this.isEmptyStyles())&&(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this._setLineDash(e,this.strokeDashArray),e.beginPath(),this._renderTextCommon(e,"strokeText"),e.closePath(),e.restore())},_renderChars:function(e,t,a,c,o,r){var u,f,p,m,v,y=this.getHeightOfLine(r),C=this.textAlign.indexOf("justify")!==-1,R="",M=0,W=this.path,j=!C&&this.charSpacing===0&&this.isEmptyStyles(r)&&!W,I=this.direction==="ltr",T=this.direction==="ltr"?1:-1,D=t.canvas.getAttribute("dir");if(t.save(),D!==this.direction&&(t.canvas.setAttribute("dir",I?"ltr":"rtl"),t.direction=I?"ltr":"rtl",t.textAlign=I?"left":"right"),o-=y*this._fontSizeFraction/this.lineHeight,j)return this._renderChar(e,t,r,0,a.join(""),c,o,y),void t.restore();for(var U=0,L=a.length-1;U<=L;U++)m=U===L||this.charSpacing||W,R+=a[U],p=this.__charBounds[r][U],M===0?(c+=T*(p.kernedWidth-p.width),M+=p.width):M+=p.kernedWidth,C&&!m&&this._reSpaceAndTab.test(a[U])&&(m=!0),m||(u=u||this.getCompleteStyleDeclaration(r,U),f=this.getCompleteStyleDeclaration(r,U+1),m=this._hasStyleChanged(u,f)),m&&(W?(t.save(),t.translate(p.renderLeft,p.renderTop),t.rotate(p.angle),this._renderChar(e,t,r,U,R,-M/2,0,y),t.restore()):(v=c,this._renderChar(e,t,r,U,R,v,o,y)),R="",u=f,c+=T*M,M=0);t.restore()},_applyPatternGradientTransformText:function(e){var t,a=i.util.createCanvasElement(),c=this.width+this.strokeWidth,o=this.height+this.strokeWidth;return a.width=c,a.height=o,(t=a.getContext("2d")).beginPath(),t.moveTo(0,0),t.lineTo(c,0),t.lineTo(c,o),t.lineTo(0,o),t.closePath(),t.translate(c/2,o/2),t.fillStyle=e.toLive(t),this._applyPatternGradientTransform(t,e),t.fill(),t.createPattern(a,"no-repeat")},handleFiller:function(e,t,a){var c,o;return a.toLive?a.gradientUnits==="percentage"||a.gradientTransform||a.patternTransform?(c=-this.width/2,o=-this.height/2,e.translate(c,o),e[t]=this._applyPatternGradientTransformText(a),{offsetX:c,offsetY:o}):(e[t]=a.toLive(e,this),this._applyPatternGradientTransform(e,a)):(e[t]=a,{offsetX:0,offsetY:0})},_setStrokeStyles:function(e,t){return e.lineWidth=t.strokeWidth,e.lineCap=this.strokeLineCap,e.lineDashOffset=this.strokeDashOffset,e.lineJoin=this.strokeLineJoin,e.miterLimit=this.strokeMiterLimit,this.handleFiller(e,"strokeStyle",t.stroke)},_setFillStyles:function(e,t){return this.handleFiller(e,"fillStyle",t.fill)},_renderChar:function(e,t,a,c,o,r,u){var f,p,m=this._getStyleDeclaration(a,c),v=this.getCompleteStyleDeclaration(a,c),y=e==="fillText"&&v.fill,C=e==="strokeText"&&v.stroke&&v.strokeWidth;(C||y)&&(t.save(),y&&(f=this._setFillStyles(t,v)),C&&(p=this._setStrokeStyles(t,v)),t.font=this._getFontDeclaration(v),m&&m.textBackgroundColor&&this._removeShadow(t),m&&m.deltaY&&(u+=m.deltaY),y&&t.fillText(o,r-f.offsetX,u-f.offsetY),C&&t.strokeText(o,r-p.offsetX,u-p.offsetY),t.restore())},setSuperscript:function(e,t){return this._setScript(e,t,this.superscript)},setSubscript:function(e,t){return this._setScript(e,t,this.subscript)},_setScript:function(e,t,a){var c=this.get2DCursorLocation(e,!0),o=this.getValueOfPropertyAt(c.lineIndex,c.charIndex,"fontSize"),r=this.getValueOfPropertyAt(c.lineIndex,c.charIndex,"deltaY"),u={fontSize:o*a.size,deltaY:r+o*a.baseline};return this.setSelectionStyles(u,e,t),this},_hasStyleChanged:function(e,t){return e.fill!==t.fill||e.stroke!==t.stroke||e.strokeWidth!==t.strokeWidth||e.fontSize!==t.fontSize||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontStyle!==t.fontStyle||e.deltaY!==t.deltaY},_hasStyleChangedForSvg:function(e,t){return this._hasStyleChanged(e,t)||e.overline!==t.overline||e.underline!==t.underline||e.linethrough!==t.linethrough},_getLineLeftOffset:function(e){var t=this.getLineWidth(e),a=this.width-t,c=this.textAlign,o=this.direction,r=0,u=this.isEndOfWrapping(e);return c==="justify"||c==="justify-center"&&!u||c==="justify-right"&&!u||c==="justify-left"&&!u?0:(c==="center"&&(r=a/2),c==="right"&&(r=a),c==="justify-center"&&(r=a/2),c==="justify-right"&&(r=a),o==="rtl"&&(r-=a),r)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var e=this._forceClearCache;return e||(e=this.hasStateChanged("_dimensionAffectingProps")),e&&(this.dirty=!0,this._forceClearCache=!1),e},getLineWidth:function(e){if(this.__lineWidths[e]!==void 0)return this.__lineWidths[e];var t=this.measureLine(e).width;return this.__lineWidths[e]=t,t},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(e,t,a){var c=this._getStyleDeclaration(e,t);return c&&c[a]!==void 0?c[a]:this[a]},_renderTextDecoration:function(e,t){if(this[t]||this.styleHas(t)){for(var a,c,o,r,u,f,p,m,v,y,C,R,M,W,j,I,T=this._getLeftOffset(),D=this._getTopOffset(),U=this.path,L=this._getWidthOfCharSpacing(),B=this.offsets[t],A=0,w=this._textLines.length;A<w;A++)if(a=this.getHeightOfLine(A),this[t]||this.styleHas(t,A)){p=this._textLines[A],W=a/this.lineHeight,r=this._getLineLeftOffset(A),y=0,C=0,m=this.getValueOfPropertyAt(A,0,t),I=this.getValueOfPropertyAt(A,0,"fill"),v=D+W*(1-this._fontSizeFraction),c=this.getHeightOfChar(A,0),u=this.getValueOfPropertyAt(A,0,"deltaY");for(var k=0,V=p.length;k<V;k++)if(R=this.__charBounds[A][k],M=this.getValueOfPropertyAt(A,k,t),j=this.getValueOfPropertyAt(A,k,"fill"),o=this.getHeightOfChar(A,k),f=this.getValueOfPropertyAt(A,k,"deltaY"),U&&M&&j)e.save(),e.fillStyle=I,e.translate(R.renderLeft,R.renderTop),e.rotate(R.angle),e.fillRect(-R.kernedWidth/2,B*o+f,R.kernedWidth,this.fontSize/15),e.restore();else if((M!==m||j!==I||o!==c||f!==u)&&C>0){var N=T+r+y;this.direction==="rtl"&&(N=this.width-N-C),m&&I&&(e.fillStyle=I,e.fillRect(N,v+B*c+u,C,this.fontSize/15)),y=R.left,C=R.width,m=M,I=j,c=o,u=f}else C+=R.kernedWidth;N=T+r+y,this.direction==="rtl"&&(N=this.width-N-C),e.fillStyle=j,M&&j&&e.fillRect(N,v+B*c+u,C-L,this.fontSize/15),D+=a}else D+=a;this._removeShadow(e)}},_getFontDeclaration:function(e,t){var a=e||this,c=this.fontFamily,o=i.Text.genericFonts.indexOf(c.toLowerCase())>-1,r=c===void 0||c.indexOf("'")>-1||c.indexOf(",")>-1||c.indexOf('"')>-1||o?a.fontFamily:'"'+a.fontFamily+'"';return[i.isLikelyNode?a.fontWeight:a.fontStyle,i.isLikelyNode?a.fontStyle:a.fontWeight,t?this.CACHE_FONT_SIZE+"px":a.fontSize+"px",r].join(" ")},render:function(e){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",e)))},_splitTextIntoLines:function(e){for(var t=e.split(this._reNewline),a=new Array(t.length),c=[`
`],o=[],r=0;r<t.length;r++)a[r]=i.util.string.graphemeSplit(t[r]),o=o.concat(a[r],c);return o.pop(),{_unwrappedLines:a,lines:t,graphemeText:o,graphemeLines:a}},toObject:function(e){var t=l.concat(e),a=this.callSuper("toObject",t);return a.styles=n(this.styles,!0),a.path&&(a.path=this.path.toObject()),a},set:function(e,t){this.callSuper("set",e,t);var a=!1,c=!1;if(typeof e=="object")for(var o in e)o==="path"&&this.setPathInfo(),a=a||this._dimensionAffectingProps.indexOf(o)!==-1,c=c||o==="path";else a=this._dimensionAffectingProps.indexOf(e)!==-1,c=e==="path";return c&&this.setPathInfo(),a&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),i.Text.ATTRIBUTE_NAMES=i.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),i.Text.DEFAULT_SVG_FONT_SIZE=16,i.Text.fromElement=function(e,t,a){if(!e)return t(null);var c=i.parseAttributes(e,i.Text.ATTRIBUTE_NAMES),o=c.textAnchor||"left";if((a=i.util.object.extend(a?n(a):{},c)).top=a.top||0,a.left=a.left||0,c.textDecoration){var r=c.textDecoration;r.indexOf("underline")!==-1&&(a.underline=!0),r.indexOf("overline")!==-1&&(a.overline=!0),r.indexOf("line-through")!==-1&&(a.linethrough=!0),delete a.textDecoration}"dx"in c&&(a.left+=c.dx),"dy"in c&&(a.top+=c.dy),"fontSize"in a||(a.fontSize=i.Text.DEFAULT_SVG_FONT_SIZE);var u="";"textContent"in e?u=e.textContent:"firstChild"in e&&e.firstChild!==null&&"data"in e.firstChild&&e.firstChild.data!==null&&(u=e.firstChild.data),u=u.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var f=a.strokeWidth;a.strokeWidth=0;var p=new i.Text(u,a),m=p.getScaledHeight()/p.height,v=((p.height+p.strokeWidth)*p.lineHeight-p.height)*m,y=p.getScaledHeight()+v,C=0;o==="center"&&(C=p.getScaledWidth()/2),o==="right"&&(C=p.getScaledWidth()),p.set({left:p.left-C,top:p.top-(y-p.fontSize*(.07+p._fontSizeFraction))/p.lineHeight,strokeWidth:f!==void 0?f:1}),t(p)},i.Text.fromObject=function(e,t){var a=n(e),c=e.path;return delete a.path,i.Object._fromObject("Text",a,function(o){c?i.Object._fromObject("Path",c,function(r){o.set("path",r),t(o)},"path"):t(o)},"text")},i.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],i.util.createAccessors&&i.util.createAccessors(i.Text)}}(h),g.util.object.extend(g.Text.prototype,{isEmptyStyles:function(s){if(!this.styles||s!==void 0&&!this.styles[s])return!0;var i=s===void 0?this.styles:{line:this.styles[s]};for(var n in i)for(var l in i[n])for(var e in i[n][l])return!1;return!0},styleHas:function(s,i){if(!this.styles||!s||s===""||i!==void 0&&!this.styles[i])return!1;var n=i===void 0?this.styles:{0:this.styles[i]};for(var l in n)for(var e in n[l])if(n[l][e][s]!==void 0)return!0;return!1},cleanStyle:function(s){if(!this.styles||!s||s==="")return!1;var i,n,l=this.styles,e=0,t=!0,a=0;for(var c in l){for(var o in i=0,l[c]){var r;e++,(r=l[c][o]).hasOwnProperty(s)?(n?r[s]!==n&&(t=!1):n=r[s],r[s]===this[s]&&delete r[s]):t=!1,Object.keys(r).length!==0?i++:delete l[c][o]}i===0&&delete l[c]}for(var u=0;u<this._textLines.length;u++)a+=this._textLines[u].length;t&&e===a&&(this[s]=n,this.removeStyle(s))},removeStyle:function(s){if(this.styles&&s&&s!==""){var i,n,l,e=this.styles;for(n in e){for(l in i=e[n])delete i[l][s],Object.keys(i[l]).length===0&&delete i[l];Object.keys(i).length===0&&delete e[n]}}},_extendStyles:function(s,i){var n=this.get2DCursorLocation(s);this._getLineStyle(n.lineIndex)||this._setLineStyle(n.lineIndex),this._getStyleDeclaration(n.lineIndex,n.charIndex)||this._setStyleDeclaration(n.lineIndex,n.charIndex,{}),g.util.object.extend(this._getStyleDeclaration(n.lineIndex,n.charIndex),i)},get2DCursorLocation:function(s,i){s===void 0&&(s=this.selectionStart);for(var n=i?this._unwrappedTextLines:this._textLines,l=n.length,e=0;e<l;e++){if(s<=n[e].length)return{lineIndex:e,charIndex:s};s-=n[e].length+this.missingNewlineOffset(e)}return{lineIndex:e-1,charIndex:n[e-1].length<s?n[e-1].length:s}},getSelectionStyles:function(s,i,n){s===void 0&&(s=this.selectionStart||0),i===void 0&&(i=this.selectionEnd||s);for(var l=[],e=s;e<i;e++)l.push(this.getStyleAtPosition(e,n));return l},getStyleAtPosition:function(s,i){var n=this.get2DCursorLocation(s);return(i?this.getCompleteStyleDeclaration(n.lineIndex,n.charIndex):this._getStyleDeclaration(n.lineIndex,n.charIndex))||{}},setSelectionStyles:function(s,i,n){i===void 0&&(i=this.selectionStart||0),n===void 0&&(n=this.selectionEnd||i);for(var l=i;l<n;l++)this._extendStyles(l,s);return this._forceClearCache=!0,this},_getStyleDeclaration:function(s,i){var n=this.styles&&this.styles[s];return n?n[i]:null},getCompleteStyleDeclaration:function(s,i){for(var n,l=this._getStyleDeclaration(s,i)||{},e={},t=0;t<this._styleProperties.length;t++)e[n=this._styleProperties[t]]=l[n]===void 0?this[n]:l[n];return e},_setStyleDeclaration:function(s,i,n){this.styles[s][i]=n},_deleteStyleDeclaration:function(s,i){delete this.styles[s][i]},_getLineStyle:function(s){return!!this.styles[s]},_setLineStyle:function(s){this.styles[s]={}},_deleteLineStyle:function(s){delete this.styles[s]}}),function(){function s(i){i.textDecoration&&(i.textDecoration.indexOf("underline")>-1&&(i.underline=!0),i.textDecoration.indexOf("line-through")>-1&&(i.linethrough=!0),i.textDecoration.indexOf("overline")>-1&&(i.overline=!0),delete i.textDecoration)}g.IText=g.util.createClass(g.Text,g.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(i,n){this.callSuper("initialize",i,n),this.initBehavior()},setSelectionStart:function(i){i=Math.max(i,0),this._updateAndFire("selectionStart",i)},setSelectionEnd:function(i){i=Math.min(i,this.text.length),this._updateAndFire("selectionEnd",i)},_updateAndFire:function(i,n){this[i]!==n&&(this._fireSelectionChanged(),this[i]=n),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(i){this.clearContextTop(),this.callSuper("render",i),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(i){this.callSuper("_render",i)},clearContextTop:function(i){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var n=this.canvas.contextTop,l=this.canvas.viewportTransform;n.save(),n.transform(l[0],l[1],l[2],l[3],l[4],l[5]),this.transform(n),this._clearTextArea(n),i||n.restore()}},renderCursorOrSelection:function(){if(this.isEditing&&this.canvas&&this.canvas.contextTop){var i=this._getCursorBoundaries(),n=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(i,n):this.renderSelection(i,n),n.restore()}},_clearTextArea:function(i){var n=this.width+4,l=this.height+4;i.clearRect(-n/2,-l/2,n,l)},_getCursorBoundaries:function(i){i===void 0&&(i=this.selectionStart);var n=this._getLeftOffset(),l=this._getTopOffset(),e=this._getCursorBoundariesOffsets(i);return{left:n,top:l,leftOffset:e.left,topOffset:e.top}},_getCursorBoundariesOffsets:function(i){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var n,l,e,t,a=0,c=0,o=this.get2DCursorLocation(i);e=o.charIndex,l=o.lineIndex;for(var r=0;r<l;r++)a+=this.getHeightOfLine(r);n=this._getLineLeftOffset(l);var u=this.__charBounds[l][e];return u&&(c=u.left),this.charSpacing!==0&&e===this._textLines[l].length&&(c-=this._getWidthOfCharSpacing()),t={top:a,left:n+(c>0?c:0)},this.direction==="rtl"&&(t.left*=-1),this.cursorOffsetCache=t,this.cursorOffsetCache},renderCursor:function(i,n){var l=this.get2DCursorLocation(),e=l.lineIndex,t=l.charIndex>0?l.charIndex-1:0,a=this.getValueOfPropertyAt(e,t,"fontSize"),c=this.scaleX*this.canvas.getZoom(),o=this.cursorWidth/c,r=i.topOffset,u=this.getValueOfPropertyAt(e,t,"deltaY");r+=(1-this._fontSizeFraction)*this.getHeightOfLine(e)/this.lineHeight-a*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(i,n),n.fillStyle=this.cursorColor||this.getValueOfPropertyAt(e,t,"fill"),n.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,n.fillRect(i.left+i.leftOffset-o/2,r+i.top+u,o,a)},renderSelection:function(i,n){for(var l=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,e=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,t=this.textAlign.indexOf("justify")!==-1,a=this.get2DCursorLocation(l),c=this.get2DCursorLocation(e),o=a.lineIndex,r=c.lineIndex,u=a.charIndex<0?0:a.charIndex,f=c.charIndex<0?0:c.charIndex,p=o;p<=r;p++){var m,v=this._getLineLeftOffset(p)||0,y=this.getHeightOfLine(p),C=0,R=0;if(p===o&&(C=this.__charBounds[o][u].left),p>=o&&p<r)R=t&&!this.isEndOfWrapping(p)?this.width:this.getLineWidth(p)||5;else if(p===r)if(f===0)R=this.__charBounds[r][f].left;else{var M=this._getWidthOfCharSpacing();R=this.__charBounds[r][f-1].left+this.__charBounds[r][f-1].width-M}m=y,(this.lineHeight<1||p===r&&this.lineHeight>1)&&(y/=this.lineHeight);var W=i.left+v+C,j=R-C,I=y,T=0;this.inCompositionMode?(n.fillStyle=this.compositionColor||"black",I=1,T=y):n.fillStyle=this.selectionColor,this.direction==="rtl"&&(W=this.width-W-j),n.fillRect(W,i.top+i.topOffset+T,j,I),i.topOffset+=m}},getCurrentCharFontSize:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fontSize")},getCurrentCharColor:function(){var i=this._getCurrentCharIndex();return this.getValueOfPropertyAt(i.l,i.c,"fill")},_getCurrentCharIndex:function(){var i=this.get2DCursorLocation(this.selectionStart,!0),n=i.charIndex>0?i.charIndex-1:0;return{l:i.lineIndex,c:n}}}),g.IText.fromObject=function(i,n){if(s(i),i.styles)for(var l in i.styles)for(var e in i.styles[l])s(i.styles[l][e]);g.Object._fromObject("IText",i,n,"text")}}(),pe=g.util.object.clone,g.util.object.extend(g.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var s=this;this.on("added",function(){var i=s.canvas;i&&(i._hasITextHandlers||(i._hasITextHandlers=!0,s._initCanvasHandlers(i)),i._iTextInstances=i._iTextInstances||[],i._iTextInstances.push(s))})},initRemovedHandler:function(){var s=this;this.on("removed",function(){var i=s.canvas;i&&(i._iTextInstances=i._iTextInstances||[],g.util.removeFromArray(i._iTextInstances,s),i._iTextInstances.length===0&&(i._hasITextHandlers=!1,s._removeCanvasHandlers(i)))})},_initCanvasHandlers:function(s){s._mouseUpITextHandler=function(){s._iTextInstances&&s._iTextInstances.forEach(function(i){i.__isMousedown=!1})},s.on("mouse:up",s._mouseUpITextHandler)},_removeCanvasHandlers:function(s){s.off("mouse:up",s._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(s,i,n,l){var e;return e={isAborted:!1,abort:function(){this.isAborted=!0}},s.animate("_currentCursorOpacity",i,{duration:n,onComplete:function(){e.isAborted||s[l]()},onChange:function(){s.canvas&&s.selectionStart===s.selectionEnd&&s.renderCursorOrSelection()},abort:function(){return e.isAborted}}),e},_onTickComplete:function(){var s=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){s._currentTickCompleteState=s._animateCursor(s,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(s){var i=this,n=s?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){i._tick()},n)},abortCursorAnimation:function(){var s=this._currentTickState||this._currentTickCompleteState,i=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,s&&i&&i.clearContext(i.contextTop||i.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(s){var i=0,n=s-1;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)i++,n--;for(;/\S/.test(this._text[n])&&n>-1;)i++,n--;return s-i},findWordBoundaryRight:function(s){var i=0,n=s;if(this._reSpace.test(this._text[n]))for(;this._reSpace.test(this._text[n]);)i++,n++;for(;/\S/.test(this._text[n])&&n<this._text.length;)i++,n++;return s+i},findLineBoundaryLeft:function(s){for(var i=0,n=s-1;!/\n/.test(this._text[n])&&n>-1;)i++,n--;return s-i},findLineBoundaryRight:function(s){for(var i=0,n=s;!/\n/.test(this._text[n])&&n<this._text.length;)i++,n++;return s+i},searchWordBoundary:function(s,i){for(var n=this._text,l=this._reSpace.test(n[s])?s-1:s,e=n[l],t=g.reNonWord;!t.test(e)&&l>0&&l<n.length;)e=n[l+=i];return t.test(e)&&(l+=i===1?0:1),l},selectWord:function(s){s=s||this.selectionStart;var i=this.searchWordBoundary(s,-1),n=this.searchWordBoundary(s,1);this.selectionStart=i,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(s){s=s||this.selectionStart;var i=this.findLineBoundaryLeft(s),n=this.findLineBoundaryRight(s);return this.selectionStart=i,this.selectionEnd=n,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(s){if(!this.isEditing&&this.editable)return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(s),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(s){s._iTextInstances&&s._iTextInstances.forEach(function(i){i.selected=!1,i.isEditing&&i.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(s){if(this.__isMousedown&&this.isEditing){var i=this.getSelectionStartFromPointer(s.e),n=this.selectionStart,l=this.selectionEnd;(i===this.__selectionStartOnMouseDown&&n!==l||n!==i&&l!==i)&&(i>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=i):(this.selectionStart=i,this.selectionEnd=this.__selectionStartOnMouseDown),this.selectionStart===n&&this.selectionEnd===l||(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(s,i,n){var l=n.slice(0,s),e=g.util.string.graphemeSplit(l).length;if(s===i)return{selectionStart:e,selectionEnd:e};var t=n.slice(s,i);return{selectionStart:e,selectionEnd:e+g.util.string.graphemeSplit(t).length}},fromGraphemeToStringSelection:function(s,i,n){var l=n.slice(0,s).join("").length;return s===i?{selectionStart:l,selectionEnd:l}:{selectionStart:l,selectionEnd:l+n.slice(s,i).join("").length}},_updateTextarea:function(){if(this.cursorOffsetCache={},this.hiddenTextarea){if(!this.inCompositionMode){var s=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=s.selectionStart,this.hiddenTextarea.selectionEnd=s.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var s=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=s.selectionEnd,this.inCompositionMode||(this.selectionStart=s.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var s=this._calcTextareaPosition();this.hiddenTextarea.style.left=s.left,this.hiddenTextarea.style.top=s.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var s=this.inCompositionMode?this.compositionStart:this.selectionStart,i=this._getCursorBoundaries(s),n=this.get2DCursorLocation(s),l=n.lineIndex,e=n.charIndex,t=this.getValueOfPropertyAt(l,e,"fontSize")*this.lineHeight,a=i.leftOffset,c=this.calcTransformMatrix(),o={x:i.left+a,y:i.top+i.topOffset+t},r=this.canvas.getRetinaScaling(),u=this.canvas.upperCanvasEl,f=u.width/r,p=u.height/r,m=f-t,v=p-t,y=u.clientWidth/f,C=u.clientHeight/p;return o=g.util.transformPoint(o,c),(o=g.util.transformPoint(o,this.canvas.viewportTransform)).x*=y,o.y*=C,o.x<0&&(o.x=0),o.x>m&&(o.x=m),o.y<0&&(o.y=0),o.y>v&&(o.y=v),o.x+=this.canvas._offset.left,o.y+=this.canvas._offset.top,{left:o.x+"px",top:o.y+"px",fontSize:t+"px",charHeight:t}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var s=this._textBeforeEdit!==this.text,i=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,i&&(i.blur&&i.blur(),i.parentNode&&i.parentNode.removeChild(i)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),s&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),s&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var s in this.styles)this._textLines[s]||delete this.styles[s]},removeStyleFromTo:function(s,i){var n,l,e=this.get2DCursorLocation(s,!0),t=this.get2DCursorLocation(i,!0),a=e.lineIndex,c=e.charIndex,o=t.lineIndex,r=t.charIndex;if(a!==o){if(this.styles[a])for(n=c;n<this._unwrappedTextLines[a].length;n++)delete this.styles[a][n];if(this.styles[o])for(n=r;n<this._unwrappedTextLines[o].length;n++)(l=this.styles[o][n])&&(this.styles[a]||(this.styles[a]={}),this.styles[a][c+n-r]=l);for(n=a+1;n<=o;n++)delete this.styles[n];this.shiftLineStyles(o,a-o)}else if(this.styles[a]){l=this.styles[a];var u,f,p=r-c;for(n=c;n<r;n++)delete l[n];for(f in this.styles[a])(u=parseInt(f,10))>=r&&(l[u-p]=l[f],delete l[f])}},shiftLineStyles:function(s,i){var n=pe(this.styles);for(var l in this.styles){var e=parseInt(l,10);e>s&&(this.styles[e+i]=n[e],n[e-i]||delete this.styles[e])}},restartCursorIfNeeded:function(){this._currentTickState&&!this._currentTickState.isAborted&&this._currentTickCompleteState&&!this._currentTickCompleteState.isAborted||this.initDelayedCursor()},insertNewlineStyleObject:function(s,i,n,l){var e,t={},a=!1,c=this._unwrappedTextLines[s].length===i;for(var o in n||(n=1),this.shiftLineStyles(s,n),this.styles[s]&&(e=this.styles[s][i===0?i:i-1]),this.styles[s]){var r=parseInt(o,10);r>=i&&(a=!0,t[r-i]=this.styles[s][o],c&&i===0||delete this.styles[s][o])}var u=!1;for(a&&!c&&(this.styles[s+n]=t,u=!0),u&&n--;n>0;)l&&l[n-1]?this.styles[s+n]={0:pe(l[n-1])}:e?this.styles[s+n]={0:pe(e)}:delete this.styles[s+n],n--;this._forceClearCache=!0},insertCharStyleObject:function(s,i,n,l){this.styles||(this.styles={});var e=this.styles[s],t=e?pe(e):{};for(var a in n||(n=1),t){var c=parseInt(a,10);c>=i&&(e[c+n]=t[c],t[c-n]||delete e[c])}if(this._forceClearCache=!0,l)for(;n--;)Object.keys(l[n]).length&&(this.styles[s]||(this.styles[s]={}),this.styles[s][i+n]=pe(l[n]));else if(e)for(var o=e[i?i-1:1];o&&n--;)this.styles[s][i+n]=pe(o)},insertNewStyleBlock:function(s,i,n){for(var l=this.get2DCursorLocation(i,!0),e=[0],t=0,a=0;a<s.length;a++)s[a]===`
`?e[++t]=0:e[t]++;for(e[0]>0&&(this.insertCharStyleObject(l.lineIndex,l.charIndex,e[0],n),n=n&&n.slice(e[0]+1)),t&&this.insertNewlineStyleObject(l.lineIndex,l.charIndex+e[0],t),a=1;a<t;a++)e[a]>0?this.insertCharStyleObject(l.lineIndex+a,0,e[a],n):n&&this.styles[l.lineIndex+a]&&n[0]&&(this.styles[l.lineIndex+a][0]=n[0]),n=n&&n.slice(e[a]+1);e[a]>0&&this.insertCharStyleObject(l.lineIndex+a,0,e[a],n)},setSelectionStartEndWithShift:function(s,i,n){n<=s?(i===s?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=s),this.selectionStart=n):n>s&&n<i?this._selectionDirection==="right"?this.selectionEnd=n:this.selectionStart=n:(i===s?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=i),this.selectionEnd=n)},setSelectionInBoundaries:function(){var s=this.text.length;this.selectionStart>s?this.selectionStart=s:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>s?this.selectionEnd=s:this.selectionEnd<0&&(this.selectionEnd=0)}}),g.util.object.extend(g.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(s){if(this.canvas){this.__newClickTime=+new Date;var i=s.pointer;this.isTripleClick(i)&&(this.fire("tripleclick",s),this._stopEvent(s.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=i,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(s){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===s.x&&this.__lastPointer.y===s.y},_stopEvent:function(s){s.preventDefault&&s.preventDefault(),s.stopPropagation&&s.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(s){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(s.e))},tripleClickHandler:function(s){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(s.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(s.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(s){if(this.__isMousedown=!1,!(!this.editable||this.group||s.transform&&s.transform.actionPerformed||s.e.button&&s.e.button!==1)){if(this.canvas){var i=this.canvas._activeObject;if(i&&i!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(s.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(s){var i=this.getSelectionStartFromPointer(s),n=this.selectionStart,l=this.selectionEnd;s.shiftKey?this.setSelectionStartEndWithShift(n,l,i):(this.selectionStart=i,this.selectionEnd=i),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(s){for(var i,n=this.getLocalPointer(s),l=0,e=0,t=0,a=0,c=0,o=0,r=this._textLines.length;o<r&&t<=n.y;o++)t+=this.getHeightOfLine(o)*this.scaleY,c=o,o>0&&(a+=this._textLines[o-1].length+this.missingNewlineOffset(o-1));e=this._getLineLeftOffset(c)*this.scaleX,i=this._textLines[c],this.direction==="rtl"&&(n.x=this.width*this.scaleX-n.x+e);for(var u=0,f=i.length;u<f&&(l=e,(e+=this.__charBounds[c][u].kernedWidth*this.scaleX)<=n.x);u++)a++;return this._getNewSelectionStartFromOffset(n,l,e,a,f)},_getNewSelectionStartFromOffset:function(s,i,n,l,e){var t=s.x-i,a=n-s.x,c=l+(a>t||a<0?0:1);return this.flipX&&(c=e-c),c>this._text.length&&(c=this._text.length),c}}),g.util.object.extend(g.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=g.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var s=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+s.top+"; left: "+s.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; paddingｰtop: "+s.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):g.document.body.appendChild(this.hiddenTextarea),g.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),g.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),g.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),g.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),g.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),g.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(g.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(s){if(this.isEditing){var i=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(s.keyCode in i)this[i[s.keyCode]](s);else{if(!(s.keyCode in this.ctrlKeysMapDown)||!s.ctrlKey&&!s.metaKey)return;this[this.ctrlKeysMapDown[s.keyCode]](s)}s.stopImmediatePropagation(),s.preventDefault(),s.keyCode>=33&&s.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(s){!this.isEditing||this._copyDone||this.inCompositionMode?this._copyDone=!1:s.keyCode in this.ctrlKeysMapUp&&(s.ctrlKey||s.metaKey)&&(this[this.ctrlKeysMapUp[s.keyCode]](s),s.stopImmediatePropagation(),s.preventDefault(),this.canvas&&this.canvas.requestRenderAll())},onInput:function(s){var i=this.fromPaste;if(this.fromPaste=!1,s&&s.stopPropagation(),this.isEditing){var n,l,e,t,a,c=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,o=this._text.length,r=c.length,u=r-o,f=this.selectionStart,p=this.selectionEnd,m=f!==p;if(this.hiddenTextarea.value==="")return this.styles={},this.updateFromTextArea(),this.fire("changed"),void(this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()));var v=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),y=f>v.selectionStart;m?(n=this._text.slice(f,p),u+=p-f):r<o&&(n=y?this._text.slice(p+u,p):this._text.slice(f,f-u)),l=c.slice(v.selectionEnd-u,v.selectionEnd),n&&n.length&&(l.length&&(e=this.getSelectionStyles(f,f+1,!1),e=l.map(function(){return e[0]})),m?(t=f,a=p):y?(t=p-n.length,a=p):(t=p,a=p+n.length),this.removeStyleFromTo(t,a)),l.length&&(i&&l.join("")===g.copiedText&&!g.disableStyleCopyPaste&&(e=g.copiedTextStyle),this.insertNewStyleBlock(l,f,e)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(s){this.compositionStart=s.target.selectionStart,this.compositionEnd=s.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(g.copiedText=this.getSelectedText(),g.disableStyleCopyPaste?g.copiedTextStyle=null:g.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(s){return s&&s.clipboardData||g.window.clipboardData},_getWidthBeforeCursor:function(s,i){var n,l=this._getLineLeftOffset(s);return i>0&&(l+=(n=this.__charBounds[s][i-1]).left+n.width),l},getDownCursorOffset:function(s,i){var n=this._getSelectionForOffset(s,i),l=this.get2DCursorLocation(n),e=l.lineIndex;if(e===this._textLines.length-1||s.metaKey||s.keyCode===34)return this._text.length-n;var t=l.charIndex,a=this._getWidthBeforeCursor(e,t),c=this._getIndexOnLine(e+1,a);return this._textLines[e].slice(t).length+c+1+this.missingNewlineOffset(e)},_getSelectionForOffset:function(s,i){return s.shiftKey&&this.selectionStart!==this.selectionEnd&&i?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(s,i){var n=this._getSelectionForOffset(s,i),l=this.get2DCursorLocation(n),e=l.lineIndex;if(e===0||s.metaKey||s.keyCode===33)return-n;var t=l.charIndex,a=this._getWidthBeforeCursor(e,t),c=this._getIndexOnLine(e-1,a),o=this._textLines[e].slice(0,t),r=this.missingNewlineOffset(e-1);return-this._textLines[e-1].length+c-o.length+(1-r)},_getIndexOnLine:function(s,i){for(var n,l,e=this._textLines[s],t=this._getLineLeftOffset(s),a=0,c=0,o=e.length;c<o;c++)if((t+=n=this.__charBounds[s][c].width)>i){l=!0;var r=t-n,u=t,f=Math.abs(r-i);a=Math.abs(u-i)<f?c:c-1;break}return l||(a=e.length-1),a},moveCursorDown:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",s)},moveCursorUp:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",s)},_moveCursorUpOrDown:function(s,i){var n=this["get"+s+"CursorOffset"](i,this._selectionDirection==="right");i.shiftKey?this.moveCursorWithShift(n):this.moveCursorWithoutShift(n),n!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(s){var i=this._selectionDirection==="left"?this.selectionStart+s:this.selectionEnd+s;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,i),s!==0},moveCursorWithoutShift:function(s){return s<0?(this.selectionStart+=s,this.selectionEnd=this.selectionStart):(this.selectionEnd+=s,this.selectionStart=this.selectionEnd),s!==0},moveCursorLeft:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",s)},_move:function(s,i,n){var l;if(s.altKey)l=this["findWordBoundary"+n](this[i]);else{if(!s.metaKey&&s.keyCode!==35&&s.keyCode!==36)return this[i]+=n==="Left"?-1:1,!0;l=this["findLineBoundary"+n](this[i])}if(typeof l!==void 0&&this[i]!==l)return this[i]=l,!0},_moveLeft:function(s,i){return this._move(s,i,"Left")},_moveRight:function(s,i){return this._move(s,i,"Right")},moveCursorLeftWithoutShift:function(s){var i=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(i=this._moveLeft(s,"selectionStart")),this.selectionEnd=this.selectionStart,i},moveCursorLeftWithShift:function(s){return this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd?this._moveLeft(s,"selectionEnd"):this.selectionStart!==0?(this._selectionDirection="left",this._moveLeft(s,"selectionStart")):void 0},moveCursorRight:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",s)},_moveCursorLeftOrRight:function(s,i){var n="moveCursor"+s+"With";this._currentCursorOpacity=1,i.shiftKey?n+="Shift":n+="outShift",this[n](i)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(s){return this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd?this._moveRight(s,"selectionStart"):this.selectionEnd!==this._text.length?(this._selectionDirection="right",this._moveRight(s,"selectionEnd")):void 0},moveCursorRightWithoutShift:function(s){var i=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(i=this._moveRight(s,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,i},removeChars:function(s,i){i===void 0&&(i=s+1),this.removeStyleFromTo(s,i),this._text.splice(s,i-s),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(s,i,n,l){l===void 0&&(l=n),l>n&&this.removeStyleFromTo(n,l);var e=g.util.string.graphemeSplit(s);this.insertNewStyleBlock(e,n,i),this._text=[].concat(this._text.slice(0,n),e,this._text.slice(l)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var s=g.util.toFixed,i=/  +/g;g.util.object.extend(g.Text.prototype,{_toSVG:function(){var n=this._getSVGLeftTopOffsets(),l=this._getSVGTextAndBg(n.textTop,n.textLeft);return this._wrapSVGTextAndBg(l)},toSVG:function(n){return this._createBaseSVGMarkup(this._toSVG(),{reviver:n,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(n){var l=this.getSvgTextDecoration(this);return[n.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",l?'text-decoration="'+l+'" ':"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",n.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(n,l){var e,t=[],a=[],c=n;this._setSVGBg(a);for(var o=0,r=this._textLines.length;o<r;o++)e=this._getLineLeftOffset(o),(this.textBackgroundColor||this.styleHas("textBackgroundColor",o))&&this._setSVGTextLineBg(a,o,l+e,c),this._setSVGTextLineText(t,o,l+e,c),c+=this.getHeightOfLine(o);return{textSpans:t,textBgRects:a}},_createTextCharSpan:function(n,l,e,t){var a=n!==n.trim()||n.match(i),c=this.getSvgSpanStyles(l,a),o=c?'style="'+c+'"':"",r=l.deltaY,u="",f=g.Object.NUM_FRACTION_DIGITS;return r&&(u=' dy="'+s(r,f)+'" '),['<tspan x="',s(e,f),'" y="',s(t,f),'" ',u,o,">",g.util.string.escapeXml(n),"</tspan>"].join("")},_setSVGTextLineText:function(n,l,e,t){var a,c,o,r,u,f=this.getHeightOfLine(l),p=this.textAlign.indexOf("justify")!==-1,m="",v=0,y=this._textLines[l];t+=f*(1-this._fontSizeFraction)/this.lineHeight;for(var C=0,R=y.length-1;C<=R;C++)u=C===R||this.charSpacing,m+=y[C],o=this.__charBounds[l][C],v===0?(e+=o.kernedWidth-o.width,v+=o.width):v+=o.kernedWidth,p&&!u&&this._reSpaceAndTab.test(y[C])&&(u=!0),u||(a=a||this.getCompleteStyleDeclaration(l,C),c=this.getCompleteStyleDeclaration(l,C+1),u=this._hasStyleChangedForSvg(a,c)),u&&(r=this._getStyleDeclaration(l,C)||{},n.push(this._createTextCharSpan(m,r,e,t)),m="",a=c,e+=v,v=0)},_pushTextBgRect:function(n,l,e,t,a,c){var o=g.Object.NUM_FRACTION_DIGITS;n.push("		<rect ",this._getFillAttributes(l),' x="',s(e,o),'" y="',s(t,o),'" width="',s(a,o),'" height="',s(c,o),`"></rect>
`)},_setSVGTextLineBg:function(n,l,e,t){for(var a,c,o=this._textLines[l],r=this.getHeightOfLine(l)/this.lineHeight,u=0,f=0,p=this.getValueOfPropertyAt(l,0,"textBackgroundColor"),m=0,v=o.length;m<v;m++)a=this.__charBounds[l][m],(c=this.getValueOfPropertyAt(l,m,"textBackgroundColor"))!==p?(p&&this._pushTextBgRect(n,p,e+f,t,u,r),f=a.left,u=a.width,p=c):u+=a.kernedWidth;c&&this._pushTextBgRect(n,c,e+f,t,u,r)},_getFillAttributes:function(n){var l=n&&typeof n=="string"?new g.Color(n):"";return l&&l.getSource()&&l.getAlpha()!==1?'opacity="'+l.getAlpha()+'" fill="'+l.setAlpha(1).toRgb()+'"':'fill="'+n+'"'},_getSVGLineTopOffset:function(n){for(var l,e=0,t=0;t<n;t++)e+=this.getHeightOfLine(t);return l=this.getHeightOfLine(t),{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*l/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(n){return g.Object.prototype.getSvgStyles.call(this,n)+" white-space: pre;"}})}(),function(s){var i=s.fabric||(s.fabric={});i.Textbox=i.util.createClass(i.IText,i.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:i.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(n){for(var l=0,e=0,t=0,a={},c=0;c<n.graphemeLines.length;c++)n.graphemeText[t]===`
`&&c>0?(e=0,t++,l++):!this.splitByGrapheme&&this._reSpaceAndTab.test(n.graphemeText[t])&&c>0&&(e++,t++),a[c]={line:l,offset:e},t+=n.graphemeLines[c].length,e+=n.graphemeLines[c].length;return a},styleHas:function(n,l){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[l];e&&(l=e.line)}return i.Text.prototype.styleHas.call(this,n,l)},isEmptyStyles:function(n){if(!this.styles)return!0;var l,e,t=0,a=!1,c=this._styleMap[n],o=this._styleMap[n+1];for(var r in c&&(n=c.line,t=c.offset),o&&(a=o.line===n,l=o.offset),e=n===void 0?this.styles:{line:this.styles[n]})for(var u in e[r])if(u>=t&&(!a||u<l))for(var f in e[r][u])return!1;return!0},_getStyleDeclaration:function(n,l){if(this._styleMap&&!this.isWrapping){var e=this._styleMap[n];if(!e)return null;n=e.line,l=e.offset+l}return this.callSuper("_getStyleDeclaration",n,l)},_setStyleDeclaration:function(n,l,e){var t=this._styleMap[n];n=t.line,l=t.offset+l,this.styles[n][l]=e},_deleteStyleDeclaration:function(n,l){var e=this._styleMap[n];n=e.line,l=e.offset+l,delete this.styles[n][l]},_getLineStyle:function(n){var l=this._styleMap[n];return!!this.styles[l.line]},_setLineStyle:function(n){var l=this._styleMap[n];this.styles[l.line]={}},_wrapText:function(n,l){var e,t=[];for(this.isWrapping=!0,e=0;e<n.length;e++)t=t.concat(this._wrapLine(n[e],e,l));return this.isWrapping=!1,t},_measureWord:function(n,l,e){var t,a=0;e=e||0;for(var c=0,o=n.length;c<o;c++)a+=this._getGraphemeBox(n[c],l,c+e,t,!0).kernedWidth,t=n[c];return a},_wrapLine:function(n,l,e,t){var a=0,c=this.splitByGrapheme,o=[],r=[],u=c?i.util.string.graphemeSplit(n):n.split(this._wordJoiners),f="",p=0,m=c?"":" ",v=0,y=0,C=0,R=!0,M=this._getWidthOfCharSpacing();t=t||0,u.length===0&&u.push([]),e-=t;for(var W=0;W<u.length;W++)f=c?u[W]:i.util.string.graphemeSplit(u[W]),v=this._measureWord(f,l,p),p+=f.length,(a+=y+v-M)>e&&!R?(o.push(r),r=[],a=v,R=!0):a+=M,R||c||r.push(m),r=r.concat(f),y=c?0:this._measureWord([m],l,p),p++,R=!1,v>C&&(C=v);return W&&o.push(r),C+t>this.dynamicMinWidth&&(this.dynamicMinWidth=C-M+t),o},isEndOfWrapping:function(n){return!this._styleMap[n+1]||this._styleMap[n+1].line!==this._styleMap[n].line},missingNewlineOffset:function(n){return this.splitByGrapheme?this.isEndOfWrapping(n)?1:0:1},_splitTextIntoLines:function(n){for(var l=i.Text.prototype._splitTextIntoLines.call(this,n),e=this._wrapText(l.lines,this.width),t=new Array(e.length),a=0;a<e.length;a++)t[a]=e[a].join("");return l.lines=t,l.graphemeLines=e,l},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var n={};for(var l in this._styleMap)this._textLines[l]&&(n[this._styleMap[l].line]=1);for(var l in this.styles)n[l]||delete this.styles[l]},toObject:function(n){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(n))}}),i.Textbox.fromObject=function(n,l){return i.Object._fromObject("Textbox",n,l,"text")}}(h),function(){var s=g.controlsUtils,i=s.scaleSkewCursorStyleHandler,n=s.scaleCursorStyleHandler,l=s.scalingEqually,e=s.scalingYOrSkewingX,t=s.scalingXOrSkewingY,a=s.scaleOrSkewActionName,c=g.Object.prototype.controls;if(c.ml=new g.Control({x:-.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:a}),c.mr=new g.Control({x:.5,y:0,cursorStyleHandler:i,actionHandler:t,getActionName:a}),c.mb=new g.Control({x:0,y:.5,cursorStyleHandler:i,actionHandler:e,getActionName:a}),c.mt=new g.Control({x:0,y:-.5,cursorStyleHandler:i,actionHandler:e,getActionName:a}),c.tl=new g.Control({x:-.5,y:-.5,cursorStyleHandler:n,actionHandler:l}),c.tr=new g.Control({x:.5,y:-.5,cursorStyleHandler:n,actionHandler:l}),c.bl=new g.Control({x:-.5,y:.5,cursorStyleHandler:n,actionHandler:l}),c.br=new g.Control({x:.5,y:.5,cursorStyleHandler:n,actionHandler:l}),c.mtr=new g.Control({x:0,y:-.5,actionHandler:s.rotationWithSnapping,cursorStyleHandler:s.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),g.Textbox){var o=g.Textbox.prototype.controls={};o.mtr=c.mtr,o.tr=c.tr,o.br=c.br,o.tl=c.tl,o.bl=c.bl,o.mt=c.mt,o.mb=c.mb,o.mr=new g.Control({x:.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),o.ml=new g.Control({x:-.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:i,actionName:"resizing"})}}()},192:()=>{},898:()=>{},245:()=>{}},rt={};function He(ae){var h=rt[ae];if(h!==void 0)return h.exports;var d=rt[ae]={exports:{}};return ut[ae](d,d.exports,He),d.exports}He.d=(ae,h)=>{for(var d in h)He.o(h,d)&&!He.o(ae,d)&&Object.defineProperty(ae,d,{enumerable:!0,get:h[d]})},He.o=(ae,h)=>Object.prototype.hasOwnProperty.call(ae,h);var st={};(()=>{let ae;He.d(st,{R:()=>ae}),ae=typeof document<"u"&&typeof window<"u"?He(653).fabric:{version:"5.2.1"}})();var be=st.R;/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.3.9 (js 20231205)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */const Qe=typeof self>"u";let qe,Ue,Ke,$e,we;if(typeof navigator<"u"&&(qe=navigator,Ue=qe.userAgent,Ke=qe.platform,$e=qe.mediaDevices),!Qe){const ae={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:qe.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},h={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:Ke,search:"Win"},Mac:{str:Ke},Linux:{str:Ke}};let d="unknownBrowser",_=0,b="unknownOS";for(let x in ae){const S=ae[x]||{};let F=S.str||Ue,E=S.search||x,P=S.verStr||Ue,O=S.verSearch||x;if(O instanceof Array||(O=[O]),F.indexOf(E)!=-1){d=x;for(let G of O){let z=P.indexOf(G);if(z!=-1){_=parseFloat(P.substring(z+G.length+1));break}}break}}for(let x in h){const S=h[x]||{};let F=S.str||Ue,E=S.search||x;if(F.indexOf(E)!=-1){b=x;break}}b=="Linux"&&Ue.indexOf("Windows NT")!=-1&&(b="HarmonyOS"),we={browser:d,version:_,OS:b}}Qe&&(we={browser:"ssr",version:0,OS:"ssr"});const dt=typeof WebAssembly<"u"&&Ue&&!(/Safari/.test(Ue)&&!/Chrome/.test(Ue)&&/\(.+\s11_2_([2-6]).*\)/.test(Ue)),ft=!(typeof Worker>"u"),ot=!(!$e||!$e.getUserMedia),gt=async()=>{let ae=!1;if(ot)try{(await $e.getUserMedia({video:!0})).getTracks().forEach(h=>{h.stop()}),ae=!0}catch{}return ae};we.browser==="Chrome"&&we.version>66||we.browser==="Safari"&&we.version>13||we.browser==="OPR"&&we.version>43||we.browser==="Edge"&&we.version;const pt=(()=>{if(!Qe&&document.currentScript){let ae=document.currentScript.src,h=ae.indexOf("?");if(h!=-1)ae=ae.substring(0,h);else{let d=ae.indexOf("#");d!=-1&&(ae=ae.substring(0,d))}return ae.substring(0,ae.lastIndexOf("/")+1)}return"./"})();class Ne{constructor(h,d){this._zIndex=null,this._drawingLayer=null,this._drawingLayerId=null,this._mapStyle=new Map,this.mapEvent_Callbacks=new Map([["selected",new Map],["deselected",new Map],["mousedown",new Map],["mouseup",new Map],["dblclick",new Map],["mouseover",new Map],["mouseout",new Map]]),this.mapNoteName_Content=new Map([]),this.isDrawingItem=!0,this._setFabricObject(h),this._mediaType=h.type,this.styleSelector="default",this.styleId=d}get mediaType(){return this._mediaType}get drawingLayerId(){return this._drawingLayerId}_setFabricObject(h){this._fabricObject=h,this._fabricObject.on("selected",()=>{this.styleSelector="selected"}),this._fabricObject.on("deselected",()=>{this._fabricObject.canvas&&this._fabricObject.canvas.getActiveObjects().includes(this._fabricObject)?this.styleSelector="selected":this.styleSelector="default",this._fabricObject.type==="textbox"&&(this._fabricObject.isEditing&&this._fabricObject.exitEditing(),this._fabricObject.selected=!1)}),h.getDrawingItem=()=>this}_getFabricObject(){return this._fabricObject}_on(h,d){if(!d)return;const _=h.toLowerCase(),b=this.mapEvent_Callbacks.get(_);if(!b)throw new Error(`Event '${h}' does not exist.`);let x=b.get(d);x||(x=S=>{const F=S.e;if(!F)return void(d&&d.apply(this,[{targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null}]));const E={targetItem:this,itemClientX:null,itemClientY:null,itemPageX:null,itemPageY:null};if(this._drawingLayer){let P,O,G,z;const J=F.target.getBoundingClientRect();P=J.left,O=J.top,G=P+window.scrollX,z=O+window.scrollY;const X=this._drawingLayer.fabricCanvas.lowerCanvasEl.width,q=this._drawingLayer.fabricCanvas.lowerCanvasEl.height,H=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).width),ee=parseFloat(window.getComputedStyle(this._drawingLayer.fabricCanvas.lowerCanvasEl).height),ne=H/ee,ie=X/q,he=this._drawingLayer._getObjectFit();let de,fe,pe,g,ce=1;if(he==="contain")ne<ie?(ce=H/X,de=P+this.get("x")*ce,fe=O+this.get("y")*ce+(ee-q*ce)/2,pe=G+this.get("x")*ce,g=z+this.get("y")*ce+(ee-q*ce)/2):(ce=ee/q,de=P+this.get("x")*ce+(H-X*ce)/2,fe=O+this.get("y")*ce,pe=G+this.get("x")*ce+(H-X*ce)/2,g=z+this.get("y")*ce);else if(he==="cover")if(ne<ie){ce=ee/q;let ve=this.get("x")*ce-(X*ce-H)/2;ve=Math.max(ve,0),ve=Math.min(ve,H),de=P+ve,fe=O+this.get("y")*ce,pe=G+ve,g=z+this.get("y")*ce}else{ce=H/X;let ve=this.get("y")*ce-(q*ce-ee)/2;ve=Math.max(ve,0),ve=Math.min(ve,ee),de=P+this.get("x")*ce,fe=O+ve,pe=G+this.get("x")*ce,g=z+ve}E.itemClientX=Math.round(de),E.itemClientY=Math.round(fe),E.itemPageX=Math.round(pe),E.itemPageY=Math.round(g)}for(let P of Object.getOwnPropertyNames(E))Object.defineProperty(F,P,{value:E[P],writable:!0});d&&d.apply(this,[F])},b.set(d,x),this._fabricObject.on(_==="dblclick"?"mousedblclick":_,x))}on(h,d){this._on(h,d)}_off(h,d){const _=h.toLowerCase(),b=this.mapEvent_Callbacks.get(_);if(!b)throw new Error(`Event '${h}' does not exist.`);let x=b.get(d);x&&(b.delete(d),this._fabricObject.off(_==="dblclick"?"mousedblclick":_,x))}off(h,d){this._off(h,d)}_setEditable(h){const d=this._fabricObject;h?(d.selectable=!0,d.hasControls=!0,d.hoverCursor=null):(d.selectable=!1,d.hasControls=!1,d.hoverCursor="default")}hasNote(h){return this.mapNoteName_Content.has(h)}addNote(h,d){if(this.hasNote(h.name)&&!d)throw new Error("A note with the same name already exists, please use a different name.");const _=h.content?JSON.parse(JSON.stringify(h.content)):h.content;this.mapNoteName_Content.set(h.name,[_])}getNote(h){const d=this.mapNoteName_Content.get(h);return d?d.length===1?{name:h,content:d[0]?JSON.parse(JSON.stringify(d[0])):d[0]}:{name:h,content:JSON.parse(JSON.stringify(d))}:null}getNotes(){const h=[];for(let d of this.mapNoteName_Content){let _=d[1].length===1?d[1][0]:d[1];_=_&&JSON.parse(JSON.stringify(_)),h.push({name:d[0],content:_})}return h}updateNote(h,d,_){const b=this.mapNoteName_Content.get(h);if(!b)throw new Error("The note name does not exist.");_||(b.length=0),d=d&&JSON.parse(JSON.stringify(d)),b.push(d)}deleteNote(h){this.mapNoteName_Content.delete(h)}clearNotes(){this.mapNoteName_Content.clear()}_extendSet(h,d){return!1}_extendGet(h){}set(h,d){if(!this._extendSet(h,d))if(h==="x"){const _=this._fabricObject.group;_?(this._fabricObject.set("left",d-_.left-_.width/2),_.addWithUpdate()):this._fabricObject.set("left",d)}else if(h==="y"){const _=this._fabricObject.group;_?(this._fabricObject.set("top",d-_.top-_.height/2),_.addWithUpdate()):this._fabricObject.set("top",d)}else h==="styleId"?this.styleId=d:this._fabricObject.set(h,d);["vertices","startPoint","endPoint","x","y","left","top","width","height","scaleX","scaleY","skewX","skewY","padding","angle","strokeWidth"].includes(h)&&this._fabricObject.setCoords()}get(h){let d=this._extendGet(h);if(d===void 0)if(h==="x"){const _=this._fabricObject.group;d=_?this._fabricObject.get("left")+_.left+_.width/2:this._fabricObject.get("left")}else if(h==="y"){const _=this._fabricObject.group;d=_?this._fabricObject.get("top")+_.top+_.height/2:this._fabricObject.get("top")}else d=["type","mediaType"].includes(h)?this.mediaType:h==="styleSelector"?this.styleSelector:h==="styleId"?this.styleId:h==="drawingLayerId"?this.drawingLayerId:this._fabricObject.get(h);return d}setAttribute(h,d){this.set(h,d)}getAttribute(h){return this.get(h)}}Ne.arrMediaTypes=["rect","arc","polygon","image","text","line","path"],Ne.arrStyleSelectors=["default","selected"];const nt=ae=>{let h=(d=>d.split(`
`).map(_=>_.split("	")))(ae);return(d=>{for(let _=0;;_++){let b=-1;for(let x=0;x<d.length;x++){let S=d[x][_];S!==void 0&&S.length>b&&(b=S.length)}if(b===-1)break;for(let x=0;x<d.length;x++){if(_>=d[x].length-1)continue;let S=" ".repeat(b+2-d[x][_].length);d[x][_]=d[x][_].concat(S)}}})(h),(d=>{let _="";for(let b=0;b<d.length;b++)_=_.concat(...d[b],b===d.length-1?"":`
`);return _})(h)};class mt extends Ne{constructor(h,d,_,b,x){if(typeof b!="number"||b<=0)throw new RangeError("Invalid width.");super(new be.Textbox(nt(h),{left:d,top:_,width:b}),x),this._mediaType="text",this._text=h}_extendSet(h,d){if(h==="text")return this._text=d,this._fabricObject.set("text",nt(d)),!0}_extendGet(h){if(h==="text")return this._text}}typeof document<"u"&&typeof window<"u"&&(be.StaticCanvas.prototype.dispose=function(){return this.isRendering&&(be.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(ae){ae.dispose&&ae.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),be.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},be.Object.prototype.transparentCorners=!1,be.Object.prototype.cornerSize=20,be.Object.prototype.touchCornerSize=100,be.Object.prototype.cornerColor="rgb(254,142,20)",be.Object.prototype.cornerStyle="circle",be.Object.prototype.strokeUniform=!0,be.Object.prototype.hasBorders=!1,be.Canvas.prototype.containerClass="",be.Canvas.prototype.getPointer=function(ae,h){if(this._absolutePointer&&!h)return this._absolutePointer;if(this._pointer&&h)return this._pointer;var d,_=this.upperCanvasEl,b=be.util.getPointer(ae,_),x=_.getBoundingClientRect(),S=x.width||0,F=x.height||0;S&&F||("top"in x&&"bottom"in x&&(F=Math.abs(x.top-x.bottom)),"right"in x&&"left"in x&&(S=Math.abs(x.right-x.left))),this.calcOffset(),b.x=b.x-this._offset.left,b.y=b.y-this._offset.top,h||(b=this.restorePointerVpt(b));var E=this.getRetinaScaling();if(E!==1&&(b.x/=E,b.y/=E),S!==0&&F!==0){var P=window.getComputedStyle(_).objectFit,O=_.width,G=_.height,z=S,J=F;d={width:O/z,height:G/J};var X,q,H=O/G,ee=z/J;return P==="contain"?H>ee?(X=z,q=z/H,{x:b.x*d.width,y:(b.y-(J-q)/2)*d.width}):(X=J*H,q=J,{x:(b.x-(z-X)/2)*d.height,y:b.y*d.height}):P==="cover"?H>ee?{x:(O-d.height*z)/2+b.x*d.height,y:b.y*d.height}:{x:b.x*d.width,y:(G-d.width*J)/2+b.y*d.width}:{x:b.x*d.width,y:b.y*d.height}}return d={width:1,height:1},{x:b.x*d.width,y:b.y*d.height}},be.Canvas.prototype._onTouchStart=function(ae){var h=this.findTarget(ae);!this.allowTouchScrolling&&ae.cancelable&&ae.preventDefault&&ae.preventDefault(),h&&ae.cancelable&&ae.preventDefault&&ae.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(ae)),this.__onMouseDown(ae),this._resetTransformEventData();var d=this.upperCanvasEl,_=this._getEventPrefix();be.util.addListener(be.document,"touchend",this._onTouchEnd,{passive:!1}),be.util.addListener(be.document,"touchmove",this._onMouseMove,{passive:!1}),be.util.removeListener(d,_+"down",this._onMouseDown)},be.Textbox.prototype._wrapLine=function(ae,h,d,_){const b=ae.match(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g),x=!(!b||!b.length);var S=0,F=this.splitByGrapheme||x,E=[],P=[],O=F?be.util.string.graphemeSplit(ae):ae.split(this._wordJoiners),G="",z=0,J=F?"":" ",X=0,q=0,H=0,ee=!0,ne=this._getWidthOfCharSpacing();_=_||0,O.length===0&&O.push([]),d-=_;for(var ie=0;ie<O.length;ie++)G=F?O[ie]:be.util.string.graphemeSplit(O[ie]),X=this._measureWord(G,h,z),z+=G.length,(S+=q+X-ne)>d&&!ee?(E.push(P),P=[],S=X,ee=!0):S+=ne,ee||F||P.push(J),P=P.concat(G),q=F?0:this._measureWord([J],h,z),z++,ee=!1,X>H&&(H=X);return ie&&E.push(P),H+_>this.dynamicMinWidth&&(this.dynamicMinWidth=H-ne+_),E});class vt{constructor(h,d,_,b){let x,S;switch(this.mapMediaType_Style=new Map,this.mode="viewer",this.onSelectionChange=null,this._arrDrwaingItem=[],this._arrFabricObject=[],this._visible=!0,h.hasOwnProperty("getFabricCanvas")?this.fabricCanvas=h.getFabricCanvas():(this.fabricCanvas=new be.Canvas(h,Object.assign(b,{allowTouchScrolling:!0})),this.fabricCanvas.setDimensions({width:"100%",height:"100%"},{cssOnly:!0}),this.fabricCanvas.lowerCanvasEl.className="",this.fabricCanvas.upperCanvasEl.className="",this.fabricCanvas.on("selection:created",function(F){const E=F.selected,P=[];for(let O of E){const G=O.getDrawingItem()._drawingLayer;G&&!P.includes(G)&&P.push(G)}for(let O of P){const G=[];for(let z of E){const J=z.getDrawingItem();J._drawingLayer===O&&G.push(J)}setTimeout(()=>{O.onSelectionChange&&O.onSelectionChange(G,[])},0)}}),this.fabricCanvas.on("before:selection:cleared",function(F){const E=this.getActiveObjects(),P=[];for(let O of E){const G=O.getDrawingItem()._drawingLayer;G&&!P.includes(G)&&P.push(G)}for(let O of P){const G=[];for(let z of E){const J=z.getDrawingItem();J._drawingLayer===O&&G.push(J)}setTimeout(()=>{const z=[];for(let J of G)O.hasDrawingItem(J)&&z.push(J);z.length>0&&O.onSelectionChange&&O.onSelectionChange([],z)},0)}}),this.fabricCanvas.on("selection:updated",function(F){const E=F.selected,P=F.deselected,O=[];for(let G of E){const z=G.getDrawingItem()._drawingLayer;z&&!O.includes(z)&&O.push(z)}for(let G of P){const z=G.getDrawingItem()._drawingLayer;z&&!O.includes(z)&&O.push(z)}for(let G of O){const z=[],J=[];for(let X of E){const q=X.getDrawingItem();q._drawingLayer===G&&z.push(q)}for(let X of P){const q=X.getDrawingItem();q._drawingLayer===G&&J.push(q)}setTimeout(()=>{G.onSelectionChange&&G.onSelectionChange(z,J)},0)}}),this.fabricCanvas.wrapperEl.style.position="absolute",h.getFabricCanvas=()=>this.fabricCanvas),this.id=d,this._mapDrawingStyles=_,d){case 1:x=_.get(1),S=_.get(5);break;case 2:x=_.get(2),S=_.get(6);break;case 3:x=_.get(3),S=_.get(7);break;default:x=_.get(4),S=_.get(8)}for(let F of Ne.arrMediaTypes)this.mapMediaType_Style.set(F,{default:x,selected:S})}getId(){return this.id}_getDrawingStyle(h,d){if(typeof h!="number")throw new Error("Invalid style id.");const _=this._mapDrawingStyles.get(h);return _?d?JSON.parse(JSON.stringify(_)):_:null}setVisible(h){if(h){for(let d of this._arrFabricObject)d.visible=!0;this._visible=!0}else{for(let d of this._arrFabricObject)d.visible=!1;this._visible=!1}this.fabricCanvas.renderAll()}isVisible(){return this._visible}_getItemCurrentStyleId(h){return h.styleId?h.styleId:this.mapMediaType_Style.get(h._mediaType)[h.styleSelector].styleId}_getItemCurrentStyle(h){return h.styleId?this._getDrawingStyle(h.styleId):h._mapStyle.get(h.styleSelector)||null}_changeMediaTypeCurStyleInStyleSelector(h,d,_,b){let x;switch(h){case"rect":x=this.fabricCanvas.getObjects("rect");break;case"arc":x=this.fabricCanvas.getObjects("circle");break;case"polygon":x=this.fabricCanvas.getObjects("polygon");break;case"image":x=this.fabricCanvas.getObjects("image");break;case"text":x=this.fabricCanvas.getObjects("textbox");break;case"line":x=this.fabricCanvas.getObjects("line");break;case"path":x=this.fabricCanvas.getObjects("path")}for(let S of x){if(!this._arrFabricObject.includes(S))continue;const F=S.getDrawingItem();F.styleSelector===d&&this._changeItemStyle(F,_,!0)}b||this.fabricCanvas.renderAll()}_changeItemStyle(h,d,_){if(!h||!d)return;const b=h._getFabricObject();typeof h.styleId=="number"&&(d=this._getDrawingStyle(h.styleId)),b.strokeWidth=d.lineWidth,d.paintMode==="fill"?(b.fill=d.fillStyle,b.stroke=d.fillStyle):d.paintMode==="stroke"?(b.fill="transparent",b.stroke=d.strokeStyle):d.paintMode==="strokeAndFill"&&(b.fill=d.fillStyle,b.stroke=d.strokeStyle),b.fontFamily&&(b.fontFamily=d.fontFamily),b.fontSize&&(b.fontSize=d.fontSize),b.group||(b.dirty=!0),_||this.fabricCanvas.renderAll()}_updateGroupItem(h,d,_){if(!h||!d)return;const b=h.getChildItems();if(_==="add"){if(b.includes(d))return;const x=d._getFabricObject();if(this.fabricCanvas.getObjects().includes(x)){if(!this._arrFabricObject.includes(x))throw new Error("Existed in other drawing layers.");d._zIndex=null}else{let S;if(d.styleId)S=this._getDrawingStyle(d.styleId);else{S=this.mapMediaType_Style.get(d._mediaType)[h.styleSelector];const F=()=>{this._changeItemStyle(d,this.mapMediaType_Style.get(d._mediaType).selected,!0)},E=()=>{this._changeItemStyle(d,this.mapMediaType_Style.get(d._mediaType).default,!0)};d._on("selected",F),d._on("deselected",E),d._funcChangeStyleToSelected=F,d._funcChangeStyleToDefault=E}d._drawingLayer=this,d._drawingLayerId=this.id,this._changeItemStyle(d,S,!0)}h._fabricObject.addWithUpdate(d._getFabricObject())}else{if(_!=="remove"||!b.includes(d))return;d._zIndex=null,d._drawingLayer=null,d._drawingLayerId=null,d._off("selected",d._funcChangeStyleToSelected),d._off("deselected",d._funcChangeStyleToDefault),d._funcChangeStyleToSelected=null,d._funcChangeStyleToDefault=null,h._fabricObject.removeWithUpdate(d._getFabricObject())}this.fabricCanvas.renderAll()}_addDrawingItem(h,d){let _=h._getFabricObject();const b=this.fabricCanvas.getObjects();let x,S;if(b.includes(_)){if(this._arrFabricObject.includes(_))return;throw new Error("Existed in other drawing layers.")}if(h._mediaType==="group"){x=h.getChildItems();for(let P of x)if(P._drawingLayer&&P._drawingLayer!==this)throw new Error("The childItems of DT_Group have existed in other drawing layers.")}if(d&&typeof d=="object"&&!Array.isArray(d))for(let P in d)_.set(P,d[P]);if(x){for(let P of x){const O=this.mapMediaType_Style.get(P._mediaType);for(let G of Ne.arrStyleSelectors)P._mapStyle.set(G,O[G]);if(P.styleId)S=this._getDrawingStyle(P.styleId);else{S=O.default;const G=()=>{this._changeItemStyle(P,this.mapMediaType_Style.get(P._mediaType).selected,!0)},z=()=>{this._changeItemStyle(P,this.mapMediaType_Style.get(P._mediaType).default,!0)};P._on("selected",G),P._on("deselected",z),P._funcChangeStyleToSelected=G,P._funcChangeStyleToDefault=z}P._drawingLayer=this,P._drawingLayerId=this.id,this._changeItemStyle(P,S,!0)}_.dirty=!0,this.fabricCanvas.renderAll()}else{const P=this.mapMediaType_Style.get(h._mediaType);for(let O of Ne.arrStyleSelectors)h._mapStyle.set(O,P[O]);if(h.styleId)S=this._getDrawingStyle(h.styleId);else{S=P.default;const O=()=>{this._changeItemStyle(h,this.mapMediaType_Style.get(h._mediaType).selected)},G=()=>{this._changeItemStyle(h,this.mapMediaType_Style.get(h._mediaType).default)};h._on("selected",O),h._on("deselected",G),h._funcChangeStyleToSelected=O,h._funcChangeStyleToDefault=G}this._changeItemStyle(h,S)}h._zIndex=this.id,h._drawingLayer=this,h._drawingLayerId=this.id;const F=this._arrFabricObject.length;let E=b.length;if(F)E=b.indexOf(this._arrFabricObject[F-1])+1;else for(let P=0;P<b.length;P++)if(h._zIndex<b[P].getDrawingItem()._zIndex){E=P;break}this._arrDrwaingItem.push(h),this._arrFabricObject.push(_),this._visible?_.visible=!0:_.visible=!1,this.fabricCanvas.insertAt(_,E,!1)}addDrawingItem(h){if(!h||!h.isDrawingItem)throw TypeError("Illegal drawing item.");if(this.mode==="viewer")h._setEditable(!1);else{if(this.mode!=="editor")throw new Error("Illegal 'mode'.");h._setEditable(!0)}this._addDrawingItem(h)}addDrawingItems(h){for(let d of h)this.addDrawingItem(d)}removeDrawingItem(h){if(!h||!h.isDrawingItem)throw TypeError("Illegal drawing item.");if(!this.hasDrawingItem(h))return;if(h._zIndex=null,h._drawingLayer=null,h._drawingLayerId=null,h._mediaType==="group"){const _=h.getChildItems();for(let b of _)b._zIndex=null,b._drawingLayer=null,b._drawingLayerId=null,b._off("selected",b._funcChangeStyleToSelected),b._off("deselected",b._funcChangeStyleToDefault),b._funcChangeStyleToSelected=null,b._funcChangeStyleToDefault=null,b._mapStyle.clear()}else h._off("selected",h._funcChangeStyleToSelected),h._off("deselected",h._funcChangeStyleToDefault),h._funcChangeStyleToSelected=null,h._funcChangeStyleToDefault=null,h._mapStyle.clear();const d=h._getFabricObject();h.styleSelector==="selected"&&(d.group?d.group.removeWithUpdate(d):this.fabricCanvas._activeObject=null,h.styleSelector="default"),this.fabricCanvas.remove(d),this._arrDrwaingItem.splice(this._arrDrwaingItem.indexOf(h),1),this._arrFabricObject.splice(this._arrFabricObject.indexOf(d),1)}removeDrawingItems(h){for(let d of h)this.removeDrawingItem(d)}setDrawingItems(h){this.clearDrawingItems(),this.addDrawingItems(h)}getDrawingItems(h){return h&&typeof h=="function"?this._arrDrwaingItem.filter(h):Array.from(this._arrDrwaingItem)}getSelectedDrawingItems(){const h=this.fabricCanvas.getActiveObjects(),d=[];for(let _ of h)this._arrFabricObject.includes(_)&&d.push(_.getDrawingItem());return d}hasDrawingItem(h){if(!h||!h.isDrawingItem)throw TypeError("Illegal drawing item.");return this._arrDrwaingItem.includes(h)}clearDrawingItems(){this.removeDrawingItems(Array.from(this._arrDrwaingItem))}setDrawingStyle(h,d,_){d=d?d.toLocaleLowerCase():"all",_=_?_.toLocaleLowerCase():"all";let b,x=this._getDrawingStyle(h);if(d==="all"){const S=this.mapMediaType_Style.keys();for(let F of S)if(b=this.mapMediaType_Style.get(F),_==="all")for(let E of Ne.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(F,E,x,!0),b[E]=x;for(let P of this._arrDrwaingItem)P._mapStyle.set(E,x)}else{this._changeMediaTypeCurStyleInStyleSelector(F,_,x,!0),b[_]=x;for(let E of this._arrDrwaingItem)E._mapStyle.set(_,x)}this.fabricCanvas.renderAll()}else if(b=this.mapMediaType_Style.get(d),_==="all")for(let S of Ne.arrStyleSelectors){this._changeMediaTypeCurStyleInStyleSelector(d,S,x,!0),b[S]=x;for(let F of this._arrDrwaingItem)F._mediaType===d&&F._mapStyle.set(S,x)}else{this._changeMediaTypeCurStyleInStyleSelector(d,_,x,!0),b[_]=x;for(let S of this._arrDrwaingItem)S._mediaType===d&&S._mapStyle.set(_,x)}}setMode(h){if((h=h.toLocaleLowerCase())==="viewer"){for(let d of this._arrDrwaingItem)d._setEditable(!1);this.fabricCanvas.discardActiveObject(),this.fabricCanvas.renderAll(),this.mode="viewer"}else{if(h!=="editor")throw new RangeError("Invalid value.");for(let d of this._arrDrwaingItem)d._setEditable(!0);this.mode="editor"}this._manager._switchPointerEvent()}getMode(){return this.mode}_setDimensions(h,d){this.fabricCanvas.setDimensions(h,d)}_setObjectFit(h){if(h=h.toLowerCase(),!["contain","cover"].includes(h))throw new Error(`Unsupported value '${h}'.`);this.fabricCanvas.lowerCanvasEl.style.objectFit=h,this.fabricCanvas.upperCanvasEl.style.objectFit=h}_getObjectFit(){return this.fabricCanvas.lowerCanvasEl.style.objectFit}renderAll(){for(let h of this._arrDrwaingItem){const d=this._getItemCurrentStyle(h);this._changeItemStyle(h,d,!0)}this.fabricCanvas.renderAll()}dispose(){this.clearDrawingItems(),this._manager._arrDrawingLayer.length===1&&(this.fabricCanvas.wrapperEl.style.pointerEvents="none",this.fabricCanvas.dispose(),this._arrDrwaingItem.length=0,this._arrFabricObject.length=0)}}class _t{constructor(){this._arrDrawingLayer=[],this._mapDrawingStyles=new Map([[1,{id:1,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[2,{id:2,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[3,{id:3,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[4,{id:4,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}],[5,{id:5,lineWidth:4,fillStyle:"rgba(73, 173, 245, 0.3)",strokeStyle:"rgba(73, 173, 245, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[6,{id:6,lineWidth:2,fillStyle:"rgba(73, 245, 73, 0.3)",strokeStyle:"rgba(73, 245, 73, 0.9)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[7,{id:7,lineWidth:2,fillStyle:"rgba(254, 180, 32, 0.3)",strokeStyle:"rgba(254, 180, 32, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}],[8,{id:8,lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"strokeAndFill",fontFamily:"consolas",fontSize:40}]]),this._defaultStyleTemplate={lineWidth:2,fillStyle:"rgba(245, 236, 73, 0.3)",strokeStyle:"rgba(245, 236, 73, 1)",paintMode:"stroke",fontFamily:"consolas",fontSize:40}}createDrawingStyle(h){if(!h)throw new Error("Invalid style definition.");let d;if(h.hasOwnProperty("id")){if(this._mapDrawingStyles.has(h.id))throw new Error("Existing drawing style id.");d=h.id}else{let b=100;for(;this._mapDrawingStyles.has(b);)b++;d=b}const _=JSON.parse(JSON.stringify(h));_.id=d;for(let b in this._defaultStyleTemplate)_.hasOwnProperty(b)||(_[b]=this._defaultStyleTemplate[b]);return this._mapDrawingStyles.set(d,_),_.id}_getDrawingStyle(h,d){if(typeof h!="number")throw new Error("Invalid style id.");const _=this._mapDrawingStyles.get(h);return _?d?JSON.parse(JSON.stringify(_)):_:null}getDrawingStyle(h){return this._getDrawingStyle(h,!0)}getDrawingStyles(){return JSON.parse(JSON.stringify(Array.from(this._mapDrawingStyles.values())))}_updateDrawingStyle(h,d){const _=this._mapDrawingStyles.get(h);if(_)for(let b in d)_.hasOwnProperty(b)&&(_[b]=d[b])}updateDrawingStyle(h,d){this._updateDrawingStyle(h,d);for(let _ of this._arrDrawingLayer)_.renderAll()}createDrawingLayer(h,d){const _=x=>{for(let S of this._arrDrawingLayer)if(S.getId()===x)return!0;return!1};if(d===void 0){for(let x=100;;x++)if(!_(x)){d=x;break}}else if(_(d))throw new Error("Existed drawing layer id.");const b=new vt(h,d,this._mapDrawingStyles,{enableRetinaScaling:!1});return b._manager=this,this._arrDrawingLayer.push(b),this._switchPointerEvent(),b}deleteDrawingLayer(h){const d=this.getDrawingLayer(h);if(!d)return;const _=this._arrDrawingLayer;d.dispose(),_.splice(_.indexOf(d),1),this._switchPointerEvent()}clearDrawingLayers(){for(let h of this._arrDrawingLayer)h.dispose();this._arrDrawingLayer.length=0}getDrawingLayer(h){for(let d of this._arrDrawingLayer)if(d.getId()===h)return d;return null}getDrawingLayers(){return Array.from(this._arrDrawingLayer)}getSelectedDrawingItems(){if(!this._arrDrawingLayer.length)return;const h=this._arrDrawingLayer[0].fabricCanvas.getActiveObjects(),d=[];for(let _ of h)d.push(_.getDrawingItem());return d}setDimensions(h,d){this._arrDrawingLayer.length&&this._arrDrawingLayer[0]._setDimensions(h,d)}setObjectFit(h){for(let d of this._arrDrawingLayer)d&&d._setObjectFit(h)}getObjectFit(){return this._arrDrawingLayer.length?this._arrDrawingLayer[0]._getObjectFit():null}setVisible(h){this._arrDrawingLayer.length&&(this._arrDrawingLayer[0].fabricCanvas.wrapperEl.style.display=h?"block":"none")}_switchPointerEvent(){if(this._arrDrawingLayer.length)for(let h of this._arrDrawingLayer)h.getMode()}}class yt{constructor(h){this._controlTarget=null,this._arrUsers=[],this._mapAction_UserArgs=new Map,this._mapProperty_UserValue=new Map,this._mapAction_Callbacks=new Map,this._controlTarget=h}setControlTarget(h){this._controlTarget=h}getControlTarget(){return this._controlTarget}register(h){this._arrUsers.includes(h)||this._arrUsers.push(h)}logout(h){const d=this._arrUsers.indexOf(h);d!==-1&&(this.clearUserDisiredAction({user:h}),this.clearUserDisiredValue({user:h}),this._arrUsers.splice(d,1))}getRegisteredUsers(){return this._arrUsers}ifUserExisted(h){return this._arrUsers.includes(h)}setDisiredValue(h,d,_,b){if(!this._arrUsers.includes(h))throw new Error("Unregistered user.");b&&(this._controlTarget[d]=_),this._mapProperty_UserValue.get(d)?this._mapProperty_UserValue.get(d).set(h,_):this._mapProperty_UserValue.set(d,new Map([[h,_]]))}clearUserDisiredValue(h){if(h&&(h.user||h.property)){if(h.property&&h.user){const d=this._mapProperty_UserValue.get(h.property);if(!d)return;d.delete(h.user)}else if(h.property)this._mapProperty_UserValue.delete(h.property);else if(h.user)for(let d of this._mapProperty_UserValue.values())d.delete(h.user)}else this._mapProperty_UserValue=new Map}getValue(h){if(!this._controlTarget)throw new Error("Control target is not set.");return this._controlTarget[h]}getPropertyDisiredValue(h){if(this._mapProperty_UserValue.get(h)){const d=[],_=this._mapProperty_UserValue.get(h);for(let b of _.values())d.push(b);return d}return null}setDisiredAction(h,d,_,b){if(!this._arrUsers.includes(h))throw new Error("Unregistered user.");return _||(_=[]),b?this._controlTarget[d](..._):(this._mapAction_UserArgs.get(d)?this._mapAction_UserArgs.get(d).set(h,_):this._mapAction_UserArgs.set(d,new Map([[h,_]])),this._render(d))}clearUserDisiredAction(h){if(h&&(h.user||h.actionName)){if(h.actionName&&h.user){const d=this._mapAction_UserArgs.get(h.actionName);if(!d)return;d.delete(h.user)}else if(h.actionName)this._mapAction_UserArgs.delete(h.actionName);else if(h.user)for(let d of this._mapAction_UserArgs.values())d.delete(h.user);this.render()}else this._mapAction_UserArgs=new Map}addCallback(h,d){const _=this._mapAction_Callbacks.get(h);_?_.push(d):this._mapAction_Callbacks.set(h,[d])}removeCallback(h,d){const _=this._mapAction_Callbacks.get(h);if(!_)return;const b=_.indexOf(d);b!==-1&&_.splice(b,1)}clearCallback(h){h?this._mapAction_Callbacks.delete(h):this._mapAction_Callbacks.clear()}_fireCallback(h){const d=this._mapAction_Callbacks.get(h);if(d)for(let _ of d){if(!_)return;setTimeout(_.bind(this._controlTarget),0)}}_render(h){const d=this._mapAction_UserArgs.get(h);if(!d)throw new Error("Unrecorded action.");if(d.size===this._arrUsers.length){let _=[];for(let b of d.values())b.length>0&&(_=b);if(this._controlTarget[h]){const b=this._controlTarget[h](..._);return this._mapAction_UserArgs.delete(h),this._fireCallback(h),b}}}render(h){if(h)return this._render(h);for(let d of this._mapAction_UserArgs.keys())this._render(d)}}class Re{static multiply(h,d){const _=[];for(let b=0;b<3;b++){const x=d.slice(3*b,3*b+3);for(let S=0;S<3;S++){const F=[h[S],h[S+3],h[S+6]].reduce((E,P,O)=>E+P*x[O],0);_.push(F)}}return _}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(h,d,_){return Re.multiply(h,[1,0,0,0,1,0,d,_,1])}static rotate(h,d){var _=Math.cos(d),b=Math.sin(d);return Re.multiply(h,[_,-b,0,b,_,0,0,0,1])}static scale(h,d,_){return Re.multiply(h,[d,0,0,0,_,0,0,0,1])}}var me;(function(ae){ae.GREY="grey",ae.GREY32="grey32",ae.RGBA="rgba",ae.RBGA="rbga",ae.GRBA="grba",ae.GBRA="gbra",ae.BRGA="brga",ae.BGRA="bgra"})(me||(me={}));const Me=(ae,h,d,_)=>{if(!d)return ae;let b=h+Math.round((ae-h)/d)*d;return _&&(b=Math.min(b,_)),b};class ${constructor(){this._maxCvsSideLength=void 0,this._defaultMaxCvsSideLength=null,this._predefinedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],this._mapCameraResolutions=new Map,this._bWebGLSupported=!0,this.extraBindings=[],this._cvsSingleFrameMode=null,this._cvsOriginalImage=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameInputContainer=null,this._clickIptSingleFrameMode=()=>{if(!this._isSingleFrameModeEnabled()||this.getDrawingLayers().some(d=>d.getMode()=="editor"))return;let h;if(this._singleFrameInputContainer)h=this._singleFrameInputContainer.firstElementChild;else{h=document.createElement("input"),h.setAttribute("type","file"),this.singleFrameMode==="camera"?(h.setAttribute("capture",""),h.setAttribute("accept","image/*")):this.singleFrameMode!=1&&this.singleFrameMode!=="image"||(h.removeAttribute("capture"),h.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp")),h.addEventListener("change",async()=>{const _=h.files[0];h.value="";const b=await(async O=>{let G=null,z=null;if(typeof createImageBitmap<"u")try{if(G=await createImageBitmap(O),G)return G}catch{}var J;return G||(z=await(J=O,new Promise((X,q)=>{let H=URL.createObjectURL(J),ee=new Image;ee.dbrObjUrl=H,ee.src=H,ee.onload=()=>{X(ee)},ee.onerror=ne=>{q(new Error("Can't convert blob to image : "+(ne instanceof Event?ne.type:ne)))}}))),z})(_),x=b instanceof HTMLImageElement?b.naturalWidth:b.width,S=b instanceof HTMLImageElement?b.naturalHeight:b.height;this._imgWidth=x,this._imgHeight=S;const F=O=>{const G=Date.now();if(x===0||S===0)return null;if(O instanceof HTMLImageElement&&!O.complete)throw new Error("The source is not loaded.");const z=this._scanRegion,J=this.getFrameSize(x,S,z,this.maxCvsSideLength);if(!J)return null;let X=!0;x===J.sWidth&&S===J.sHeight&&(X=!1);const q=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase()),H={data:null,region:z?JSON.parse(JSON.stringify(z)):null,sx:J.sx,sy:J.sy,width:J.dWidth,height:J.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:X,toCanvas:this._toCanvas,_sWidth:J.sWidth,_sHeight:J.sHeight,_bUseWebGL:null},ee=this._getImageData(O,x,S,J,null,{pixelFormat:q});if(!ee)return null;const ne=Date.now();return $._onLog&&$._onLog("DCE: _getVideoData(region?) END: "+ne),H.data=ee.data,H.pixelFormat=H.colorMode=ee.pixelFormat,H._bUseWebGL=ee._bUseWebGL,H.timeSpent=ne-G,H.timeStamp=ne,ee.pixelFormat===me.GREY?H.stride=H.width:H.stride=4*H.width,H};(O=>{let G=this._cvsSingleFrameMode;if(!G){if(G=document.createElement("canvas"),!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(G),G.style.position="absolute",G.style.width="100%",G.style.height="100%",G.style.left="0",G.style.top="0",G.style.objectFit="contain",G.style.pointerEvents="none",this._cvsSingleFrameMode=G}G.width==x&&G.height==S||(G.width=x,G.height=S);const z=G.getContext("2d");z.clearRect(0,0,G.width,G.height),z.drawImage(O,0,0)})(b),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let O of this._arrScanRegionOverlays)O&&this._updateScanRegionOverlay(O);let E;this._updateDrawingLayersSize();try{E=F(b)}catch(O){throw O}const P=this.mapCameraEvents.get("singleframeacquired");for(let O of P)if(O)try{const G={data:new Uint8Array(E.data),region:JSON.parse(JSON.stringify(E.region)),sx:E.sx,sy:E.sy,width:E.width,height:E.height,stride:E.stride,colorMode:E.colorMode,pixelFormat:E.pixelFormat,timeSpent:E.timeSpent,timeStamp:E.timeStamp,isCropped:E.isCropped,toCanvas:E.toCanvas,_sWidth:E._sWidth,_sHeight:E._sHeight,_bUseWebGL:E._bUseWebGL};await O.apply(this,[G])}catch(G){console.error(G)}}),h.style.position="absolute",h.style.top="-9999px",h.style.backgroundColor="transparent",h.style.color="transparent";const d=document.createElement("div");d.append(h),d.style.position="absolute",d.style.width="1px",d.style.height="1px",d.style.overflow="hidden",d.style.pointerEvents="none",this._elContainer.prepend(d),this._singleFrameInputContainer=d}h==null||h.click()},this.styleEls=[],this._framePixelFormat=void 0,this._defaultFramePixelFormat="rgba",this.mapPixelFormatString_Enum=new Map([["grey",me.GREY],["grey32",me.GREY32],["rgba",me.RGBA],["rbga",me.RBGA],["grba",me.GRBA],["gbra",me.GBRA],["brga",me.BRGA],["bgra",me.BGRA]]),this.shaderPixelFormat=me.RGBA,this.maxVideoCvsLength=3,this._reusedCvs=null,this._reusedWebGLCvs=null,this._tempDataContainer=null,this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._softwareScale=1,this._scaleCenter={x:0,y:0},this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,_focusArea:null},this._tapFocusEnabled=!0,this._focusSupported=!0,this._tapDoFocus=async h=>{if(this._touchMoved)return void(this._touchMoved=!1);if(!this._tapFocusEnabled||!this._bOpen||this._isSingleFrameModeEnabled()||!this._video||this._video.paused||!this._videoTrack||!this._focusSupported||this.getDrawingLayers().some(de=>de.getMode()=="editor"))return;if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(this._focusParameters.kTimeout==null&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus==1)return;let d,_,b,x;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),h instanceof MouseEvent)d=h.clientX,_=h.clientY;else{if(!(h instanceof TouchEvent))throw new Error("Unknown event type.");if(!h.changedTouches.length)return;d=h.changedTouches[0].clientX,_=h.changedTouches[0].clientY}const S=this.getVideoFit(),F=this._video.videoWidth,E=this._video.videoHeight,P=this._elContainer.getBoundingClientRect(),O=P.left,G=P.top,z=window.getComputedStyle(this._elContainer),J=parseFloat(z.width),X=parseFloat(z.height),q=J/X,H=F/E;let ee=1;if(S==="contain")H>q?(ee=J/F,b=(d-O)/ee,x=(_-G-(X-J/H)/2)/ee):(ee=X/E,x=(_-G)/ee,b=(d-O-(J-X*H)/2)/ee);else{if(S!=="cover")throw new Error("Unsupported object-fit.");H>q?(ee=X/E,x=(_-G)/ee,b=(d-O+(X*H-J)/2)/ee):(ee=J/F,b=(d-O)/ee,x=(_-G+(J/H-X)/2)/ee)}const ne={x:b+"px",y:x+"px"},ie=2*Math.round(Math.min(F,E)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px",he=ie;await this._setLocalFocus(ne,ie,he,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance),this._focusParameters.taskBackToContinous=setTimeout(()=>{this._videoTrack&&this._videoTrack.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch(()=>{})},this._focusParameters.focusBackToContinousTime)},this._touchMoved=!1,this._touchMoveEvent=()=>{this._touchMoved=!0},this._recordedStates={},this.playCallbackInfo=null,this._toCanvas=function(){const h=document.createElement("canvas");let d;if(h.width=this.width,h.height=this.height,(this.pixelFormat||this.colorMode)==="grey"){d=new Uint8ClampedArray(this.width*this.height*4);for(let b=0;b<d.length;b+=4)d[b]=this.data[b/4],d[b+1]=this.data[b/4],d[b+2]=this.data[b/4],d[b+3]=255}else d=new Uint8ClampedArray(this.data.buffer);const _=new ImageData(d,this.width,this.height);return h.getContext("2d").putImageData(_,0,0),h},this._onCameraSelChange=async()=>{await this.selectCamera(this._selCam.value),this._bOpen||this.stop()},this._onResolutionSelChange=async()=>{let h,d;if(this._selRsl&&this._selRsl.selectedIndex!=-1){let _=this._selRsl.options[this._selRsl.selectedIndex];h=_.getAttribute("data-width"),d=_.getAttribute("data-height")}await this.setResolution(h,d),this._bOpen||this.stop()},this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.isCameraEnhancer=!0,this.isDisposed=!1,this.disposed=!1,this.videoSrc=null,this.cameraOpenTimeout=4e3,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{if(!this._isSingleFrameModeEnabled()){if(document.visibilityState==="visible"){if($._onLog&&$._onLog("DCE: document visible."),this._bOpen&&this._vc_bPlayingVideoBeforeHide){if(this.videoSrc)this._video.play();else if(this._video.srcObject){const h=this._video.srcObject.getTracks()[0];if(this._video.srcObject.active&&h)if(h.muted&&["iPhone","iPad","Mac"].includes(we.OS)){if(we.version>=17)return;this.play()}else this._video.play();else this.play()}}}else if(document.visibilityState==="hidden")if($._onLog&&$._onLog("DCE: document hidden."),["iPhone","iPad","Mac"].includes(we.OS)){if(this._vc_bPlayingVideoBeforeHide=!0,we.version>=17)return;this._video&&this._video.pause()}else this._video&&!this._video.paused?(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause()):this._vc_bPlayingVideoBeforeHide=!1}},this.containerClassName="dce-video-container",this._elContainer=null,this._videoContainer=null,this._video=null,this.videoFit="contain",this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=void 0,this._defaultBShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._layerBaseCvs=null,this._drawingLayerOfTip=null,this._tipArgs={x:void 0,y:void 0,width:void 0,duration:void 0,autoShowSuggestedTip:void 0},this._hideTipTimeoutId=null,this.onTipSuggested=null,this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this._croppingRegions=void 0,this._defaultCroppingRegions=[null],this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=void 0,this._defaultLoopInterval=0,this._maxNumberOfFramesInBuffer=void 0,this._defaultMaxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._refreshInterval=void 0,this._defaultRefreshInterval=-1,this._updateLayersTimeout=500,this._updateLayers=()=>{this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none");for(let h of this._arrScanRegionOverlays)h&&(h.style.display="none");this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout(()=>{if(!this.isDisposed||!this.disposed){this.ifShowScanRegionMask&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this.showScanRegionLaser(),this._cvsViewDecorator&&this.showViewDecorator(),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let h of this._arrScanRegionOverlays)h&&(h.style.display="",this._updateScanRegionOverlay(h));this._updateDrawingLayersSize(),this._updateVideoContainerStyle()}},this._updateLayersTimeout)},this._windowResizeListener=()=>{this._windowWidth!==document.documentElement.clientWidth&&(this._windowWidth=document.documentElement.clientWidth,this._updateLayers())},this.mapCameraEvents=new Map([["cameraopen",[]],["cameraclose",[]],["camerachange",[]],["resolutionchange",[]],["played",[]],["singleframeacquired",[]],["frameaddedtobuffer",[]]]),this._controler=null,navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?this._singleFrameMode=!1:this._singleFrameMode=!0}static getVersion(){return this._version}static async detectEnvironment(){return await(async()=>({wasm:dt,worker:ft,getUserMedia:ot,camera:await gt(),browser:we.browser,version:we.version,OS:we.OS}))()}static set engineResourcePath(h){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");$._engineResourcePath=(d=>{if(d==null&&(d="./"),!Qe){let _=document.createElement("a");_.href=d,d=_.href}return d.endsWith("/")||(d+="/"),d})(h)}static get engineResourcePath(){return this._engineResourcePath}static isStorageAvailable(h){let d;try{d=window[h];const _="__storage_test__";return d.setItem(_,_),d.removeItem(_),!0}catch(_){return _ instanceof DOMException&&(_.code===22||_.code===1014||_.name==="QuotaExceededError"||_.name==="NS_ERROR_DOM_QUOTA_REACHED")&&d&&d.length!==0}}static isDCEFrame(h){return!(!h||typeof h!="object"||Array.isArray(h))&&"data"in h&&"region"in h&&"sx"in h&&"sy"in h&&"width"in h&&"height"in h&&("colorMode"in h||"pixelFormat"in h)&&"timeSpent"in h&&"timeStamp"in h&&"isCropped"in h&&"toCanvas"in h&&"_sWidth"in h&&"_sHeight"in h&&"_bUseWebGL"in h}static async testCameraAccess(){try{if(!navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return{ok:!1,message:"Insecure context."};(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(h=>{h.stop()})}catch(h){if(h.name==="OverconstrainedError"||h.name==="NotFoundError")return{ok:!1,message:"No camera detected."};if(h.name==="NotAllowedError")return{ok:!1,message:"No permission to access camera."};if(h.name==="AbortError")return{ok:!1,message:"Some problem occurred which prevented the device from being used."};if(h.name==="NotReadableError")return{ok:!1,message:"A hardware error occurred."};if(h.name==="SecurityError")return{ok:!1,message:"User media support is disabled."};throw h}return{ok:!0,message:"Successfully accessed the camera."}}set maxCvsSideLength(h){if(h<=0)throw new Error("Invalid value.");this._maxCvsSideLength=h}get maxCvsSideLength(){if(this._maxCvsSideLength!==void 0)return this._maxCvsSideLength;if(this._controler){const h=this._controler.getPropertyDisiredValue("maxCvsSideLength");if(h&&h.length===1)return h[0]}return this._defaultMaxCvsSideLength}static set defaultUIElementURL(h){$._defaultUIElementURL=h}static get defaultUIElementURL(){var h;return(h=$._defaultUIElementURL)===null||h===void 0?void 0:h.replace("@engineResourcePath/",$.engineResourcePath)}getUIElement(){return this.UIElement}async setUIElement(h){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if(typeof h=="string"||h instanceof String){if(!h.trim().startsWith("<")){let _=await fetch(h);if(!_.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+_.statusText);h=await _.text()}if(!h.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let d=document.createElement("div");d.innerHTML=h;for(let _=0;_<d.childElementCount;++_){let b=d.children[_];b instanceof HTMLStyleElement&&(this.styleEls.push(b),document.head.append(b))}(h=d.childElementCount==1?d.children[0]:d).remove()}this.UIElement=h,this._uiOriginalState={display:h&&h.style.display,inDom:document.body.contains(h)}}appendAndShowUI(){this.UIElement&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),this.UIElement.style.display=="none"&&(this.UIElement.style.display=""))}hideUI(){this.UIElement&&(this.UIElement.style.display="none")}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(h){var d;if(typeof h!="boolean"&&!["image","camera"].includes(h))throw new Error("Invalid value.");if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=h;const _=(d=this._singleFrameInputContainer)===null||d===void 0?void 0:d.firstElementChild;_&&(h==="camera"?(_.setAttribute("capture",""),_.setAttribute("accept","image/*")):h!=1&&h!=="image"||(_.removeAttribute("capture"),_.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp")))}set frameColorMode(h){this._framePixelFormat=h}get frameColorMode(){if(this._framePixelFormat!==void 0)return this._framePixelFormat;if(this._controler){const h=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(h&&h.length===1)return h[0]}return this._defaultFramePixelFormat}set framePixelFormat(h){this._framePixelFormat=h}get framePixelFormat(){if(this._framePixelFormat!==void 0)return this._framePixelFormat;if(this._controler){const h=this._controler.getPropertyDisiredValue("framePixelFormat")||this._controler.getPropertyDisiredValue("frameColorMode");if(h&&h.length===1)return h[0]}return this._defaultFramePixelFormat}set bOpen(h){if(this._bOpen=h,h){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let d of this._arrScanRegionOverlays)d&&this._updateScanRegionOverlay(d);this._updateDrawingLayersSize(),this.ifShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this.ifShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this.showScanRegionOverlays(),this._drawingLayersManager.setVisible(!0)}else this._softwareScale=1}set ifSaveLastUsedCamera(h){h?$.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(h){if(h=h.toLowerCase(),!["contain","cover"].includes(h))throw new Error(`Unsupported value '${h}'.`);if(this.videoFit=h,this._video&&(this._video.style.objectFit=h,!this._isSingleFrameModeEnabled())){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let d of this._arrScanRegionOverlays)d&&this._updateScanRegionOverlay(d);this._updateVideoContainerStyle(),this._drawingLayersManager.setObjectFit(h)}}getVideoFit(){return this.videoFit}_showElClassName(){this._videoContainer&&this._videoContainer.classList.add("div-video-container"),this._cvsScanRegion&&this._cvsScanRegion.classList.add("cvs-scan-region-mask"),this._cvsViewDecorator&&this._cvsViewDecorator.classList.add("cvs-view-decorator"),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.classList.add("div-scan-region-overlay-container"),this._layerBaseCvs&&this._layerBaseCvs.classList.add("cvs-drawing-layer-base"),this._layerBaseCvs&&this._layerBaseCvs.parentElement.classList.add("div-drawing-layer-container"),this._cvsOriginalImage&&this._cvsOriginalImage.classList.add("cvs-original-image"),this._cvsSingleFrameMode&&this._cvsSingleFrameMode.classList.add("cvs-single-frame"),this._singleFrameInputContainer&&this._singleFrameInputContainer.classList.add("div-single-frame-input-container")}_hideElClassName(){this._videoContainer&&(this._videoContainer.className=""),this._cvsScanRegion&&(this._cvsScanRegion.className=""),this._cvsViewDecorator&&(this._cvsViewDecorator.className=""),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.className=""),this._layerBaseCvs&&(this._layerBaseCvs.className=""),this._layerBaseCvs&&(this._layerBaseCvs.className=""),this._cvsOriginalImage&&(this._cvsOriginalImage.className=""),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.className=""),this._singleFrameInputContainer&&(this._singleFrameInputContainer.className="")}set ifShowScanRegionMask(h){this._bShowScanRegionMask=h,h?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display=="none"&&(this._cvsScanRegion.style.display=""),this._recordedStates.maskShow=!0)}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none",this._recordedStates.maskShow=!1)}set ifShowScanRegionLaser(h){this._bShowScanRegionLaser=h,h?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){if(this._bShowScanRegionLaser!==void 0)return this._bShowScanRegionLaser;if(this._controler){const h=this._controler.getPropertyDisiredValue("ifShowScanRegionLaser");if(h&&h.length){let d=0;for(let _ of h)_||d++;return d!==this._controler.getRegisteredUsers().length}}return this._defaultBShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display=="none"&&(this._divScanLight.style.display="block"),this._recordedStates.laserShow=!0)}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none",this._recordedStates.laserShow=!1)}_checkValidRegion(h){return h===null||!!h&&!!(h.hasOwnProperty("regionLeft")&&h.hasOwnProperty("regionTop")&&h.hasOwnProperty("regionRight")&&h.hasOwnProperty("regionBottom")&&h.hasOwnProperty("regionMeasuredByPercentage"))&&!(h.regionLeft<0||h.regionTop<0||h.regionRight<0||h.regionBottom<0)&&(!h.regionMeasuredByPercentage||!(h.regionLeft>100||h.regionTop>100||h.regionRight>100||h.regionBottom>100))}set scanRegion(h){if(!this._checkValidRegion(h))throw new Error("Invalid region.");this._scanRegion=JSON.parse(JSON.stringify(h)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let d of this._arrScanRegionOverlays)d&&this._updateScanRegionOverlay(d)}setScanRegion(h){this.scanRegion=h}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}_calculateCvsSize(){var h,d;let _,b,x;if(this._isSingleFrameModeEnabled()?(_=this._imgWidth,b=this._imgHeight,x="contain"):(_=(h=this._video)===null||h===void 0?void 0:h.videoWidth,b=(d=this._video)===null||d===void 0?void 0:d.videoHeight,x=this.getVideoFit()),!_||!b)throw new Error("Invalid content dimensions.");return{width:_,height:b,objectFit:x}}addScanRegionOverlayCanvas(){this._assertOpen();const h=document.createElement("canvas");if(this._updateScanRegionOverlay(h),!this._scanRegionOverlayContainer){const d=document.createElement("div");if(this._scanRegionOverlayContainer=d,d.style.position="absolute",d.style.left="0",d.style.top="0",d.style.width="100%",d.style.height="100%",d.style.overflow="hidden",d.style.pointerEvents="none",this._layerBaseCvs)this._layerBaseCvs.parentElement.after(d);else if(this._cvsScanRegion)this._cvsScanRegion.after(d);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(d);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(d);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(d)}this._recordedStates.overlayShow=!0}return this._scanRegionOverlayContainer.append(h),this._arrScanRegionOverlays.push(h),h}removeScanRegionOverlayCanvas(h){const d=this._arrScanRegionOverlays.indexOf(h);d!==-1&&(h.remove(),this._arrScanRegionOverlays.splice(d,1))}_updateScanRegionOverlay(h){if(!h)return;let d;try{d=this._calculateCvsSize()}catch(he){if((he.message||he)==="Invalid content dimensions.")return;throw he}const{width:_,height:b,objectFit:x}=d;if(_<=0||b<=0)return h.width=0,void(h.height=0);const S=this._getRegionInPixels(_,b,this._scanRegion),F=this.getFrameSize(_,b,this._scanRegion,this.maxCvsSideLength),E=F.dWidth,P=F.dHeight;h.width==E&&h.height==P||(h.width=E,h.height=P);const O=window.getComputedStyle(this._elContainer),G=parseFloat(O.width),z=parseFloat(O.height),J=G/z,X=_/b;let q,H,ee,ne,ie=1;x==="contain"?(X>J?(ie=G/_,q=0,H=(z-b*ie)/2):(ie=z/b,q=(G-_*ie)/2,H=0),q+=S.regionLeft*ie,H+=S.regionTop*ie,ee=(S.regionRight-S.regionLeft)*ie,ne=(S.regionBottom-S.regionTop)*ie):x==="cover"?(X>J?(ie=z/b,q=S.regionLeft*ie-(_*ie-G)/2,H=S.regionTop*ie):(ie=G/_,q=S.regionLeft*ie,H=S.regionTop*ie-(b*ie-z)/2),ee=(S.regionRight-S.regionLeft)*ie,ne=(S.regionBottom-S.regionTop)*ie):(q=0,H=0,ee=0,ne=0),h.style.position="absolute",h.style.left=q+"px",h.style.top=H+"px",h.style.width=ee+"px",h.style.height=ne+"px"}showScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display=="none"&&(this._scanRegionOverlayContainer.style.display=""),this._recordedStates.overlayShow=!0)}hideScanRegionOverlays(){this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none",this._recordedStates.overlayShow=!1)}setViewDecorator(h,d){if(!h)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));if(!d)throw new Error("Invalid area.");this._assertOpen();let _=[];if(typeof h=="string"?_.push(h):Array.isArray(h)&&(_=JSON.parse(JSON.stringify(h))),!this._cvsViewDecorator){if(this._cvsViewDecorator=document.createElement("canvas"),this._scanRegionOverlayContainer)this._scanRegionOverlayContainer.after(this._cvsViewDecorator);else if(this._layerBaseCvs)this._layerBaseCvs.parentElement.after(this._cvsViewDecorator);else if(this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsViewDecorator);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsViewDecorator)}this._recordedStates.decoratorShow=!0}this._decoratorArea=JSON.parse(JSON.stringify(d)),this._decoratorType.length=0;const b=["rectangle","focus"],x=["crossline","crosshair"];let S=!1,F=!1;for(let E of _)E=E.toLowerCase(),b.includes(E)&&!S&&(S=!0,this._decoratorType.push(E)),x.includes(E)&&!F&&(F=!0,!this._decoratorType.includes(E)&&this._decoratorType.push(E));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display=="none"&&(this._cvsViewDecorator.style.display=""),this._recordedStates.decoratorShow=!0)}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none",this._recordedStates.decoratorShow=!1)}setViewDecoratorLineWidth(h,d){if(typeof h!="string")throw new Error("The 'type' should be a string.");if(h=h.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(h))throw new Error(`The type of '${h}' doesn't exist.`);if(!this._viewDecoratorInfo[h].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${h}'.`);this._viewDecoratorInfo[h].lineWidth=d,this._updateViewDecorator()}setViewDecoratorStrokeStyle(h,d){if(typeof h!="string")throw new Error("The 'type' should be a string.");if(h=h.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(h))throw new Error(`The type of '${h}' doesn't exist.`);if(!this._viewDecoratorInfo[h].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${h}'.`);this._viewDecoratorInfo[h].strokeStyle=d,this._updateViewDecorator()}setViewDecoratorFillStyle(h,d){if(typeof h!="string")throw new Error("The 'type' should be a string.");if(h=h.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(h))throw new Error(`The type of '${h}' doesn't exist.`);if(!this._viewDecoratorInfo[h].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${h}'.`);this._viewDecoratorInfo[h].fillStyle=d,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(h,d){if(typeof h!="string")throw new Error("The 'type' should be a string.");if(h=h.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(h))throw new Error(`The type of '${h}' doesn't exist.`);if(!this._viewDecoratorInfo[h].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${h}'.`);this._viewDecoratorInfo[h].maskFillStyle=d,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen||!this._cvsViewDecorator||!this._decoratorArea)return;let h;if(this._isSingleFrameModeEnabled())h="contain";else{if(!this._video)return;h=this.getVideoFit()}const d=this._cvsViewDecorator;d.style.position="absolute",d.style.width="100%",d.style.height="100%",d.style.left="0",d.style.top="0",d.style.objectFit=h,d.style.pointerEvents="none";const _=this.getVisibleRegion(!0);if(!_)return;const b=_.regionRight-_.regionLeft,x=_.regionBottom-_.regionTop;if(d.width==b&&d.height==x||(d.width=b,d.height=x),b<=0||x<=0)return;const S=d.getContext("2d");S.clearRect(0,0,d.width,d.height);const F=this._decoratorArea.x/100*b,E=this._decoratorArea.y/100*x,P=this._decoratorArea.width/100*b,O=this._decoratorArea.height/100*x;for(let G of this._decoratorType){if(G==="rectangle"){S.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,S.fillRect(0,0,d.width,d.height),S.clearRect(Math.round(F),Math.round(E),Math.round(P),Math.round(O)),S.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,S.fillRect(Math.round(F),Math.round(E),Math.round(P),Math.round(O)),S.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,S.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const z=S.lineWidth/2;S.strokeRect(Math.round(F-z),Math.round(E-z),Math.round(P+S.lineWidth),Math.round(O+S.lineWidth))}if(G==="focus"){S.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,S.fillRect(0,0,d.width,d.height),S.clearRect(Math.round(F),Math.round(E),Math.round(P),Math.round(O)),S.fillStyle=this._viewDecoratorInfo.focus.fillStyle,S.fillRect(Math.round(F),Math.round(E),Math.round(P),Math.round(O)),S.lineWidth=this._viewDecoratorInfo.focus.lineWidth,S.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const z=S.lineWidth/2,J=[0,.25,.75,1],X=[0,.25,.75,1];S.beginPath();for(let q=0;q<J.length;q++)if(q==0||q==3)for(let H=0;H<X.length;H+=2)S.moveTo(Math.round(F+J[q]*P),Math.round(E+X[H]*O)),S.lineTo(Math.round(F+J[q]*P),Math.round(E+X[H+1]*O));for(let q=0;q<X.length;q++)if(q==0||q==3)for(let H=0;H<J.length;H+=2)S.moveTo(Math.round(F+J[H]*P-z),Math.round(E+X[q]*O)),S.lineTo(Math.round(F+J[H+1]*P+z),Math.round(E+X[q]*O));S.stroke()}if(G==="crossline"&&(S.beginPath(),S.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,S.moveTo(Math.round(F),Math.round(E+O/2)),S.lineTo(Math.round(F+P),Math.round(E+O/2)),S.moveTo(Math.round(F+P/2),Math.round(E)),S.lineTo(Math.round(F+P/2),Math.round(E+O)),S.stroke()),G==="crosshair"){S.beginPath();const z=.05*Math.min(P,O);S.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,S.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,S.moveTo(Math.round(F+(P-z)/2),Math.round(E+O/2)),S.lineTo(Math.round(F+(P+z)/2),Math.round(E+O/2)),S.moveTo(Math.round(F+P/2),Math.round(E+(O-z)/2)),S.lineTo(Math.round(F+P/2),Math.round(E+(O+z)/2)),S.stroke()}}}getVisibleRegion(h){let d;this._assertOpen();try{d=this._calculateCvsSize()}catch(F){if((F.message||F)==="Invalid content dimensions.")return null;throw F}const{width:_,height:b,objectFit:x}=d;let S=(()=>{const F=parseFloat(window.getComputedStyle(this._elContainer).width),E=parseFloat(window.getComputedStyle(this._elContainer).height);let P,O={regionBottom:b,regionRight:_,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return x==="cover"?F/E<_/b?(P=E/b,O.regionLeft=Math.floor((_-F/P)/2),O.regionRight=Math.ceil(_-O.regionLeft),O.regionTop=0,O.regionBottom=b):(P=F/_,O.regionTop=Math.floor((b-E/P)/2),O.regionBottom=Math.ceil(b-O.regionTop),O.regionLeft=0,O.regionRight=_):x==="none"&&(F<_&&E<b?(O.regionLeft=Math.floor((_-F)/2),O.regionRight=Math.ceil(_-O.regionLeft),O.regionTop=Math.floor((b-E)/2),O.regionBottom=Math.ceil(b-O.regionTop)):F<_?(O.regionLeft=Math.floor((_-F)/2),O.regionRight=Math.ceil(_-O.regionLeft),O.regionTop=0,O.regionBottom=b):E<b&&(O.regionTop=Math.floor((b-E)/2),O.regionBottom=Math.ceil(b-O.regionTop),O.regionLeft=0,O.regionRight=_)),O})();return h?S.regionMeasuredByPercentage=!1:(S.regionBottom=Math.ceil(S.regionBottom/b*100),S.regionRight=Math.ceil(S.regionRight/_*100),S.regionLeft=Math.floor(S.regionLeft/_*100),S.regionTop=Math.floor(S.regionTop/b*100),S.regionMeasuredByPercentage=!0),S}setScanRegionMaskStyle(h){h&&(h.fillStyle&&(this.regionMaskFillStyle=h.fillStyle),h.strokeStyle&&(this.regionMaskStrokeStyle=h.strokeStyle),h.lineWidth&&(this.regionMaskLineWidth=h.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(h,d,_){if(!(h<=0||d<=0))return _?_.regionMeasuredByPercentage?{regionLeft:Math.round(_.regionLeft/100*h),regionTop:Math.round(_.regionTop/100*d),regionRight:Math.round(_.regionRight/100*h),regionBottom:Math.round(_.regionBottom/100*d),regionMeasuredByPercentage:!1}:JSON.parse(JSON.stringify(_)):{regionLeft:0,regionTop:0,regionRight:h,regionBottom:d,regionMeasuredByPercentage:!1}}_updateScanRegionCanvas(){if(!this._bOpen)return;let h;try{h=this._calculateCvsSize()}catch(E){if((E.message||E)==="Invalid content dimensions.")return;throw E}const{width:d,height:_,objectFit:b}=h;if(d<=0||_<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const x=this._getRegionInPixels(d,_,this._scanRegion);if(!this._cvsScanRegion){if(this._cvsScanRegion=document.createElement("canvas"),this._cvsOriginalImage)this._cvsOriginalImage.after(this._cvsScanRegion);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsScanRegion);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(this._cvsScanRegion)}this._recordedStates.maskShow=!0}const S=this._cvsScanRegion;S.style.position="absolute",S.style.width="100%",S.style.height="100%",S.style.left="0",S.style.top="0",S.style.objectFit=b,S.style.pointerEvents="none",S.width==d&&S.height==_||(S.width=d,S.height=_);const F=S.getContext("2d");if(F.clearRect(0,0,S.width,S.height),x.regionLeft!=0||x.regionRight!=d||x.regionTop!=0||x.regionBottom!=_){const E=x.regionLeft,P=x.regionTop,O=x.regionRight-x.regionLeft,G=x.regionBottom-x.regionTop;F.fillStyle=this.regionMaskFillStyle,F.fillRect(0,0,S.width,S.height),F.clearRect(Math.round(E),Math.round(P),Math.round(O),Math.round(G)),F.strokeStyle=this.regionMaskStrokeStyle,F.lineWidth=this.regionMaskLineWidth;const z=F.lineWidth/2;F.strokeRect(Math.round(E-z),Math.round(P-z),Math.round(O+F.lineWidth),Math.round(G+F.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;let h;try{h=this._calculateCvsSize()}catch(H){if((H.message||H)==="Invalid content dimensions.")return;throw H}const{width:d,height:_,objectFit:b}=h;if(!this._divScanArea)return;if(d<=0||_<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const x=this._getRegionInPixels(d,_,this._scanRegion),S=window.getComputedStyle(this._elContainer),F=parseFloat(S.width),E=parseFloat(S.height),P=F/E,O=d/_;let G,z,J,X,q=1;if(b==="contain")P<O?(q=F/d,G=0,z=(E-_*q)/2):(q=E/_,G=(F-d*q)/2,z=0),G+=x.regionLeft*q,z+=x.regionTop*q,J=(x.regionRight-x.regionLeft)*q,X=(x.regionBottom-x.regionTop)*q;else if(b==="cover")if(P<O){q=E/_,G=x.regionLeft*q-(d*q-F)/2,G=Math.max(G,0),G=Math.min(G,parseFloat(S.width)),z=x.regionTop*q;let H=x.regionRight*q-(d*q-F)/2;H=Math.max(H,0),H=Math.min(H,parseFloat(S.width)),J=H-G,X=(x.regionBottom-x.regionTop)*q}else{q=F/d,G=x.regionLeft*q,z=x.regionTop*q-(_*q-E)/2,z=Math.max(z,0),z=Math.min(z,parseFloat(S.height));let H=x.regionBottom*q-(_*q-E)/2;H=Math.max(H,0),H=Math.min(H,parseFloat(S.height)),J=(x.regionRight-x.regionLeft)*q,X=H-z}else G=0,z=0,J=0,X=0;this._divScanArea.style.left=G+"px",this._divScanArea.style.top=z+"px",this._divScanArea.style.width=J+"px",this._divScanArea.style.height=X+"px"}set croppingRegions(h){this._croppingRegions=h,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){if(this._croppingRegions!==void 0)return this._croppingRegions;if(this._controler){const h=this._controler.getPropertyDisiredValue("croppingRegions");if(h&&h.length===1)return h[0]}return this._defaultCroppingRegions}set croppingRegionIndex(h){h<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=h)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(h){if(h<0)throw new Error("'Invalid value.");this._loopInterval=h,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){if(this._loopInterval!==void 0)return this._loopInterval;if(this._controler){const h=this._controler.getPropertyDisiredValue("loopInterval");if(h&&h.length===1)return h[0]}return this._defaultLoopInterval}set maxNumberOfFramesInBuffer(h){if(h<=0)throw new Error("Invalid value.");for(this._maxNumberOfFramesInBuffer=h;this._frameQueue&&this._frameQueue.length>this.maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){if(this._maxNumberOfFramesInBuffer!==void 0)return this._maxNumberOfFramesInBuffer;if(this._controler){const h=this._controler.getPropertyDisiredValue("maxNumberOfFramesInBuffer");if(h&&h.length===1)return h[0]}return this._defaultMaxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}set refreshInterval(h){this._refreshInterval=h}get refreshInterval(){if(this._refreshInterval!==void 0)return this._refreshInterval;if(this._controler){const h=this._controler.getPropertyDisiredValue("refreshInterval");if(h&&h.length===1)return h[0]}return this._defaultRefreshInterval}static async createInstance(h){let d=new $;(typeof h=="string"||h instanceof String)&&(h=JSON.parse(h));for(let _ in h)d[_]=h[_];return this._hasEngineResourceLoaded=!0,$.onWarning&&(location&&location.protocol==="file:"?setTimeout(()=>{$.onWarning&&$.onWarning({id:1,message:"The page is opened over file:// and Dynamsoft Camera Enhancer may not work properly. Please open the page via https://."})},0):window.isSecureContext!==!1&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||setTimeout(()=>{$.onWarning&&$.onWarning({id:2,message:"Dynamsoft Camera Enhancer may not work properly in a non-secure context. Please open the page via https://."})},0)),d._drawingLayersManager=new _t,d}static async playVideo(h,d,_){if(!h)throw new Error("Invalid 'videoEl'.");if(!d)throw new Error("Invalid 'source'.");return typeof d=="string"||d instanceof String?h.src=d:h.srcObject=d,new Promise((b,x)=>{let S;const F=()=>{h.removeEventListener("loadstart",O),h.removeEventListener("abort",G),h.removeEventListener("play",z),h.removeEventListener("error",J)},E=()=>{S&&clearTimeout(S),F(),b(h)},P=X=>{S&&clearTimeout(S),F(),x(X)},O=()=>{h.addEventListener("abort",G,{once:!0})},G=()=>{const X=new Error("Video playing was interrupted.");X.name="AbortError",P(X)},z=()=>{E()},J=()=>{P(new Error(`Video error ${h.error.code}: ${h.error.message}.`))};h.addEventListener("loadstart",O,{once:!0}),h.autoplay?(h.addEventListener("play",z,{once:!0}),h.addEventListener("error",J,{once:!0})):(h.load(),h.play().then(()=>{E()}).catch(X=>{P(X)})),_&&(S=setTimeout(()=>{F(),x(new Error("Failed to play video. Timeout."))},_))})}static findBestRearCameraInIOS(h){if(!h||!h.length)return null;const d=["back","baksidan","bakre","bak","後置","后置","背面","خلفية","задна","posteriore","posterior","zadní","bagside","rück","πίσω","trasera","taka","arrière","אחורית","बैक","stražnja","hátsó","belakang","aртқы","후면","achterzijde","tylny","traseira","spate","задняя","задней","zadná","านหลัง","arka","sau"],_=["triple","三镜头","三鏡頭","トリプル","ثلاثية","тройна","trojný","τριπλή","kolmois","משולשת","ट्रिपल","trostruka","tiga","tripla","үштік","트리플","trippelt","trippel","trójobiektywowy","triplă","тройная","trojitá","สาม","üçlü","потроєна","ba camera"],b=["dual wide","dual-weitwinkel","dual con gran angular","dual","doble","double","双广角","雙廣角","デュアル広角","مزدوجة عريضة","двойна широкоъгълна","duální širokoúhlý","διπλή ευρεία","laajakulmainen kaksois","כפולה רחבה","ड्युअल वाइड","dvostruka široka","kettős, széles látószögű","ganda","doppia con grandangolo","қос кең бұрышты","듀얼 와이드","dwikamera","dobbelt vidvinkelkamera","dwuobiektywowy","dupla grande-angular","grande angular dupla","dublă","двойная широкоугольная","duálna širokouhlá","dubbel vidvinkel","คู่ด้านหลังมุมกว้าง","çift geniş","здвоєна ширококутна","kép rộng mặt sau"],x=h.filter(E=>{const P=E.label.toLowerCase();return d.some(O=>P.includes(O))});if(!x.length)return null;const S=x.find(E=>{const P=E.label.toLowerCase();return _.some(O=>P.includes(O))});if(S)return S.deviceId;const F=x.find(E=>{const P=E.label.toLowerCase();return b.some(O=>P.includes(O))});return F?F.deviceId:x[0].deviceId}static findBestRearCamera(h){if(!h||!h.length)return null;if(["iPhone","iPad","Mac"].includes(we.OS))return $.findBestRearCameraInIOS(h);const d=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","posterior","后面","後面","背面","后置","後置","背置","задней","خلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","taka","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belakang","बैक","задна","aртқы","задняя","bakre","านหลัง"];for(let _ of h){const b=_.label.toLowerCase();if(b&&d.some(x=>b.includes(x))&&/\b0(\b)?/.test(b))return _.deviceId}return["Android","HarmonyOS"].includes(we.OS)?h[h.length-1].deviceId:null}_isSingleFrameModeEnabled(){return this.singleFrameMode!=0}async play(h,d,_,b){let x;if(this._video&&this.videoSrc){$._onLog&&(x=Date.now(),$._onLog("DCE: start loading static video: "+x));const E=await $.playVideo(this._video,this.videoSrc,this.cameraOpenTimeout);if($._onLog&&$._onLog("DCE: finish loading static video. Costs: "+(Date.now()-x)),!this._video)return E.pause(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};const P={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.playCallbackInfo=JSON.parse(JSON.stringify(P));const O=this.mapCameraEvents.get("played");for(let G of O){if(!G)continue;const z=JSON.parse(JSON.stringify(P));setTimeout(()=>{this.isDisposed&&this.disposed||G.apply(this,[z])},0)}return this._recordedStates.videoPlaying=!0,P}if(this._isSingleFrameModeEnabled())return b&&b.notTriggerSingleFrameClick||this._clickIptSingleFrameMode(),this.playCallbackInfo={width:0,height:0,deviceId:null},{width:0,height:0,deviceId:null};if(!this._video)throw new Error("'video' is null or undefined.");const S=++this.iPlayRound;if(this.promisePlay&&(await this.promisePlay,S<this.iPlayRound))return this.playCallbackInfo={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId},{width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.promisePlay=(async()=>{var E;try{this._video&&this._video.srcObject&&this.stop(),$._onLog&&$._onLog("DCE: ======before video========");const P=()=>{if(!this._video)throw z&&z.getTracks().forEach(he=>{he.stop()}),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null or undefined.")},O=this.getVideoSettings();let G,z;if(typeof O.video=="boolean"&&(O.video={}),h)delete O.video.facingMode,O.video.deviceId={exact:h};else if(!O.video.deviceId){if(this._lastDeviceId)delete O.video.facingMode,O.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&$.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete O.video.facingMode,O.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const he=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),de=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));he&&de&&(O.video.width=he,O.video.height=de)}else if(!this.ifSkipCameraInspection){if(O.video.facingMode){if(await this.getAllCameras(!1),!this._video)throw new Error("'video' is null or undefined.");let he=O.video.facingMode;if(he instanceof Array&&he.length&&(he=he[0]),he=he.exact||he.ideal||he,he==="environment"){G=!0;const de=$.findBestRearCamera(this._allCameras);de&&(delete O.video.facingMode,O.video.deviceId={exact:de})}}}}d&&(O.video.width={ideal:d}),_&&(O.video.height={ideal:_}),$._onLog&&$._onLog("DCE: ======try getUserMedia========");let J=[0,500],X=null;const q=async he=>{for(let de of J){de&&await new Promise(fe=>setTimeout(fe,de)),P();try{$._onLog&&$._onLog("DCE: ask "+JSON.stringify(he)),z=await navigator.mediaDevices.getUserMedia(he);break}catch(fe){if(P(),fe.name==="NotFoundError"||fe.name==="NotAllowedError")throw fe;X=fe,$._onLog&&$._onLog("DCE: "+fe.message||fe)}}P()};let H;if(await q(O),!z&&($._onLog&&$._onLog("DCE: ======try getUserMedia again========"),H=JSON.parse(JSON.stringify(O)),typeof H.video=="object"&&(["iPhone","iPad"].includes(we.OS)?(d>=1280||_>=1280?H.video.width=1280:d>=640||_>=640?H.video.width=640:(d<640||_<640)&&(H.video.width=320),delete H.video.height):G&&!O.video.deviceId?(delete H.video.facingMode,this._allCameras.length&&(H.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):H.video=!0),$._onLog&&$._onLog("DCE: "+H),await q(H)),z||(J=[1e3,2e3],await q(O)),z||await q(H),!z)throw X;const ee=()=>{const he=z.getVideoTracks();let de,fe;if(he.length&&(de=this._videoTrack=he[0]),this._video&&de){const pe=de.getSettings();if(pe){for(let g of this._allCameras)if(pe.deviceId===g.deviceId){g._checked=!0,g.label=de.label,fe=g;break}}}this._currentCamera=fe};if(await this.getAllCameras(!1),P(),G&&!this.ifSkipCameraInspection){ee();const he=$.findBestRearCamera(this._allCameras),de=(E=this._currentCamera)===null||E===void 0?void 0:E.deviceId;he&&he!=de&&(z.getTracks().forEach(fe=>{fe.stop()}),J=[0,500,1e3,2e3],O.video.deviceId={exact:he},await q(O))}$._onLog&&$._onLog("DCE: ======play video========"),P(),await $.playVideo(this._video,z,this.cameraOpenTimeout),P(),$._onLog&&$._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const ne="got "+this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=ne,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),$._onLog&&$._onLog("DCE: got "+ne),ee(),this._renderSelCameraInfo();const ie={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};if(ie.deviceId&&(this._lastDeviceId=ie.deviceId,this.ifSaveLastUsedCamera&&$.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),O.video.width&&O.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(O.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(O.video.height))))),!b||!b.notTriggerPlayedEvent){const he=this.mapCameraEvents.get("played");for(let de of he){if(!de)continue;const fe=JSON.parse(JSON.stringify(ie));setTimeout(()=>{this.isDisposed&&this.disposed||de.apply(this,[fe])},0)}}return this.promisePlay=null,ie}catch(P){throw this.promisePlay=null,this._bgLoading&&(this._bgLoading.style.display="none"),P.name==="NotFoundError"&&(DOMException?P=new DOMException("No camera available, please use a device with an accessible camera.",P.name):(P=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),P}})(),$._onLog&&(x=Date.now(),$._onLog("DCE: start opening camera: "+x));const F=await this.promisePlay;return $._onLog&&$._onLog("DCE: finish opening camera. Costs: "+(Date.now()-x)),this.playCallbackInfo=JSON.parse(JSON.stringify(F)),this._recordedStates.videoPlaying=!0,F}async resume(){this._assertOpen(),this._video&&(await this._video.play(),this._recordedStates.videoPlaying=!0),this.ifShowScanRegionLaser&&this.showScanRegionLaser()}pause(){this._assertOpen(),this._video&&(this._video.pause(),this._recordedStates.videoPlaying=!1),this.ifShowScanRegionLaser&&this.hideScanRegionLaser()}isPaused(){var h;return!this._isSingleFrameModeEnabled()&&((h=this._video)===null||h===void 0?void 0:h.paused)===!0}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");const h=[this.UIElement];for(let d=0;d<h.length;++d)for(let _ of h[d].children)h.push(_);for(let d of h){if(!this._video&&d.classList.contains(this.containerClassName)){this._elContainer=d;const _=document.createElement("video");_.style.position="absolute",_.style.left="0",_.style.top="0",_.style.width="100%",_.style.height="100%",_.style.objectFit=this.getVideoFit(),_.setAttribute("autoplay","true"),_.setAttribute("playsinline","true"),_.setAttribute("muted","true"),["iPhone","iPad","Mac"].includes(we.OS)&&we.version>=17&&_.setAttribute("poster","data:image/gif;base64,R0lGODlhAQABAIEAAAAAAAAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAgEAAEEBAA7"),this._video=_;const b=document.createElement("div");b.append(_),b.style.position="absolute",b.style.left="0",b.style.top="0",b.style.width="100%",b.style.height="100%",b.style.overflow="hidden",this._videoContainer=b,d.prepend(b)}else!this._divScanArea&&d.classList.contains("dce-scanarea")?this._divScanArea=d:!this._divScanLight&&d.classList.contains("dce-scanlight")?this._divScanLight=d:!this._bgLoading&&d.classList.contains("dce-bg-loading")?this._bgLoading=d:!this._bgCamera&&d.classList.contains("dce-bg-camera")?this._bgCamera=d:!this._selCam&&d.classList.contains("dce-sel-camera")?this._selCam=d:!this._selRsl&&d.classList.contains("dce-sel-resolution")?(this._selRsl=d,this.videoSrc||this._isSingleFrameModeEnabled()||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">ask 1920x1080</option>','<option data-width="1280" data-height="720">ask 1280x720</option>','<option data-width="640" data-height="480">ask 640x480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&d.classList.contains("dce-opt-gotResolution")?this._optGotRsl=d:!this._btnClose&&d.classList.contains("dce-btn-close")?this._btnClose=d:!this._selMinLtr&&d.classList.contains("dlr-sel-minletter")?(this._selMinLtr=d,this._selMinLtr.options.length||(this._selMinLtr.innerHTML=[this._optGotMinLtr?"":'<option class="dlr-opt-gotMinLtr" value="got"></option>','<option value="0" selected>any letter</option>','<option value="3">3+ letters</option>','<option value="5">5+ letters</option>','<option value="8">8+ letters</option>','<option value="12">12+ letters</option>','<option value="17">17+ letters</option>','<option value="30">30+ letters</option>','<option value="50">50+ letters</option>','<option value="80">80+ letters</option>','<option value="120">120+ letters</option>'].join(""),this._optGotMinLtr=this._optGotMinLtr||this._selMinLtr.options[0])):!this._optGotMinLtr&&d.classList.contains("dlr-opt-gotMinLtr")&&(this._optGotMinLtr=d);if(this.extraBindings&&this.extraBindings.length)for(let _ of this.extraBindings)try{_(d)}catch{}}if(!this._video)throw this._unbindUI(),Error(`Can not find the video container element with class '${this.containerClassName}'`);this._isSingleFrameModeEnabled()||this.videoSrc?(this._isSingleFrameModeEnabled()&&(this._elContainer&&(this._elContainer.addEventListener("click",this._clickIptSingleFrameMode),this._elContainer.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="block")),this._selCam&&(this._selCam.style.display="none"),this._selRsl&&(this._selRsl.style.display="none"),this._selMinLtr&&(this._selMinLtr.style.display="none")):(this._elContainer&&(["Android","HarmonyOS"].includes(we.OS)?(this._elContainer.addEventListener("touchend",this._tapDoFocus),this._elContainer.addEventListener("touchmove",this._touchMoveEvent)):this._elContainer.addEventListener("click",this._tapDoFocus)),this._selCam&&(this._selCam.style.display="block",this._selCam.addEventListener("change",this._onCameraSelChange)),this._selRsl&&(this._selRsl.style.display="block",this._selRsl.addEventListener("change",this._onResolutionSelChange)),this._selMinLtr&&(this._selMinLtr.style.display="block"),this._bgLoading&&(this._bgLoading.style.display="block")),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&(this._resizeObserver||(this._resizeObserver=new ResizeObserver(d=>{for(let _ of d)_.target===this._elContainer&&this._updateLayers()})),this._elContainer&&this._resizeObserver.observe(this._elContainer)),this._windowWidth=document.documentElement.clientWidth,window.addEventListener("resize",this._windowResizeListener)}_unbindUI(){this._isSingleFrameModeEnabled()?(this._elContainer&&(this._elContainer.removeEventListener("click",this._clickIptSingleFrameMode),this._elContainer.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._elContainer&&(this._elContainer.removeEventListener("click",this._tapDoFocus),this._elContainer.removeEventListener("touchend",this._tapDoFocus),this._elContainer.removeEventListener("touchmove",this._touchMoveEvent)),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this.hideScanRegionOverlays(),this._drawingLayersManager.setVisible(!1),this._hideOriginalImageCvs(),this._videoContainer&&this._videoContainer.remove(),this._video=null,this._videoContainer=null,this._elContainer=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._selMinLtr=null,this._optGotMinLtr=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameInputContainer&&(this._singleFrameInputContainer.remove(),this._singleFrameInputContainer=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.ResizeObserver&&this._resizeObserver&&this._resizeObserver.disconnect(),window.removeEventListener("resize",this._windowResizeListener)}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}async open(h){this.UIElement||await this.setUIElement($.defaultUIElementURL),this._bindUI(),h&&this.appendAndShowUI();let d=await this.play();this.bOpen=!0,this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this._isSingleFrameModeEnabled()&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1));const _=this.mapCameraEvents.get("cameraopen");for(let b of _){if(!b)continue;const x=JSON.parse(JSON.stringify(d));setTimeout(()=>{this.isDisposed&&this.disposed||b.apply(this,[x])},0)}return d}close(h){if(!this._video)return;this.stop(),this._hideOriginalImage(!1),this.hideTip(),this._unbindUI(),h&&this.hideUI(),this.stopFetchingLoop(),this.bOpen=!1;const d=this.mapCameraEvents.get("cameraclose");for(let _ of d){if(!_)continue;const b={width:0,height:0,deviceId:null};setTimeout(()=>{this.isDisposed&&this.disposed||_.apply(this,[b])},0)}}stop(){this._video&&this._video.srcObject&&($._onLog&&$._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach(h=>{h.stop()}),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this.videoSrc&&($._onLog&&$._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0,this._reusedCvs&&this._reusedCvs.ctx2d&&this._reusedCvs.ctx2d.clearRect(0,0,this._reusedCvs.width,this._reusedCvs.height),this.forceLoseContext()}async getAllCameras(h=!0){let d=(await navigator.mediaDevices.enumerateDevices()).filter(x=>x.kind==="videoinput");if(h&&d&&d.length&&!d[0].deviceId){let x=await navigator.mediaDevices.getUserMedia({video:!0});d=(await navigator.mediaDevices.enumerateDevices()).filter(S=>S.kind==="videoinput"),x.getTracks().forEach(S=>{S.stop()})}const _=[],b=[];if(this._allCameras)for(let x of this._allCameras)x._checked&&b.push(x);for(let x=0;x<d.length;x++){let S,F=d[x];for(let E of b)if(F.deviceId==E.deviceId){S=E;break}S||(S={deviceId:F.deviceId,label:F.label?F.label:"camera "+x,_checked:!1}),S.deviceId&&_.push(S)}return this._allCameras=_,$._onLog&&$._onLog("DCE: "+JSON.stringify(this._allCameras)),_}_renderSelCameraInfo(){if(!this._selCam)return;let h;this._selCam.textContent="";for(let d of this._allCameras){const _=document.createElement("option");_.value=d.deviceId,_.innerText=d.label,this._selCam.append(_),d.deviceId&&this._currentCamera&&this._currentCamera.deviceId==d.deviceId&&(h=_)}this._selCam.value=h?h.value:""}getSelectedCamera(){if(!this._bOpen){let h="";const d=this.videoSettings.video.deviceId;d&&(h=d.exact||d.ideal||d);for(let _ of this._allCameras)if(_.deviceId===h)return JSON.parse(JSON.stringify(_));return{deviceId:h,label:"",_checked:!1}}return this._currentCamera}async selectCamera(h){let d="";if(h&&(d=h.deviceId||h),this.videoSettings.video.deviceId={exact:d},!this._bOpen||this._video.paused)return null;let _=null;this._currentCamera&&(_=this._currentCamera.deviceId);const b=this._video.videoWidth,x=this._video.videoHeight,S=await this.play(h.deviceId||h);if(this._focusParameters.fds=null,this._focusParameters.kTimeout=void 0,this._focusSupported=!0,this._tapFocusEnabled&&!this._isSingleFrameModeEnabled()&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,this._focusParameters.fds||(this._focusSupported=!1,this._tapFocusEnabled=!1)),_!==S.deviceId){const F=this.mapCameraEvents.get("camerachange");for(let E of F){if(!E)continue;const P=JSON.parse(JSON.stringify(S));setTimeout(()=>{this.isDisposed&&this.disposed||E.apply(this,[P])},0)}}if(b!==S.width||x!==S.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let E of this._arrScanRegionOverlays)E&&this._updateScanRegionOverlay(E);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const F=this.mapCameraEvents.get("resolutionchange");for(let E of F){if(!E)continue;const P=JSON.parse(JSON.stringify(S));setTimeout(()=>{this.isDisposed&&this.disposed||E.apply(this,[P])},0)}}return S}getResolution(){if(this._bOpen)return[this._video.videoWidth,this._video.videoHeight];{let h=0,d=0;const _=this.videoSettings.video.width,b=this.videoSettings.video.height;return _&&(h=_.exact||_.ideal||_),b&&(d=b.exact||b.ideal||b),[h,d]}}async setResolution(h,d){let _,b;if(h instanceof Array?(_=h[0],b=h[1]):(_=h,b=d),this.videoSettings.video.width={ideal:_},this.videoSettings.video.height={ideal:b},!this._bOpen||this._video.paused)return null;const x=this._video.videoWidth,S=this._video.videoHeight,F=await this.play(null,_,b);if(x!==F.width||S!==F.height){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let P of this._arrScanRegionOverlays)P&&this._updateScanRegionOverlay(P);this._updateDrawingLayersSize(),this._updateVideoContainerStyle();const E=this.mapCameraEvents.get("resolutionchange");for(let P of E){if(!P)continue;const O=JSON.parse(JSON.stringify(F));setTimeout(()=>{this.isDisposed&&this.disposed||P.apply(this,[O])},0)}}return F}async getResolutions(h){var d,_;let b="";const x=(F,E)=>{const P=this._mapCameraResolutions.get(F);if(!P||!P.length)return!1;for(let O of P)if(O[0]===E.width&&O[1]===E.height)return!0;return!1},S=async(F,E,P)=>{const O={video:{deviceId:{exact:F},width:{ideal:E},height:{ideal:P}}};let G=null;try{G=await navigator.mediaDevices.getUserMedia(O)}catch{return null}if(!G)return null;const z=G.getVideoTracks();let J=null;try{const X=z[0].getSettings();J={width:X.width,height:X.height}}catch{const q=document.createElement("video");q.srcObject=G,J={width:q.videoWidth,height:q.videoHeight},q.srcObject=null}return z.forEach(X=>{X.stop()}),J};if(!this._bOpen){const F=(_=(d=this.videoSettings)===null||d===void 0?void 0:d.video)===null||_===void 0?void 0:_.deviceId;if(!F||(b=F.hasOwnProperty("exact")?this.videoSettings.video.deviceId.exact:F.hasOwnProperty("ideal")?this.videoSettings.video.deviceId.ideal:this.videoSettings.video.deviceId,!b))return null;let E=this._mapCameraResolutions.get(b);if(E&&!h)return this._mapCameraResolutions.get(b);this._mapCameraResolutions.set(b,[]),E=this._mapCameraResolutions.get(b);for(let P of this._predefinedResolutions){const O=await S(b,P.width,P.height);O&&!x(b,O)&&E.push([O.width,O.height])}return E}if(this._currentCamera){b=this._currentCamera.deviceId;let F=this._mapCameraResolutions.get(b);if(F&&!h)return this._mapCameraResolutions.get(b);this._mapCameraResolutions.set(b,[]),F=this._mapCameraResolutions.get(b);let E=this._videoTrack;for(let P of this._predefinedResolutions){await E.applyConstraints({width:{ideal:P.width},height:{ideal:P.height}});const O=E.getSettings(),G={width:O.width,height:O.height};x(b,G)||F.push([G.width,G.height])}return this._video.srcObject.getTracks().forEach(P=>{P.stop()}),await this.play(b,null,null,{notTriggerPlayedEvent:!0}),F}return null}on(h,d){if(!d)return;const _=this.mapCameraEvents.get(h.toLowerCase());if(!_)throw new Error(`Event '${h}' does not exist.`);_.includes(d)||_.push(d)}off(h,d){const _=this.mapCameraEvents.get(h.toLowerCase());if(!_)throw new Error(`Event '${h}' does not exist.`);const b=_.indexOf(d);b!==-1&&_.splice(b,1)}offAll(h){if(h){if(typeof h=="string"){const d=this.mapCameraEvents.get(h);d&&(d.length=0)}}else for(let d of this.mapCameraEvents.values())d&&(d.length=0)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(h){if(this.videoSettings=JSON.parse(JSON.stringify(h)),this._lastDeviceId=null,this._bOpen)return this.play()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getCapabilities()' is unavailable in singleFrameMode.");return this._videoTrack&&this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings():null}getConstraints(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getConstraints()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getConstraints():null}async applyConstraints(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return await this._videoTrack.applyConstraints(h)}async turnOnTorch(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}async turnOffTorch(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return await this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}async setColorTemperature(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let d=this.getCapabilities().colorTemperature;if(!d)throw Error("Not supported.");return h<d.min?h=d.min:h>d.max&&(h=d.max),await this._videoTrack.applyConstraints({advanced:[{colorTemperature:h,whiteBalanceMode:"manual"}]})}getColorTemperature(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getColorTemperature()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().colorTemperature||0:null}async setExposureCompensation(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let d=this.getCapabilities().exposureCompensation;if(!d)throw Error("Not supported.");return h<d.min?h=d.min:h>d.max&&(h=d.max),await this._videoTrack.applyConstraints({advanced:[{exposureCompensation:h}]})}getExposureCompensation(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getExposureCompensation()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().exposureCompensation||0:null}async _setHardwareScale(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_setHardwareScale()' is unavailable in singleFrameMode.");if(h<1)throw new RangeError("Invalid value.");if(!this._videoTrack)return;const d=this.getCapabilities().zoom;if(!d)throw new Error("Not supported.");return h<d.min?h=d.min:h>d.max&&(h=d.max),h=Me(h,d.min,d.step,d.max),await this._videoTrack.applyConstraints({advanced:[{zoom:h}]}),h}_getHardwareScale(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().zoom||1:null}_setSoftwareScale(h,d){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_setSoftwareScale()' is unavailable in singleFrameMode.");if(h<1)throw new RangeError("Invalid value.");d&&this._setScaleCenter(d),this._softwareScale=h,this._scaleVideo(h,d)}_getSoftwareScale(){return this._softwareScale}_setScaleCenter(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_setScaleCenter()' is unavailable in singleFrameMode.");if(!h||typeof h.x!="string"||typeof h.y!="string")throw new Error("Invalid center.");const d=this._video.videoWidth,_=this._video.videoHeight;let b=0,x=0;if(h.x.endsWith("px"))b=parseFloat(h.x);else{if(!h.x.endsWith("%"))throw new Error("Invalid scale center.");b=parseFloat(h.x)/100*d}if(h.y.endsWith("px"))x=parseFloat(h.y);else{if(!h.y.endsWith("%"))throw new Error("Invalid scale center.");x=parseFloat(h.y)/100*_}if(b==NaN||x==NaN)throw new Error("Invalid scale center.");this._scaleCenter={x:b,y:x}}_resetScaleCenter(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_resetScaleCenter()' is unavailable in singleFrameMode.");const h=this._video.videoWidth,d=this._video.videoHeight;this._scaleCenter={x:h/2,y:d/2}}_isVideoCenter(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_isVideoCenter()' is unavailable in singleFrameMode.");return h&&h.x==this._video.videoWidth/2&&h.y==this._video.videoHeight/2}async _setZoom(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(h<1)throw new RangeError("Invalid value.");this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const d=await this._setHardwareScale(h);let _=this._getHardwareScale();_==1&&d!=1&&(_=d),h>_?this._setSoftwareScale(h/_):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(h)}catch(d){if((d.message||d)!=="Not supported.")throw d;this._setSoftwareScale(h)}}async setZoom(h){if(typeof h!="number"&&typeof h!="object")throw new TypeError("Illegal type of argument.");if(typeof h=="number")return this._setZoom(h);if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setZoom()' is unavailable in singleFrameMode.");if(h){if(typeof h.factor!="number")throw new TypeError("Illegal type of 'factor'.");if(h.factor<1)throw new RangeError("Invalid value.");h.centerPoint?this._setScaleCenter(h.centerPoint):this._resetScaleCenter();try{if(this._isVideoCenter(this._scaleCenter)){const d=await this._setHardwareScale(h.factor);let _=this._getHardwareScale();_==1&&d!=1&&(_=d),h.factor>_?this._setSoftwareScale(h.factor/_):this._setSoftwareScale(1)}else await this._setHardwareScale(1),this._setSoftwareScale(h.factor)}catch(d){if((d.message||d)!=="Not supported.")throw d;this._setSoftwareScale(h.factor)}}}getZoom(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getZoom()' is unavailable in singleFrameMode.");return this._videoTrack?this._getHardwareScale()*this._softwareScale:null}getZoomSettings(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getZoom()' is unavailable in singleFrameMode.");return this._videoTrack?{factor:this._getHardwareScale()*this._softwareScale}:null}async resetZoom(){await this.setZoom({factor:1})}async setFrameRate(h){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let d=this.getCapabilities().frameRate;if(!d)throw Error("Not supported.");return h<d.min?h=d.min:h>d.max&&(h=d.max),await this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:h})}getFrameRate(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getFrameRate()' is unavailable in singleFrameMode.");return this._videoTrack?this._videoTrack.getSettings().frameRate:null}async _setFocus(h,d){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setFocus()' is unavailable in singleFrameMode.");if(typeof h!="string")throw Error("Invalid focus mode.");h=h.toLowerCase();const _=this.getCapabilities().focusMode,b=this.getCapabilities().focusDistance;if(!_)throw Error("Not supported.");if(!_.includes(h))throw Error("Unsupported mode.");if(d>=0){if(!b)throw Error("Manual focus unsupported.");return d<b.min?d=b.min:d>b.max&&(d=b.max),d=Me(d,b.min,b.step,b.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:h,focusDistance:d}]})}return await this._videoTrack.applyConstraints({advanced:[{focusMode:h}]})}async setFocus(h,d){if(typeof h=="string")return this._setFocus(h,d);if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'setFocus()' is unavailable in singleFrameMode.");if(!h)return;const _=this.getCapabilities(),b=_.focusMode,x=_.focusDistance;if(!b)throw Error("Not supported.");if(typeof h.mode!="string")throw Error("Invalid focus mode.");const S=h.mode.toLowerCase();if(!b.includes(S))throw Error("Unsupported focus mode.");if(S!=="manual")return this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:S}]});if(!x)throw Error("Manual focus unsupported.");if(h.hasOwnProperty("distance")){let F=h.distance;return F<x.min?F=x.min:F>x.max&&(F=x.max),F=Me(F,x.min,x.step,x.max),this._focusParameters._focusArea=null,await this._videoTrack.applyConstraints({advanced:[{focusMode:S,focusDistance:F}]})}if(!h.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const F=h.area.centerPoint;let E=h.area.width,P=h.area.height;if(!E||!P){const O=this._video.videoWidth,G=this._video.videoHeight;E||(E=2*Math.round(Math.min(O,G)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),P||(P=2*Math.round(Math.min(O,G)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters._focusArea={centerPoint:{x:F.x,y:F.y},width:E,height:P},await this._setLocalFocus(F,E,P)}}getFocus(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const h=this._videoTrack.getSettings().focusMode;return h?h==="continuous"?{mode:h}:{mode:h,distance:this._videoTrack.getSettings().focusDistance}:null}getFocusSettings(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_getHardwareScale()' is unavailable in singleFrameMode.");if(!this._videoTrack)return null;const h=this._videoTrack.getSettings(),d=h.focusMode;return d?d==="manual"?this._focusParameters._focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters._focusArea))}:{mode:"manual",distance:h.focusDistance}:{mode:d}:null}async _setFocusAndGetContract(h,d){const _=z=>{if(!this._bOpen||!this._videoTrack||this.video.paused||z.focusTaskId!=this._focusParameters.curFocusTaskId){this._bOpen&&this._videoTrack&&!this.video.paused||(this._focusParameters.isDoingFocus=0);const J=new Error(`Focus task ${z.focusTaskId} canceled.`);throw J.name="DeprecatedTaskError",J}this._focusParameters.isDoingFocus===1&&Date.now()-z.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let b;d=Me(d,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:d}]}),_(h),b=this._focusParameters.oldDistance==null?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/d),Math.abs(1/this._focusParameters.fds.max-1/d))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/d)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=d,await new Promise(z=>{setTimeout(z,b)}),_(h);let x=h.focusL-h.focusW/2,S=h.focusT-h.focusH/2,F=h.focusW,E=h.focusH;if(x>=this.video.videoWidth||S>=this.video.videoHeight)throw new Error("Invalid area.");x+F>this.video.videoWidth&&(F=this.video.videoWidth-x),S+E>this.video.videoHeight&&(E=this.video.videoHeight-S);const P=this._getImageData(this.video,this.video.videoWidth,this.video.videoHeight,{sx:x,sy:S,sWidth:F,sHeight:E,dWidth:F,dHeight:E},null,{pixelFormat:me.RGBA});if(!P)return this._setFocusAndGetContract(h,d);const O=P.data;let G=0;for(let z=0,J=O.length-8;z<J;++z){let X=O[z]-O[z+8];++z;let q=O[z]-O[z+8];++z;let H=O[z]-O[z+8];++z,G+=X*X+q*q+H*H}return-G}async _doFocusDetail(h,d,_,b,x,S,F){let E;if(d=Me(d,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),b=Me(b,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),S?S=Me(S,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(S=Me(Math.sqrt((d||this._focusParameters.fds.step)*(b||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),F=await this._setFocusAndGetContract(h,S)),F<=_&&F<=x?E=3:_<x&&_<F?E=1:x<_&&x<F&&(E=2),(b-d)/2<=this._focusParameters.fds.step)return E===3||(E===1?await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:d}]}):E===2&&await this._videoTrack.applyConstraints({advanced:[{focusMode:"manual",focusDistance:b}]})),!0;if(E===1)return await this._doFocusDetail(h,d,_,S,F);if(E===2)return await this._doFocusDetail(h,S,F,b,x);if(E!==3)return _=await this._setFocusAndGetContract(h,d),x=await this._setFocusAndGetContract(h,b),await this._doFocusDetail(h,d,_,b,x);let P=Me(Math.sqrt((d||this._focusParameters.fds.step)*(S||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),O=Me(Math.sqrt((b||this._focusParameters.fds.step)*(S||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/P)<=Math.abs(1/this._focusParameters.oldDistance-1/O)){let G=await this._setFocusAndGetContract(h,P);if(G<F)return await this._doFocusDetail(h,d,_,S,F,P,G);if(G==F)return await this._doFocusDetail(h,P,G,S,F);let z=await this._setFocusAndGetContract(h,O);if(G>F&&F<z)return await this._doFocusDetail(h,P,G,O,z,S,F);if(F==z)return await this._doFocusDetail(h,S,F,O,z);if(F>z)return await this._doFocusDetail(h,S,F,b,x,O,z)}else{let G=await this._setFocusAndGetContract(h,O);if(F>G)return await this._doFocusDetail(h,S,F,b,x,O,G);if(F==G)return await this._doFocusDetail(h,S,F,O,G);let z=await this._setFocusAndGetContract(h,P);if(z>F&&F<G)return await this._doFocusDetail(h,P,z,O,G,S,F);if(z==F)return await this._doFocusDetail(h,P,z,S,F);if(z<F)return await this._doFocusDetail(h,d,_,S,F,P,z)}return!1}async _setLocalFocus(h,d,_,b,x){if(this._focusParameters.isDoingFocus==1)return!1;if(!h||typeof h.x!="string"||typeof h.y!="string")throw new Error("Invalid centerPoint.");if(!d||typeof d!="string")throw new Error("Invalid width.");if(!_||typeof _!="string")throw new Error("Invalid height.");const S=this._video.videoWidth,F=this._video.videoHeight;let E=0,P=0;if(h.x.endsWith("px"))E=parseFloat(h.x);else{if(!h.x.endsWith("%"))throw new Error("Invalid centerPoint.");E=parseFloat(h.x)/100*S}if(h.y.endsWith("px"))P=parseFloat(h.y);else{if(!h.y.endsWith("%"))throw new Error("Invalid centerPoint.");P=parseFloat(h.y)/100*F}if(E==NaN||P==NaN)throw new Error("Invalid centerPoint.");let O=0;if(d.endsWith("px"))O=parseFloat(d);else{if(!d.endsWith("%"))throw new Error("Invalid width.");O=parseFloat(d)/100*S}if(O==NaN)throw new Error("Invalid width.");let G=0;if(_.endsWith("px"))G=parseFloat(_);else{if(!_.endsWith("%"))throw new Error("Invalid height.");G=parseFloat(_)/100*F}if(G==NaN)throw new Error("Invalid height.");if(this._softwareScale!==1){const X=this._softwareScale,q=this._scaleCenter;O/=X,G/=X,E=(1-1/X)*q.x+E/X,P=(1-1/X)*q.y+P/X}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");this._focusParameters.kTimeout==null&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const z={focusL:E,focusT:P,focusW:O,focusH:G,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},J=async(X,q,H)=>{try{(q==null||q<this._focusParameters.fds.min)&&(q=this._focusParameters.fds.min),(H==null||H>this._focusParameters.fds.max)&&(H=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let ee=Me(Math.sqrt(H*(q||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),ne=Me(Math.sqrt((q||this._focusParameters.fds.step)*ee),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),ie=Me(Math.sqrt(ee*H),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),he=await this._setFocusAndGetContract(X,ie),de=await this._setFocusAndGetContract(X,ne),fe=await this._setFocusAndGetContract(X,ee);if(de>fe&&fe<he){const pe=await this._doFocusDetail(X,ne,de,ie,he,ee,fe);return this._focusParameters.isDoingFocus=0,pe}if(de<fe&&de<he){let pe=await this._setFocusAndGetContract(X,q);const g=await this._doFocusDetail(X,q,pe,ee,fe,ne,de);return this._focusParameters.isDoingFocus=0,g}if(fe>he&&de>he){let pe=await this._setFocusAndGetContract(X,H);const g=await this._doFocusDetail(X,ee,fe,H,pe,ie,he);return this._focusParameters.isDoingFocus=0,g}if(de==fe&&fe<he){const pe=await this._doFocusDetail(X,ne,de,ee,fe);return this._focusParameters.isDoingFocus=0,pe}if(fe==he&&de>fe){const pe=await this._doFocusDetail(X,ee,fe,ie,he);return this._focusParameters.isDoingFocus=0,pe}return J(X,q,H)}catch(ee){if(ee.name!=="DeprecatedTaskError")throw ee}};return J(z,b,x)}async enableTapToFocus(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'enableTapToFocus()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error("Video is not playing.");if(!this._focusSupported)throw new Error("Tapping to focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=(await this.getCapabilities()).focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,this._tapFocusEnabled=!1,new Error("Tapping to focus unsupported.");this._tapFocusEnabled=!0}disableTapToFocus(){this._tapFocusEnabled=!1}isTapToFocusEnabled(){return this._tapFocusEnabled}_updateVideoContainerStyle(){if(!this._video||this._isSingleFrameModeEnabled())return;const h=this._getSoftwareScale(),d=this._videoContainer;if(this.videoFit==="contain"&&h>1){const _=this._video.videoWidth,b=this._video.videoHeight,x=window.getComputedStyle(this._elContainer),S=parseFloat(x.width),F=parseFloat(x.height),E=_/b;if(S/F<E){let P=S/E;d.style.left="0",d.style.top=(F-P)/2/F*100+"%",d.style.width="100%",d.style.height=P/F*100+"%"}else{let P=F*E;d.style.left=(S-P)/2/S*100+"%",d.style.top="0",d.style.width=P/S*100+"%",d.style.height="100%"}}else d.style.left="0",d.style.top="0",d.style.width="100%",d.style.height="100%"}_scaleVideo(h,d){if(this._video&&!this._isSingleFrameModeEnabled()){if(h<1)throw new RangeError("Invalid scale value.");if(d&&this._setScaleCenter(d),h===1)this._video.style.transform="";else{const _=this.getVideoFit(),b=this._video.videoWidth,x=this._video.videoHeight,S=window.getComputedStyle(this._elContainer),F=parseFloat(S.width),E=parseFloat(S.height),P=F/E,O=b/x;let G=1;_==="contain"?G=P<O?F/(b/h):E/(x/h):_==="cover"&&(G=O>P?E/(b/h):F/(x/h));const z=G*(1-1/h)*(b/2-this._scaleCenter.x),J=G*(1-1/h)*(x/2-this._scaleCenter.y);this._video.style.transform=`translate(${z}px, ${J}px) scale(${h})`}this._updateVideoContainerStyle()}}getFrameSize(h,d,_,b){if(!h||!d)return null;let x,S,F,E,P=h,O=d;const G={regionLeft:0,regionTop:0,regionRight:P,regionBottom:O,regionMeasuredByPercentage:!1};_?(_.regionMeasuredByPercentage?(G.regionLeft=_.regionLeft*P/100,G.regionTop=_.regionTop*O/100,G.regionRight=_.regionRight*P/100,G.regionBottom=_.regionBottom*O/100):(G.regionLeft=_.regionLeft,G.regionTop=_.regionTop,G.regionRight=_.regionRight,G.regionBottom=_.regionBottom),x=Math.round(G.regionLeft),S=Math.round(G.regionTop),P=Math.round(G.regionRight-G.regionLeft),O=Math.round(G.regionBottom-G.regionTop)):(x=0,S=0,P=Math.round(P),O=Math.round(O));const z=Math.max(P,O);if(b&&b>0&&z>b){const J=b/z;P>O?(F=b,E=Math.round(O*J)):(F=Math.round(P*J),E=b)}else F=P,E=O;return F<=0||E<=0?null:{sx:x,sy:S,sWidth:P,sHeight:O,dWidth:F,dHeight:E}}getFrame(){if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'getFrame()' is unavailable in singleFrameMode.");return this._getVideoData()}getImage(){return this.getFrame()}_drawImage(h,d,_,b,x,S,F){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!_||!b)return null;if(d instanceof HTMLVideoElement&&d.readyState!==4||d instanceof HTMLImageElement&&!d.complete)throw new Error("The source is not loaded.");let E;$._onLog&&(E=Date.now(),$._onLog("DCE: _drawImage(), START: "+E));let P=0,O=0,G=_,z=b,J=0,X=0,q=_,H=b;x&&(x.sx&&(P=Math.round(x.sx)),x.sy&&(O=Math.round(x.sy)),x.sWidth&&(G=Math.round(x.sWidth)),x.sHeight&&(z=Math.round(x.sHeight)),x.dx&&(J=Math.round(x.dx)),x.dy&&(X=Math.round(x.dy)),x.dWidth&&(q=Math.round(x.dWidth)),x.dHeight&&(H=Math.round(x.dHeight)));let ee=me.RGBA;F&&F.pixelFormat&&(ee=F.pixelFormat);const ne=h;if(!F||!F.bUseWebGL){$._onLog&&$._onLog("DCE: _drawImage() in context2d."),ne.ctx2d||(ne.ctx2d=ne.getContext("2d",{willReadFrequently:!0}));const ie=ne.ctx2d;if(!ie)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(ne.width<J+q||ne.height<X+H)&&(ne.width=J+q,ne.height=X+H),ie.drawImage(d,P,O,G,z,J,X,q,H),$._onLog&&$._onLog("DCE: _drawImage() in context2d end. Costs: "+(Date.now()-E)),{context:ie,pixelFormat:me.RGBA,_bUseWebGL:!1}}$._onLog&&$._onLog("DCE: _drawImage() in WebGL.");try{(ne.width<J+q||ne.height<X+H)&&(ne.width=J+q,ne.height=X+H,ne.ctxWebGL&&ne.ctxWebGL.viewport(0,0,J+q,X+H));const ie=ne.ctxWebGL||ne.getContext("webgl",{antialias:!1})||ne.getContext("experimental-webgl",{antialias:!1});if(!ie){$._onLog&&$._onLog("DCE: WebGL unavailable.");const g=new Error("WebGL error: unable to initialize WebGL. Your browser or machine may not support it.");throw g.name="WebGLError",g}if(!ne.ctxWebGL||ee!==this.shaderPixelFormat){ne.ctxWebGL=ie;const g=t=>{const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW);const c=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW),{positions:a,texCoords:c}},ce=t=>{const a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),a},ve=(t,a)=>{const c=t.createProgram();if(a.forEach(o=>t.attachShader(c,o)),t.linkProgram(c),!t.getProgramParameter(c,t.LINK_STATUS)){const o=new Error(`An error occured linking the program: ${t.getProgramInfoLog(c)}.`);throw o.name="WebGLError",o}return t.useProgram(c),c},Ee=(t,a,c)=>{const o=t.createShader(a);if(t.shaderSource(o,c),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS)){const r=new Error(`An error occured compiling the shader: ${t.getShaderInfoLog(o)}.`);throw r.name="WebGLError",r}return o},s=`
                        attribute vec2 a_position;
                        attribute vec2 a_texCoord;
    
                        uniform mat3 u_matrix;
                        uniform mat3 u_textureMatrix;
    
                        varying vec2 v_texCoord;
                        void main(void) {
                        gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);
                        v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;
                        }
                    `;let i="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(ee)&&(i=ee.slice(0,3));const n=`
                        precision mediump float;
                        varying vec2 v_texCoord;
                        uniform sampler2D u_image;
                        uniform float uColorFactor;
    
                        void main() {
                            vec4 sample = texture2D(u_image, v_texCoord);
                            float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;
                            gl_FragColor = vec4(sample.${i} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);
                        }
                    `,l=Ee(ie,ie.VERTEX_SHADER,s),e=ve(ie,[l,Ee(ie,ie.FRAGMENT_SHADER,n)]);this._webGLProgramInfo={program:e,attribLocations:{vertexPosition:ie.getAttribLocation(e,"a_position"),texPosition:ie.getAttribLocation(e,"a_texCoord")},uniformLocations:{uSampler:ie.getUniformLocation(e,"u_image"),uColorFactor:ie.getUniformLocation(e,"uColorFactor"),uMatrix:ie.getUniformLocation(e,"u_matrix"),uTextureMatrix:ie.getUniformLocation(e,"u_textureMatrix")}},this._webGLBuffers=g(ie),this._webGLTexture=ce(ie),this.shaderPixelFormat=ee}const he=(g,ce,ve)=>{g.bindBuffer(g.ARRAY_BUFFER,ce),g.enableVertexAttribArray(ve),g.vertexAttribPointer(ve,2,g.FLOAT,!1,0,0)},de=(g,ce,ve)=>{const Ee=g.RGBA,s=g.RGBA,i=g.UNSIGNED_BYTE;g.bindTexture(g.TEXTURE_2D,ce),g.texImage2D(g.TEXTURE_2D,0,Ee,s,i,ve)},fe=(g,ce,ve,Ee)=>{g.clearColor(0,0,0,1),g.clearDepth(1),g.enable(g.DEPTH_TEST),g.depthFunc(g.LEQUAL),g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT),he(g,ve.positions,ce.attribLocations.vertexPosition),he(g,ve.texCoords,ce.attribLocations.texPosition),g.activeTexture(g.TEXTURE0),g.bindTexture(g.TEXTURE_2D,Ee),g.uniform1i(ce.uniformLocations.uSampler,0),g.uniform1f(ce.uniformLocations.uColorFactor,[me.GREY,me.GREY32].includes(ee)?1:0);let s,i,n=Re.translate(Re.identity(),-1,-1);n=Re.scale(n,2,2),n=Re.scale(n,1/g.canvas.width,1/g.canvas.height),s=Re.translate(n,J,X),s=Re.scale(s,q,H),g.uniformMatrix3fv(ce.uniformLocations.uMatrix,!1,s),i=Re.translate(Re.identity(),P/_,O/b),i=Re.scale(i,G/_,z/b),g.uniformMatrix3fv(ce.uniformLocations.uTextureMatrix,!1,i),g.drawArrays(g.TRIANGLES,0,6)};let pe;if(de(ie,this._webGLTexture,d),fe(ie,this._webGLProgramInfo,this._webGLBuffers,this._webGLTexture),S){if(S.length<q*H*4)throw new Error("Unexpected size of the 'bufferContainer'.");pe=S}else pe=new Uint8Array(q*H*4);if(ie.readPixels(J,X,q,H,ie.RGBA,ie.UNSIGNED_BYTE,pe),pe[3]!==255){$._onLog&&$._onLog("DCE: WebGL drawing incorrect."),this._bWebGLSupported=!1;const g=new Error("WebGL error: incorrect WebGL drawing.");throw g.name="WebGLError",g}return $._onLog&&$._onLog("DCE: _drawImage() in WebGL end. Costs: "+(Date.now()-E)),{context:ie,pixelFormat:ee===me.GREY?me.GREY32:ee,_bUseWebGL:!0}}catch(ie){throw this._bWebGLSupported=!1,ie.name="WebGLError",ie}}_readCvsData(h,d,_){let b,x=0,S=0,F=h.canvas.width,E=h.canvas.height;if(d&&(d.x&&(x=d.x),d.y&&(S=d.y),d.width&&(F=d.width),d.height&&(E=d.height)),h instanceof WebGLRenderingContext){const P=h;if(_){if(_.length<F*E*4)throw new Error("Unexpected size of the 'bufferContainer'.");P.readPixels(x,S,F,E,P.RGBA,P.UNSIGNED_BYTE,_),b=new Uint8Array(_.buffer,0,F*E*4)}else b=new Uint8Array(F*E*4),P.readPixels(x,S,F,E,P.RGBA,P.UNSIGNED_BYTE,b)}else if(h instanceof CanvasRenderingContext2D){let P;if(P=h.getImageData(x,S,F,E),b=new Uint8Array(P.data.buffer),_){if(_.length<b.length)throw new Error("Unexpected size of the 'bufferContainer'.");_.set(b)}}return b}_transformPixelFormat(h,d,_,b){let x,S;if($._onLog&&(x=Date.now(),$._onLog("DCE: _transformPixelFormat(), START: "+x)),d===_)return $._onLog&&$._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-x)),b?new Uint8Array(h):h;const F=[me.RGBA,me.RBGA,me.GRBA,me.GBRA,me.BRGA,me.BGRA];if(F.includes(d))if(_===me.GREY){S=new Uint8Array(h.length/4);for(let E=0;E<h.length;E+=4){const P=.21*h[E]+.71*h[E+1]+.07*h[E+2];S[E/4]=P}}else if(_===me.GREY32){S=b?new Uint8Array(h):h;for(let E=0;E<h.length;E+=4){const P=.21*h[E]+.71*h[E+1]+.07*h[E+2];S[E]=P,S[E+1]=P,S[E+2]=P}}else{if(!F.includes(_))throw new Error("Unable to transform.");if(b){S=new Uint8Array(h);const E=d.indexOf("r"),P=d.indexOf("g"),O=d.indexOf("b"),G=_.indexOf("r"),z=_.indexOf("g"),J=_.indexOf("b");for(let X=0;X<h.length;X+=4)S[X+G]=h[X+E],S[X+z]=h[X+P],S[X+J]=h[X+O]}else{S=h;const E=d.indexOf("r"),P=d.indexOf("g"),O=d.indexOf("b"),G=_.indexOf("r"),z=_.indexOf("g"),J=_.indexOf("b");for(let X=0;X<h.length;X+=4){let q=[h[X],h[X+1],h[X+2]];S[X+G]=q[E],S[X+z]=q[P],S[X+J]=q[O]}}}else if(d===me.GREY){if(_!==me.GREY32)throw new Error("Unable to transform.");S=new Uint8Array(4*h.length);for(let E=0;E<h.length;E++)S[4*E]=h[E],S[4*E+1]=h[E],S[4*E+2]=h[E],S[4*E+3]=255}else{if(d!==me.GREY32)throw new Error("Unable to transform.");if(_!==me.GREY)throw new Error("Unable to transform.");S=new Uint8Array(h.length/4);for(let E=0;E<h.length;E+=4)S[E/4]=h[E]}return $._onLog&&$._onLog("DCE: _transformPixelFormat() end. Costs: "+(Date.now()-x)),S}_getImageData(h,d,_,b,x,S){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(!d||!_)return null;if(b.sx>d||b.sy>_||b.sx+b.sWidth>d||b.sy+b.sHeight>_)throw new Error("Invalid position.");if(h instanceof HTMLVideoElement&&h.readyState!==4||h instanceof HTMLImageElement&&!h.complete)throw new Error("The source is not loaded.");let F;$._onLog&&(F=Date.now(),$._onLog("DCE: _getImageData(), START: "+F));const E=Math.round(b.sx),P=Math.round(b.sy),O=Math.round(b.sWidth),G=Math.round(b.sHeight),z=Math.round(b.dWidth),J=Math.round(b.dHeight);let X=me.RGBA;S&&S.pixelFormat&&(X=S.pixelFormat);let q,H,ee,ne=this._bWebGLSupported;S&&S.bUseWebGL==0&&(ne=!1),ne?(this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),q=this._reusedWebGLCvs):(this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),q=this._reusedCvs);try{if(ne)if($._onLog&&$._onLog("DCE: _getImageData() in WebGL."),x)if(X===me.GREY){if(ee=new Uint8Array(z*J*4),H=this._drawImage(q,h,d,_,{sx:E,sy:P,sWidth:O,sHeight:G,dWidth:z,dHeight:J},ee,{pixelFormat:X,bUseWebGL:ne}),ee=this._transformPixelFormat(ee,H.pixelFormat,X),x){if(x.length<ee.length)throw new Error("Unexpected size of the 'bufferContainer'.");x.set(ee)}}else H=this._drawImage(q,h,d,_,{sx:E,sy:P,sWidth:O,sHeight:G,dWidth:z,dHeight:J},x,{pixelFormat:X,bUseWebGL:ne}),ee=new Uint8Array(x.buffer,0,z*J*4),ee=this._transformPixelFormat(ee,H.pixelFormat,X);else X===me.GREY?((!this._tempDataContainer||this._tempDataContainer.length<z*J*4)&&(this._tempDataContainer=new Uint8Array(z*J*4)),ee=new Uint8Array(this._tempDataContainer.buffer,0,z*J*4)):ee=new Uint8Array(z*J*4),H=this._drawImage(q,h,d,_,{sx:E,sy:P,sWidth:O,sHeight:G,dWidth:z,dHeight:J},ee,{pixelFormat:X,bUseWebGL:ne}),ee=this._transformPixelFormat(ee,H.pixelFormat,X);else if($._onLog&&$._onLog("DCE: _getImageData() in context2d."),H=this._drawImage(q,h,d,_,{sx:E,sy:P,sWidth:O,sHeight:G,dWidth:z,dHeight:J},null,{pixelFormat:me.RGBA,bUseWebGL:ne}),ee=this._readCvsData(H.context,{width:z,height:J},null),ee=this._transformPixelFormat(ee,H.pixelFormat,X),x){if(x.length<ee.length)throw new Error("Unexpected size of the 'bufferContainer'.");x.set(ee)}}catch(ie){if(ie.name==="WebGLError")return $._onLog&&$._onLog("DCE: _getImageData() in WebGL failed, try again in context2d."),this.forceLoseContext(),this._bWebGLSupported=!1,this._getImageData(h,d,_,{sx:E,sy:P,sWidth:O,sHeight:G,dWidth:z,dHeight:J},x,S);throw ie}return $._onLog&&$._onLog("DCE: _getImageData() end. Costs: "+(Date.now()-F)),{data:ee,pixelFormat:X,_bUseWebGL:H._bUseWebGL}}forceLoseContext(){if(!this._reusedWebGLCvs)return;const h=this._reusedWebGLCvs.ctxWebGL;h&&!h.isContextLost()&&h.getExtension("WEBGL_lose_context")&&h.getExtension("WEBGL_lose_context").loseContext(),this._webGLTexture=null,this._webGLProgramInfo=null,this._webGLBuffers=null,this._reusedWebGLCvs=null}_getVideoData(h,d){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this._isSingleFrameModeEnabled())throw new Error("'_getVideoData()' is unavailable in singleFrameMode.");if(!this._video||this._video.readyState!==4)return null;const _=Date.now();$._onLog&&$._onLog("DCE: _getVideoData() START: "+_);let b=this._scanRegion;d&&d.hasOwnProperty("region")&&(b=d.region);let x=this.mapPixelFormatString_Enum.get(this.framePixelFormat.toLowerCase());d&&d.pixelFormat&&(x=this.mapPixelFormatString_Enum.get(d.pixelFormat.toLowerCase()));let S=this._softwareScale;d&&d.scale&&(S=d.scale);const F=this._video.videoWidth,E=this._video.videoHeight;let P=this._scaleCenter;if(d&&d.scaleCenter){if(typeof d.scaleCenter.x!="string"||typeof d.scaleCenter.y!="string")throw new Error("Invalid scale center.");let q=0,H=0;if(d.scaleCenter.x.endsWith("px"))q=parseFloat(d.scaleCenter.x);else{if(!d.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");q=parseFloat(d.scaleCenter.x)/100*F}if(d.scaleCenter.y.endsWith("px"))H=parseFloat(d.scaleCenter.y);else{if(!d.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");H=parseFloat(d.scaleCenter.y)/100*E}if(q==NaN||H==NaN)throw new Error("Invalid scale center.");P.x=Math.round(q),P.y=Math.round(H)}if(F===0||E===0)return null;const O=this.getFrameSize(F,E,b,this.maxCvsSideLength);if(!O)return null;let G=!0;F===O.sWidth&&E===O.sHeight&&(G=!1);const z={data:null,region:b?JSON.parse(JSON.stringify(b)):null,sx:O.sx,sy:O.sy,width:O.dWidth,height:O.dHeight,colorMode:null,pixelFormat:null,timeSpent:null,timeStamp:null,isCropped:G,toCanvas:this._toCanvas,_sWidth:O.sWidth,_sHeight:O.sHeight,_bUseWebGL:null};S!==1&&(O.sWidth=Math.round(O.sWidth/S),O.sHeight=Math.round(O.sHeight/S),O.sx=Math.round((1-1/S)*P.x+O.sx/S),O.sy=Math.round((1-1/S)*P.y+O.sy/S));const J=this._getImageData(this._video,F,E,O,h,{pixelFormat:x});if(!J)return null;const X=Date.now();return $._onLog&&$._onLog("DCE: _getVideoData() END: "+X),z.data=J.data,z.pixelFormat=z.colorMode=J.pixelFormat,z._bUseWebGL=J._bUseWebGL,z.timeSpent=X-_,z.timeStamp=X,J.pixelFormat===me.GREY?z.stride=z.width:z.stride=4*z.width,z}getCurrentRegion(){let h=null;if(this._scanRegion)h=this._scanRegion;else if(this.croppingRegions){if(this._croppingRegionIndex>=this.croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");h=this.croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this.croppingRegions.length&&(this._croppingRegionIndex=0)}return h}_fetchingLoop(h){if(this.isDisposed&&this.disposed)return;if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();const d=()=>{$._onLog&&$._onLog("DCE: start fetching a frame into buffer: "+Date.now());const b=this.getCurrentRegion();let x=this._getVideoData(null,{region:b});if(!x)return void($._onLog&&$._onLog("DCE: get a invalid frame, abandon it: "+Date.now()));for(;this._frameQueue&&this._frameQueue.length>=this.maxNumberOfFramesInBuffer;)this._frameQueue.shift();this._frameQueue.push(x),$._onLog&&$._onLog("DCE: finish fetching a frame into buffer: "+Date.now());const S=this.mapCameraEvents.get("frameaddedtobuffer");for(let F of S)F&&setTimeout(()=>{this.isDisposed&&this.disposed||F.apply(this)},0)},_=()=>{this.isDisposed&&this.disposed||(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout(()=>{this.isDisposed&&this.disposed||(this._bOpen&&this.isFetchingLoopStarted()?($._onLog&&$._onLog("DCE: second timeout executes: "+Date.now()),d(),_()):this.stopFetchingLoop())},this.refreshInterval)))};h&&(this._frameQueue.length<this.maxNumberOfFramesInBuffer?(d(),this.refreshInterval>0&&_()):this.refreshInterval===0&&d()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout(()=>{this.isDisposed&&this.disposed||this._fetchingLoop(!0)},this.loopInterval)}startFetchingLoop(){if(this.isDisposed&&this.disposed)throw Error("The 'CameraEnhancer' instance has been disposed.");if(this._assertOpen(),this._isSingleFrameModeEnabled())throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,this._recordedStates.fetchingLoopStart=!0,$._onLog&&$._onLog("DCE: start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&($._onLog&&$._onLog("DCE: stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1,this._recordedStates.fetchingLoopStart=!1)}getFrameFromBuffer(h){return this._frameQueue&&this._frameQueue.length?h?h<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(h,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.pop()):null}clearFrameBuffer(){this._frameQueue&&(this._frameQueue.length=0)}_createDrawingLayerBaseCvs(){let h;this._assertOpen();try{h=this._calculateCvsSize()}catch(S){throw S}let{width:d,height:_,objectFit:b}=h;(d<=0||_<=0)&&(d=2,_=2);const x=document.createElement("canvas");if(x.width==d&&x.height==_||(x.width=d,x.height=_),x.style.objectFit=b,this._cvsScanRegion)this._cvsScanRegion.after(x);else if(this._cvsOriginalImage)this._cvsOriginalImage.after(x);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(x);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(x)}return x}_updateDrawingLayersSize(h){let d;try{d=h&&h.width&&h.height&&h.objectFit?{width:h.width,height:h.height,objectFit:h.objectFit}:this._calculateCvsSize()}catch(S){if((S.message||S)==="Invalid content dimensions.")return;throw S}const{width:_,height:b,objectFit:x}=d;this._drawingLayersManager.setDimensions({width:_,height:b},{backstoreOnly:!0}),this._drawingLayersManager.setObjectFit(x)}_createDrawingLayer(h){this._layerBaseCvs||(this._layerBaseCvs=this._createDrawingLayerBaseCvs());const d=this._layerBaseCvs;return this._drawingLayersManager.createDrawingLayer(d,h)}deleteDrawingLayer(h){this._drawingLayersManager.deleteDrawingLayer(h),this._drawingLayersManager.getDrawingLayers().length||this._layerBaseCvs&&(this._layerBaseCvs.remove(),this._layerBaseCvs=null)}createDrawingLayer(){return this._createDrawingLayer()}getDrawingLayer(h){return this._drawingLayersManager.getDrawingLayer(h)||([1,2,3].includes(h)?this._createDrawingLayer(h):null)}getDrawingLayers(){return this._drawingLayersManager.getDrawingLayers().filter(h=>h.getId()>=0)}getSelectedDrawingItems(){return this._drawingLayersManager.getSelectedDrawingItems()}createDrawingStyle(h){return this._drawingLayersManager.createDrawingStyle(h)}getDrawingStyle(h){return this._drawingLayersManager.getDrawingStyle(h)}getDrawingStyles(){return this._drawingLayersManager.getDrawingStyles()}updateDrawingStyle(h,d){return this._drawingLayersManager.updateDrawingStyle(h,d)}clearDrawingLayers(){const h=this.getDrawingLayers();for(let d of h)this.deleteDrawingLayer(d.getId())}showTip(h,d,_,b,x=3e3,S=!0){this._assertOpen(),this._tipArgs.x=h,this._tipArgs.y=d,this._tipArgs.width=_,this._tipArgs.autoShowSuggestedTip=!!S,this._drawingLayerOfTip||(this._drawingLayerOfTip=this._createDrawingLayer(-1)),this._tipStyleId||(this._tipStyleId=this.createDrawingStyle({fillStyle:"#FFFFFF",paintMode:"fill",fontFamily:"Open Sans",fontSize:40})),this._drawingLayerOfTip.clearDrawingItems();const F=new mt(b||"",h,d,_,this._tipStyleId);F._fabricObject.paddingTop=15,F._fabricObject.calcTextHeight=function(){for(var E=0,P=0,O=this._textLines.length;P<O;P++)E+=this.getHeightOfLine(P);return E+=2*this.paddingTop},F._fabricObject._getTopOffset=function(){return-this.height/2+this.getHeightOfLine(0)*(1-1/this.lineHeight)/2+this.paddingTop},F.setAttribute("backgroundColor","rgba(50, 50, 52, .8)"),F.setAttribute("lineHeight",1.3),F.setAttribute("textAlign","center"),this._drawingLayerOfTip.addDrawingItem(F),this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._tipArgs.duration=x===void 0?3e3:x,this._tipArgs.duration>0&&(this._hideTipTimeoutId=setTimeout(()=>{this.isDisposed&&this.disposed||this._hideTip()},this._tipArgs.duration))}_hideTip(){this._drawingLayerOfTip&&(this.deleteDrawingLayer(this._drawingLayerOfTip.getId()),this._drawingLayerOfTip=null,this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId))}hideTip(){this._hideTip(),this._tipArgs.x=null,this._tipArgs.y=null,this._tipArgs.width=null,this._tipArgs.autoShowSuggestedTip=null}updateTipMessage(h){if(!this._drawingLayerOfTip)throw new Error("The Tip is not showing.");this._drawingLayerOfTip.getDrawingItems()[0].setAttribute("text",h),this._drawingLayerOfTip.renderAll(),this._tipArgs.duration>0&&(this._hideTipTimeoutId&&clearTimeout(this._hideTipTimeoutId),this._hideTipTimeoutId=setTimeout(()=>{this.isDisposed&&this.disposed||this._hideTip()},this._tipArgs.duration))}suggestTip(h,d){this._tipArgs.autoShowSuggestedTip&&(this._drawingLayerOfTip?this.updateTipMessage(d):this._tipArgs.x!==void 0&&this.showTip(this._tipArgs.x,this._tipArgs.y,this._tipArgs.width,d,this._tipArgs.duration)),this.onTipSuggested&&setTimeout(()=>{this.isDisposed&&this.disposed||this.onTipSuggested.apply(this,[h,d])},0)}_createControler(){if(this._controler||(this._controler=new yt(this)),this._controler)return this._controler}_destroyControler(){this._controler=null}setOriginalImage(h,d,_){if(!h||!d||!_)throw new Error("Invalid arguments");this._originalImageData={imageData:h,width:d,height:_};let b=this._cvsOriginalImage;b||(b=document.createElement("canvas"),b.style.position="absolute",b.style.width="100%",b.style.height="100%",b.style.left="0",b.style.top="0",b.style.backgroundColor="white",b.style.objectFit="contain",this._cvsOriginalImage=b),b.width===d&&b.height===_||(b.width=d,b.height=_);const x=b.getContext("2d");x.clearRect(0,0,b.width,b.height),h instanceof Uint8Array||h instanceof Uint8ClampedArray?(h instanceof Uint8Array&&(h=new Uint8ClampedArray(h.buffer)),x.putImageData(new ImageData(h,d,_),0,0)):h instanceof HTMLCanvasElement&&x.drawImage(h,0,0),document.body.contains(b)&&b.style.display===""&&this._updateDrawingLayersSize({width:d,height:_,objectFit:"contain"})}getOriginalImage(){return this._originalImageData?Object.assign({},this._originalImageData):null}async deleteOriginalImage(){await this.hideOriginalImage(),this._cvsOriginalImage&&(this._cvsOriginalImage.remove(),this._cvsOriginalImage=null),this._originalImageData=null}_showOriginalImageCvs(){this._cvsOriginalImage&&this._cvsOriginalImage.style.display=="none"&&(this._cvsOriginalImage.style.display="")}_hideOriginalImageCvs(){this._cvsOriginalImage&&(this._cvsOriginalImage.style.display="none")}showOriginalImage(){if(!this._originalImageData)throw new Error("No original image is set.");const h=this._cvsOriginalImage;if(h.style.display===""&&document.body.contains(h))return;const{width:d,height:_}=this._originalImageData;if(this._updateDrawingLayersSize({width:d,height:_,objectFit:"contain"}),this._bOpen&&(this._video&&!this._video.paused&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._recordedStates.fetchingLoopStart=!0),this.ifShowScanRegionMask&&this._cvsScanRegion&&(this._cvsScanRegion.style.display="none"),this.ifShowScanRegionLaser&&this._divScanLight&&(this._divScanLight.style.display="none"),this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none"),this._scanRegionOverlayContainer&&(this._scanRegionOverlayContainer.style.display="none"),this._selCam&&(this._selCam.parentElement.style.display="none")),!document.body.contains(h))if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(h);else{if(!this._videoContainer)throw new Error("Unable to find video element");this._videoContainer.after(h)}this._showOriginalImageCvs()}async _hideOriginalImage(h){this._originalImageData&&this._cvsOriginalImage&&this._cvsOriginalImage.style.display!=="none"&&(this._updateDrawingLayersSize(),this._bOpen&&h&&(this._video&&this._recordedStates.videoPlaying&&await this.play(null,null,null,{notTriggerSingleFrameClick:!0}),this._recordedStates.fetchingLoopStart&&!this._isSingleFrameModeEnabled()&&this.startFetchingLoop(),this.ifShowScanRegionMask&&this._cvsScanRegion&&this._recordedStates.maskShow&&this.showScanRegionMask(),this.ifShowScanRegionLaser&&this._divScanLight&&this._recordedStates.laserShow&&this.showScanRegionLaser(),this._cvsViewDecorator&&this._recordedStates.decoratorShow&&this.showViewDecorator(),this._scanRegionOverlayContainer&&this._recordedStates.overlayShow&&this.showScanRegionOverlays()),this._selCam&&(this._selCam.parentElement.style.display=""),this._hideOriginalImageCvs())}async hideOriginalImage(){return this._hideOriginalImage(!0)}transformCoord(h){if(!this.isOpen())throw new Error("Unavailable when the camera is not open.");if(this._isSingleFrameModeEnabled()&&!this._cvsSingleFrameMode)throw new Error("No image is selected. ");const d=this._elContainer.getBoundingClientRect();let _,b,x,S,F,E=d.left,P=d.top,O=E+window.scrollX,G=P+window.scrollY;this._isSingleFrameModeEnabled()?(_=this._cvsSingleFrameMode.width,b=this._cvsSingleFrameMode.height,x=parseFloat(window.getComputedStyle(this._cvsSingleFrameMode).width),S=parseFloat(window.getComputedStyle(this._cvsSingleFrameMode).height),F="contain"):(_=this.video.videoWidth,b=this.video.videoHeight,x=parseFloat(window.getComputedStyle(this._elContainer).width),S=parseFloat(window.getComputedStyle(this._elContainer).height),F=this.videoFit);const z=x/S,J=_/b;let X,q,H,ee,ne=1;if(F==="contain")z<J?(ne=x/_,X=E+h.x*ne,q=P+h.y*ne+(S-b*ne)/2,H=O+h.x*ne,ee=G+h.y*ne+(S-b*ne)/2):(ne=S/b,X=E+h.x*ne+(x-_*ne)/2,q=P+h.y*ne,H=O+h.x*ne+(x-_*ne)/2,ee=G+h.y*ne);else if(F==="cover")if(z<J){ne=S/b;let ie=h.x*ne-(_*ne-x)/2;ie=Math.max(ie,0),ie=Math.min(ie,x),X=E+ie,q=P+h.y*ne,H=O+ie,ee=G+h.y*ne}else{ne=x/_;let ie=h.y*ne-(b*ne-S)/2;ie=Math.max(ie,0),ie=Math.min(ie,S),X=E+h.x*ne,q=P+ie,H=O+h.x*ne,ee=G+ie}return{clientX:X,clientY:q,pageX:H,pageY:ee}}convertToPageCoordinates(h){const d=this.transformCoord(h);return{x:d.pageX,y:d.pageY}}convertToClientCoordinates(h){const d=this.transformCoord(h);return{x:d.clientX,y:d.clientY}}dispose(h){this.UIElement&&(this._uiOriginalState&&this._uiOriginalState.inDom?this.UIElement.style.display=this._uiOriginalState.display:this.UIElement.style.display="none"),this.clearDrawingLayers(),this.close(),this.forceLoseContext(),this.setViewDecorator(null,null),this._scanRegionOverlayContainer&&this._scanRegionOverlayContainer.remove(),this._arrScanRegionOverlays.length=0,h&&this.UIElement&&this.UIElement.remove(),this.__proto__=null;for(let d in this)delete this[d];Object.defineProperty(this,"isCameraEnhancer",{value:!0}),Object.defineProperty(this,"isDisposed",{value:!0}),Object.defineProperty(this,"disposed",{value:!0})}}$._jsVersion="3.3.9",$._jsEditVersion="20231205",$._version="JS "+$._jsVersion+"."+$._jsEditVersion,$.browserInfo=we,$._hasEngineResourceLoaded=!1,$._engineResourcePath=pt,$._defaultUIElementURL="@engineResourcePath/dce.ui.html";var ye=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function bt(ae){return ae&&ae.__esModule&&Object.prototype.hasOwnProperty.call(ae,"default")?ae.default:ae}var at={exports:{}};(function(ae){/**
 * {@link https://github.com/muaz-khan/RecordRTC|RecordRTC} is a WebRTC JavaScript library for audio/video as well as screen activity recording. It supports Chrome, Firefox, Opera, Android, and Microsoft Edge. Platforms: Linux, Mac and Windows. 
 * @summary Record audio, video or screen inside the browser.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef RecordRTC
 * @class
 * @example
 * var recorder = RecordRTC(mediaStream or [arrayOfMediaStream], {
 *     type: 'video', // audio or video or gif or canvas
 *     recorderType: MediaStreamRecorder || CanvasRecorder || StereoAudioRecorder || Etc
 * });
 * recorder.startRecording();
 * @see For further information:
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - Single media-stream object, array of media-streams, html-canvas-element, etc.
 * @param {object} config - {type:"video", recorderType: MediaStreamRecorder, disableLogs: true, numberOfAudioChannels: 1, bufferSize: 0, sampleRate: 0, desiredSampRate: 16000, video: HTMLVideoElement, etc.}
 */function h(o,r){if(!o)throw"First parameter is required.";r=r||{type:"video"},r=new d(o,r);var u=this;function f(L){return r.disableLogs||console.log("RecordRTC version: ",u.version),L&&(r=new d(o,L)),r.disableLogs||console.log("started recording "+r.type+" stream."),T?(T.clearRecordedData(),T.record(),W("recording"),u.recordingDuration&&M(),u):(p(function(){u.recordingDuration&&M()}),u)}function p(L){L&&(r.initCallback=function(){L(),L=r.initCallback=null});var B=new _(o,r);T=new B(o,r),T.record(),W("recording"),r.disableLogs||console.log("Initialized recorderType:",T.constructor.name,"for output-type:",r.type)}function m(L){if(L=L||function(){},!T){I();return}if(u.state==="paused"){u.resumeRecording(),setTimeout(function(){m(L)},1);return}u.state!=="recording"&&!r.disableLogs&&console.warn('Recording state should be: "recording", however current state is: ',u.state),r.disableLogs||console.log("Stopped recording "+r.type+" stream."),r.type!=="gif"?T.stop(B):(T.stop(),B()),W("stopped");function B(A){if(!T){typeof L.call=="function"?L.call(u,""):L("");return}Object.keys(T).forEach(function(V){typeof T[V]!="function"&&(u[V]=T[V])});var w=T.blob;if(!w)if(A)T.blob=w=A;else throw"Recording failed.";if(w&&!r.disableLogs&&console.log(w.type,"->",ee(w.size)),L){var k;try{k=O.createObjectURL(w)}catch{}typeof L.call=="function"?L.call(u,k):L(k)}r.autoWriteToDisk&&R(function(V){var N={};N[r.type+"Blob"]=V,n.Store(N)})}}function v(){if(!T){I();return}if(u.state!=="recording"){r.disableLogs||console.warn("Unable to pause the recording. Recording state: ",u.state);return}W("paused"),T.pause(),r.disableLogs||console.log("Paused recording.")}function y(){if(!T){I();return}if(u.state!=="paused"){r.disableLogs||console.warn("Unable to resume the recording. Recording state: ",u.state);return}W("recording"),T.resume(),r.disableLogs||console.log("Resumed recording.")}function C(L){postMessage(new FileReaderSync().readAsDataURL(L))}function R(L,B){if(!L)throw"Pass a callback function over getDataURL.";var A=B?B.blob:(T||{}).blob;if(!A){r.disableLogs||console.warn("Blob encoder did not finish its job yet."),setTimeout(function(){R(L,B)},1e3);return}if(typeof Worker<"u"&&!navigator.mozGetUserMedia){var w=V(C);w.onmessage=function(N){L(N.data)},w.postMessage(A)}else{var k=new FileReader;k.readAsDataURL(A),k.onload=function(N){L(N.target.result)}}function V(N){try{var Y=O.createObjectURL(new Blob([N.toString(),"this.onmessage =  function (eee) {"+N.name+"(eee.data);}"],{type:"application/javascript"})),K=new Worker(Y);return O.revokeObjectURL(Y),K}catch{}}}function M(L){if(L=L||0,u.state==="paused"){setTimeout(function(){M(L)},1e3);return}if(u.state!=="stopped"){if(L>=u.recordingDuration){m(u.onRecordingStopped);return}L+=1e3,setTimeout(function(){M(L)},1e3)}}function W(L){u&&(u.state=L,typeof u.onStateChanged.call=="function"?u.onStateChanged.call(u,L):u.onStateChanged(L))}var j='It seems that recorder is destroyed or "startRecording" is not invoked for '+r.type+" recorder.";function I(){r.disableLogs!==!0&&console.warn(j)}var T,D={startRecording:f,stopRecording:m,pauseRecording:v,resumeRecording:y,initRecorder:p,setRecordingDuration:function(L,B){if(typeof L>"u")throw"recordingDuration is required.";if(typeof L!="number")throw"recordingDuration must be a number.";return u.recordingDuration=L,u.onRecordingStopped=B||function(){},{onRecordingStopped:function(A){u.onRecordingStopped=A}}},clearRecordedData:function(){if(!T){I();return}T.clearRecordedData(),r.disableLogs||console.log("Cleared old recorded data.")},getBlob:function(){if(!T){I();return}return T.blob},getDataURL:R,toURL:function(){if(!T){I();return}return O.createObjectURL(T.blob)},getInternalRecorder:function(){return T},save:function(L){if(!T){I();return}ne(T.blob,L)},getFromDisk:function(L){if(!T){I();return}h.getFromDisk(r.type,L)},setAdvertisementArray:function(L){r.advertisement=[];for(var B=L.length,A=0;A<B;A++)r.advertisement.push({duration:A,image:L[A]})},blob:null,bufferSize:0,sampleRate:0,buffer:null,reset:function(){u.state==="recording"&&!r.disableLogs&&console.warn("Stop an active recorder."),T&&typeof T.clearRecordedData=="function"&&T.clearRecordedData(),T=null,W("inactive"),u.blob=null},onStateChanged:function(L){r.disableLogs||console.log("Recorder state changed:",L)},state:"inactive",getState:function(){return u.state},destroy:function(){var L=r.disableLogs;r={disableLogs:!0},u.reset(),W("destroyed"),D=u=null,pe.AudioContextConstructor&&(pe.AudioContextConstructor.close(),pe.AudioContextConstructor=null),r.disableLogs=L,r.disableLogs||console.log("RecordRTC is destroyed.")},version:"5.6.2"};if(!this)return u=D,D;for(var U in D)this[U]=D[U];return u=this,D}h.version="5.6.2",ae.exports=h,h.getFromDisk=function(o,r){if(!r)throw"callback is mandatory.";console.log("Getting recorded "+(o==="all"?"blobs":o+" blob ")+" from disk!"),n.Fetch(function(u,f){o!=="all"&&f===o+"Blob"&&r&&r(u),o==="all"&&r&&r(u,f.replace("Blob",""))})},h.writeToDisk=function(o){console.log("Writing recorded blob(s) to disk!"),o=o||{},o.audio&&o.video&&o.gif?o.audio.getDataURL(function(r){o.video.getDataURL(function(u){o.gif.getDataURL(function(f){n.Store({audioBlob:r,videoBlob:u,gifBlob:f})})})}):o.audio&&o.video?o.audio.getDataURL(function(r){o.video.getDataURL(function(u){n.Store({audioBlob:r,videoBlob:u})})}):o.audio&&o.gif?o.audio.getDataURL(function(r){o.gif.getDataURL(function(u){n.Store({audioBlob:r,gifBlob:u})})}):o.video&&o.gif?o.video.getDataURL(function(r){o.gif.getDataURL(function(u){n.Store({videoBlob:r,gifBlob:u})})}):o.audio?o.audio.getDataURL(function(r){n.Store({audioBlob:r})}):o.video?o.video.getDataURL(function(r){n.Store({videoBlob:r})}):o.gif&&o.gif.getDataURL(function(r){n.Store({gifBlob:r})})};/**
 * {@link RecordRTCConfiguration} is an inner/private helper for {@link RecordRTC}.
 * @summary It configures the 2nd parameter passed over {@link RecordRTC} and returns a valid "config" object.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef RecordRTCConfiguration
 * @class
 * @example
 * var options = RecordRTCConfiguration(mediaStream, options);
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @param {object} config - {type:"video", disableLogs: true, numberOfAudioChannels: 1, bufferSize: 0, sampleRate: 0, video: HTMLVideoElement, getNativeBlob:true, etc.}
 */function d(o,r){return!r.recorderType&&!r.type&&(r.audio&&r.video?r.type="video":r.audio&&!r.video&&(r.type="audio")),r.recorderType&&!r.type&&(r.recorderType===s||r.recorderType===Ee||typeof c<"u"&&r.recorderType===c?r.type="video":r.recorderType===l?r.type="gif":r.recorderType===ve?r.type="audio":r.recorderType===ce&&(he(o,"audio").length&&he(o,"video").length||!he(o,"audio").length&&he(o,"video").length?r.type="video":he(o,"audio").length&&!he(o,"video").length&&(r.type="audio"))),typeof ce<"u"&&typeof MediaRecorder<"u"&&"requestData"in MediaRecorder.prototype&&(r.mimeType||(r.mimeType="video/webm"),r.type||(r.type=r.mimeType.split("/")[0]),r.bitsPerSecond),r.type||(r.mimeType&&(r.type=r.mimeType.split("/")[0]),r.type||(r.type="audio")),r}/**
 * {@link GetRecorderType} is an inner/private helper for {@link RecordRTC}.
 * @summary It returns best recorder-type available for your browser.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef GetRecorderType
 * @class
 * @example
 * var RecorderType = GetRecorderType(options);
 * var recorder = new RecorderType(options);
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @param {object} config - {type:"video", disableLogs: true, numberOfAudioChannels: 1, bufferSize: 0, sampleRate: 0, video: HTMLVideoElement, etc.}
 */function _(o,r){var u;return(X||G||z)&&(u=ve),typeof MediaRecorder<"u"&&"requestData"in MediaRecorder.prototype&&!X&&(u=ce),r.type==="video"&&(X||z)&&(u=s,typeof c<"u"&&typeof ReadableStream<"u"&&(u=c)),r.type==="gif"&&(u=l),r.type==="canvas"&&(u=Ee),g()&&u!==Ee&&u!==l&&typeof MediaRecorder<"u"&&"requestData"in MediaRecorder.prototype&&(he(o,"video").length||he(o,"audio").length)&&(r.type==="audio"?typeof MediaRecorder.isTypeSupported=="function"&&MediaRecorder.isTypeSupported("audio/webm")&&(u=ce):typeof MediaRecorder.isTypeSupported=="function"&&MediaRecorder.isTypeSupported("video/webm")&&(u=ce)),o instanceof Array&&o.length&&(u=t),r.recorderType&&(u=r.recorderType),!r.disableLogs&&u&&u.name&&console.log("Using recorderType:",u.name||u.constructor.name),!u&&q&&(u=ce),u}/**
 * MRecordRTC runs on top of {@link RecordRTC} to bring multiple recordings in a single place, by providing simple API.
 * @summary MRecordRTC stands for "Multiple-RecordRTC".
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef MRecordRTC
 * @class
 * @example
 * var recorder = new MRecordRTC();
 * recorder.addStream(MediaStream);
 * recorder.mediaType = {
 *     audio: true, // or StereoAudioRecorder or MediaStreamRecorder
 *     video: true, // or WhammyRecorder or MediaStreamRecorder or WebAssemblyRecorder or CanvasRecorder
 *     gif: true    // or GifRecorder
 * };
 * // mimeType is optional and should be set only in advance cases.
 * recorder.mimeType = {
 *     audio: 'audio/wav',
 *     video: 'video/webm',
 *     gif:   'image/gif'
 * };
 * recorder.startRecording();
 * @see For further information:
 * @see {@link https://github.com/muaz-khan/RecordRTC/tree/master/MRecordRTC|MRecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @requires {@link RecordRTC}
 */function b(o){this.addStream=function(r){r&&(o=r)},this.mediaType={audio:!0,video:!0},this.startRecording=function(){var r=this.mediaType,u,f=this.mimeType||{audio:null,video:null,gif:null};if(typeof r.audio!="function"&&g()&&!he(o,"audio").length&&(r.audio=!1),typeof r.video!="function"&&g()&&!he(o,"video").length&&(r.video=!1),typeof r.gif!="function"&&g()&&!he(o,"video").length&&(r.gif=!1),!r.audio&&!r.video&&!r.gif)throw"MediaStream must have either audio or video tracks.";if(r.audio&&(u=null,typeof r.audio=="function"&&(u=r.audio),this.audioRecorder=new h(o,{type:"audio",bufferSize:this.bufferSize,sampleRate:this.sampleRate,numberOfAudioChannels:this.numberOfAudioChannels||2,disableLogs:this.disableLogs,recorderType:u,mimeType:f.audio,timeSlice:this.timeSlice,onTimeStamp:this.onTimeStamp}),r.video||this.audioRecorder.startRecording()),r.video){u=null,typeof r.video=="function"&&(u=r.video);var p=o;if(g()&&r.audio&&typeof r.audio=="function"){var m=he(o,"video")[0];J?(p=new H,p.addTrack(m),u&&u===s&&(u=ce)):(p=new H,p.addTrack(m))}this.videoRecorder=new h(p,{type:"video",video:this.video,canvas:this.canvas,frameInterval:this.frameInterval||10,disableLogs:this.disableLogs,recorderType:u,mimeType:f.video,timeSlice:this.timeSlice,onTimeStamp:this.onTimeStamp,workerPath:this.workerPath,webAssemblyPath:this.webAssemblyPath,frameRate:this.frameRate,bitrate:this.bitrate}),r.audio||this.videoRecorder.startRecording()}if(r.audio&&r.video){var v=this,y=g()===!0;(r.audio instanceof ve&&r.video||r.audio!==!0&&r.video!==!0&&r.audio!==r.video)&&(y=!1),y===!0?(v.audioRecorder=null,v.videoRecorder.startRecording()):v.videoRecorder.initRecorder(function(){v.audioRecorder.initRecorder(function(){v.videoRecorder.startRecording(),v.audioRecorder.startRecording()})})}r.gif&&(u=null,typeof r.gif=="function"&&(u=r.gif),this.gifRecorder=new h(o,{type:"gif",frameRate:this.frameRate||200,quality:this.quality||10,disableLogs:this.disableLogs,recorderType:u,mimeType:f.gif}),this.gifRecorder.startRecording())},this.stopRecording=function(r){r=r||function(){},this.audioRecorder&&this.audioRecorder.stopRecording(function(u){r(u,"audio")}),this.videoRecorder&&this.videoRecorder.stopRecording(function(u){r(u,"video")}),this.gifRecorder&&this.gifRecorder.stopRecording(function(u){r(u,"gif")})},this.pauseRecording=function(){this.audioRecorder&&this.audioRecorder.pauseRecording(),this.videoRecorder&&this.videoRecorder.pauseRecording(),this.gifRecorder&&this.gifRecorder.pauseRecording()},this.resumeRecording=function(){this.audioRecorder&&this.audioRecorder.resumeRecording(),this.videoRecorder&&this.videoRecorder.resumeRecording(),this.gifRecorder&&this.gifRecorder.resumeRecording()},this.getBlob=function(r){var u={};return this.audioRecorder&&(u.audio=this.audioRecorder.getBlob()),this.videoRecorder&&(u.video=this.videoRecorder.getBlob()),this.gifRecorder&&(u.gif=this.gifRecorder.getBlob()),r&&r(u),u},this.destroy=function(){this.audioRecorder&&(this.audioRecorder.destroy(),this.audioRecorder=null),this.videoRecorder&&(this.videoRecorder.destroy(),this.videoRecorder=null),this.gifRecorder&&(this.gifRecorder.destroy(),this.gifRecorder=null)},this.getDataURL=function(r){this.getBlob(function(p){p.audio&&p.video?u(p.audio,function(m){u(p.video,function(v){r({audio:m,video:v})})}):p.audio?u(p.audio,function(m){r({audio:m})}):p.video&&u(p.video,function(m){r({video:m})})});function u(p,m){if(typeof Worker<"u"){var v=f(function(R){postMessage(new FileReaderSync().readAsDataURL(R))});v.onmessage=function(C){m(C.data)},v.postMessage(p)}else{var y=new FileReader;y.readAsDataURL(p),y.onload=function(C){m(C.target.result)}}}function f(p){var m=O.createObjectURL(new Blob([p.toString(),"this.onmessage =  function (eee) {"+p.name+"(eee.data);}"],{type:"application/javascript"})),v=new Worker(m),y;if(typeof O<"u")y=O;else if(typeof webkitURL<"u")y=webkitURL;else throw"Neither URL nor webkitURL detected.";return y.revokeObjectURL(m),v}},this.writeToDisk=function(){h.writeToDisk({audio:this.audioRecorder,video:this.videoRecorder,gif:this.gifRecorder})},this.save=function(r){r=r||{audio:!0,video:!0,gif:!0},r.audio&&this.audioRecorder&&this.audioRecorder.save(typeof r.audio=="string"?r.audio:""),r.video&&this.videoRecorder&&this.videoRecorder.save(typeof r.video=="string"?r.video:""),r.gif&&this.gifRecorder&&this.gifRecorder.save(typeof r.gif=="string"?r.gif:"")}}b.getFromDisk=h.getFromDisk,b.writeToDisk=h.writeToDisk,typeof h<"u"&&(h.MRecordRTC=b);var x="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";(function(o){o&&(typeof window<"u"||typeof ye>"u"||(ye.navigator={userAgent:x,getUserMedia:function(){}},ye.console||(ye.console={}),(typeof ye.console.log>"u"||typeof ye.console.error>"u")&&(ye.console.error=ye.console.log=ye.console.log||function(){console.log(arguments)}),typeof document>"u"&&(o.document={documentElement:{appendChild:function(){return""}}},document.createElement=document.captureStream=document.mozCaptureStream=function(){var r={getContext:function(){return r},play:function(){},pause:function(){},drawImage:function(){},toDataURL:function(){return""},style:{}};return r},o.HTMLVideoElement=function(){}),typeof location>"u"&&(o.location={protocol:"file:",href:"",hash:""}),typeof screen>"u"&&(o.screen={width:0,height:0}),typeof O>"u"&&(o.URL={createObjectURL:function(){return""},revokeObjectURL:function(){return""}}),o.window=ye))})(typeof ye<"u"?ye:null);var S=window.requestAnimationFrame;if(typeof S>"u"){if(typeof webkitRequestAnimationFrame<"u")S=webkitRequestAnimationFrame;else if(typeof mozRequestAnimationFrame<"u")S=mozRequestAnimationFrame;else if(typeof msRequestAnimationFrame<"u")S=msRequestAnimationFrame;else if(typeof S>"u"){var F=0;S=function(o,r){var u=new Date().getTime(),f=Math.max(0,16-(u-F)),p=setTimeout(function(){o(u+f)},f);return F=u+f,p}}}var E=window.cancelAnimationFrame;typeof E>"u"&&(typeof webkitCancelAnimationFrame<"u"?E=webkitCancelAnimationFrame:typeof mozCancelAnimationFrame<"u"?E=mozCancelAnimationFrame:typeof msCancelAnimationFrame<"u"?E=msCancelAnimationFrame:typeof E>"u"&&(E=function(o){clearTimeout(o)}));var P=window.AudioContext;typeof P>"u"&&(typeof webkitAudioContext<"u"&&(P=webkitAudioContext),typeof mozAudioContext<"u"&&(P=mozAudioContext));var O=window.URL;typeof O>"u"&&typeof webkitURL<"u"&&(O=webkitURL),typeof navigator<"u"&&typeof navigator.getUserMedia>"u"&&(typeof navigator.webkitGetUserMedia<"u"&&(navigator.getUserMedia=navigator.webkitGetUserMedia),typeof navigator.mozGetUserMedia<"u"&&(navigator.getUserMedia=navigator.mozGetUserMedia));var G=navigator.userAgent.indexOf("Edge")!==-1&&(!!navigator.msSaveBlob||!!navigator.msSaveOrOpenBlob),z=!!window.opera||navigator.userAgent.indexOf("OPR/")!==-1,J=navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&"netscape"in window&&/ rv:/.test(navigator.userAgent),X=!z&&!G&&!!navigator.webkitGetUserMedia||ie()||navigator.userAgent.toLowerCase().indexOf("chrome/")!==-1,q=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);q&&!X&&navigator.userAgent.indexOf("CriOS")!==-1&&(q=!1,X=!0);var H=window.MediaStream;typeof H>"u"&&typeof webkitMediaStream<"u"&&(H=webkitMediaStream),typeof H<"u"&&typeof H.prototype.stop>"u"&&(H.prototype.stop=function(){this.getTracks().forEach(function(o){o.stop()})});function ee(o){var r=1e3,u=["Bytes","KB","MB","GB","TB"];if(o===0)return"0 Bytes";var f=parseInt(Math.floor(Math.log(o)/Math.log(r)),10);return(o/Math.pow(r,f)).toPrecision(3)+" "+u[f]}function ne(o,r){if(!o)throw"Blob object is required.";if(!o.type)try{o.type="video/webm"}catch{}var u=(o.type||"video/webm").split("/")[1];if(u.indexOf(";")!==-1&&(u=u.split(";")[0]),r&&r.indexOf(".")!==-1){var f=r.split(".");r=f[0],u=f[1]}var p=(r||Math.round(Math.random()*9999999999)+888888888)+"."+u;if(typeof navigator.msSaveOrOpenBlob<"u")return navigator.msSaveOrOpenBlob(o,p);if(typeof navigator.msSaveBlob<"u")return navigator.msSaveBlob(o,p);var m=document.createElement("a");m.href=O.createObjectURL(o),m.download=p,m.style="display:none;opacity:0;color:transparent;",(document.body||document.documentElement).appendChild(m),typeof m.click=="function"?m.click():(m.target="_blank",m.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))),O.revokeObjectURL(m.href)}function ie(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}function he(o,r){return!o||!o.getTracks?[]:o.getTracks().filter(function(u){return u.kind===(r||"audio")})}function de(o,r){"srcObject"in r?r.srcObject=o:"mozSrcObject"in r?r.mozSrcObject=o:r.srcObject=o}function fe(o,r){if(typeof EBML>"u")throw new Error("Please link: https://www.webrtc-experiment.com/EBML.js");var u=new EBML.Reader,f=new EBML.Decoder,p=EBML.tools,m=new FileReader;m.onload=function(v){var y=f.decode(this.result);y.forEach(function(W){u.read(W)}),u.stop();var C=p.makeMetadataSeekable(u.metadatas,u.duration,u.cues),R=this.result.slice(u.metadataSize),M=new Blob([C,R],{type:"video/webm"});r(M)},m.readAsArrayBuffer(o)}typeof h<"u"&&(h.invokeSaveAsDialog=ne,h.getTracks=he,h.getSeekableBlob=fe,h.bytesToSize=ee,h.isElectron=ie);/**
 * Storage is a standalone object used by {@link RecordRTC} to store reusable objects e.g. "new AudioContext".
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @example
 * Storage.AudioContext === webkitAudioContext
 * @property {webkitAudioContext} AudioContext - Keeps a reference to AudioContext object.
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 */var pe={};typeof P<"u"?pe.AudioContext=P:typeof webkitAudioContext<"u"&&(pe.AudioContext=webkitAudioContext),typeof h<"u"&&(h.Storage=pe);function g(){if(J||q||G)return!0;var o=navigator.userAgent,r=""+parseFloat(navigator.appVersion),u=parseInt(navigator.appVersion,10),f,p;return(X||z)&&(f=o.indexOf("Chrome"),r=o.substring(f+7)),(p=r.indexOf(";"))!==-1&&(r=r.substring(0,p)),(p=r.indexOf(" "))!==-1&&(r=r.substring(0,p)),u=parseInt(""+r,10),isNaN(u)&&(r=""+parseFloat(navigator.appVersion),u=parseInt(navigator.appVersion,10)),u>=49}/**
 * MediaStreamRecorder is an abstraction layer for {@link https://w3c.github.io/mediacapture-record/MediaRecorder.html|MediaRecorder API}. It is used by {@link RecordRTC} to record MediaStream(s) in both Chrome and Firefox.
 * @summary Runs top over {@link https://w3c.github.io/mediacapture-record/MediaRecorder.html|MediaRecorder API}.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://github.com/muaz-khan|Muaz Khan}
 * @typedef MediaStreamRecorder
 * @class
 * @example
 * var config = {
 *     mimeType: 'video/webm', // vp8, vp9, h264, mkv, opus/vorbis
 *     audioBitsPerSecond : 256 * 8 * 1024,
 *     videoBitsPerSecond : 256 * 8 * 1024,
 *     bitsPerSecond: 256 * 8 * 1024,  // if this is provided, skip above two
 *     checkForInactiveTracks: true,
 *     timeSlice: 1000, // concatenate intervals based blobs
 *     ondataavailable: function() {} // get intervals based blobs
 * }
 * var recorder = new MediaStreamRecorder(mediaStream, config);
 * recorder.record();
 * recorder.stop(function(blob) {
 *     video.src = URL.createObjectURL(blob);
 *
 *     // or
 *     var blob = recorder.blob;
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @param {object} config - {disableLogs:true, initCallback: function, mimeType: "video/webm", timeSlice: 1000}
 * @throws Will throw an error if first argument "MediaStream" is missing. Also throws error if "MediaRecorder API" are not supported by the browser.
 */function ce(o,r){var M=this;if(typeof o>"u")throw'First argument "MediaStream" is required.';if(typeof MediaRecorder>"u")throw"Your browser does not support the Media Recorder API. Please try other modules e.g. WhammyRecorder or StereoAudioRecorder.";if(r=r||{mimeType:"video/webm"},r.type==="audio"){if(he(o,"video").length&&he(o,"audio").length){var u;navigator.mozGetUserMedia?(u=new H,u.addTrack(he(o,"audio")[0])):u=new H(he(o,"audio")),o=u}(!r.mimeType||r.mimeType.toString().toLowerCase().indexOf("audio")===-1)&&(r.mimeType=X?"audio/webm":"audio/ogg"),r.mimeType&&r.mimeType.toString().toLowerCase()!=="audio/ogg"&&navigator.mozGetUserMedia&&(r.mimeType="audio/ogg")}var f=[];this.getArrayOfBlobs=function(){return f},this.record=function(){M.blob=null,M.clearRecordedData(),M.timestamps=[],R=[],f=[];var W=r;r.disableLogs||console.log("Passing following config over MediaRecorder API.",W),y&&(y=null),X&&!g()&&(W="video/vp8"),typeof MediaRecorder.isTypeSupported=="function"&&W.mimeType&&(MediaRecorder.isTypeSupported(W.mimeType)||(r.disableLogs||console.warn("MediaRecorder API seems unable to record mimeType:",W.mimeType),W.mimeType=r.type==="audio"?"audio/webm":"video/webm"));try{y=new MediaRecorder(o,W),r.mimeType=W.mimeType}catch{y=new MediaRecorder(o)}W.mimeType&&!MediaRecorder.isTypeSupported&&"canRecordMimeType"in y&&y.canRecordMimeType(W.mimeType)===!1&&(r.disableLogs||console.warn("MediaRecorder API seems unable to record mimeType:",W.mimeType)),y.ondataavailable=function(j){if(j.data&&R.push("ondataavailable: "+ee(j.data.size)),typeof r.timeSlice=="number"){if(j.data&&j.data.size&&(f.push(j.data),p(),typeof r.ondataavailable=="function")){var I=r.getNativeBlob?j.data:new Blob([j.data],{type:m(W)});r.ondataavailable(I)}return}if(!j.data||!j.data.size||j.data.size<100||M.blob){M.recordingCallback&&(M.recordingCallback(new Blob([],{type:m(W)})),M.recordingCallback=null);return}M.blob=r.getNativeBlob?j.data:new Blob([j.data],{type:m(W)}),M.recordingCallback&&(M.recordingCallback(M.blob),M.recordingCallback=null)},y.onstart=function(){R.push("started")},y.onpause=function(){R.push("paused")},y.onresume=function(){R.push("resumed")},y.onstop=function(){R.push("stopped")},y.onerror=function(j){j&&(j.name||(j.name="UnknownError"),R.push("error: "+j),r.disableLogs||(j.name.toString().toLowerCase().indexOf("invalidstate")!==-1?console.error("The MediaRecorder is not in a state in which the proposed operation is allowed to be executed.",j):j.name.toString().toLowerCase().indexOf("notsupported")!==-1?console.error("MIME type (",W.mimeType,") is not supported.",j):j.name.toString().toLowerCase().indexOf("security")!==-1?console.error("MediaRecorder security error",j):j.name==="OutOfMemory"?console.error("The UA has exhaused the available memory. User agents SHOULD provide as much additional information as possible in the message attribute.",j):j.name==="IllegalStreamModification"?console.error("A modification to the stream has occurred that makes it impossible to continue recording. An example would be the addition of a Track while recording is occurring. User agents SHOULD provide as much additional information as possible in the message attribute.",j):j.name==="OtherRecordingError"?console.error("Used for an fatal error other than those listed above. User agents SHOULD provide as much additional information as possible in the message attribute.",j):j.name==="GenericError"?console.error("The UA cannot provide the codec or recording option that has been requested.",j):console.error("MediaRecorder Error",j)),function(I){if(!M.manuallyStopped&&y&&y.state==="inactive"){delete r.timeslice,y.start(10*60*1e3);return}setTimeout(I,1e3)}(),y.state!=="inactive"&&y.state!=="stopped"&&y.stop())},typeof r.timeSlice=="number"?(p(),y.start(r.timeSlice)):y.start(36e5),r.initCallback&&r.initCallback()},this.timestamps=[];function p(){M.timestamps.push(new Date().getTime()),typeof r.onTimeStamp=="function"&&r.onTimeStamp(M.timestamps[M.timestamps.length-1],M.timestamps)}function m(W){return y&&y.mimeType?y.mimeType:W.mimeType||"video/webm"}this.stop=function(W){W=W||function(){},M.manuallyStopped=!0,y&&(this.recordingCallback=W,y.state==="recording"&&y.stop(),typeof r.timeSlice=="number"&&setTimeout(function(){M.blob=new Blob(f,{type:m(r)}),M.recordingCallback(M.blob)},100))},this.pause=function(){y&&y.state==="recording"&&y.pause()},this.resume=function(){y&&y.state==="paused"&&y.resume()},this.clearRecordedData=function(){y&&y.state==="recording"&&M.stop(v),v()};function v(){f=[],y=null,M.timestamps=[]}var y;this.getInternalRecorder=function(){return y};function C(){if("active"in o){if(!o.active)return!1}else if("ended"in o&&o.ended)return!1;return!0}this.blob=null,this.getState=function(){return y&&y.state||"inactive"};var R=[];this.getAllStates=function(){return R},typeof r.checkForInactiveTracks>"u"&&(r.checkForInactiveTracks=!1);var M=this;(function W(){if(!(!y||r.checkForInactiveTracks===!1)){if(C()===!1){r.disableLogs||console.log("MediaStream seems stopped."),M.stop();return}setTimeout(W,1e3)}})(),this.name="MediaStreamRecorder",this.toString=function(){return this.name}}typeof h<"u"&&(h.MediaStreamRecorder=ce);/**
 * StereoAudioRecorder is a standalone class used by {@link RecordRTC} to bring "stereo" audio-recording in chrome.
 * @summary JavaScript standalone object for stereo audio recording.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef StereoAudioRecorder
 * @class
 * @example
 * var recorder = new StereoAudioRecorder(MediaStream, {
 *     sampleRate: 44100,
 *     bufferSize: 4096
 * });
 * recorder.record();
 * recorder.stop(function(blob) {
 *     video.src = URL.createObjectURL(blob);
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @param {object} config - {sampleRate: 44100, bufferSize: 4096, numberOfAudioChannels: 1, etc.}
 */function ve(o,r){if(!he(o,"audio").length)throw"Your stream has no audio tracks.";r=r||{};var u=this,f=[],p=[],m=!1,v=0,y,C=2,R=r.desiredSampRate;r.leftChannel===!0&&(C=1),r.numberOfAudioChannels===1&&(C=1),(!C||C<1)&&(C=2),r.disableLogs||console.log("StereoAudioRecorder is set to record number of channels: "+C),typeof r.checkForInactiveTracks>"u"&&(r.checkForInactiveTracks=!0);function M(){if(r.checkForInactiveTracks===!1)return!0;if("active"in o){if(!o.active)return!1}else if("ended"in o&&o.ended)return!1;return!0}this.record=function(){if(M()===!1)throw"Please make sure MediaStream is active.";A(),k=B=!1,m=!0,typeof r.timeSlice<"u"&&Y()};function W(K,te){function Q(Z,oe){var le=Z.numberOfAudioChannels,se=Z.leftBuffers.slice(0),ue=Z.rightBuffers.slice(0),ge=Z.sampleRate,Ce=Z.internalInterleavedLength,xe=Z.desiredSampRate;le===2&&(se=Oe(se,Ce),ue=Oe(ue,Ce),xe&&(se=Le(se,xe,ge),ue=Le(ue,xe,ge))),le===1&&(se=Oe(se,Ce),xe&&(se=Le(se,xe,ge))),xe&&(ge=xe);function Le(Te,je,Fe){var Ae=Math.round(Te.length*(je/Fe)),De=[],Be=Number((Te.length-1)/(Ae-1));De[0]=Te[0];for(var ze=1;ze<Ae-1;ze++){var tt=ze*Be,it=Number(Math.floor(tt)).toFixed(),ht=Number(Math.ceil(tt)).toFixed(),lt=tt-it;De[ze]=_e(Te[it],Te[ht],lt)}return De[Ae-1]=Te[Te.length-1],De}function _e(Te,je,Fe){return Te+(je-Te)*Fe}function Oe(Te,je){for(var Fe=new Float64Array(je),Ae=0,De=Te.length,Be=0;Be<De;Be++){var ze=Te[Be];Fe.set(ze,Ae),Ae+=ze.length}return Fe}function Ge(Te,je){for(var Fe=Te.length+je.length,Ae=new Float64Array(Fe),De=0,Be=0;Be<Fe;)Ae[Be++]=Te[De],Ae[Be++]=je[De],De++;return Ae}function Pe(Te,je,Fe){for(var Ae=Fe.length,De=0;De<Ae;De++)Te.setUint8(je+De,Fe.charCodeAt(De))}var ke;le===2&&(ke=Ge(se,ue)),le===1&&(ke=se);var Ie=ke.length,Je=44+Ie*2,We=new ArrayBuffer(Je),Se=new DataView(We);Pe(Se,0,"RIFF"),Se.setUint32(4,36+Ie*2,!0),Pe(Se,8,"WAVE"),Pe(Se,12,"fmt "),Se.setUint32(16,16,!0),Se.setUint16(20,1,!0),Se.setUint16(22,le,!0),Se.setUint32(24,ge,!0),Se.setUint32(28,ge*le*2,!0),Se.setUint16(32,le*2,!0),Se.setUint16(34,16,!0),Pe(Se,36,"data"),Se.setUint32(40,Ie*2,!0);for(var Ze=Ie,Xe=44,Ve=1,et=0;et<Ze;et++)Se.setInt16(Xe,ke[et]*(32767*Ve),!0),Xe+=2;if(oe)return oe({buffer:We,view:Se});postMessage({buffer:We,view:Se})}if(K.noWorker){Q(K,function(Z){te(Z.buffer,Z.view)});return}var re=j(Q);re.onmessage=function(Z){te(Z.data.buffer,Z.data.view),O.revokeObjectURL(re.workerURL),re.terminate()},re.postMessage(K)}function j(K){var te=O.createObjectURL(new Blob([K.toString(),";this.onmessage =  function (eee) {"+K.name+"(eee.data);}"],{type:"application/javascript"})),Q=new Worker(te);return Q.workerURL=te,Q}this.stop=function(K){K=K||function(){},m=!1,W({desiredSampRate:R,sampleRate:L,numberOfAudioChannels:C,internalInterleavedLength:v,leftBuffers:f,rightBuffers:C===1?[]:p,noWorker:r.noWorker},function(te,Q){u.blob=new Blob([Q],{type:"audio/wav"}),u.buffer=new ArrayBuffer(Q.buffer.byteLength),u.view=Q,u.sampleRate=R||L,u.bufferSize=U,u.length=v,k=!1,K&&K(u.blob)})},typeof h.Storage>"u"&&(h.Storage={AudioContextConstructor:null,AudioContext:window.AudioContext||window.webkitAudioContext}),(!h.Storage.AudioContextConstructor||h.Storage.AudioContextConstructor.state==="closed")&&(h.Storage.AudioContextConstructor=new h.Storage.AudioContext);var I=h.Storage.AudioContextConstructor,T=I.createMediaStreamSource(o),D=[0,256,512,1024,2048,4096,8192,16384],U=typeof r.bufferSize>"u"?4096:r.bufferSize;if(D.indexOf(U)===-1&&(r.disableLogs||console.log("Legal values for buffer-size are "+JSON.stringify(D,null,"	"))),I.createJavaScriptNode)y=I.createJavaScriptNode(U,C,C);else if(I.createScriptProcessor)y=I.createScriptProcessor(U,C,C);else throw"WebAudio API has no support on this browser.";T.connect(y),r.bufferSize||(U=y.bufferSize);var L=typeof r.sampleRate<"u"?r.sampleRate:I.sampleRate||44100;(L<22050||L>96e3)&&(r.disableLogs||console.log("sample-rate must be under range 22050 and 96000.")),r.disableLogs||r.desiredSampRate&&console.log("Desired sample-rate: "+r.desiredSampRate);var B=!1;this.pause=function(){B=!0},this.resume=function(){if(M()===!1)throw"Please make sure MediaStream is active.";if(!m){r.disableLogs||console.log("Seems recording has been restarted."),this.record();return}B=!1},this.clearRecordedData=function(){r.checkForInactiveTracks=!1,m&&this.stop(w),w()};function A(){f=[],p=[],v=0,k=!1,m=!1,B=!1,I=null,u.leftchannel=f,u.rightchannel=p,u.numberOfAudioChannels=C,u.desiredSampRate=R,u.sampleRate=L,u.recordingLength=v,N={left:[],right:[],recordingLength:0}}function w(){y&&(y.onaudioprocess=null,y.disconnect(),y=null),T&&(T.disconnect(),T=null),A()}this.name="StereoAudioRecorder",this.toString=function(){return this.name};var k=!1;function V(K){if(!B){if(M()===!1&&(r.disableLogs||console.log("MediaStream seems stopped."),y.disconnect(),m=!1),!m){T&&(T.disconnect(),T=null);return}k||(k=!0,r.onAudioProcessStarted&&r.onAudioProcessStarted(),r.initCallback&&r.initCallback());var te=K.inputBuffer.getChannelData(0),Q=new Float32Array(te);if(f.push(Q),C===2){var re=K.inputBuffer.getChannelData(1),Z=new Float32Array(re);p.push(Z)}v+=U,u.recordingLength=v,typeof r.timeSlice<"u"&&(N.recordingLength+=U,N.left.push(Q),C===2&&N.right.push(Z))}}y.onaudioprocess=V,I.createMediaStreamDestination?y.connect(I.createMediaStreamDestination()):y.connect(I.destination),this.leftchannel=f,this.rightchannel=p,this.numberOfAudioChannels=C,this.desiredSampRate=R,this.sampleRate=L,u.recordingLength=v;var N={left:[],right:[],recordingLength:0};function Y(){!m||typeof r.ondataavailable!="function"||typeof r.timeSlice>"u"||(N.left.length?(W({desiredSampRate:R,sampleRate:L,numberOfAudioChannels:C,internalInterleavedLength:N.recordingLength,leftBuffers:N.left,rightBuffers:C===1?[]:N.right},function(K,te){var Q=new Blob([te],{type:"audio/wav"});r.ondataavailable(Q),setTimeout(Y,r.timeSlice)}),N={left:[],right:[],recordingLength:0}):setTimeout(Y,r.timeSlice))}}typeof h<"u"&&(h.StereoAudioRecorder=ve);/**
 * CanvasRecorder is a standalone class used by {@link RecordRTC} to bring HTML5-Canvas recording into video WebM. It uses HTML2Canvas library and runs top over {@link Whammy}.
 * @summary HTML2Canvas recording into video WebM.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef CanvasRecorder
 * @class
 * @example
 * var recorder = new CanvasRecorder(htmlElement, { disableLogs: true, useWhammyRecorder: true });
 * recorder.record();
 * recorder.stop(function(blob) {
 *     video.src = URL.createObjectURL(blob);
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {HTMLElement} htmlElement - querySelector/getElementById/getElementsByTagName[0]/etc.
 * @param {object} config - {disableLogs:true, initCallback: function}
 */function Ee(o,r){if(typeof html2canvas>"u")throw"Please link: https://www.webrtc-experiment.com/screenshot.js";r=r||{},r.frameInterval||(r.frameInterval=10);var u=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach(function(D){D in document.createElement("canvas")&&(u=!0)});var f=(!!window.webkitRTCPeerConnection||!!window.webkitGetUserMedia)&&!!window.chrome,p=50,m=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);f&&m&&m[2]&&(p=parseInt(m[2],10)),f&&p<52&&(u=!1),r.useWhammyRecorder&&(u=!1);var v,y;if(u)if(r.disableLogs||console.log("Your browser supports both MediRecorder API and canvas.captureStream!"),o instanceof HTMLCanvasElement)v=o;else if(o instanceof CanvasRenderingContext2D)v=o.canvas;else throw"Please pass either HTMLCanvasElement or CanvasRenderingContext2D.";else navigator.mozGetUserMedia&&(r.disableLogs||console.error("Canvas recording is NOT supported in Firefox."));var C;this.record=function(){if(C=!0,u&&!r.useWhammyRecorder){var D;"captureStream"in v?D=v.captureStream(25):"mozCaptureStream"in v?D=v.mozCaptureStream(25):"webkitCaptureStream"in v&&(D=v.webkitCaptureStream(25));try{var U=new H;U.addTrack(he(D,"video")[0]),D=U}catch{}if(!D)throw"captureStream API are NOT available.";y=new ce(D,{mimeType:r.mimeType||"video/webm"}),y.record()}else T.frames=[],I=new Date().getTime(),j();r.initCallback&&r.initCallback()},this.getWebPImages=function(D){if(o.nodeName.toLowerCase()!=="canvas"){D();return}var U=T.frames.length;T.frames.forEach(function(L,B){var A=U-B;r.disableLogs||console.log(A+"/"+U+" frames remaining"),r.onEncodingCallback&&r.onEncodingCallback(A,U);var w=L.image.toDataURL("image/webp",1);T.frames[B].image=w}),r.disableLogs||console.log("Generating WebM"),D()},this.stop=function(D){C=!1;var U=this;if(u&&y){y.stop(D);return}this.getWebPImages(function(){T.compile(function(L){r.disableLogs||console.log("Recording finished!"),U.blob=L,U.blob.forEach&&(U.blob=new Blob([],{type:"video/webm"})),D&&D(U.blob),T.frames=[]})})};var R=!1;this.pause=function(){if(R=!0,y instanceof ce){y.pause();return}},this.resume=function(){if(R=!1,y instanceof ce){y.resume();return}C||this.record()},this.clearRecordedData=function(){C&&this.stop(M),M()};function M(){T.frames=[],C=!1,R=!1}this.name="CanvasRecorder",this.toString=function(){return this.name};function W(){var D=document.createElement("canvas"),U=D.getContext("2d");return D.width=o.width,D.height=o.height,U.drawImage(o,0,0),D}function j(){if(R)return I=new Date().getTime(),setTimeout(j,500);if(o.nodeName.toLowerCase()==="canvas"){var D=new Date().getTime()-I;I=new Date().getTime(),T.frames.push({image:W(),duration:D}),C&&setTimeout(j,r.frameInterval);return}html2canvas(o,{grabMouse:typeof r.showMousePointer>"u"||r.showMousePointer,onrendered:function(U){var L=new Date().getTime()-I;if(!L)return setTimeout(j,r.frameInterval);I=new Date().getTime(),T.frames.push({image:U.toDataURL("image/webp",1),duration:L}),C&&setTimeout(j,r.frameInterval)}})}var I=new Date().getTime(),T=new i.Video(100)}typeof h<"u"&&(h.CanvasRecorder=Ee);/**
 * WhammyRecorder is a standalone class used by {@link RecordRTC} to bring video recording in Chrome. It runs top over {@link Whammy}.
 * @summary Video recording feature in Chrome.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef WhammyRecorder
 * @class
 * @example
 * var recorder = new WhammyRecorder(mediaStream);
 * recorder.record();
 * recorder.stop(function(blob) {
 *     video.src = URL.createObjectURL(blob);
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @param {object} config - {disableLogs: true, initCallback: function, video: HTMLVideoElement, etc.}
 */function s(o,r){r=r||{},r.frameInterval||(r.frameInterval=10),r.disableLogs||console.log("Using frames-interval:",r.frameInterval),this.record=function(){r.width||(r.width=320),r.height||(r.height=240),r.video||(r.video={width:r.width,height:r.height}),r.canvas||(r.canvas={width:r.width,height:r.height}),C.width=r.canvas.width||320,C.height=r.canvas.height||240,R=C.getContext("2d"),r.video&&r.video instanceof HTMLVideoElement?(M=r.video.cloneNode(),r.initCallback&&r.initCallback()):(M=document.createElement("video"),de(o,M),M.onloadedmetadata=function(){r.initCallback&&r.initCallback()},M.width=r.video.width,M.height=r.video.height),M.muted=!0,M.play(),W=new Date().getTime(),j=new i.Video,r.disableLogs||(console.log("canvas resolutions",C.width,"*",C.height),console.log("video width/height",M.width||C.width,"*",M.height||C.height)),u(r.frameInterval)};function u(I){I=typeof I<"u"?I:10;var T=new Date().getTime()-W;if(!T)return setTimeout(u,I,I);if(v)return W=new Date().getTime(),setTimeout(u,100);W=new Date().getTime(),M.paused&&M.play(),R.drawImage(M,0,0,C.width,C.height),j.frames.push({duration:T,image:C.toDataURL("image/webp")}),m||setTimeout(u,I,I)}function f(I){var T=-1,D=I.length;(function U(){if(T++,T===D){I.callback();return}setTimeout(function(){I.functionToLoop(U,T)},1)})()}function p(I,T,D,U,L){var B=document.createElement("canvas");B.width=C.width,B.height=C.height;var A=B.getContext("2d"),w=[],k=I.length,V={r:0,g:0,b:0},N=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),Y=0,K=0,te=!1;f({length:k,functionToLoop:function(Q,re){var Z,oe,le,se=function(){!te&&le-Z<=le*K||(te=!0,w.push(I[re])),Q()};if(te)se();else{var ue=new Image;ue.onload=function(){A.drawImage(ue,0,0,C.width,C.height);var ge=A.getImageData(0,0,C.width,C.height);Z=0,oe=ge.data.length,le=ge.data.length/4;for(var Ce=0;Ce<oe;Ce+=4){var xe={r:ge.data[Ce],g:ge.data[Ce+1],b:ge.data[Ce+2]},Le=Math.sqrt(Math.pow(xe.r-V.r,2)+Math.pow(xe.g-V.g,2)+Math.pow(xe.b-V.b,2));Le<=N*Y&&Z++}se()},ue.src=I[re].image}},callback:function(){w=w.concat(I.slice(k)),w.length<=0&&w.push(I[I.length-1]),L(w)}})}var m=!1;this.stop=function(I){I=I||function(){},m=!0;var T=this;setTimeout(function(){p(j.frames,-1,null,null,function(D){j.frames=D,r.advertisement&&r.advertisement.length&&(j.frames=r.advertisement.concat(j.frames)),j.compile(function(U){T.blob=U,T.blob.forEach&&(T.blob=new Blob([],{type:"video/webm"})),I&&I(T.blob)})})},10)};var v=!1;this.pause=function(){v=!0},this.resume=function(){v=!1,m&&this.record()},this.clearRecordedData=function(){m||this.stop(y),y()};function y(){j.frames=[],m=!0,v=!1}this.name="WhammyRecorder",this.toString=function(){return this.name};var C=document.createElement("canvas"),R=C.getContext("2d"),M,W,j}typeof h<"u"&&(h.WhammyRecorder=s);/**
 * Whammy is a standalone class used by {@link RecordRTC} to bring video recording in Chrome. It is written by {@link https://github.com/antimatter15|antimatter15}
 * @summary A real time javascript webm encoder based on a canvas hack.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef Whammy
 * @class
 * @example
 * var recorder = new Whammy().Video(15);
 * recorder.add(context || canvas || dataURL);
 * var output = recorder.compile();
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 */var i=function(){function o(f){this.frames=[],this.duration=f||1,this.quality=.8}o.prototype.add=function(f,p){if("canvas"in f&&(f=f.canvas),"toDataURL"in f&&(f=f.toDataURL("image/webp",this.quality)),!/^data:image\/webp;base64,/ig.test(f))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:f,duration:p||this.duration})};function r(f){var p=O.createObjectURL(new Blob([f.toString(),"this.onmessage =  function (eee) {"+f.name+"(eee.data);}"],{type:"application/javascript"})),m=new Worker(p);return O.revokeObjectURL(p),m}function u(f){function p(L){var B=v(L);if(!B)return[];for(var A=3e4,w=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:D(B.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:B.width,id:176},{data:B.height,id:186}]}]}]}]}],k=0,V=0;k<L.length;){var N=[],Y=0;do N.push(L[k]),Y+=L[k].duration,k++;while(k<L.length&&Y<A);var K=0,te={id:524531317,data:m(V,K,N)};w[1].data.push(te),V+=Y}return M(w)}function m(L,B,A){return[{data:L,id:231}].concat(A.map(function(w){var k=W({discardable:0,frame:w.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(B)});return B+=w.duration,{data:k,id:163}}))}function v(L){if(!L[0]){postMessage({error:"Something went wrong. Maybe WebP format is not supported in the current browser."});return}for(var B=L[0].width,A=L[0].height,w=L[0].duration,k=1;k<L.length;k++)w+=L[k].duration;return{duration:w,width:B,height:A}}function y(L){for(var B=[];L>0;)B.push(L&255),L=L>>8;return new Uint8Array(B.reverse())}function C(L){return new Uint8Array(L.split("").map(function(B){return B.charCodeAt(0)}))}function R(L){var B=[],A=L.length%8?new Array(9-L.length%8).join("0"):"";L=A+L;for(var w=0;w<L.length;w+=8)B.push(parseInt(L.substr(w,8),2));return new Uint8Array(B)}function M(L){for(var B=[],A=0;A<L.length;A++){var w=L[A].data;typeof w=="object"&&(w=M(w)),typeof w=="number"&&(w=R(w.toString(2))),typeof w=="string"&&(w=C(w));var k=w.size||w.byteLength||w.length,V=Math.ceil(Math.ceil(Math.log(k)/Math.log(2))/8),N=k.toString(2),Y=new Array(V*7+7+1-N.length).join("0")+N,K=new Array(V).join("0")+"1"+Y;B.push(y(L[A].id)),B.push(R(K)),B.push(w)}return new Blob(B,{type:"video/webm"})}function W(L){var B=0;if(B|=128,L.trackNum>127)throw"TrackNumber > 127 not supported";var A=[L.trackNum|128,L.timecode>>8,L.timecode&255,B].map(function(w){return String.fromCharCode(w)}).join("")+L.frame;return A}function j(L){for(var B=L.RIFF[0].WEBP[0],A=B.indexOf("*"),w=0,k=[];w<4;w++)k[w]=B.charCodeAt(A+3+w);var V,N,Y;return Y=k[1]<<8|k[0],V=Y&16383,Y=k[3]<<8|k[2],N=Y&16383,{width:V,height:N,data:B,riff:L}}function I(L,B){return parseInt(L.substr(B+4,4).split("").map(function(A){var w=A.charCodeAt(0).toString(2);return new Array(8-w.length+1).join("0")+w}).join(""),2)}function T(L){for(var B=0,A={};B<L.length;){var w=L.substr(B,4),k=I(L,B),V=L.substr(B+4+4,k);B+=8+k,A[w]=A[w]||[],w==="RIFF"||w==="LIST"?A[w].push(T(V)):A[w].push(V)}return A}function D(L){return[].slice.call(new Uint8Array(new Float64Array([L]).buffer),0).map(function(B){return String.fromCharCode(B)}).reverse().join("")}var U=new p(f.map(function(L){var B=j(T(atob(L.image.slice(23))));return B.duration=L.duration,B}));postMessage(U)}return o.prototype.compile=function(f){var p=r(u);p.onmessage=function(m){if(m.data.error){console.error(m.data.error);return}f(m.data)},p.postMessage(this.frames)},{Video:o}}();typeof h<"u"&&(h.Whammy=i);/**
 * DiskStorage is a standalone object used by {@link RecordRTC} to store recorded blobs in IndexedDB storage.
 * @summary Writing blobs into IndexedDB.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @example
 * DiskStorage.Store({
 *     audioBlob: yourAudioBlob,
 *     videoBlob: yourVideoBlob,
 *     gifBlob  : yourGifBlob
 * });
 * DiskStorage.Fetch(function(dataURL, type) {
 *     if(type === 'audioBlob') { }
 *     if(type === 'videoBlob') { }
 *     if(type === 'gifBlob')   { }
 * });
 * // DiskStorage.dataStoreName = 'recordRTC';
 * // DiskStorage.onError = function(error) { };
 * @property {function} init - This method must be called once to initialize IndexedDB ObjectStore. Though, it is auto-used internally.
 * @property {function} Fetch - This method fetches stored blobs from IndexedDB.
 * @property {function} Store - This method stores blobs in IndexedDB.
 * @property {function} onError - This function is invoked for any known/unknown error.
 * @property {string} dataStoreName - Name of the ObjectStore created in IndexedDB storage.
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 */var n={init:function(){var o=this;if(typeof indexedDB>"u"||typeof indexedDB.open>"u"){console.error("IndexedDB API are not available in this browser.");return}var r=1,u=this.dbName||location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),f,p=indexedDB.open(u,r);function m(y){y.createObjectStore(o.dataStoreName)}function v(){var y=f.transaction([o.dataStoreName],"readwrite");o.videoBlob&&y.objectStore(o.dataStoreName).put(o.videoBlob,"videoBlob"),o.gifBlob&&y.objectStore(o.dataStoreName).put(o.gifBlob,"gifBlob"),o.audioBlob&&y.objectStore(o.dataStoreName).put(o.audioBlob,"audioBlob");function C(R){y.objectStore(o.dataStoreName).get(R).onsuccess=function(M){o.callback&&o.callback(M.target.result,R)}}C("audioBlob"),C("videoBlob"),C("gifBlob")}p.onerror=o.onError,p.onsuccess=function(){if(f=p.result,f.onerror=o.onError,f.setVersion)if(f.version!==r){var y=f.setVersion(r);y.onsuccess=function(){m(f),v()}}else v();else v()},p.onupgradeneeded=function(y){m(y.target.result)}},Fetch:function(o){return this.callback=o,this.init(),this},Store:function(o){return this.audioBlob=o.audioBlob,this.videoBlob=o.videoBlob,this.gifBlob=o.gifBlob,this.init(),this},onError:function(o){console.error(JSON.stringify(o,null,"	"))},dataStoreName:"recordRTC",dbName:null};typeof h<"u"&&(h.DiskStorage=n);/**
 * GifRecorder is standalone calss used by {@link RecordRTC} to record video or canvas into animated gif.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef GifRecorder
 * @class
 * @example
 * var recorder = new GifRecorder(mediaStream || canvas || context, { onGifPreview: function, onGifRecordingStarted: function, width: 1280, height: 720, frameRate: 200, quality: 10 });
 * recorder.record();
 * recorder.stop(function(blob) {
 *     img.src = URL.createObjectURL(blob);
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object or HTMLCanvasElement or CanvasRenderingContext2D.
 * @param {object} config - {disableLogs:true, initCallback: function, width: 320, height: 240, frameRate: 200, quality: 10}
 */function l(o,r){if(typeof GIFEncoder>"u"){var u=document.createElement("script");u.src="https://www.webrtc-experiment.com/gif-recorder.js",(document.body||document.documentElement).appendChild(u)}r=r||{};var f=o instanceof CanvasRenderingContext2D||o instanceof HTMLCanvasElement;this.record=function(){if(typeof GIFEncoder>"u"){setTimeout(I.record,1e3);return}if(!C){setTimeout(I.record,1e3);return}f||(r.width||(r.width=R.offsetWidth||320),r.height||(r.height=R.offsetHeight||240),r.video||(r.video={width:r.width,height:r.height}),r.canvas||(r.canvas={width:r.width,height:r.height}),v.width=r.canvas.width||320,v.height=r.canvas.height||240,R.width=r.video.width||320,R.height=r.video.height||240),j=new GIFEncoder,j.setRepeat(0),j.setDelay(r.frameRate||200),j.setQuality(r.quality||10),j.start(),typeof r.onGifRecordingStarted=="function"&&r.onGifRecordingStarted();function T(D){if(I.clearedRecordedData!==!0){if(p)return setTimeout(function(){T(D)},100);M=S(T),typeof W===void 0&&(W=D),!(D-W<90)&&(!f&&R.paused&&R.play(),f||y.drawImage(R,0,0,v.width,v.height),r.onGifPreview&&r.onGifPreview(v.toDataURL("image/png")),j.addFrame(y),W=D)}}M=S(T),r.initCallback&&r.initCallback()},this.stop=function(T){T=T||function(){},M&&E(M),this.blob=new Blob([new Uint8Array(j.stream().bin)],{type:"image/gif"}),T(this.blob),j.stream().bin=[]};var p=!1;this.pause=function(){p=!0},this.resume=function(){p=!1},this.clearRecordedData=function(){I.clearedRecordedData=!0,m()};function m(){j&&(j.stream().bin=[])}this.name="GifRecorder",this.toString=function(){return this.name};var v=document.createElement("canvas"),y=v.getContext("2d");f&&(o instanceof CanvasRenderingContext2D?(y=o,v=y.canvas):o instanceof HTMLCanvasElement&&(y=o.getContext("2d"),v=o));var C=!0;if(!f){var R=document.createElement("video");R.muted=!0,R.autoplay=!0,R.playsInline=!0,C=!1,R.onloadedmetadata=function(){C=!0},de(o,R),R.play()}var M=null,W,j,I=this}typeof h<"u"&&(h.GifRecorder=l);function e(o,r){var u="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";(function(w){typeof h<"u"||w&&(typeof window<"u"||typeof ye>"u"||(ye.navigator={userAgent:u,getUserMedia:function(){}},ye.console||(ye.console={}),(typeof ye.console.log>"u"||typeof ye.console.error>"u")&&(ye.console.error=ye.console.log=ye.console.log||function(){console.log(arguments)}),typeof document>"u"&&(w.document={documentElement:{appendChild:function(){return""}}},document.createElement=document.captureStream=document.mozCaptureStream=function(){var k={getContext:function(){return k},play:function(){},pause:function(){},drawImage:function(){},toDataURL:function(){return""},style:{}};return k},w.HTMLVideoElement=function(){}),typeof location>"u"&&(w.location={protocol:"file:",href:"",hash:""}),typeof screen>"u"&&(w.screen={width:0,height:0}),typeof R>"u"&&(w.URL={createObjectURL:function(){return""},revokeObjectURL:function(){return""}}),w.window=ye))})(typeof ye<"u"?ye:null),r=r||"multi-streams-mixer";var f=[],p=!1,m=document.createElement("canvas"),v=m.getContext("2d");m.style.opacity=0,m.style.position="absolute",m.style.zIndex=-1,m.style.top="-1000em",m.style.left="-1000em",m.className=r,(document.body||document.documentElement).appendChild(m),this.disableLogs=!1,this.frameInterval=10,this.width=360,this.height=240,this.useGainNode=!0;var y=this,C=window.AudioContext;typeof C>"u"&&(typeof webkitAudioContext<"u"&&(C=webkitAudioContext),typeof mozAudioContext<"u"&&(C=mozAudioContext));var R=window.URL;typeof R>"u"&&typeof webkitURL<"u"&&(R=webkitURL),typeof navigator<"u"&&typeof navigator.getUserMedia>"u"&&(typeof navigator.webkitGetUserMedia<"u"&&(navigator.getUserMedia=navigator.webkitGetUserMedia),typeof navigator.mozGetUserMedia<"u"&&(navigator.getUserMedia=navigator.mozGetUserMedia));var M=window.MediaStream;typeof M>"u"&&typeof webkitMediaStream<"u"&&(M=webkitMediaStream),typeof M<"u"&&typeof M.prototype.stop>"u"&&(M.prototype.stop=function(){this.getTracks().forEach(function(w){w.stop()})});var W={};typeof C<"u"?W.AudioContext=C:typeof webkitAudioContext<"u"&&(W.AudioContext=webkitAudioContext);function j(w,k){"srcObject"in k?k.srcObject=w:"mozSrcObject"in k?k.mozSrcObject=w:k.srcObject=w}this.startDrawingFrames=function(){I()};function I(){if(!p){var w=f.length,k=!1,V=[];if(f.forEach(function(Y){Y.stream||(Y.stream={}),Y.stream.fullcanvas?k=Y:V.push(Y)}),k)m.width=k.stream.width,m.height=k.stream.height;else if(V.length){m.width=w>1?V[0].width*2:V[0].width;var N=1;(w===3||w===4)&&(N=2),(w===5||w===6)&&(N=3),(w===7||w===8)&&(N=4),(w===9||w===10)&&(N=5),m.height=V[0].height*N}else m.width=y.width||360,m.height=y.height||240;k&&k instanceof HTMLVideoElement&&T(k),V.forEach(function(Y,K){T(Y,K)}),setTimeout(I,y.frameInterval)}}function T(w,k){if(!p){var V=0,N=0,Y=w.width,K=w.height;k===1&&(V=w.width),k===2&&(N=w.height),k===3&&(V=w.width,N=w.height),k===4&&(N=w.height*2),k===5&&(V=w.width,N=w.height*2),k===6&&(N=w.height*3),k===7&&(V=w.width,N=w.height*3),typeof w.stream.left<"u"&&(V=w.stream.left),typeof w.stream.top<"u"&&(N=w.stream.top),typeof w.stream.width<"u"&&(Y=w.stream.width),typeof w.stream.height<"u"&&(K=w.stream.height),v.drawImage(w,V,N,Y,K),typeof w.stream.onRender=="function"&&w.stream.onRender(v,V,N,Y,K,k)}}function D(){p=!1;var w=U(),k=L();return k&&k.getTracks().filter(function(V){return V.kind==="audio"}).forEach(function(V){w.addTrack(V)}),o.forEach(function(V){V.fullcanvas}),w}function U(){A();var w;"captureStream"in m?w=m.captureStream():"mozCaptureStream"in m?w=m.mozCaptureStream():y.disableLogs||console.error("Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features");var k=new M;return w.getTracks().filter(function(V){return V.kind==="video"}).forEach(function(V){k.addTrack(V)}),m.stream=k,k}function L(){W.AudioContextConstructor||(W.AudioContextConstructor=new W.AudioContext),y.audioContext=W.AudioContextConstructor,y.audioSources=[],y.useGainNode===!0&&(y.gainNode=y.audioContext.createGain(),y.gainNode.connect(y.audioContext.destination),y.gainNode.gain.value=0);var w=0;if(o.forEach(function(k){if(k.getTracks().filter(function(N){return N.kind==="audio"}).length){w++;var V=y.audioContext.createMediaStreamSource(k);y.useGainNode===!0&&V.connect(y.gainNode),y.audioSources.push(V)}}),!!w)return y.audioDestination=y.audioContext.createMediaStreamDestination(),y.audioSources.forEach(function(k){k.connect(y.audioDestination)}),y.audioDestination.stream}function B(w){var k=document.createElement("video");return j(w,k),k.className=r,k.muted=!0,k.volume=0,k.width=w.width||y.width||360,k.height=w.height||y.height||240,k.play(),k}this.appendStreams=function(w){if(!w)throw"First parameter is required.";w instanceof Array||(w=[w]),w.forEach(function(k){var V=new M;if(k.getTracks().filter(function(K){return K.kind==="video"}).length){var N=B(k);N.stream=k,f.push(N),V.addTrack(k.getTracks().filter(function(K){return K.kind==="video"})[0])}if(k.getTracks().filter(function(K){return K.kind==="audio"}).length){var Y=y.audioContext.createMediaStreamSource(k);y.audioDestination=y.audioContext.createMediaStreamDestination(),Y.connect(y.audioDestination),V.addTrack(y.audioDestination.stream.getTracks().filter(function(K){return K.kind==="audio"})[0])}o.push(V)})},this.releaseStreams=function(){f=[],p=!0,y.gainNode&&(y.gainNode.disconnect(),y.gainNode=null),y.audioSources.length&&(y.audioSources.forEach(function(w){w.disconnect()}),y.audioSources=[]),y.audioDestination&&(y.audioDestination.disconnect(),y.audioDestination=null),y.audioContext&&y.audioContext.close(),y.audioContext=null,v.clearRect(0,0,m.width,m.height),m.stream&&(m.stream.stop(),m.stream=null)},this.resetVideoStreams=function(w){w&&!(w instanceof Array)&&(w=[w]),A(w)};function A(w){f=[],w=w||o,w.forEach(function(k){if(k.getTracks().filter(function(N){return N.kind==="video"}).length){var V=B(k);V.stream=k,f.push(V)}})}this.name="MultiStreamsMixer",this.toString=function(){return this.name},this.getMixedStream=D}typeof h>"u"&&(ae.exports=e);/**
 * MultiStreamRecorder can record multiple videos in single container.
 * @summary Multi-videos recorder.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef MultiStreamRecorder
 * @class
 * @example
 * var options = {
 *     mimeType: 'video/webm'
 * }
 * var recorder = new MultiStreamRecorder(ArrayOfMediaStreams, options);
 * recorder.record();
 * recorder.stop(function(blob) {
 *     video.src = URL.createObjectURL(blob);
 *
 *     // or
 *     var blob = recorder.blob;
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStreams} mediaStreams - Array of MediaStreams.
 * @param {object} config - {disableLogs:true, frameInterval: 1, mimeType: "video/webm"}
 */function t(o,r){o=o||[];var u=this,f,p;r=r||{elementClass:"multi-streams-mixer",mimeType:"video/webm",video:{width:360,height:240}},r.frameInterval||(r.frameInterval=10),r.video||(r.video={}),r.video.width||(r.video.width=360),r.video.height||(r.video.height=240),this.record=function(){f=new e(o,r.elementClass||"multi-streams-mixer"),m().length&&(f.frameInterval=r.frameInterval||10,f.width=r.video.width||360,f.height=r.video.height||240,f.startDrawingFrames()),r.previewStream&&typeof r.previewStream=="function"&&r.previewStream(f.getMixedStream()),p=new ce(f.getMixedStream(),r),p.record()};function m(){var v=[];return o.forEach(function(y){he(y,"video").forEach(function(C){v.push(C)})}),v}this.stop=function(v){p&&p.stop(function(y){u.blob=y,v(y),u.clearRecordedData()})},this.pause=function(){p&&p.pause()},this.resume=function(){p&&p.resume()},this.clearRecordedData=function(){p&&(p.clearRecordedData(),p=null),f&&(f.releaseStreams(),f=null)},this.addStreams=function(v){if(!v)throw"First parameter is required.";v instanceof Array||(v=[v]),o.concat(v),!(!p||!f)&&(f.appendStreams(v),r.previewStream&&typeof r.previewStream=="function"&&r.previewStream(f.getMixedStream()))},this.resetVideoStreams=function(v){f&&(v&&!(v instanceof Array)&&(v=[v]),f.resetVideoStreams(v))},this.getMixer=function(){return f},this.name="MultiStreamRecorder",this.toString=function(){return this.name}}typeof h<"u"&&(h.MultiStreamRecorder=t);/**
 * RecordRTCPromisesHandler adds promises support in {@link RecordRTC}. Try a {@link https://github.com/muaz-khan/RecordRTC/blob/master/simple-demos/RecordRTCPromisesHandler.html|demo here}
 * @summary Promises for {@link RecordRTC}
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef RecordRTCPromisesHandler
 * @class
 * @example
 * var recorder = new RecordRTCPromisesHandler(mediaStream, options);
 * recorder.startRecording()
 *         .then(successCB)
 *         .catch(errorCB);
 * // Note: You can access all RecordRTC API using "recorder.recordRTC" e.g. 
 * recorder.recordRTC.onStateChanged = function(state) {};
 * recorder.recordRTC.setRecordingDuration(5000);
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - Single media-stream object, array of media-streams, html-canvas-element, etc.
 * @param {object} config - {type:"video", recorderType: MediaStreamRecorder, disableLogs: true, numberOfAudioChannels: 1, bufferSize: 0, sampleRate: 0, video: HTMLVideoElement, etc.}
 * @throws Will throw an error if "new" keyword is not used to initiate "RecordRTCPromisesHandler". Also throws error if first argument "MediaStream" is missing.
 * @requires {@link RecordRTC}
 */function a(o,r){if(!this)throw'Use "new RecordRTCPromisesHandler()"';if(typeof o>"u")throw'First argument "MediaStream" is required.';var u=this;u.recordRTC=new h(o,r),this.startRecording=function(){return new Promise(function(f,p){try{u.recordRTC.startRecording(),f()}catch(m){p(m)}})},this.stopRecording=function(){return new Promise(function(f,p){try{u.recordRTC.stopRecording(function(m){if(u.blob=u.recordRTC.getBlob(),!u.blob||!u.blob.size){p("Empty blob.",u.blob);return}f(m)})}catch(m){p(m)}})},this.pauseRecording=function(){return new Promise(function(f,p){try{u.recordRTC.pauseRecording(),f()}catch(m){p(m)}})},this.resumeRecording=function(){return new Promise(function(f,p){try{u.recordRTC.resumeRecording(),f()}catch(m){p(m)}})},this.getDataURL=function(f){return new Promise(function(p,m){try{u.recordRTC.getDataURL(function(v){p(v)})}catch(v){m(v)}})},this.getBlob=function(){return new Promise(function(f,p){try{f(u.recordRTC.getBlob())}catch(m){p(m)}})},this.getInternalRecorder=function(){return new Promise(function(f,p){try{f(u.recordRTC.getInternalRecorder())}catch(m){p(m)}})},this.reset=function(){return new Promise(function(f,p){try{f(u.recordRTC.reset())}catch(m){p(m)}})},this.destroy=function(){return new Promise(function(f,p){try{f(u.recordRTC.destroy())}catch(m){p(m)}})},this.getState=function(){return new Promise(function(f,p){try{f(u.recordRTC.getState())}catch(m){p(m)}})},this.blob=null,this.version="5.6.2"}typeof h<"u"&&(h.RecordRTCPromisesHandler=a);/**
 * WebAssemblyRecorder lets you create webm videos in JavaScript via WebAssembly. The library consumes raw RGBA32 buffers (4 bytes per pixel) and turns them into a webm video with the given framerate and quality. This makes it compatible out-of-the-box with ImageData from a CANVAS. With realtime mode you can also use webm-wasm for streaming webm videos.
 * @summary Video recording feature in Chrome, Firefox and maybe Edge.
 * @license {@link https://github.com/muaz-khan/RecordRTC/blob/master/LICENSE|MIT}
 * @author {@link https://MuazKhan.com|Muaz Khan}
 * @typedef WebAssemblyRecorder
 * @class
 * @example
 * var recorder = new WebAssemblyRecorder(mediaStream);
 * recorder.record();
 * recorder.stop(function(blob) {
 *     video.src = URL.createObjectURL(blob);
 * });
 * @see {@link https://github.com/muaz-khan/RecordRTC|RecordRTC Source Code}
 * @param {MediaStream} mediaStream - MediaStream object fetched using getUserMedia API or generated using captureStreamUntilEnded or WebAudio API.
 * @param {object} config - {webAssemblyPath:'webm-wasm.wasm',workerPath: 'webm-worker.js', frameRate: 30, width: 1920, height: 1080, bitrate: 1024, realtime: true}
 */function c(o,r){(typeof ReadableStream>"u"||typeof WritableStream>"u")&&console.error("Following polyfill is strongly recommended: https://unpkg.com/@mattiasbuelens/web-streams-polyfill/dist/polyfill.min.js"),r=r||{},r.width=r.width||640,r.height=r.height||480,r.frameRate=r.frameRate||30,r.bitrate=r.bitrate||1200,r.realtime=r.realtime||!0;var u;function f(){return new ReadableStream({start:function(R){var M=document.createElement("canvas"),W=document.createElement("video"),j=!0;W.srcObject=o,W.muted=!0,W.height=r.height,W.width=r.width,W.volume=0,W.onplaying=function(){M.width=r.width,M.height=r.height;var I=M.getContext("2d"),T=1e3/r.frameRate,D=setInterval(function(){if(u&&(clearInterval(D),R.close()),j&&(j=!1,r.onVideoProcessStarted&&r.onVideoProcessStarted()),I.drawImage(W,0,0),R._controlledReadableStream.state!=="closed")try{R.enqueue(I.getImageData(0,0,r.width,r.height))}catch{}},T)},W.play()}})}var p;function m(R,M){if(!r.workerPath&&!M){u=!1,fetch("https://unpkg.com/webm-wasm@latest/dist/webm-worker.js").then(function(j){j.arrayBuffer().then(function(I){m(R,I)})});return}if(!r.workerPath&&M instanceof ArrayBuffer){var W=new Blob([M],{type:"text/javascript"});r.workerPath=O.createObjectURL(W)}r.workerPath||console.error("workerPath parameter is missing."),p=new Worker(r.workerPath),p.postMessage(r.webAssemblyPath||"https://unpkg.com/webm-wasm@latest/dist/webm-wasm.wasm"),p.addEventListener("message",function(j){j.data==="READY"?(p.postMessage({width:r.width,height:r.height,bitrate:r.bitrate||1200,timebaseDen:r.frameRate||30,realtime:r.realtime}),f().pipeTo(new WritableStream({write:function(I){if(u){console.error("Got image, but recorder is finished!");return}p.postMessage(I.data.buffer,[I.data.buffer])}}))):j.data&&(v||C.push(j.data))})}this.record=function(){C=[],v=!1,this.blob=null,m(o),typeof r.initCallback=="function"&&r.initCallback()};var v;this.pause=function(){v=!0},this.resume=function(){v=!1};function y(R){if(!p){R&&R();return}p.addEventListener("message",function(M){M.data===null&&(p.terminate(),p=null,R&&R())}),p.postMessage(null)}var C=[];this.stop=function(R){u=!0;var M=this;y(function(){M.blob=new Blob(C,{type:"video/webm"}),R(M.blob)})},this.name="WebAssemblyRecorder",this.toString=function(){return this.name},this.clearRecordedData=function(){C=[],v=!1,this.blob=null},this.blob=null}typeof h<"u"&&(h.WebAssemblyRecorder=c)})(at);var wt=at.exports;const Ct=bt(wt);$.defaultUIElementURL="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@3.3.9/dist/dce.ui.html";class xt extends ct{constructor(){super(...arguments),this.hasMicrophone=!1}async setDefaultUIElementURL(h){$.defaultUIElementURL=h}async setElement(h){this.container=h}saveFrame(){throw new Error("Method not implemented.")}async getOrientation(){return window.matchMedia("(orientation: portrait)").matches?{orientation:"PORTRAIT"}:{orientation:"LANDSCAPE"}}async initialize(){this.camera=await $.createInstance(),this.camera.on("played",d=>{this.notifyListeners("onPlayed",{resolution:d.width+"x"+d.height});try{let _=this.camera.getUIElement().getElementsByClassName("dce-video-container")[0].getElementsByTagName("canvas")[0];_&&_.remove()}catch(_){console.log(_)}}),this.container?await this.camera.setUIElement(this.container):(await this.camera.setUIElement($.defaultUIElementURL),this.camera.getUIElement().getElementsByClassName("dce-btn-close")[0].remove(),this.camera.getUIElement().getElementsByClassName("dce-sel-camera")[0].remove(),this.camera.getUIElement().getElementsByClassName("dce-sel-resolution")[0].remove(),this.camera.getUIElement().getElementsByClassName("dce-msg-poweredby")[0].remove()),this.camera.setVideoFit("cover"),window.matchMedia("(orientation: portrait)").addEventListener("change",()=>{this.notifyListeners("onOrientationChanged",null)})}async getResolution(){if(this.camera){let h=this.camera.getResolution();return{resolution:h[0]+"x"+h[1]}}else throw new Error("Camera not initialized")}async setResolution(h){if(this.camera){let d=h.resolution,_=1280,b=720;d==Ye.RESOLUTION_480P?(_=640,b=480):d==Ye.RESOLUTION_720P?(_=1280,b=720):d==Ye.RESOLUTION_1080P?(_=1920,b=1080):d==Ye.RESOLUTION_2K?(_=2560,b=1440):d==Ye.RESOLUTION_4K&&(_=3840,b=2160),await this.camera.setResolution(_,b);return}else throw new Error("Camera not initialized")}async getAllCameras(){if(this.camera){let h=await this.camera.getAllCameras(),d=[];return h.forEach(_=>{d.push(_.label)}),{cameras:d}}else throw new Error("Camera not initialized")}async getSelectedCamera(){if(this.camera)return{selectedCamera:this.camera.getSelectedCamera().label};throw new Error("Camera not initialized")}async selectCamera(h){if(this.camera){let d=await this.camera.getAllCameras();for(let _=0;_<d.length;_++){const b=d[_];if(b.label===h.cameraID){await this.camera.selectCamera(b);return}}}else throw new Error("Camera not initialized")}async setScanRegion(h){if(this.camera)this.region=h.region,this.applyScanRegion();else throw new Error("Camera not initialized")}applyScanRegion(){this.camera&&this.region&&this.camera.setScanRegion({regionLeft:this.region.left,regionTop:this.region.top,regionRight:this.region.right,regionBottom:this.region.bottom,regionMeasuredByPercentage:this.region.measuredByPercentage})}async setZoom(h){if(this.camera){await this.camera.setZoom(h.factor);return}else throw new Error("Camera not initialized")}async setFocus(h){if(this.camera)this.camera.setFocus({mode:"manual",area:{centerPoint:{x:h.x.toString(),y:h.y.toString()}}});else throw new Error("Camera not initialized")}async toggleTorch(h){if(this.camera)try{h.on?await this.camera.turnOnTorch():await this.camera.turnOffTorch()}catch{throw new Error("Torch unsupported")}}async startCamera(){var h;if(this.camera)await((h=this.camera)===null||h===void 0?void 0:h.open(!0)),this.container&&this.isSafari()===!0&&setTimeout(async()=>{var _,b;await((_=this.camera)===null||_===void 0?void 0:_.setZoom(1.001)),await((b=this.camera)===null||b===void 0?void 0:b.setZoom(1))},500);else throw new Error("Camera not initialized")}isSafari(){const h=navigator.userAgent.toLowerCase();return h.indexOf("safari")>-1&&h.indexOf("chrome")===-1}async stopCamera(){if(this.camera)this.camera.close(!0);else throw new Error("Camera not initialized")}async isOpen(){if(this.camera)return{isOpen:this.camera.isOpen()};throw new Error("Camera not initialized")}async takeSnapshot(h){if(this.camera){let d=85;return h.quality&&(d=h.quality),{base64:this.camera.getFrame().toCanvas().toDataURL("image/jpeg",d).replace("data:image/jpeg;base64,","")}}else throw new Error("Camera not initialized")}async takeSnapshot2(h){if(this.camera){let d=h.canvas,_=1;if(h&&h.maxLength){let b=(await this.getResolution()).resolution,x=parseInt(b.split("x")[0]),S=parseInt(b.split("x")[1]),F=x,E=S;if(x>h.maxLength||S>h.maxLength){x>S?(F=h.maxLength,E=h.maxLength/x*S,_=h.maxLength/x):(E=h.maxLength,F=h.maxLength/S*x,_=h.maxLength/S),d.width=F,d.height=E;let P=this.camera.getUIElement().getElementsByTagName("video")[0],O=d.getContext("2d");O&&O.drawImage(P,0,0,F,E)}else this.drawFullFrame(d)}else this.drawFullFrame(d);return{scaleRatio:_}}else throw new Error("Camera not initialized")}drawFullFrame(h){var d;let _=(d=this.camera)===null||d===void 0?void 0:d.getUIElement().getElementsByTagName("video")[0];if(_){h.width=_.videoWidth,h.height=_.videoHeight;let b=h.getContext("2d");b&&b.drawImage(_,0,0,h.width,h.height)}return h}async takePhoto(h){if(this.camera){let _=this.camera.getUIElement().getElementsByTagName("video")[0].srcObject;if(_)if("ImageCapture"in window)try{let x=window.ImageCapture;console.log("ImageCapture supported");const S=_.getVideoTracks()[0];return{blob:await new x(S).takePhoto()}}catch(x){console.log(x)}else console.log("ImageCapture not supported");this.camera.setScanRegion({regionLeft:0,regionTop:0,regionBottom:100,regionRight:100,regionMeasuredByPercentage:1});let b=this.removeDataURLHead(this.camera.getFrame().toCanvas().toDataURL("image/jpeg"));return this.applyScanRegion(),{base64:b}}else throw new Error("Camera not initialized")}removeDataURLHead(h){return h.substring(h.indexOf(",")+1,h.length)}async requestCameraPermission(){const h={video:!0,audio:!1},_=(await navigator.mediaDevices.getUserMedia(h)).getTracks();for(let b=0;b<_.length;b++)_[b].stop()}async requestMicroPhonePermission(){try{const h={video:!1,audio:!0},_=(await navigator.mediaDevices.getUserMedia(h)).getTracks();for(let b=0;b<_.length;b++)_[b].stop();this.hasMicrophone=!0}catch(h){throw this.hasMicrophone=!1,h}}async startRecording(){if(this.camera){if(this.hasMicrophone){let d=this.camera.getVideoSettings();d.audio=!0,await this.camera.updateVideoSettings(d)}let h=this.camera.getUIElement().getElementsByTagName("video")[0];this.recorder=new Ct(h.srcObject,{type:"video"}),this.recorder.startRecording()}else throw new Error("camera not initialized")}async stopRecording(){return new Promise((h,d)=>{if(this.recorder){const _=()=>{let b=this.recorder.getBlob();this.recorder.destroy(),this.recorder=null,h({blob:b})};this.recorder.stopRecording(_)}else d("recorder not initialized")})}async setLayout(h){if(this.camera){let d=this.camera.getUIElement();h.top&&(d.style.top=h.top),h.left&&(d.style.left=h.left),h.width&&(d.style.width=h.width),h.height&&(d.style.height=h.height),d.style.position="absolute"}else throw new Error("Camera not initialized")}}export{xt as CameraPreviewWeb};
